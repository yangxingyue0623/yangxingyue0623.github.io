<a name=top></a><!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Hugo-HT</title><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/r.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/bash.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/python.min.js></script><script src=https://cdn.jsdelivr.net/npm/vega@5.17.0></script><script src=https://cdn.jsdelivr.net/npm/vega-lite@4.17.0></script><script src=https://cdn.jsdelivr.net/npm/vega-embed@6.12.2></script><script>hljs.initHighlightingOnLoad();</script><link rel=icon href=https://yangxingyue0623.github.io/media/hugo-logo.png></head><body><div class=wrapper><header class=header><nav class=nav><a href=/ class=nav-logo><img src=/media/hugo-logo.png width=50 height=50 alt=Hugo-ht></a><ul class=nav-links><li><a href=/>主页</a></li><li><a href=/cn/about/>关于</a></li><li><a href=/cn/posts/>博客</a></li><li><a href=/en/about>English</a></li></ul></nav></header><main class=content role=main><div style=text-align:center><h1>redis项目黑马点评（秒杀）</h1><p>yangxingyue0623
/ 2022-12-11</p><hr></div><span class=article-toolbar><a href=https://github.com/yangxingyue0623/yangxingyue0623.github.io/edit/master/content/cn/posts/2022-12-13-redis-hmdp.md style=font-size:24px;color:#000 target=_blank><i class="fa fa-edit" aria-hidden=true title=编辑本页></i></a></span><div class="body-text list-text"><p>[toc]</p><h2 id=1项目介绍>1.项目介绍<a href=#1项目介绍 class=header-anchor arialabel=Anchor> #</a></h2><p><img src=https://img-blog.csdnimg.cn/abf1246ffdca4c90a1b00f36905892bf.png#pic_center alt=在这里插入图片描述></p><ul><li>Spring 相关：</li></ul><blockquote><p>Spring Boot 2.x
Spring MVC
数据存储层：</p></blockquote><blockquote><p>MySQL：存储数据
MyBatis Plus：数据访问框架
Redis 相关：</p></blockquote><blockquote><p>spring-data-redis：操作 Redis
Lettuce：操作 Redis 的高级客户端
Apache Commons Pool：用于实现 Redis 连接池
Redisson：基于 Redis 的分布式数据网格
工具库：</p></blockquote><blockquote><p>HuTool：工具库合集
Lombok：注解式代码生成工具</p></blockquote><h2 id=github源码httpsgithubcomyangxingyue0623redis-hmdp><a href=https://github.com/yangxingyue0623/redis-hmdp target=_blank rel="noreferrer noopener">github源码</a></h2><h2 id=gitee源码httpsgiteecomyangxingyue0623redis-hmdp><a href=https://gitee.com/yangxingyue0623/redis-hmdp target=_blank rel="noreferrer noopener">gitee源码</a></h2><ul><li>短信登录</li></ul><p>这一块我们会使用redis共享session来实现</p><ul><li>商户查询缓存</li></ul><p>通过本章节，我们会理解缓存击穿，缓存穿透，缓存雪崩等问题，让小伙伴的对于这些概念的理解不仅仅是停留在概念上，更是能在代码中看到对应的内容</p><ul><li>优惠卷秒杀</li></ul><p>通过本章节，我们可以学会Redis的计数器功能， 结合Lua完成高性能的redis操作，同时学会Redis分布式锁的原理，包括Redis的三种消息队列</p><ul><li>附近的商户</li></ul><p>我们利用Redis的GEOHash来完成对于地理坐标的操作</p><ul><li>UV统计</li></ul><p>主要是使用Redis来完成统计功能</p><ul><li>用户签到</li></ul><p>使用Redis的BitMap数据统计功能</p><ul><li>好友关注</li></ul><p>基于Set集合的关注、取消关注，共同关注等等功能，这一块知识咱们之前就讲过，这次我们在项目中来使用一下</p><ul><li>打人探店</li></ul><p>基于List来完成点赞列表的操作，同时基于SortedSet来完成点赞的排行榜功能</p><blockquote><p>基于黑马点评所做的项目优化，实现基于session的session共享，解决商户缓存的缓存穿透缓存雪崩缓存击穿，基于redission分布式锁lua脚本消息队列实现异步秒杀下单，Redis的GEOHash来完成对于地理坐标的操作，使用Redis的BitMap数据实现签到统计，好友关注基于Set集合的关注取消关注共同关注等等功能，达人探店基于List来完成点赞列表的操作，Feed流推送博客基于SortedSet来完成点赞的排行榜功能，UV统计使用HyperLogLog</p></blockquote><h2 id=源码后端地址>源码后端地址<a href=#源码后端地址 class=header-anchor arialabel=Anchor> #</a></h2><h3 id=githubhttpsgithubcomyangxingyue0623redis-hmdp><a href=https://github.com/yangxingyue0623/redis-hmdp target=_blank rel="noreferrer noopener">github</a></h3><h3 id=giteehttpsgiteecomyangxingyue0623redis-hmdp><a href=https://gitee.com/yangxingyue0623/redis-hmdp target=_blank rel="noreferrer noopener">gitee</a></h3><h2 id=yaml配置>yaml配置<a href=#yaml配置 class=header-anchor arialabel=Anchor> #</a></h2><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>server</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>8081</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spring</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>application</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>hmdp<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>datasource</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>driver-class-name</span>:<span style=color:#bbb> </span>com.mysql.cj.jdbc.Driver<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#408080;font-style:italic>#    url: jdbc:mysql://127.0.0.1:3306/hmdp?useSSL=false&amp;serverTimezone=UTC</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>username</span>:<span style=color:#bbb> </span>root<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>password</span>:<span style=color:#bbb> </span><span style=color:#666>123456</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>url</span>:<span style=color:#bbb> </span>jdbc:mysql://localhost:3306/hmdp?serverTimezone=Asia/Shanghai&amp;useUnicode=true&amp;characterEncoding=utf-8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=false&amp;allowPublicKeyRetrieval=true<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>redis</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>host</span>:<span style=color:#bbb> </span><span style=color:#666>192.168.8.130</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>6379</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>password</span>:<span style=color:#bbb> </span>yangroot<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>lettuce</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>pool</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>max-active</span>:<span style=color:#bbb> </span><span style=color:#666>10</span><span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>max-idle</span>:<span style=color:#bbb> </span><span style=color:#666>10</span><span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>min-idle</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>time-between-eviction-runs</span>:<span style=color:#bbb> </span>10s<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>jackson</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>default-property-inclusion</span>:<span style=color:#bbb> </span>non_null<span style=color:#bbb> </span><span style=color:#408080;font-style:italic># JSON处理时忽略非空字段</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>mybatis-plus</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>type-aliases-package</span>:<span style=color:#bbb> </span>com.hmdp.entity<span style=color:#bbb> </span><span style=color:#408080;font-style:italic># 别名扫描包</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>logging</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>level</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>com.hmdp</span>:<span style=color:#bbb> </span>debug<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>pattern</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>dateformat</span>:<span style=color:#bbb> </span>mm:ss.SSS<span style=color:#bbb>
</span></code></pre></div><h2 id=pom文件>pom文件<a href=#pom文件 class=header-anchor arialabel=Anchor> #</a></h2><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#bc7a00>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span style=color:green;font-weight:700>&lt;project</span> <span style=color:#7d9029>xmlns=</span><span style=color:#ba2121>&#34;http://maven.apache.org/POM/4.0.0&#34;</span> <span style=color:#7d9029>xmlns:xsi=</span><span style=color:#ba2121>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
         <span style=color:#7d9029>xsi:schemaLocation=</span><span style=color:#ba2121>&#34;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span style=color:green;font-weight:700>&gt;</span>
    <span style=color:green;font-weight:700>&lt;modelVersion&gt;</span>4.0.0<span style=color:green;font-weight:700>&lt;/modelVersion&gt;</span>
    <span style=color:green;font-weight:700>&lt;parent&gt;</span>
        <span style=color:green;font-weight:700>&lt;groupId&gt;</span>org.springframework.boot<span style=color:green;font-weight:700>&lt;/groupId&gt;</span>
        <span style=color:green;font-weight:700>&lt;artifactId&gt;</span>spring-boot-starter-parent<span style=color:green;font-weight:700>&lt;/artifactId&gt;</span>
        <span style=color:green;font-weight:700>&lt;version&gt;</span>2.7.5<span style=color:green;font-weight:700>&lt;/version&gt;</span>
        <span style=color:green;font-weight:700>&lt;relativePath/&gt;</span> <span style=color:#408080;font-style:italic>&lt;!-- lookup parent from repository --&gt;</span>
    <span style=color:green;font-weight:700>&lt;/parent&gt;</span>
    <span style=color:green;font-weight:700>&lt;groupId&gt;</span>com.hmdp<span style=color:green;font-weight:700>&lt;/groupId&gt;</span>
    <span style=color:green;font-weight:700>&lt;artifactId&gt;</span>hm-dianping<span style=color:green;font-weight:700>&lt;/artifactId&gt;</span>
    <span style=color:green;font-weight:700>&lt;version&gt;</span>0.0.1-SNAPSHOT<span style=color:green;font-weight:700>&lt;/version&gt;</span>
    <span style=color:green;font-weight:700>&lt;name&gt;</span>hm-dianping<span style=color:green;font-weight:700>&lt;/name&gt;</span>
    <span style=color:green;font-weight:700>&lt;description&gt;</span>Demo project for Spring Boot<span style=color:green;font-weight:700>&lt;/description&gt;</span>
    <span style=color:green;font-weight:700>&lt;properties&gt;</span>
        <span style=color:green;font-weight:700>&lt;java.version&gt;</span>1.8<span style=color:green;font-weight:700>&lt;/java.version&gt;</span>
    <span style=color:green;font-weight:700>&lt;/properties&gt;</span>
    <span style=color:green;font-weight:700>&lt;dependencies&gt;</span>
        <span style=color:green;font-weight:700>&lt;dependency&gt;</span>
            <span style=color:green;font-weight:700>&lt;groupId&gt;</span>org.springframework.boot<span style=color:green;font-weight:700>&lt;/groupId&gt;</span>
            <span style=color:green;font-weight:700>&lt;artifactId&gt;</span>spring-boot-starter-data-redis<span style=color:green;font-weight:700>&lt;/artifactId&gt;</span>
            <span style=color:green;font-weight:700>&lt;exclusions&gt;</span>
                <span style=color:green;font-weight:700>&lt;exclusion&gt;</span>
                    <span style=color:green;font-weight:700>&lt;artifactId&gt;</span>spring-data-redis<span style=color:green;font-weight:700>&lt;/artifactId&gt;</span>
                    <span style=color:green;font-weight:700>&lt;groupId&gt;</span>org.springframework.data<span style=color:green;font-weight:700>&lt;/groupId&gt;</span>
                <span style=color:green;font-weight:700>&lt;/exclusion&gt;</span>
                <span style=color:green;font-weight:700>&lt;exclusion&gt;</span>
                    <span style=color:green;font-weight:700>&lt;artifactId&gt;</span>lettuce-core<span style=color:green;font-weight:700>&lt;/artifactId&gt;</span>
                    <span style=color:green;font-weight:700>&lt;groupId&gt;</span>io.lettuce<span style=color:green;font-weight:700>&lt;/groupId&gt;</span>
                <span style=color:green;font-weight:700>&lt;/exclusion&gt;</span>
            <span style=color:green;font-weight:700>&lt;/exclusions&gt;</span>
        <span style=color:green;font-weight:700>&lt;/dependency&gt;</span>
        <span style=color:green;font-weight:700>&lt;dependency&gt;</span>
            <span style=color:green;font-weight:700>&lt;groupId&gt;</span>org.springframework.data<span style=color:green;font-weight:700>&lt;/groupId&gt;</span>
            <span style=color:green;font-weight:700>&lt;artifactId&gt;</span>spring-data-redis<span style=color:green;font-weight:700>&lt;/artifactId&gt;</span>
        <span style=color:green;font-weight:700>&lt;/dependency&gt;</span>
        <span style=color:green;font-weight:700>&lt;dependency&gt;</span>
            <span style=color:green;font-weight:700>&lt;groupId&gt;</span>org.apache.commons<span style=color:green;font-weight:700>&lt;/groupId&gt;</span>
            <span style=color:green;font-weight:700>&lt;artifactId&gt;</span>commons-pool2<span style=color:green;font-weight:700>&lt;/artifactId&gt;</span>
        <span style=color:green;font-weight:700>&lt;/dependency&gt;</span>
        <span style=color:green;font-weight:700>&lt;dependency&gt;</span>
            <span style=color:green;font-weight:700>&lt;groupId&gt;</span>io.lettuce<span style=color:green;font-weight:700>&lt;/groupId&gt;</span>
            <span style=color:green;font-weight:700>&lt;artifactId&gt;</span>lettuce-core<span style=color:green;font-weight:700>&lt;/artifactId&gt;</span>
            <span style=color:green;font-weight:700>&lt;version&gt;</span>6.1.6.RELEASE<span style=color:green;font-weight:700>&lt;/version&gt;</span>
        <span style=color:green;font-weight:700>&lt;/dependency&gt;</span>
        <span style=color:green;font-weight:700>&lt;dependency&gt;</span>
            <span style=color:green;font-weight:700>&lt;groupId&gt;</span>org.springframework.boot<span style=color:green;font-weight:700>&lt;/groupId&gt;</span>
            <span style=color:green;font-weight:700>&lt;artifactId&gt;</span>spring-boot-starter-web<span style=color:green;font-weight:700>&lt;/artifactId&gt;</span>
        <span style=color:green;font-weight:700>&lt;/dependency&gt;</span>

        <span style=color:#408080;font-style:italic>&lt;!--        &lt;dependency&gt;--&gt;</span>
        <span style=color:#408080;font-style:italic>&lt;!--            &lt;groupId&gt;mysql&lt;/groupId&gt;--&gt;</span>
        <span style=color:#408080;font-style:italic>&lt;!--            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;--&gt;</span>
        <span style=color:#408080;font-style:italic>&lt;!--            &lt;scope&gt;runtime&lt;/scope&gt;--&gt;</span>
        <span style=color:#408080;font-style:italic>&lt;!--            &lt;version&gt;5.1.47&lt;/version&gt;--&gt;</span>
        <span style=color:#408080;font-style:italic>&lt;!--        &lt;/dependency&gt;--&gt;</span>
        <span style=color:green;font-weight:700>&lt;dependency&gt;</span>
            <span style=color:green;font-weight:700>&lt;groupId&gt;</span>mysql<span style=color:green;font-weight:700>&lt;/groupId&gt;</span>
            <span style=color:green;font-weight:700>&lt;artifactId&gt;</span>mysql-connector-java<span style=color:green;font-weight:700>&lt;/artifactId&gt;</span>
            <span style=color:green;font-weight:700>&lt;scope&gt;</span>runtime<span style=color:green;font-weight:700>&lt;/scope&gt;</span>
        <span style=color:green;font-weight:700>&lt;/dependency&gt;</span>
        <span style=color:green;font-weight:700>&lt;dependency&gt;</span>
            <span style=color:green;font-weight:700>&lt;groupId&gt;</span>org.projectlombok<span style=color:green;font-weight:700>&lt;/groupId&gt;</span>
            <span style=color:green;font-weight:700>&lt;artifactId&gt;</span>lombok<span style=color:green;font-weight:700>&lt;/artifactId&gt;</span>
            <span style=color:green;font-weight:700>&lt;optional&gt;</span>true<span style=color:green;font-weight:700>&lt;/optional&gt;</span>
        <span style=color:green;font-weight:700>&lt;/dependency&gt;</span>
        <span style=color:green;font-weight:700>&lt;dependency&gt;</span>
            <span style=color:green;font-weight:700>&lt;groupId&gt;</span>org.springframework.boot<span style=color:green;font-weight:700>&lt;/groupId&gt;</span>
            <span style=color:green;font-weight:700>&lt;artifactId&gt;</span>spring-boot-starter-test<span style=color:green;font-weight:700>&lt;/artifactId&gt;</span>
            <span style=color:green;font-weight:700>&lt;scope&gt;</span>test<span style=color:green;font-weight:700>&lt;/scope&gt;</span>
        <span style=color:green;font-weight:700>&lt;/dependency&gt;</span>
        <span style=color:green;font-weight:700>&lt;dependency&gt;</span>
            <span style=color:green;font-weight:700>&lt;groupId&gt;</span>com.baomidou<span style=color:green;font-weight:700>&lt;/groupId&gt;</span>
            <span style=color:green;font-weight:700>&lt;artifactId&gt;</span>mybatis-plus-boot-starter<span style=color:green;font-weight:700>&lt;/artifactId&gt;</span>
            <span style=color:green;font-weight:700>&lt;version&gt;</span>3.4.3<span style=color:green;font-weight:700>&lt;/version&gt;</span>
        <span style=color:green;font-weight:700>&lt;/dependency&gt;</span>
        <span style=color:#408080;font-style:italic>&lt;!--hutool--&gt;</span>
        <span style=color:green;font-weight:700>&lt;dependency&gt;</span>
            <span style=color:green;font-weight:700>&lt;groupId&gt;</span>cn.hutool<span style=color:green;font-weight:700>&lt;/groupId&gt;</span>
            <span style=color:green;font-weight:700>&lt;artifactId&gt;</span>hutool-all<span style=color:green;font-weight:700>&lt;/artifactId&gt;</span>
            <span style=color:green;font-weight:700>&lt;version&gt;</span>5.7.17<span style=color:green;font-weight:700>&lt;/version&gt;</span>
        <span style=color:green;font-weight:700>&lt;/dependency&gt;</span>
        <span style=color:#408080;font-style:italic>&lt;!--redisson--&gt;</span>
        <span style=color:green;font-weight:700>&lt;dependency&gt;</span>
            <span style=color:green;font-weight:700>&lt;groupId&gt;</span>org.redisson<span style=color:green;font-weight:700>&lt;/groupId&gt;</span>
            <span style=color:green;font-weight:700>&lt;artifactId&gt;</span>redisson<span style=color:green;font-weight:700>&lt;/artifactId&gt;</span>
            <span style=color:green;font-weight:700>&lt;version&gt;</span>3.13.6<span style=color:green;font-weight:700>&lt;/version&gt;</span>
        <span style=color:green;font-weight:700>&lt;/dependency&gt;</span>
        <span style=color:#408080;font-style:italic>&lt;!-- https://mvnrepository.com/artifact/org.aspectj/aspectjweaver --&gt;</span>
        <span style=color:green;font-weight:700>&lt;dependency&gt;</span>
            <span style=color:green;font-weight:700>&lt;groupId&gt;</span>org.aspectj<span style=color:green;font-weight:700>&lt;/groupId&gt;</span>
            <span style=color:green;font-weight:700>&lt;artifactId&gt;</span>aspectjweaver<span style=color:green;font-weight:700>&lt;/artifactId&gt;</span>
            <span style=color:green;font-weight:700>&lt;version&gt;</span>1.9.9.1<span style=color:green;font-weight:700>&lt;/version&gt;</span>
        <span style=color:green;font-weight:700>&lt;/dependency&gt;</span>

    <span style=color:green;font-weight:700>&lt;/dependencies&gt;</span>

    <span style=color:green;font-weight:700>&lt;build&gt;</span>
        <span style=color:green;font-weight:700>&lt;plugins&gt;</span>
            <span style=color:green;font-weight:700>&lt;plugin&gt;</span>
                <span style=color:green;font-weight:700>&lt;groupId&gt;</span>org.springframework.boot<span style=color:green;font-weight:700>&lt;/groupId&gt;</span>
                <span style=color:green;font-weight:700>&lt;artifactId&gt;</span>spring-boot-maven-plugin<span style=color:green;font-weight:700>&lt;/artifactId&gt;</span>
                <span style=color:green;font-weight:700>&lt;configuration&gt;</span>
                    <span style=color:green;font-weight:700>&lt;excludes&gt;</span>
                        <span style=color:green;font-weight:700>&lt;exclude&gt;</span>
                            <span style=color:green;font-weight:700>&lt;groupId&gt;</span>org.projectlombok<span style=color:green;font-weight:700>&lt;/groupId&gt;</span>
                            <span style=color:green;font-weight:700>&lt;artifactId&gt;</span>lombok<span style=color:green;font-weight:700>&lt;/artifactId&gt;</span>
                        <span style=color:green;font-weight:700>&lt;/exclude&gt;</span>
                    <span style=color:green;font-weight:700>&lt;/excludes&gt;</span>
                <span style=color:green;font-weight:700>&lt;/configuration&gt;</span>
            <span style=color:green;font-weight:700>&lt;/plugin&gt;</span>
        <span style=color:green;font-weight:700>&lt;/plugins&gt;</span>
    <span style=color:green;font-weight:700>&lt;/build&gt;</span>

<span style=color:green;font-weight:700>&lt;/project&gt;</span>

</code></pre></div><h2 id=1短信登录>1、短信登录<a href=#1短信登录 class=header-anchor arialabel=Anchor> #</a></h2><h3 id=11基于session实现登录流程>1.1、基于Session实现登录流程<a href=#11基于session实现登录流程 class=header-anchor arialabel=Anchor> #</a></h3><p><img src=https://img-blog.csdnimg.cn/9e6337b2deed414f8619eacb01e1e9c0.png alt=在这里插入图片描述></p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#a2f>@Override</span>
    <span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>sendCode</span><span style=color:#666>(</span>String phone<span style=color:#666>,</span> HttpSession session<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 1.校验手机号
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>RegexUtils<span style=color:#666>.</span><span style=color:#7d9029>isPhoneInvalid</span><span style=color:#666>(</span>phone<span style=color:#666>))</span> <span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>// 2.如果不符合，返回错误信息
</span><span style=color:#408080;font-style:italic></span>            <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;手机号格式错误！&#34;</span><span style=color:#666>);</span>
        <span style=color:#666>}</span>
        <span style=color:#408080;font-style:italic>// 3.符合，生成验证码
</span><span style=color:#408080;font-style:italic></span>        String code <span style=color:#666>=</span> RandomUtil<span style=color:#666>.</span><span style=color:#7d9029>randomNumbers</span><span style=color:#666>(</span>6<span style=color:#666>);</span>

        <span style=color:#408080;font-style:italic>// 4.保存验证码到 session
</span><span style=color:#408080;font-style:italic></span>        session<span style=color:#666>.</span><span style=color:#7d9029>setAttribute</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;code&#34;</span><span style=color:#666>,</span>code<span style=color:#666>);</span>
        <span style=color:#408080;font-style:italic>// 5.发送验证码
</span><span style=color:#408080;font-style:italic></span>        log<span style=color:#666>.</span><span style=color:#7d9029>debug</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;发送短信验证码成功，验证码：{}&#34;</span><span style=color:#666>,</span> code<span style=color:#666>);</span>
        <span style=color:#408080;font-style:italic>// 返回ok
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>();</span>
    <span style=color:#666>}</span>


</code></pre></div><h3 id=12基于session实现登陆的问题>1.2.基于session实现登陆的问题<a href=#12基于session实现登陆的问题 class=header-anchor arialabel=Anchor> #</a></h3><blockquote><p>单体应用时用户的会话信息保存在session中，session存在于服务器端的内存中，由于前前后后用户只针对一个web服务器，所以没啥问题。但是一到了web服务器集群的环境下（我们一般都是用Nginx做负载均衡，若是使用了轮询等这种请求分配策略），就会导致用户小a在A服务器登录了，session存在于A服务器中，但是第二次请求被分配到了B服务器，由于B服务器中没有用户小a的session会话，导致用户小a还要再登陆一次.</p><p><img src=https://img-blog.csdnimg.cn/abf1246ffdca4c90a1b00f36905892bf.png#pic_center alt=在这里插入图片描述></p></blockquote><blockquote><p><strong>session 的替代方案</strong> 应该满足：数据共享；内存存储；key、value 结构（<strong>Redis</strong> 恰好就满足这些情况）</p></blockquote><h3 id=13-redis-实现共享-session>1.3 Redis 实现共享 session<a href=#13-redis-实现共享-session class=header-anchor arialabel=Anchor> #</a></h3><p><img src=https://img-blog.csdnimg.cn/79783e6d465249b882ca325c68c2c288.png alt=在这里插入图片描述></p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  
<span style=color:#a2f>@Resource</span>
    <span style=color:green;font-weight:700>private</span> StringRedisTemplate stringRedisTemplate<span style=color:#666>;</span>

    <span style=color:#a2f>@Override</span>
    <span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>sendCode</span><span style=color:#666>(</span>String phone<span style=color:#666>,</span> HttpSession session<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 1.校验手机号
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>RegexUtils<span style=color:#666>.</span><span style=color:#7d9029>isPhoneInvalid</span><span style=color:#666>(</span>phone<span style=color:#666>))</span> <span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>// 2.如果不符合，返回错误信息
</span><span style=color:#408080;font-style:italic></span>            <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;手机号格式错误！&#34;</span><span style=color:#666>);</span>
        <span style=color:#666>}</span>
        <span style=color:#408080;font-style:italic>// 3.符合，生成验证码
</span><span style=color:#408080;font-style:italic></span>        String code <span style=color:#666>=</span> RandomUtil<span style=color:#666>.</span><span style=color:#7d9029>randomNumbers</span><span style=color:#666>(</span>6<span style=color:#666>);</span>

        <span style=color:#408080;font-style:italic>// 4.保存验证码到 session
</span><span style=color:#408080;font-style:italic></span>        stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>().</span><span style=color:#7d9029>set</span><span style=color:#666>(</span>LOGIN_CODE_KEY <span style=color:#666>+</span> phone<span style=color:#666>,</span> code<span style=color:#666>,</span> LOGIN_CODE_TTL<span style=color:#666>,</span> TimeUnit<span style=color:#666>.</span><span style=color:#7d9029>MINUTES</span><span style=color:#666>);</span>

        <span style=color:#408080;font-style:italic>// 5.发送验证码
</span><span style=color:#408080;font-style:italic></span>        log<span style=color:#666>.</span><span style=color:#7d9029>debug</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;发送短信验证码成功，验证码：{}&#34;</span><span style=color:#666>,</span> code<span style=color:#666>);</span>
        <span style=color:#408080;font-style:italic>// 返回ok
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>();</span>
    <span style=color:#666>}</span>
</code></pre></div><h3 id=14实现登录拦截功能>1.4、实现登录拦截功能<a href=#14实现登录拦截功能 class=header-anchor arialabel=Anchor> #</a></h3><blockquote><p>在这个方案中，对应路径的拦截，同时刷新登录token令牌的存活时间，但是现在这个拦截器他只是拦截需要被拦截的路径，假设当前用户访问了一些不需要拦截的路径，那么这个拦截器就不会生效，所以此时令牌刷新的动作实际上就不会执行，所以这个方案他是存在问题的.</p><p>既然之前的拦截器无法对不需要拦截的路径生效，那么我们可以添加一个拦截器，在第一个拦截器中拦截所有的路径，把第二个拦截器做的事情放入到第一个拦截器中，同时刷新令牌，因为第一个拦截器有了threadLocal的数据，所以此时第二个拦截器只需要判断拦截器中的user对象是否存在即可，完成整体刷新功能。</p></blockquote><p><img src=https://img-blog.csdnimg.cn/9f06eba6bdab4c8eb132dc680fc9263a.png#pic_center alt=在这里插入图片描述></p><p><img src=https://img-blog.csdnimg.cn/5d6320f988a94c9f9dff10756dc83bdc.png#pic_center alt=在这里插入图片描述></p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>RefreshTokenInterceptor</span> <span style=color:green;font-weight:700>implements</span> HandlerInterceptor <span style=color:#666>{</span>

    <span style=color:green;font-weight:700>private</span> StringRedisTemplate stringRedisTemplate<span style=color:#666>;</span>

    <span style=color:green;font-weight:700>public</span> <span style=color:#00f>RefreshTokenInterceptor</span><span style=color:#666>(</span>StringRedisTemplate stringRedisTemplate<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:green;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#7d9029>stringRedisTemplate</span> <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>;</span>
    <span style=color:#666>}</span>

    <span style=color:#a2f>@Override</span>
    <span style=color:green;font-weight:700>public</span> <span style=color:#b00040>boolean</span> <span style=color:#00f>preHandle</span><span style=color:#666>(</span>HttpServletRequest request<span style=color:#666>,</span> HttpServletResponse response<span style=color:#666>,</span> Object handler<span style=color:#666>)</span> <span style=color:green;font-weight:700>throws</span> Exception <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 1.获取请求头中的token
</span><span style=color:#408080;font-style:italic></span>        String token <span style=color:#666>=</span> request<span style=color:#666>.</span><span style=color:#7d9029>getHeader</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;authorization&#34;</span><span style=color:#666>);</span>
        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>StrUtil<span style=color:#666>.</span><span style=color:#7d9029>isBlank</span><span style=color:#666>(</span>token<span style=color:#666>))</span> <span style=color:#666>{</span>
            <span style=color:green;font-weight:700>return</span> <span style=color:green;font-weight:700>true</span><span style=color:#666>;</span>
        <span style=color:#666>}</span>
        <span style=color:#408080;font-style:italic>// 2.基于TOKEN获取redis中的用户
</span><span style=color:#408080;font-style:italic></span>        String key  <span style=color:#666>=</span> LOGIN_USER_KEY <span style=color:#666>+</span> token<span style=color:#666>;</span>
        Map<span style=color:#666>&lt;</span>Object<span style=color:#666>,</span> Object<span style=color:#666>&gt;</span> userMap <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForHash</span><span style=color:#666>().</span><span style=color:#7d9029>entries</span><span style=color:#666>(</span>key<span style=color:#666>);</span>
        <span style=color:#408080;font-style:italic>// 3.判断用户是否存在
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>userMap<span style=color:#666>.</span><span style=color:#7d9029>isEmpty</span><span style=color:#666>())</span> <span style=color:#666>{</span>
            <span style=color:green;font-weight:700>return</span> <span style=color:green;font-weight:700>true</span><span style=color:#666>;</span>
        <span style=color:#666>}</span>
        <span style=color:#408080;font-style:italic>// 5.将查询到的hash数据转为UserDTO
</span><span style=color:#408080;font-style:italic></span>        UserDTO userDTO <span style=color:#666>=</span> BeanUtil<span style=color:#666>.</span><span style=color:#7d9029>fillBeanWithMap</span><span style=color:#666>(</span>userMap<span style=color:#666>,</span> <span style=color:green;font-weight:700>new</span> UserDTO<span style=color:#666>(),</span> <span style=color:green;font-weight:700>false</span><span style=color:#666>);</span>
        <span style=color:#408080;font-style:italic>// 6.存在，保存用户信息到 ThreadLocal
</span><span style=color:#408080;font-style:italic></span>        UserHolder<span style=color:#666>.</span><span style=color:#7d9029>saveUser</span><span style=color:#666>(</span>userDTO<span style=color:#666>);</span>
        <span style=color:#408080;font-style:italic>// 7.刷新token有效期
</span><span style=color:#408080;font-style:italic></span>        stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>expire</span><span style=color:#666>(</span>key<span style=color:#666>,</span> LOGIN_USER_TTL<span style=color:#666>,</span> TimeUnit<span style=color:#666>.</span><span style=color:#7d9029>MINUTES</span><span style=color:#666>);</span>
        <span style=color:#408080;font-style:italic>// 8.放行
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>return</span> <span style=color:green;font-weight:700>true</span><span style=color:#666>;</span>
    <span style=color:#666>}</span>

    <span style=color:#a2f>@Override</span>
    <span style=color:green;font-weight:700>public</span> <span style=color:#b00040>void</span> <span style=color:#00f>afterCompletion</span><span style=color:#666>(</span>HttpServletRequest request<span style=color:#666>,</span> HttpServletResponse response<span style=color:#666>,</span> Object handler<span style=color:#666>,</span> Exception ex<span style=color:#666>)</span> <span style=color:green;font-weight:700>throws</span> Exception <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 移除用户
</span><span style=color:#408080;font-style:italic></span>        UserHolder<span style=color:#666>.</span><span style=color:#7d9029>removeUser</span><span style=color:#666>();</span>
    <span style=color:#666>}</span>
<span style=color:#666>}</span>

</code></pre></div><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>LoginInterceptor</span> <span style=color:green;font-weight:700>implements</span> HandlerInterceptor <span style=color:#666>{</span>

    <span style=color:#a2f>@Override</span>
    <span style=color:green;font-weight:700>public</span> <span style=color:#b00040>boolean</span> <span style=color:#00f>preHandle</span><span style=color:#666>(</span>HttpServletRequest request<span style=color:#666>,</span> HttpServletResponse response<span style=color:#666>,</span> Object handler<span style=color:#666>)</span> <span style=color:green;font-weight:700>throws</span> Exception <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 1.判断是否需要拦截（ThreadLocal中是否有用户）
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>UserHolder<span style=color:#666>.</span><span style=color:#7d9029>getUser</span><span style=color:#666>()</span> <span style=color:#666>==</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>// 没有，需要拦截，设置状态码
</span><span style=color:#408080;font-style:italic></span>            response<span style=color:#666>.</span><span style=color:#7d9029>setStatus</span><span style=color:#666>(</span>401<span style=color:#666>);</span>
            <span style=color:#408080;font-style:italic>// 拦截
</span><span style=color:#408080;font-style:italic></span>            <span style=color:green;font-weight:700>return</span> <span style=color:green;font-weight:700>false</span><span style=color:#666>;</span>
        <span style=color:#666>}</span>
        <span style=color:#408080;font-style:italic>// 有用户，则放行
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>return</span> <span style=color:green;font-weight:700>true</span><span style=color:#666>;</span>
    <span style=color:#666>}</span>
<span style=color:#666>}</span>

</code></pre></div><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@Configuration</span>
<span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>MvcConfig</span> <span style=color:green;font-weight:700>implements</span> WebMvcConfigurer <span style=color:#666>{</span>

    <span style=color:#a2f>@Resource</span>
    <span style=color:green;font-weight:700>private</span> StringRedisTemplate stringRedisTemplate<span style=color:#666>;</span>

    <span style=color:#a2f>@Override</span>
    <span style=color:green;font-weight:700>public</span> <span style=color:#b00040>void</span> <span style=color:#00f>addInterceptors</span><span style=color:#666>(</span>InterceptorRegistry registry<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 登录拦截器
</span><span style=color:#408080;font-style:italic></span>        registry<span style=color:#666>.</span><span style=color:#7d9029>addInterceptor</span><span style=color:#666>(</span><span style=color:green;font-weight:700>new</span> LoginInterceptor<span style=color:#666>())</span>
                <span style=color:#666>.</span><span style=color:#7d9029>excludePathPatterns</span><span style=color:#666>(</span>
                        <span style=color:#ba2121>&#34;/shop/**&#34;</span><span style=color:#666>,</span>
                        <span style=color:#ba2121>&#34;/voucher/**&#34;</span><span style=color:#666>,</span>
                        <span style=color:#ba2121>&#34;/shop-type/**&#34;</span><span style=color:#666>,</span>
                        <span style=color:#ba2121>&#34;/upload/**&#34;</span><span style=color:#666>,</span>
                        <span style=color:#ba2121>&#34;/blog/hot&#34;</span><span style=color:#666>,</span>
                        <span style=color:#ba2121>&#34;/user/code&#34;</span><span style=color:#666>,</span>
                        <span style=color:#ba2121>&#34;/user/login&#34;</span>
                <span style=color:#666>).</span><span style=color:#7d9029>order</span><span style=color:#666>(</span>1<span style=color:#666>);</span>
        <span style=color:#408080;font-style:italic>// token刷新的拦截器
</span><span style=color:#408080;font-style:italic></span>        registry<span style=color:#666>.</span><span style=color:#7d9029>addInterceptor</span><span style=color:#666>(</span><span style=color:green;font-weight:700>new</span> RefreshTokenInterceptor<span style=color:#666>(</span>stringRedisTemplate<span style=color:#666>)).</span><span style=color:#7d9029>addPathPatterns</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;/**&#34;</span><span style=color:#666>).</span><span style=color:#7d9029>order</span><span style=color:#666>(</span>0<span style=color:#666>);</span>
    <span style=color:#666>}</span>
<span style=color:#666>}</span>
</code></pre></div><h3 id=15隐藏用户敏感信息>1.5、隐藏用户敏感信息<a href=#15隐藏用户敏感信息 class=header-anchor arialabel=Anchor> #</a></h3><blockquote><p>我们通过浏览器观察到此时用户的全部信息都在，这样极为不靠谱，所以我们应当在返回用户信息之前，将用户的敏感信息进行隐藏，采用的核心思路就是书写一个UserDto对象，这个UserDto对象就没有敏感信息了，我们在返回前，将有用户敏感信息的User对象转化成没有敏感信息的UserDto对象，那么就能够避免这个尴尬的问题了</p></blockquote><h3 id=16-思路>1.6 思路<a href=#16-思路 class=header-anchor arialabel=Anchor> #</a></h3><blockquote><p>第一次登录 ：</p><blockquote><ol><li><p>两个拦截器都通过（login send)</p></li><li><p>发送验证码，验证码保存到redis</p></li><li><p>loginformDto( phone,code, password）从redis获得验证码进行验证</p><p>成功后根据phone从数据库查出user,如果不存在创建新用户</p><p>得到用户之后，随机生成taken，vlaue是 user>userdto>usermap</p><p>返回是taken</p></li></ol></blockquote><p>第二次刷新：</p><blockquote><p>1.拦截器1，获得token，在redis得到usermap > userdto >保存到线程，刷新token有效期</p><p>2.拦截器2，判断用户是否存在，存在就放行。</p></blockquote><p>logininterceper inplement handlerintercept 在pre保存线程 after移除线程(防止线程的泄露)</p><p>在mvcconfig里面addIntercepter 用registry.addinterceper(new logininter()).excluepath(需要排除 的路径)</p><p>/me返回了user(内存压力过大而且返回容易泄露)，可以用.copyProperties(user,userDto.classs),现在存拿都是dto</p></blockquote><h3 id=17-usercontroller-login---logout--code-->1.7 UserController(/ login /logout /code )<a href=#17-usercontroller-login---logout--code-- class=header-anchor arialabel=Anchor> #</a></h3><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@Slf4j</span>
<span style=color:#a2f>@RestController</span>
<span style=color:#a2f>@RequestMapping</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;/user&#34;</span><span style=color:#666>)</span>
<span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>UserController</span> <span style=color:#666>{</span>

    <span style=color:#a2f>@Resource</span>
    <span style=color:green;font-weight:700>private</span> IUserService userService<span style=color:#666>;</span>

    <span style=color:#a2f>@Resource</span>
    <span style=color:green;font-weight:700>private</span> IUserInfoService userInfoService<span style=color:#666>;</span>

    <span style=color:#408080;font-style:italic>/**
</span><span style=color:#408080;font-style:italic>     * 发送手机验证码
</span><span style=color:#408080;font-style:italic>     */</span>
    <span style=color:#a2f>@PostMapping</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;code&#34;</span><span style=color:#666>)</span>
    <span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>sendCode</span><span style=color:#666>(</span><span style=color:#a2f>@RequestParam</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;phone&#34;</span><span style=color:#666>)</span> String phone<span style=color:#666>,</span> HttpSession session<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 发送短信验证码并保存验证码
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>return</span> userService<span style=color:#666>.</span><span style=color:#7d9029>sendCode</span><span style=color:#666>(</span>phone<span style=color:#666>,</span> session<span style=color:#666>);</span>
    <span style=color:#666>}</span>

    <span style=color:#408080;font-style:italic>/**
</span><span style=color:#408080;font-style:italic>     * 登录功能
</span><span style=color:#408080;font-style:italic>     * @param loginForm 登录参数，包含手机号、验证码；或者手机号、密码
</span><span style=color:#408080;font-style:italic>     */</span>
    <span style=color:#a2f>@PostMapping</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;/login&#34;</span><span style=color:#666>)</span>
    <span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>login</span><span style=color:#666>(</span><span style=color:#a2f>@RequestBody</span> LoginFormDTO loginForm<span style=color:#666>,</span> HttpSession session<span style=color:#666>){</span>
        <span style=color:#408080;font-style:italic>// 实现登录功能
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>return</span> userService<span style=color:#666>.</span><span style=color:#7d9029>login</span><span style=color:#666>(</span>loginForm<span style=color:#666>,</span> session<span style=color:#666>);</span>
    <span style=color:#666>}</span>

    <span style=color:#408080;font-style:italic>/**
</span><span style=color:#408080;font-style:italic>     * 登出功能
</span><span style=color:#408080;font-style:italic>     * @return 无
</span><span style=color:#408080;font-style:italic>     */</span>
    <span style=color:#a2f>@PostMapping</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;/logout&#34;</span><span style=color:#666>)</span>
    <span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>logout</span><span style=color:#666>(){</span>
        UserHolder<span style=color:#666>.</span><span style=color:#7d9029>removeUser</span><span style=color:#666>();</span>
        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;退出登录&#34;</span><span style=color:#666>);</span>
    <span style=color:#666>}</span>
<span style=color:#666>}</span>    
</code></pre></div><h3 id=18-userserviceimpl>1.8 UserServiceImpl<a href=#18-userserviceimpl class=header-anchor arialabel=Anchor> #</a></h3><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@Slf4j</span>
<span style=color:#a2f>@Service</span>
<span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>UserServiceImpl</span> <span style=color:green;font-weight:700>extends</span> ServiceImpl<span style=color:#666>&lt;</span>UserMapper<span style=color:#666>,</span> User<span style=color:#666>&gt;</span> <span style=color:green;font-weight:700>implements</span> IUserService <span style=color:#666>{</span>

    <span style=color:#a2f>@Resource</span>
    <span style=color:green;font-weight:700>private</span> StringRedisTemplate stringRedisTemplate<span style=color:#666>;</span>

    <span style=color:#a2f>@Override</span>
    <span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>sendCode</span><span style=color:#666>(</span>String phone<span style=color:#666>,</span> HttpSession session<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 1.校验手机号
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>RegexUtils<span style=color:#666>.</span><span style=color:#7d9029>isPhoneInvalid</span><span style=color:#666>(</span>phone<span style=color:#666>))</span> <span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>// 2.如果不符合，返回错误信息
</span><span style=color:#408080;font-style:italic></span>            <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;手机号格式错误！&#34;</span><span style=color:#666>);</span>
        <span style=color:#666>}</span>
        <span style=color:#408080;font-style:italic>// 3.符合，生成验证码
</span><span style=color:#408080;font-style:italic></span>        String code <span style=color:#666>=</span> RandomUtil<span style=color:#666>.</span><span style=color:#7d9029>randomNumbers</span><span style=color:#666>(</span>6<span style=color:#666>);</span>

        <span style=color:#408080;font-style:italic>// 4.保存验证码到 session
</span><span style=color:#408080;font-style:italic></span>        stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>().</span><span style=color:#7d9029>set</span><span style=color:#666>(</span>LOGIN_CODE_KEY <span style=color:#666>+</span> phone<span style=color:#666>,</span> code<span style=color:#666>,</span> LOGIN_CODE_TTL<span style=color:#666>,</span> TimeUnit<span style=color:#666>.</span><span style=color:#7d9029>MINUTES</span><span style=color:#666>);</span>

        <span style=color:#408080;font-style:italic>// 5.发送验证码
</span><span style=color:#408080;font-style:italic></span>        log<span style=color:#666>.</span><span style=color:#7d9029>debug</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;发送短信验证码成功，验证码：{}&#34;</span><span style=color:#666>,</span> code<span style=color:#666>);</span>
        <span style=color:#408080;font-style:italic>// 返回ok
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>();</span>
    <span style=color:#666>}</span>

    <span style=color:#a2f>@Override</span>
    <span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>login</span><span style=color:#666>(</span>LoginFormDTO loginForm<span style=color:#666>,</span> HttpSession session<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 1.校验手机号
</span><span style=color:#408080;font-style:italic></span>        String phone <span style=color:#666>=</span> loginForm<span style=color:#666>.</span><span style=color:#7d9029>getPhone</span><span style=color:#666>();</span>
        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>RegexUtils<span style=color:#666>.</span><span style=color:#7d9029>isPhoneInvalid</span><span style=color:#666>(</span>phone<span style=color:#666>))</span> <span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>// 2.如果不符合，返回错误信息
</span><span style=color:#408080;font-style:italic></span>            <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;手机号格式错误！&#34;</span><span style=color:#666>);</span>
        <span style=color:#666>}</span>
        <span style=color:#408080;font-style:italic>// 3.从redis获取验证码并校验
</span><span style=color:#408080;font-style:italic></span>        String cacheCode <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>().</span><span style=color:#7d9029>get</span><span style=color:#666>(</span>LOGIN_CODE_KEY <span style=color:#666>+</span> phone<span style=color:#666>);</span>
        String code <span style=color:#666>=</span> loginForm<span style=color:#666>.</span><span style=color:#7d9029>getCode</span><span style=color:#666>();</span>
        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>cacheCode <span style=color:#666>==</span> <span style=color:green;font-weight:700>null</span> <span style=color:#666>||</span> <span style=color:#666>!</span>cacheCode<span style=color:#666>.</span><span style=color:#7d9029>equals</span><span style=color:#666>(</span>code<span style=color:#666>))</span> <span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>// 不一致，报错
</span><span style=color:#408080;font-style:italic></span>            <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;验证码错误&#34;</span><span style=color:#666>);</span>
        <span style=color:#666>}</span>

        <span style=color:#408080;font-style:italic>// 4.一致，根据手机号查询用户 select * from tb_user where phone = ?
</span><span style=color:#408080;font-style:italic></span>        User user <span style=color:#666>=</span> query<span style=color:#666>().</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;phone&#34;</span><span style=color:#666>,</span> phone<span style=color:#666>).</span><span style=color:#7d9029>one</span><span style=color:#666>();</span>

        <span style=color:#408080;font-style:italic>// 5.判断用户是否存在
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>user <span style=color:#666>==</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>// 6.不存在，创建新用户并保存
</span><span style=color:#408080;font-style:italic></span>            user <span style=color:#666>=</span> createUserWithPhone<span style=color:#666>(</span>phone<span style=color:#666>);</span>
        <span style=color:#666>}</span>

        <span style=color:#408080;font-style:italic>// 7.保存用户信息到 redis中
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#408080;font-style:italic>// 7.1.随机生成token，作为登录令牌
</span><span style=color:#408080;font-style:italic></span>        String token <span style=color:#666>=</span> UUID<span style=color:#666>.</span><span style=color:#7d9029>randomUUID</span><span style=color:#666>().</span><span style=color:#7d9029>toString</span><span style=color:#666>(</span><span style=color:green;font-weight:700>true</span><span style=color:#666>);</span>
        <span style=color:#408080;font-style:italic>// 7.2.将User对象转为HashMap存储
</span><span style=color:#408080;font-style:italic></span>        UserDTO userDTO <span style=color:#666>=</span> BeanUtil<span style=color:#666>.</span><span style=color:#7d9029>copyProperties</span><span style=color:#666>(</span>user<span style=color:#666>,</span> UserDTO<span style=color:#666>.</span><span style=color:#7d9029>class</span><span style=color:#666>);</span>
        Map<span style=color:#666>&lt;</span>String<span style=color:#666>,</span> Object<span style=color:#666>&gt;</span> userMap <span style=color:#666>=</span> BeanUtil<span style=color:#666>.</span><span style=color:#7d9029>beanToMap</span><span style=color:#666>(</span>userDTO<span style=color:#666>,</span> <span style=color:green;font-weight:700>new</span> HashMap<span style=color:#666>&lt;&gt;(),</span>
                CopyOptions<span style=color:#666>.</span><span style=color:#7d9029>create</span><span style=color:#666>()</span>
                        <span style=color:#666>.</span><span style=color:#7d9029>setIgnoreNullValue</span><span style=color:#666>(</span><span style=color:green;font-weight:700>true</span><span style=color:#666>)</span>
                        <span style=color:#666>.</span><span style=color:#7d9029>setFieldValueEditor</span><span style=color:#666>((</span>fieldName<span style=color:#666>,</span> fieldValue<span style=color:#666>)</span> <span style=color:#666>-&gt;</span> fieldValue<span style=color:#666>.</span><span style=color:#7d9029>toString</span><span style=color:#666>()));</span>
        <span style=color:#408080;font-style:italic>// 7.3.存储
</span><span style=color:#408080;font-style:italic></span>        String tokenKey <span style=color:#666>=</span> LOGIN_USER_KEY <span style=color:#666>+</span> token<span style=color:#666>;</span>
        stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForHash</span><span style=color:#666>().</span><span style=color:#7d9029>putAll</span><span style=color:#666>(</span>tokenKey<span style=color:#666>,</span> userMap<span style=color:#666>);</span>
        <span style=color:#408080;font-style:italic>// 7.4.设置token有效期
</span><span style=color:#408080;font-style:italic></span>        stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>expire</span><span style=color:#666>(</span>tokenKey<span style=color:#666>,</span> LOGIN_USER_TTL<span style=color:#666>,</span> TimeUnit<span style=color:#666>.</span><span style=color:#7d9029>MINUTES</span><span style=color:#666>);</span>

        <span style=color:#408080;font-style:italic>// 8.返回token
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>token<span style=color:#666>);</span>
    <span style=color:#666>}</span>


    <span style=color:green;font-weight:700>private</span> User <span style=color:#00f>createUserWithPhone</span><span style=color:#666>(</span>String phone<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 1.创建用户
</span><span style=color:#408080;font-style:italic></span>        User user <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> User<span style=color:#666>();</span>
        user<span style=color:#666>.</span><span style=color:#7d9029>setPhone</span><span style=color:#666>(</span>phone<span style=color:#666>);</span>
        user<span style=color:#666>.</span><span style=color:#7d9029>setNickName</span><span style=color:#666>(</span>USER_NICK_NAME_PREFIX <span style=color:#666>+</span> RandomUtil<span style=color:#666>.</span><span style=color:#7d9029>randomString</span><span style=color:#666>(</span>10<span style=color:#666>));</span>
        <span style=color:#408080;font-style:italic>// 2.保存用户
</span><span style=color:#408080;font-style:italic></span>        save<span style=color:#666>(</span>user<span style=color:#666>);</span>
        <span style=color:green;font-weight:700>return</span> user<span style=color:#666>;</span>
    <span style=color:#666>}</span>
<span style=color:#666>}</span>


</code></pre></div><p><strong>温馨小贴士：关于threadlocal</strong></p><p>如果小伙伴们看过threadLocal的源码，你会发现在threadLocal中，无论是他的put方法和他的get方法， 都是先从获得当前用户的线程，然后从线程中取出线程的成员变量map，只要线程不一样，map就不一样，所以可以通过这种方式来做到线程隔离</p><h3 id=补充threadlocal相关知识22>补充ThreadLocal相关知识22<a href=#补充threadlocal相关知识22 class=header-anchor arialabel=Anchor> #</a></h3><p><img src=https://img-blog.csdnimg.cn/3268bc89d5904ada9f6b35b7c18217e5.png alt=在这里插入图片描述></p><h4 id=athreadlocal的数据结构>a.ThreadLocal的数据结构<a href=#athreadlocal的数据结构 class=header-anchor arialabel=Anchor> #</a></h4><ul><li>Thread类有一个类型为ThreadLocal.ThreadLocalMap的实例变量threadLocals，也就是说每个线程有一个自己的ThreadLocalMap。</li><li>ThreadLocalMap有自己的独立实现，可以简单地将它的key视作ThreadLocal，value为代码中放入的值（实际上key并不是ThreadLocal本身，而是它的一个弱引用）。</li><li>每个线程在往ThreadLocal里放值的时候，都会往自己的ThreadLocalMap里存，读也是以ThreadLocal作为引用，在自己的map里找对应的key，从而实现了线程隔离。</li><li>ThreadLocalMap有点类似HashMap的结构，只是HashMap是由数组+链表实现的，而ThreadLocalMap中并没有链表结构。</li><li>我们还要注意Entry， 它的key是ThreadLocal&lt;?> k ，继承自WeakReference， 也就是我们常说的弱引用类型。</li></ul><h4 id=b内存泄露问题>b.内存泄露问题<a href=#b内存泄露问题 class=header-anchor arialabel=Anchor> #</a></h4><ul><li>由于ThreadLocal的key是弱引用，故在gc时，key会被回收掉，但是value是强引用没有被回收，所以在我们拦截器的方法里必须手动remove()。
原文链接：https://blog.csdn.net/qq_45733304/article/details/126443684</li></ul><h2 id=2商户查询缓存>2、商户查询缓存<a href=#2商户查询缓存 class=header-anchor arialabel=Anchor> #</a></h2><h3 id=21-认识缓存>2.1 认识缓存<a href=#21-认识缓存 class=header-anchor arialabel=Anchor> #</a></h3><p><strong>缓存(<strong>Cache),就是数据交换的</strong>缓冲区</strong>,俗称的缓存就是<strong>缓冲区内的数据</strong>,一般从数据库中获取,存储于本地代码(例如:</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a0a000>例1:</span>Static <span style=color:green;font-weight:700>final</span> ConcurrentHashMap<span style=color:#666>&lt;</span>K<span style=color:#666>,</span>V<span style=color:#666>&gt;</span> map <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> ConcurrentHashMap<span style=color:#666>&lt;&gt;();</span> 本地用于高并发
<span style=color:#a0a000>
</span><span style=color:#a0a000>例2:</span><span style=color:green;font-weight:700>static</span> <span style=color:green;font-weight:700>final</span> Cache<span style=color:#666>&lt;</span>K<span style=color:#666>,</span>V<span style=color:#666>&gt;</span> USER_CACHE <span style=color:#666>=</span> CacheBuilder<span style=color:#666>.</span><span style=color:#7d9029>newBuilder</span><span style=color:#666>().</span><span style=color:#7d9029>build</span><span style=color:#666>();</span> 用于redis等缓存
<span style=color:#a0a000>
</span><span style=color:#a0a000>例3:</span>Static <span style=color:green;font-weight:700>final</span> Map<span style=color:#666>&lt;</span>K<span style=color:#666>,</span>V<span style=color:#666>&gt;</span> map <span style=color:#666>=</span>  <span style=color:green;font-weight:700>new</span> HashMap<span style=color:#666>();</span> 本地缓存
</code></pre></div><p>由于其被<strong>Static</strong>修饰,所以随着类的加载而被加载到<strong>内存之中</strong>,作为本地缓存,由于其又被<strong>final</strong>修饰,所以其引用(例3:map)和对象(例3:new HashMap())之间的关系是固定的,不能改变,因此不用担心赋值(=)导致缓存失效;</p><blockquote><p>缓存数据存储于代码中,而代码运行在内存中,内存的读写性能远高于磁盘,缓存可以大大降低<strong>用户访问并发量带来的</strong>服务器读写压力</p></blockquote><h4 id=211-如何使用缓存>2.1.1 如何使用缓存<a href=#211-如何使用缓存 class=header-anchor arialabel=Anchor> #</a></h4><p>实际开发中,会构筑多级缓存来使系统运行速度进一步提升,例如:本地缓存与redis中的缓存并发使用</p><p><strong>浏览器缓存</strong>：主要是存在于浏览器端的缓存</p><p>**应用层缓存：**可以分为tomcat本地缓存，比如之前提到的map，或者是使用redis作为缓存</p><p>**数据库缓存：**在数据库中有一片空间是 buffer pool，增改查数据都会先加载到mysql的缓存中</p><p>**CPU缓存：**当代计算机最大的问题是 cpu性能提升了，但内存读写速度没有跟上，所以为了适应当下的情况，增加了cpu的L1，L2，L3级的缓存</p><p>磁盘缓存：</p><h3 id=22-添加商户缓存>2.2 添加商户缓存<a href=#22-添加商户缓存 class=header-anchor arialabel=Anchor> #</a></h3><h4 id=221-缓存模型和思路>2.2.1 、缓存模型和思路<a href=#221-缓存模型和思路 class=header-anchor arialabel=Anchor> #</a></h4><p>标准的操作方式就是查询数据库之前先查询缓存，如果缓存数据存在，则直接从缓存中返回，如果缓存数据不存在，再查询数据库，然后将数据存入redis。</p><p><img src=https://img-blog.csdnimg.cn/26f83cadced24841a7660107d190fbd3.png#pic_center alt=在这里插入图片描述></p><h4 id=212代码如下>2.1.2、代码如下<a href=#212代码如下 class=header-anchor arialabel=Anchor> #</a></h4><p>代码思路：如果缓存有，则直接返回，如果缓存不存在，则查询数据库，然后存入redis。</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#a2f>@Override</span>
    <span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>queryById</span><span style=color:#666>(</span>Long id<span style=color:#666>)</span> <span style=color:#666>{</span>
        String key <span style=color:#666>=</span>CACHE_SHOP_KEY <span style=color:#666>+</span> id<span style=color:#666>;</span>
        <span style=color:#408080;font-style:italic>//1.从redis查询商铺缓存
</span><span style=color:#408080;font-style:italic></span>        String shopJson <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>().</span><span style=color:#7d9029>get</span><span style=color:#666>(</span>key<span style=color:#666>);</span>
        <span style=color:#408080;font-style:italic>//2.判断是否存在
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>StrUtil<span style=color:#666>.</span><span style=color:#7d9029>isNotBlank</span><span style=color:#666>(</span>shopJson<span style=color:#666>)){</span>
            <span style=color:#408080;font-style:italic>//3.存在直接返回
</span><span style=color:#408080;font-style:italic></span>            Shop shop <span style=color:#666>=</span> JSONUtil<span style=color:#666>.</span><span style=color:#7d9029>toBean</span><span style=color:#666>(</span>shopJson<span style=color:#666>,</span> Shop<span style=color:#666>.</span><span style=color:#7d9029>class</span><span style=color:#666>);</span>
            <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>shop<span style=color:#666>);</span>
        <span style=color:#666>}</span>
        <span style=color:#408080;font-style:italic>//4.不存在返，根据id查询数据库
</span><span style=color:#408080;font-style:italic></span>        Shop shop <span style=color:#666>=</span> getById<span style=color:#666>(</span>id<span style=color:#666>);</span>
        <span style=color:#408080;font-style:italic>//5.不存在返回错误
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>shop<span style=color:#666>==</span><span style=color:green;font-weight:700>null</span><span style=color:#666>){</span>
            <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;店铺不存在&#34;</span><span style=color:#666>);</span>
        <span style=color:#666>}</span>
        <span style=color:#408080;font-style:italic>//6.存在写入rdis
</span><span style=color:#408080;font-style:italic></span>        stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>().</span><span style=color:#7d9029>set</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;cache:shop:&#34;</span> <span style=color:#666>+</span> id<span style=color:#666>,</span>JSONUtil<span style=color:#666>.</span><span style=color:#7d9029>toJsonStr</span><span style=color:#666>(</span>shop<span style=color:#666>));</span>
        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>shop<span style=color:#666>);</span>
    <span style=color:#666>}</span>        
</code></pre></div><p>//缓存练习，写shop-type/list的缓存</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>
<span style=color:#a2f>@Service</span>
<span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>ShopTypeServiceImpl</span> <span style=color:green;font-weight:700>extends</span> ServiceImpl
        <span style=color:#666>&lt;</span>ShopTypeMapper<span style=color:#666>,</span> ShopType<span style=color:#666>&gt;</span> <span style=color:green;font-weight:700>implements</span> IShopTypeService <span style=color:#666>{</span>
    <span style=color:#a2f>@Resource</span>
    <span style=color:green;font-weight:700>private</span> StringRedisTemplate stringRedisTemplate<span style=color:#666>;</span>
    <span style=color:green;font-weight:700>public</span> Result  <span style=color:#00f>queryshopTypeList</span><span style=color:#666>(){</span>
        <span style=color:#408080;font-style:italic>//展示所有的店铺信息
</span><span style=color:#408080;font-style:italic></span>        String key <span style=color:#666>=</span>CACHE_SHOPTYPE_KEY <span style=color:#666>;</span>
        <span style=color:#408080;font-style:italic>//1.从redis查询商铺缓存
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#408080;font-style:italic>// String shopJson = stringRedisTemplate.opsForValue().get(key);
</span><span style=color:#408080;font-style:italic></span>        List<span style=color:#666>&lt;</span>String<span style=color:#666>&gt;</span> strshopTypeList <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForList</span><span style=color:#666>().</span><span style=color:#7d9029>range</span><span style=color:#666>(</span>key<span style=color:#666>,</span> 0<span style=color:#666>,</span> <span style=color:#666>-</span>1<span style=color:#666>);</span>
        ArrayList<span style=color:#666>&lt;</span>ShopType<span style=color:#666>&gt;</span> shopTypes <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> ArrayList<span style=color:#666>&lt;&gt;();</span>
        <span style=color:#408080;font-style:italic>//2.判断是否存在
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(!</span>strshopTypeList<span style=color:#666>.</span><span style=color:#7d9029>isEmpty</span><span style=color:#666>()){</span>
            <span style=color:#408080;font-style:italic>//3.存在直接返回
</span><span style=color:#408080;font-style:italic></span>
            <span style=color:green;font-weight:700>for</span> <span style=color:#666>(</span>String s<span style=color:#666>:</span>strshopTypeList<span style=color:#666>)</span> <span style=color:#666>{</span>
                ShopType shopType <span style=color:#666>=</span> JSONUtil<span style=color:#666>.</span><span style=color:#7d9029>toBean</span><span style=color:#666>(</span>s<span style=color:#666>,</span> ShopType<span style=color:#666>.</span><span style=color:#7d9029>class</span><span style=color:#666>);</span>
                shopTypes<span style=color:#666>.</span><span style=color:#7d9029>add</span><span style=color:#666>(</span>shopType<span style=color:#666>);</span>
            <span style=color:#666>}</span>
            <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>shopTypes<span style=color:#666>);</span>
        <span style=color:#666>}</span>

        <span style=color:#408080;font-style:italic>//4.不存在,查询数据库
</span><span style=color:#408080;font-style:italic></span>        List<span style=color:#666>&lt;</span>ShopType<span style=color:#666>&gt;</span> typeList <span style=color:#666>=</span> query<span style=color:#666>().</span><span style=color:#7d9029>orderByAsc</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;sort&#34;</span><span style=color:#666>).</span><span style=color:#7d9029>list</span><span style=color:#666>();</span>
        <span style=color:#408080;font-style:italic>//5.不存在直接返回错误
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span><span style=color:#666>(</span>typeList<span style=color:#666>.</span><span style=color:#7d9029>isEmpty</span><span style=color:#666>()){</span>
            <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;不存在分类&#34;</span><span style=color:#666>);</span>
        <span style=color:#666>}</span>
        <span style=color:#408080;font-style:italic>//6.存在写入rdis
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>for</span> <span style=color:#666>(</span>ShopType s<span style=color:#666>:</span>typeList<span style=color:#666>)</span> <span style=color:#666>{</span>
            String shopjson <span style=color:#666>=</span> JSONUtil<span style=color:#666>.</span><span style=color:#7d9029>toJsonStr</span><span style=color:#666>(</span>s<span style=color:#666>);</span>
            strshopTypeList<span style=color:#666>.</span><span style=color:#7d9029>add</span><span style=color:#666>(</span>shopjson<span style=color:#666>);</span>
        <span style=color:#666>}</span>
        stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForList</span><span style=color:#666>().</span><span style=color:#7d9029>rightPushAll</span><span style=color:#666>(</span>key<span style=color:#666>,</span>strshopTypeList<span style=color:#666>);</span>

        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>typeList<span style=color:#666>);</span>
    <span style=color:#666>}</span>


<span style=color:#666>}</span>
</code></pre></div><h3 id=23-缓存更新策略>2.3 缓存更新策略<a href=#23-缓存更新策略 class=header-anchor arialabel=Anchor> #</a></h3><p>缓存更新是redis为了节约内存而设计出来的一个东西，主要是因为内存数据宝贵，当我们向redis插入太多数据，此时就可能会导致缓存中的数据过多，所以redis会对部分数据进行更新，或者把他叫为淘汰更合适。</p><p>**内存淘汰：**redis自动进行，当redis内存达到咱们设定的max-memery的时候，会自动触发淘汰机制，淘汰掉一些不重要的数据(可以自己设置策略方式)</p><p>**超时剔除：**当我们给redis设置了过期时间ttl之后，redis会将超时的数据进行删除，方便咱们继续使用缓存</p><p>**主动更新：**我们可以手动调用方法把缓存删掉，通常用于解决缓存和数据库不一致问题</p><table><thead><tr><th></th><th>内存淘汰</th><th>超时剔除</th><th>主动更新</th></tr></thead><tbody><tr><td>说明</td><td>不用自己维护。利用 Redis 的内存淘汰机制： 当内存不足时自动淘汰部分数据。</td><td>下次查询时更新缓存。 给缓存数据添加 TTL 时间，到期后自动删除缓存。</td><td>编写业务逻辑，在修改数据库的同时，更新缓存。</td></tr></tbody></table><p><img src=https://img-blog.csdnimg.cn/c731ea380a2f4766a3e8775d7dc8af51.png alt=在这里插入图片描述></p><h4 id=231-数据库缓存不一致解决方案>2.3.1 、数据库缓存不一致解决方案：<a href=#231-数据库缓存不一致解决方案 class=header-anchor arialabel=Anchor> #</a></h4><p>由于我们的<strong>缓存的数据源来自于数据库</strong>,而数据库的<strong>数据是会发生变化的</strong>,因此,如果当数据库中<strong>数据发生变化,而缓存却没有同步</strong>,此时就会有<strong>一致性问题存在</strong>,其后果是:</p><p>用户使用缓存中的过时数据,就会产生类似多线程数据安全问题,从而影响业务,产品口碑等;怎么解决呢？有如下几种方案</p><blockquote><p>Cache Aside Pattern 人工编码方式：缓存调用者在更新完数据库后再去更新缓存，也称之为双写方</p><p>Read/Write Through Pattern : 由系统本身完成，数据库与缓存的问题交由系统本身去处理</p><p>Write Behind Caching Pattern ：调用者只操作缓存，其他线程去异步处理数据库，实现最终一致</p></blockquote><p><img src=https://img-blog.csdnimg.cn/b4a6334951ed48c8823fa94ca634f2a9.png alt=在这里插入图片描述></p><h4 id=232-数据库和缓存不一致采用什么方案>2.3.2 、数据库和缓存不一致采用什么方案<a href=#232-数据库和缓存不一致采用什么方案 class=header-anchor arialabel=Anchor> #</a></h4><p>综合考虑使用方案一，但是方案一调用者如何处理呢？</p><p>操作缓存和数据库时有三个问题需要考虑：</p><p>如果采用第一个方案，那么假设我们每次操作数据库后，都操作缓存，但是中间如果没有人查询，那么这个更新动作实际上只有最后一次生效，中间的更新动作意义并不大，我们可以把缓存删除，等待再次查询时，将缓存中的数据加载出来</p><ul><li><p>删除缓存还是更新缓存？</p><ul><li>更新缓存：每次更新数据库都更新缓存，无效写操作较多</li><li>删除缓存：更新数据库时让缓存失效，查询时再更新缓存</li></ul></li><li><p>如何保证缓存与数据库的操作的同时成功或失败？</p><ul><li>单体系统，将缓存与数据库操作放在一个事务</li><li>分布式系统，利用TCC等分布式事务方案</li></ul></li></ul><p>应该具体操作缓存还是操作数据库，我们应当是先操作数据库，再删除缓存，原因在于，如果你选择第一种方案，在两个线程并发来访问时，假设线程1先来，他先把缓存删了，此时线程2过来，他查询缓存数据并不存在，此时他写入缓存，当他写入缓存后，线程1再执行更新动作时，实际上写入的就是旧的数据，新的数据被旧数据覆盖了。</p><blockquote><ul><li>第一种方案：先删除缓存，再输出数据库</li></ul><blockquote><p>异常情况介绍：在线程 1 删除缓存后，完成对数据库的更新（目标是更新为 v = 20）前。线程 2 恰好此时也查询了缓存，但是这时的缓存已经被线程 1 删除了，所以线程 1 它又直接去查询了数据库，并将数据库中的数据（v = 10）写入了缓存。在线程 2 进行完了上述的操作后，线程 1 才终于完成了对数据库中的数据的更新（v = 20）。此时，缓存中的数据为 v = 10，数据库中的数据为 v = 20，此时数据库和缓存中的数据不一致。</p></blockquote><p><img src=https://img-blog.csdnimg.cn/5e793929fb4a4a0a8aa6d2e5f3c6bc41.png#pic_center alt=在这里插入图片描述></p><ul><li>第二种方案：先操作数据库，再删除缓存</li></ul><blockquote><p>异常情况介绍：由于某种原因（不如过期时间到了），缓存此时恰好失效了，线程 1 查询不到缓存，线程 1 它需要再去数据库中查询数据后再写入缓存。但是就在线程 1 完成写入缓存的操作前，恰好此时线程 2 来更新数据库的数据（更新 v = 20），之后线程 2 又删除了缓存（此时缓存是空的，所以这里相当于删除了个寂寞）。在线程 2 完成这些操作后，线程 1 才终于将数据库中的旧数据写入了缓存（v = 10）。此时数据库中的数据（v = 20）和缓存中的数据（v = 10）不一致。</p></blockquote><p><img src=https://img-blog.csdnimg.cn/b2adbd376d6e4f53b4248fcbedf5b2b4.png#pic_center alt=在这里插入图片描述></p><p>可以看出两种方法都有各自的问题，但是由于写的时间要远大于读的时间，所以先操作db再删除cache的出现问题的几率非常小。</p></blockquote><ul><li>先操作缓存还是先操作数据库？<ul><li>先删除缓存，再操作数据库</li><li>先操作数据库，再删除缓存</li></ul></li></ul><p><img src=.%5CRedis%E5%AE%9E%E6%88%98%E7%AF%87.assets%5C1653323595206.png alt=1653323595206></p><h3 id=24-实现商铺和缓存与数据库双写一致>2.4 实现商铺和缓存与数据库双写一致<a href=#24-实现商铺和缓存与数据库双写一致 class=header-anchor arialabel=Anchor> #</a></h3><p>核心思路如下：</p><p>修改ShopController中的业务逻辑，满足下面的需求：</p><p>根据id查询店铺时，如果缓存未命中，则查询数据库，将数据库结果写入缓存，并设置超时时间</p><p>根据id修改店铺时，先修改数据库，再删除缓存</p><p><strong>修改重点代码1</strong>：修改<strong>ShopServiceImpl</strong>的queryById方法</p><p><strong>设置redis缓存时添加过期时间</strong></p><p><strong>修改重点代码2</strong></p><p>代码分析：通过之前的淘汰，我们确定了采用删除策略，来解决双写问题，当我们修改了数据之后，然后把缓存中的数据进行删除，查询时发现缓存中没有数据，则会从mysql中加载最新的数据，从而避免数据库和缓存不一致的问题</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#a2f>@Override</span>
    <span style=color:#a2f>@Transactional</span>
    <span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>update</span><span style=color:#666>(</span>Shop shop<span style=color:#666>)</span> <span style=color:#666>{</span>
        Long id <span style=color:#666>=</span> shop<span style=color:#666>.</span><span style=color:#7d9029>getId</span><span style=color:#666>();</span>
        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>id <span style=color:#666>==</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
            <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;店铺id不能为空&#34;</span><span style=color:#666>);</span>
        <span style=color:#666>}</span>
        <span style=color:#408080;font-style:italic>// 1.更新数据库
</span><span style=color:#408080;font-style:italic></span>        updateById<span style=color:#666>(</span>shop<span style=color:#666>);</span>
        <span style=color:#408080;font-style:italic>// 2.删除缓存
</span><span style=color:#408080;font-style:italic></span>        stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>delete</span><span style=color:#666>(</span>CACHE_SHOP_KEY <span style=color:#666>+</span> id<span style=color:#666>);</span>
        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>();</span>
    <span style=color:#666>}</span>

</code></pre></div><h3 id=小结-缓存更新策略>小结 缓存更新策略<a href=#小结-缓存更新策略 class=header-anchor arialabel=Anchor> #</a></h3><blockquote><p>缓存更新策略的最佳实践方案：</p></blockquote><p><img src=https://img-blog.csdnimg.cn/ae9ec55850d6416a821af35e6dc2981c.png#pic_center alt=在这里插入图片描述></p><blockquote><p>低一致性需求：使用 Redis 自带的内存淘汰机制
高一致性需求：主动更新，并以超时剔除作为兜底方案
读操作：
缓存命中则直接返回
缓存未命中则查询数据库，并写入缓存，设定超时时间
写操作：
先写数据库，然后再删除缓存
要确保数据库与缓存操作的原子性</p></blockquote><h3 id=25-缓存穿透问题的解决思路>2.5 缓存穿透问题的解决思路<a href=#25-缓存穿透问题的解决思路 class=header-anchor arialabel=Anchor> #</a></h3><blockquote><p>缓存穿透 ：缓存穿透是指客户端请求的数据在缓存中和数据库中都不存在，这样缓存永远不会生效，这些请求都会打到数据库。</p></blockquote><p>常见的解决方案有两种：</p><ul><li><p>缓存空对象</p><ul><li><p>优点：实现简单，维护方便</p></li><li><p>缺点：</p><ul><li>额外的内存消耗</li><li>可能造成短期的不一致</li></ul><p>适合命中不高，但可能被频繁更新的数据</p></li></ul></li><li><p>布隆过滤</p><ul><li><p>优点：内存占用较少，没有多余key</p></li><li><p>缺点：</p><ul><li>实现复杂</li><li>存在误判可能</li></ul><p>适合命中不高，但是更新不频繁的数据</p></li></ul></li></ul><p>**缓存空对象思路分析：**当我们客户端访问不存在的数据时，先请求redis，但是此时redis中没有数据，此时会访问到数据库，但是数据库中也没有数据，这个数据穿透了缓存，直击数据库，我们都知道数据库能够承载的并发不如redis这么高，如果大量的请求同时过来访问这种不存在的数据，这些请求就都会访问到数据库，简单的解决方案就是哪怕这个数据在数据库中也不存在，我们也把这个数据存入到redis中去，这样，下次用户过来访问这个不存在的数据，那么在redis中也能找到这个数据就不会进入到缓存了</p><p>**布隆过滤：**布隆过滤器其实采用的是哈希思想来解决这个问题，通过一个庞大的二进制数组，走哈希思想去判断当前这个要查询的这个数据是否存在，如果布隆过滤器判断存在，则放行，这个请求会去访问redis，哪怕此时redis中的数据过期了，但是数据库中一定存在这个数据，在数据库中查询出来这个数据后，再将其放入到redis中，</p><p>假设布隆过滤器判断这个数据不存在，则直接返回</p><p>这种方式优点在于节约内存空间，存在误判，误判原因在于：布隆过滤器走的是哈希思想，只要哈希思想，就可能存在哈希冲突（布隆过滤器算的哈希值，但不是百分百存在）</p><p><img src=https://img-blog.csdnimg.cn/55fa2728437b45f08826bc5f57ae5f87.png alt=在这里插入图片描述></p><h3 id=26-编码解决商品查询的缓存穿透问题>2.6 编码解决商品查询的缓存穿透问题：<a href=#26-编码解决商品查询的缓存穿透问题 class=header-anchor arialabel=Anchor> #</a></h3><p>核心思路如下：</p><p>在原来的逻辑中，我们如果发现这个数据在mysql中不存在，直接就返回404了，这样是会存在缓存穿透问题的</p><p>现在的逻辑中：如果这个数据不存在，我们不会返回404 ，还是会把这个数据写入到Redis中，并且将value设置为空，欧当再次发起查询时，我们如果发现命中之后，判断这个value是否是null，如果是null，则是之前写入的数据，证明是缓存穿透数据，如果不是，则直接返回数据。</p><p><img src=https://img-blog.csdnimg.cn/64cfebdac05641178556a90decd0bf70.png alt=在这里插入图片描述></p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#408080;font-style:italic>//写的null缓存
</span><span style=color:#408080;font-style:italic></span>
 <span style=color:#a2f>@Override</span>
    <span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>queryById</span><span style=color:#666>(</span>Long id<span style=color:#666>)</span> <span style=color:#666>{</span>
        String key <span style=color:#666>=</span>CACHE_SHOP_KEY <span style=color:#666>+</span> id<span style=color:#666>;</span>
        <span style=color:#408080;font-style:italic>//1.从redis查询商铺缓存
</span><span style=color:#408080;font-style:italic></span>        String shopJson <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>().</span><span style=color:#7d9029>get</span><span style=color:#666>(</span>key<span style=color:#666>);</span>
        <span style=color:#408080;font-style:italic>//2.判断是否存在
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>StrUtil<span style=color:#666>.</span><span style=color:#7d9029>isNotBlank</span><span style=color:#666>(</span>shopJson<span style=color:#666>)){</span>
			<span style=color:#408080;font-style:italic>//isnotBlank只有&#34;abc&#34;true,null &#34;&#34; \t\n都是false
</span><span style=color:#408080;font-style:italic></span>            <span style=color:#408080;font-style:italic>//3.存在直接返回
</span><span style=color:#408080;font-style:italic></span>            Shop shop <span style=color:#666>=</span> JSONUtil<span style=color:#666>.</span><span style=color:#7d9029>toBean</span><span style=color:#666>(</span>shopJson<span style=color:#666>,</span> Shop<span style=color:#666>.</span><span style=color:#7d9029>class</span><span style=color:#666>);</span>
            <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>shop<span style=color:#666>);</span>
        <span style=color:#666>}</span>
		<span style=color:#408080;font-style:italic>//2.3判断命中的是否是空值
</span><span style=color:#408080;font-style:italic></span>		<span style=color:green;font-weight:700>if</span><span style=color:#666>(</span>shopJson <span style=color:#666>==</span><span style=color:green;font-weight:700>null</span><span style=color:#666>){</span>
			<span style=color:#408080;font-style:italic>//返回一个错误信息
</span><span style=color:#408080;font-style:italic></span>		<span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;店铺不存在&#34;</span><span style=color:#666>);</span>
		<span style=color:#666>}</span>
        <span style=color:#408080;font-style:italic>//4.不存在返，根据id查询数据库
</span><span style=color:#408080;font-style:italic></span>        Shop shop <span style=color:#666>=</span> getById<span style=color:#666>(</span>id<span style=color:#666>);</span>
        <span style=color:#408080;font-style:italic>//5.不存在返回错误
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>shop<span style=color:#666>==</span><span style=color:green;font-weight:700>null</span><span style=color:#666>){</span>
			<span style=color:#408080;font-style:italic>//将空值写入redis
</span><span style=color:#408080;font-style:italic></span>			stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>().</span><span style=color:#7d9029>set</span><span style=color:#666>(</span>key<span style=color:#666>,</span><span style=color:#ba2121>&#34;&#34;</span><span style=color:#666>,</span>CACHE_NULL_TTL<span style=color:#666>,</span>TimeUnit<span style=color:#666>.</span><span style=color:#7d9029>MINUTES</span><span style=color:#666>);</span>
            <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;店铺不存在&#34;</span><span style=color:#666>);</span>
        <span style=color:#666>}</span>
        <span style=color:#408080;font-style:italic>//6.存在写入rdis
</span><span style=color:#408080;font-style:italic></span>        stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>().</span><span style=color:#7d9029>set</span><span style=color:#666>(</span>key<span style=color:#666>,</span>JSONUtil<span style=color:#666>.</span><span style=color:#7d9029>toJsonStr</span><span style=color:#666>(</span>shop<span style=color:#666>),</span>CACHE_SHOP_TTL<span style=color:#666>,</span>TimeUnit<span style=color:#666>.</span><span style=color:#7d9029>MINUTES</span><span style=color:#666>);</span>
        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>shop<span style=color:#666>);</span>
    <span style=color:#666>}</span>    
      
</code></pre></div><h3 id=小结-缓存穿透解决>小结 缓存穿透解决<a href=#小结-缓存穿透解决 class=header-anchor arialabel=Anchor> #</a></h3><p>缓存穿透产生的原因是什么？</p><ul><li>用户请求的数据在缓存中和数据库中都不存在，不断发起这样的请求，给数据库带来巨大压力</li></ul><p>缓存穿透的解决方案有哪些？</p><ul><li>缓存null值</li><li>布隆过滤</li><li>增强id的复杂度，避免被猜测id规律</li><li>做好数据的基础格式校验</li><li>加强用户权限校验</li><li>做好热点参数的限流</li></ul><h3 id=27-缓存雪崩问题及解决思路>2.7 缓存雪崩问题及解决思路<a href=#27-缓存雪崩问题及解决思路 class=header-anchor arialabel=Anchor> #</a></h3><p>缓存雪崩是指在同一时段大量的缓存key同时失效或者Redis服务宕机，导致大量请求到达数据库，带来巨大压力。</p><p>解决方案：</p><ul><li>给不同的Key的TTL添加随机值</li><li>利用Redis集群提高服务的可用性</li><li>给缓存业务添加降级限流策略</li><li>给业务添加多级缓存（比如nginx,redis,jvm,数据库）</li></ul><p><img src=https://img-blog.csdnimg.cn/3ab16e6cbafe455ea2da1daf0909d00c.png#pic_center alt=在这里插入图片描述></p><h3 id=28-缓存击穿问题及解决思路>2.8 缓存击穿问题及解决思路<a href=#28-缓存击穿问题及解决思路 class=header-anchor arialabel=Anchor> #</a></h3><p>缓存击穿问题也叫热点Key问题，就是一个被高并发访问并且缓存重建业务较复杂的key突然失效了，无数的请求访问会在瞬间给数据库带来巨大的冲击。</p><p>常见的解决方案有两种：</p><ul><li>互斥锁</li><li>逻辑过期</li></ul><p>逻辑分析：假设线程1在查询缓存之后，本来应该去查询数据库，然后把这个数据重新加载到缓存的，此时只要线程1走完这个逻辑，其他线程就都能从缓存中加载这些数据了，但是假设在线程1没有走完的时候，后续的线程2，线程3，线程4同时过来访问当前这个方法， 那么这些线程都不能从缓存中查询到数据，那么他们就会同一时刻来访问查询缓存，都没查到，接着同一时间去访问数据库，同时的去执行数据库代码，对数据库访问压力过大</p><p><img src=https://img-blog.csdnimg.cn/53942e19217f4942823f97326b130dfa.png#pic_center alt=在这里插入图片描述></p><ul><li>解决方案一、使用锁来解决：</li></ul><p>因为锁能实现互斥性。假设线程过来，只能一个人一个人的来访问数据库，从而避免对于数据库访问压力过大，但这也会影响查询的性能，因为此时会让查询的性能从并行变成了串行，我们可以采用tryLock方法 + double check来解决这样的问题。</p><p>假设现在线程1过来访问，他查询缓存没有命中，但是此时他获得到了锁的资源，那么线程1就会一个人去执行逻辑，假设现在线程2过来，线程2在执行过程中，并没有获得到锁，那么线程2就可以进行到休眠，直到线程1把锁释放后，线程2获得到锁，然后再来执行逻辑，此时就能够从缓存中拿到数据了。</p><p><img src=https://img-blog.csdnimg.cn/23de481ff2b84df5af98ecbc7132175d.png alt=在这里插入图片描述></p><p>解决方案二、逻辑过期方案</p><p>方案分析：我们之所以会出现这个缓存击穿问题，主要原因是在于我们对key设置了过期时间，假设我们不设置过期时间，其实就不会有缓存击穿的问题，但是不设置过期时间，这样数据不就一直占用我们内存了吗，我们可以采用逻辑过期方案。</p><p>我们把过期时间设置在 redis的value中，注意：这个过期时间并不会直接作用于redis，而是我们后续通过逻辑去处理。假设线程1去查询缓存，然后从value中判断出来当前的数据已经过期了，此时线程1去获得互斥锁，那么其他线程会进行阻塞，获得了锁的线程他会开启一个 线程去进行 以前的重构数据的逻辑，直到新开的线程完成这个逻辑后，才释放锁， 而线程1直接进行返回，假设现在线程3过来访问，由于线程线程2持有着锁，所以线程3无法获得锁，线程3也直接返回数据，只有等到新开的线程2把重建数据构建完后，其他线程才能走返回正确的数据。</p><p>这种方案巧妙在于，异步的构建缓存，缺点在于在构建完缓存之前，返回的都是脏数据。</p><p><img src=https://img-blog.csdnimg.cn/15f64e8ac949420d98a096d069fe9681.png alt=在这里插入图片描述></p><p>进行对比</p><p>**互斥锁方案：**由于保证了互斥性，所以数据一致，且实现简单，因为仅仅只需要加一把锁而已，也没其他的事情需要操心，所以没有额外的内存消耗，缺点在于有锁就有死锁问题的发生，且只能串行执行性能肯定受到影响</p><p><strong>逻辑过期方案：</strong> 线程读取过程中不需要等待，性能好，有一个额外的线程持有锁去进行重构数据，但是在重构数据完成前，其他的线程只能返回之前的数据，且实现起来麻烦</p><p><img src=https://img-blog.csdnimg.cn/ff74fcc5d82440b48e6f8b388537e7ac.png alt=在这里插入图片描述></p><h3 id=29-利用互斥锁解决缓存击穿问题>2.9 利用互斥锁解决缓存击穿问题<a href=#29-利用互斥锁解决缓存击穿问题 class=header-anchor arialabel=Anchor> #</a></h3><p>核心思路：相较于原来从缓存中查询不到数据后直接查询数据库而言，现在的方案是 进行查询之后，如果从缓存没有查询到数据，则进行互斥锁的获取，获取互斥锁后，判断是否获得到了锁，如果没有获得到，则休眠，过一会再进行尝试，直到获取到锁为止，才能进行查询</p><p>如果获取到了锁的线程，再去进行查询，查询后将数据写入redis，再释放锁，返回数据，利用互斥锁就能保证只有一个线程去执行操作数据库的逻辑，防止缓存击穿</p><blockquote><p><strong>基于</strong> <strong>互斥锁</strong> <strong>方式解决缓存击穿问题</strong></p></blockquote><ul><li><strong>需求</strong>：修改根据 id 查询商铺的业务，基于互斥锁方式来解决缓存击穿问题</li><li><strong>自定义互斥锁</strong>（Redis 中的 <code>setnx</code> 就可以办到这点）</li></ul><p><img src=https://img-blog.csdnimg.cn/d9649c9d3a1748bba2360de88a0a7ac9.png#pic_center alt=在这里插入图片描述></p><p><strong>操作锁的代码：</strong></p><p>核心思路就是利用redis的setnx方法来表示获取锁，该方法含义是redis中如果没有这个key，则插入成功，返回1，在stringRedisTemplate中返回true， 如果有这个key则插入失败，则返回0，在stringRedisTemplate返回false，我们可以通过true，或者是false，来表示是否有线程成功插入key，成功插入的key的线程我们认为他就是获得到锁的线程。</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:green;font-weight:700>private</span> <span style=color:#b00040>boolean</span> <span style=color:#00f>tryLock</span><span style=color:#666>(</span>String key<span style=color:#666>)</span> <span style=color:#666>{</span>
    Boolean flag <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>().</span><span style=color:#7d9029>setIfAbsent</span><span style=color:#666>(</span>key<span style=color:#666>,</span> <span style=color:#ba2121>&#34;1&#34;</span><span style=color:#666>,</span> 10<span style=color:#666>,</span> TimeUnit<span style=color:#666>.</span><span style=color:#7d9029>SECONDS</span><span style=color:#666>);</span>
    <span style=color:green;font-weight:700>return</span> BooleanUtil<span style=color:#666>.</span><span style=color:#7d9029>isTrue</span><span style=color:#666>(</span>flag<span style=color:#666>);</span><span style=color:#408080;font-style:italic>////这里最好不要直接返回flag，拆箱容易空指针
</span><span style=color:#408080;font-style:italic></span><span style=color:#666>}</span>

<span style=color:green;font-weight:700>private</span> <span style=color:#b00040>void</span> <span style=color:#00f>unlock</span><span style=color:#666>(</span>String key<span style=color:#666>)</span> <span style=color:#666>{</span>
    stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>delete</span><span style=color:#666>(</span>key<span style=color:#666>);</span>
<span style=color:#666>}</span>
</code></pre></div><p><strong>操作代码：</strong></p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:green;font-weight:700>public</span> Shop <span style=color:#00f>queryWithMutex</span><span style=color:#666>(</span>Long id<span style=color:#666>)</span>  <span style=color:#666>{</span>
        String key <span style=color:#666>=</span> CACHE_SHOP_KEY <span style=color:#666>+</span> id<span style=color:#666>;</span>
        <span style=color:#408080;font-style:italic>// 1、从redis中查询商铺缓存
</span><span style=color:#408080;font-style:italic></span>        String shopJson <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>().</span><span style=color:#7d9029>get</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;key&#34;</span><span style=color:#666>);</span>
        <span style=color:#408080;font-style:italic>// 2、判断是否存在
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>StrUtil<span style=color:#666>.</span><span style=color:#7d9029>isNotBlank</span><span style=color:#666>(</span>shopJson<span style=color:#666>))</span> <span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>// 存在,直接返回
</span><span style=color:#408080;font-style:italic></span>            <span style=color:green;font-weight:700>return</span> JSONUtil<span style=color:#666>.</span><span style=color:#7d9029>toBean</span><span style=color:#666>(</span>shopJson<span style=color:#666>,</span> Shop<span style=color:#666>.</span><span style=color:#7d9029>class</span><span style=color:#666>);</span>
        <span style=color:#666>}</span>
        <span style=color:#408080;font-style:italic>//判断命中的值是否是空值
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>shopJson <span style=color:#666>!=</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>//返回一个错误信息
</span><span style=color:#408080;font-style:italic></span>            <span style=color:green;font-weight:700>return</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>;</span>
        <span style=color:#666>}</span>
        <span style=color:#408080;font-style:italic>// 4.实现缓存重构
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#408080;font-style:italic>//4.1 获取互斥锁
</span><span style=color:#408080;font-style:italic></span>        String lockKey <span style=color:#666>=</span> <span style=color:#ba2121>&#34;lock:shop:&#34;</span> <span style=color:#666>+</span> id<span style=color:#666>;</span>
        Shop shop <span style=color:#666>=</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>;</span>
        <span style=color:green;font-weight:700>try</span> <span style=color:#666>{</span>
            <span style=color:#b00040>boolean</span> isLock <span style=color:#666>=</span> tryLock<span style=color:#666>(</span>lockKey<span style=color:#666>);</span>
            <span style=color:#408080;font-style:italic>// 4.2 判断否获取成功
</span><span style=color:#408080;font-style:italic></span>            <span style=color:green;font-weight:700>if</span><span style=color:#666>(!</span>isLock<span style=color:#666>){</span>
                <span style=color:#408080;font-style:italic>//4.3 失败，则休眠重试
</span><span style=color:#408080;font-style:italic></span>                Thread<span style=color:#666>.</span><span style=color:#7d9029>sleep</span><span style=color:#666>(</span>50<span style=color:#666>);</span>
                <span style=color:green;font-weight:700>return</span> queryWithMutex<span style=color:#666>(</span>id<span style=color:#666>);</span>
            <span style=color:#666>}</span>
            <span style=color:#408080;font-style:italic>//4.4 成功，根据id查询数据库
</span><span style=color:#408080;font-style:italic></span>             shop <span style=color:#666>=</span> getById<span style=color:#666>(</span>id<span style=color:#666>);</span>
            <span style=color:#408080;font-style:italic>// 5.不存在，返回错误
</span><span style=color:#408080;font-style:italic></span>            <span style=color:green;font-weight:700>if</span><span style=color:#666>(</span>shop <span style=color:#666>==</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>){</span>
                 <span style=color:#408080;font-style:italic>//将空值写入redis
</span><span style=color:#408080;font-style:italic></span>                stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>().</span><span style=color:#7d9029>set</span><span style=color:#666>(</span>key<span style=color:#666>,</span><span style=color:#ba2121>&#34;&#34;</span><span style=color:#666>,</span>CACHE_NULL_TTL<span style=color:#666>,</span>TimeUnit<span style=color:#666>.</span><span style=color:#7d9029>MINUTES</span><span style=color:#666>);</span>
                <span style=color:#408080;font-style:italic>//返回错误信息
</span><span style=color:#408080;font-style:italic></span>                <span style=color:green;font-weight:700>return</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>;</span>
            <span style=color:#666>}</span>
            <span style=color:#408080;font-style:italic>//6.写入redis
</span><span style=color:#408080;font-style:italic></span>            stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>().</span><span style=color:#7d9029>set</span><span style=color:#666>(</span>key<span style=color:#666>,</span>JSONUtil<span style=color:#666>.</span><span style=color:#7d9029>toJsonStr</span><span style=color:#666>(</span>shop<span style=color:#666>),</span>CACHE_NULL_TTL<span style=color:#666>,</span>TimeUnit<span style=color:#666>.</span><span style=color:#7d9029>MINUTES</span><span style=color:#666>);</span>

        <span style=color:#666>}</span><span style=color:green;font-weight:700>catch</span> <span style=color:#666>(</span>Exception e<span style=color:#666>){</span>
            <span style=color:green;font-weight:700>throw</span> <span style=color:green;font-weight:700>new</span> RuntimeException<span style=color:#666>(</span>e<span style=color:#666>);</span>
        <span style=color:#666>}</span>
        <span style=color:green;font-weight:700>finally</span> <span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>//7.释放互斥锁
</span><span style=color:#408080;font-style:italic></span>            unlock<span style=color:#666>(</span>lockKey<span style=color:#666>);</span>
        <span style=color:#666>}</span>
        <span style=color:green;font-weight:700>return</span> shop<span style=color:#666>;</span>
    <span style=color:#666>}</span>
</code></pre></div><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>自写的<span>，</span>利用jmeter进行测试
  <span style=color:#a2f>@Override</span>
    <span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>queryById</span><span style=color:#666>(</span>Long id<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>//互斥锁解决缓存击穿
</span><span style=color:#408080;font-style:italic></span>        Shop shop <span style=color:#666>=</span> queryWithNutex<span style=color:#666>(</span>id<span style=color:#666>);</span>
        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>shop<span style=color:#666>==</span><span style=color:green;font-weight:700>null</span><span style=color:#666>){</span>
            <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;店铺不存在1&#34;</span><span style=color:#666>);</span>
        <span style=color:#666>}</span>
                <span style=color:#408080;font-style:italic>// 7.返回
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>shop<span style=color:#666>);</span>

    <span style=color:#666>}</span>
</code></pre></div><h3 id=总结用互斥锁解决缓存击穿>总结用互斥锁解决缓存击穿<a href=#总结用互斥锁解决缓存击穿 class=header-anchor arialabel=Anchor> #</a></h3><blockquote><p>1.商户数据从redis中获得缓存，存在就返回。不存在发现是否为空值（判断缓存穿透)</p><p>2.实现缓存重构：</p><blockquote><p>2.1 获得互斥锁（没有获得互斥锁，休眠，再调用方法回溯）</p><p>2.2 从数据库查询数据，（数据不存在写null值），存在写入缓存，释放锁</p></blockquote></blockquote><h3 id=30-利用逻辑过期解决缓存击穿问题>3.0 、利用逻辑过期解决缓存击穿问题<a href=#30-利用逻辑过期解决缓存击穿问题 class=header-anchor arialabel=Anchor> #</a></h3><p><strong>需求：修改根据id查询商铺的业务，基于逻辑过期方式来解决缓存击穿问题</strong></p><p>思路分析：当用户开始查询redis时，判断是否命中，如果没有命中则直接返回空数据，不查询数据库，而一旦命中后，将value取出，判断value中的过期时间是否满足，如果没有过期，则直接返回redis中的数据，如果过期，则在开启独立线程后直接返回之前的数据，独立线程去重构数据，重构完成后释放互斥锁。</p><blockquote><p>基于逻辑过期方式解决缓存击穿问题</p></blockquote><ul><li><strong>需求</strong>：修改根据id查询商铺的业务，基于逻辑过期方式来解决缓存击穿问题</li></ul><p><img src=https://img-blog.csdnimg.cn/3fb3a2949fdb4467aace114fa59e01bc.png#pic_center alt=在这里插入图片描述></p><p>如果封装数据：因为现在redis中存储的数据的value需要带上过期时间，此时要么你去修改原来的实体类，要么你</p><p><strong>步骤一、</strong></p><p>新建一个实体类，我们采用第二个方案，这个方案，对原来代码没有侵入性。</p><pre><code>@Data
public class RedisData {
    private LocalDateTime expireTime;
    private Object data;
}
</code></pre><p><strong>步骤二、</strong></p><p>在<strong>ShopServiceImpl</strong> 新增此方法，利用单元测试进行缓存预热</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span>#</span>
    <span style=color:green;font-weight:700>public</span> <span style=color:#b00040>void</span> <span style=color:#00f>saveShop2Redis</span><span style=color:#666>(</span>Long id<span style=color:#666>,</span>Long expireSeconds<span style=color:#666>){</span>
        <span style=color:#408080;font-style:italic>//1.查询店铺的数据
</span><span style=color:#408080;font-style:italic></span>      Shop shop<span style=color:#666>=</span>  getById<span style=color:#666>(</span>id<span style=color:#666>);</span>
      <span style=color:#408080;font-style:italic>//2.封装逻辑过期时间
</span><span style=color:#408080;font-style:italic></span>        RedisData redisData <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> RedisData<span style=color:#666>();</span>
        redisData<span style=color:#666>.</span><span style=color:#7d9029>setData</span><span style=color:#666>(</span>shop<span style=color:#666>);</span>
        redisData<span style=color:#666>.</span><span style=color:#7d9029>setExpireTime</span><span style=color:#666>(</span>LocalDateTime<span style=color:#666>.</span><span style=color:#7d9029>now</span><span style=color:#666>().</span><span style=color:#7d9029>plusSeconds</span><span style=color:#666>(</span>expireSeconds<span style=color:#666>));</span>
        <span style=color:#408080;font-style:italic>//3.写入Redis
</span><span style=color:#408080;font-style:italic></span>        stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>().</span><span style=color:#7d9029>set</span><span style=color:#666>(</span>CACHE_SHOP_KEY<span style=color:#666>+</span>id<span style=color:#666>,</span>JSONUtil<span style=color:#666>.</span><span style=color:#7d9029>toJsonStr</span><span style=color:#666>(</span>redisData<span style=color:#666>));</span>
    <span style=color:#666>}</span>
</code></pre></div><p><strong>在测试类中</strong></p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#a2f>@Test</span>
    <span style=color:#b00040>void</span> <span style=color:#00f>testSaveShop</span><span style=color:#666>(){</span>
        shopService<span style=color:#666>.</span><span style=color:#7d9029>saveShop2Redis</span><span style=color:#666>(</span>1L<span style=color:#666>,</span>10L<span style=color:#666>);</span>
    <span style=color:#666>}</span>
</code></pre></div><p>步骤三：正式代码</p><p><strong>ShopServiceImpl</strong></p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:green;font-weight:700>private</span> <span style=color:green;font-weight:700>static</span> <span style=color:green;font-weight:700>final</span> ExecutorService CACHE_REBUILD_EXECUTOR <span style=color:#666>=</span> Executors<span style=color:#666>.</span><span style=color:#7d9029>newFixedThreadPool</span><span style=color:#666>(</span>10<span style=color:#666>);</span>
<span style=color:green;font-weight:700>public</span> Shop <span style=color:#00f>queryWithLogicalExpire</span><span style=color:#666>(</span> Long id <span style=color:#666>)</span> <span style=color:#666>{</span>
    String key <span style=color:#666>=</span> CACHE_SHOP_KEY <span style=color:#666>+</span> id<span style=color:#666>;</span>
    <span style=color:#408080;font-style:italic>// 1.从redis查询商铺缓存
</span><span style=color:#408080;font-style:italic></span>    String json <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>().</span><span style=color:#7d9029>get</span><span style=color:#666>(</span>key<span style=color:#666>);</span>
    <span style=color:#408080;font-style:italic>// 2.判断是否存在
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>StrUtil<span style=color:#666>.</span><span style=color:#7d9029>isBlank</span><span style=color:#666>(</span>json<span style=color:#666>))</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 3.存在，直接返回
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>return</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>;</span>
    <span style=color:#666>}</span>
    <span style=color:#408080;font-style:italic>// 4.命中，需要先把json反序列化为对象
</span><span style=color:#408080;font-style:italic></span>    RedisData redisData <span style=color:#666>=</span> JSONUtil<span style=color:#666>.</span><span style=color:#7d9029>toBean</span><span style=color:#666>(</span>json<span style=color:#666>,</span> RedisData<span style=color:#666>.</span><span style=color:#7d9029>class</span><span style=color:#666>);</span>
    Shop shop <span style=color:#666>=</span> JSONUtil<span style=color:#666>.</span><span style=color:#7d9029>toBean</span><span style=color:#666>((</span>JSONObject<span style=color:#666>)</span> redisData<span style=color:#666>.</span><span style=color:#7d9029>getData</span><span style=color:#666>(),</span> Shop<span style=color:#666>.</span><span style=color:#7d9029>class</span><span style=color:#666>);</span>
    LocalDateTime expireTime <span style=color:#666>=</span> redisData<span style=color:#666>.</span><span style=color:#7d9029>getExpireTime</span><span style=color:#666>();</span>
    <span style=color:#408080;font-style:italic>// 5.判断是否过期
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>if</span><span style=color:#666>(</span>expireTime<span style=color:#666>.</span><span style=color:#7d9029>isAfter</span><span style=color:#666>(</span>LocalDateTime<span style=color:#666>.</span><span style=color:#7d9029>now</span><span style=color:#666>()))</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 5.1.未过期，直接返回店铺信息
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>return</span> shop<span style=color:#666>;</span>
    <span style=color:#666>}</span>
    <span style=color:#408080;font-style:italic>// 5.2.已过期，需要缓存重建
</span><span style=color:#408080;font-style:italic></span>    <span style=color:#408080;font-style:italic>// 6.缓存重建
</span><span style=color:#408080;font-style:italic></span>    <span style=color:#408080;font-style:italic>// 6.1.获取互斥锁
</span><span style=color:#408080;font-style:italic></span>    String lockKey <span style=color:#666>=</span> LOCK_SHOP_KEY <span style=color:#666>+</span> id<span style=color:#666>;</span>
    <span style=color:#b00040>boolean</span> isLock <span style=color:#666>=</span> tryLock<span style=color:#666>(</span>lockKey<span style=color:#666>);</span>
    <span style=color:#408080;font-style:italic>// 6.2.判断是否获取锁成功
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>isLock<span style=color:#666>){</span>
        CACHE_REBUILD_EXECUTOR<span style=color:#666>.</span><span style=color:#7d9029>submit</span><span style=color:#666>(</span> <span style=color:#666>()-&gt;{</span>

            <span style=color:green;font-weight:700>try</span><span style=color:#666>{</span>
                <span style=color:#408080;font-style:italic>//重建缓存
</span><span style=color:#408080;font-style:italic></span>                <span style=color:green;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#7d9029>saveShop2Redis</span><span style=color:#666>(</span>id<span style=color:#666>,</span>20L<span style=color:#666>);</span>
            <span style=color:#666>}</span><span style=color:green;font-weight:700>catch</span> <span style=color:#666>(</span>Exception e<span style=color:#666>){</span>
                <span style=color:green;font-weight:700>throw</span> <span style=color:green;font-weight:700>new</span> RuntimeException<span style=color:#666>(</span>e<span style=color:#666>);</span>
            <span style=color:#666>}</span><span style=color:green;font-weight:700>finally</span> <span style=color:#666>{</span>
                unlock<span style=color:#666>(</span>lockKey<span style=color:#666>);</span>
            <span style=color:#666>}</span>
        <span style=color:#666>});</span>
    <span style=color:#666>}</span>
    <span style=color:#408080;font-style:italic>// 6.4.返回过期的商铺信息
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>return</span> shop<span style=color:#666>;</span>
<span style=color:#666>}</span>
</code></pre></div><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span>#</span> 自写
 <span style=color:#a2f>@Override</span>
    <span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>queryById</span><span style=color:#666>(</span>Long id<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>//解决缓存穿透
</span><span style=color:#408080;font-style:italic>//        Shop shop = queryWithPassThrough(id);
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#408080;font-style:italic>//互斥锁解决缓存击穿
</span><span style=color:#408080;font-style:italic>//        Shop shop = queryWithNutex(id);
</span><span style=color:#408080;font-style:italic></span>
        <span style=color:#408080;font-style:italic>//逻辑过期解决缓存击穿
</span><span style=color:#408080;font-style:italic></span>         Shop shop<span style=color:#666>=</span>queryWithLogicalExpire<span style=color:#666>(</span>id<span style=color:#666>);</span>
        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>shop<span style=color:#666>==</span><span style=color:green;font-weight:700>null</span><span style=color:#666>){</span>
            <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;店铺不存在1&#34;</span><span style=color:#666>);</span>
        <span style=color:#666>}</span>
                <span style=color:#408080;font-style:italic>// 7.返回
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>shop<span style=color:#666>);</span>
<span style=color:#666>}</span>
    <span style=color:#408080;font-style:italic>//做一个线程池
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>private</span> <span style=color:green;font-weight:700>static</span> <span style=color:green;font-weight:700>final</span> ExecutorService CACHE_REBULD_EXECUTOR<span style=color:#666>=</span> Executors<span style=color:#666>.</span><span style=color:#7d9029>newFixedThreadPool</span><span style=color:#666>(</span>10<span style=color:#666>);</span>
    <span style=color:green;font-weight:700>public</span> Shop <span style=color:#00f>queryWithLogicalExpire</span><span style=color:#666>(</span>Long id<span style=color:#666>){</span>
        String key <span style=color:#666>=</span>CACHE_SHOP_KEY <span style=color:#666>+</span> id<span style=color:#666>;</span>
        <span style=color:#408080;font-style:italic>//1.从redis查询商铺缓存
</span><span style=color:#408080;font-style:italic></span>        String shopJson <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>().</span><span style=color:#7d9029>get</span><span style=color:#666>(</span>key<span style=color:#666>);</span>
        <span style=color:#408080;font-style:italic>//2.判断是否存在
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>StrUtil<span style=color:#666>.</span><span style=color:#7d9029>isBlank</span><span style=color:#666>(</span>shopJson<span style=color:#666>)){</span>
            <span style=color:#408080;font-style:italic>//isnotBlank只有&#34;abc&#34;true,null &#34;&#34; \t\n都是false
</span><span style=color:#408080;font-style:italic></span>            <span style=color:#408080;font-style:italic>//3.不存在直接返回
</span><span style=color:#408080;font-style:italic></span>            <span style=color:green;font-weight:700>return</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>;</span>
        <span style=color:#666>}</span>
        <span style=color:#408080;font-style:italic>//4.命中，先把json反序列化为对象，
</span><span style=color:#408080;font-style:italic></span>        RedisData redisData <span style=color:#666>=</span> JSONUtil<span style=color:#666>.</span><span style=color:#7d9029>toBean</span><span style=color:#666>(</span>shopJson<span style=color:#666>,</span> RedisData<span style=color:#666>.</span><span style=color:#7d9029>class</span><span style=color:#666>);</span>
        JSONObject data <span style=color:#666>=</span> <span style=color:#666>(</span>JSONObject<span style=color:#666>)</span>redisData<span style=color:#666>.</span><span style=color:#7d9029>getData</span><span style=color:#666>();</span><span style=color:#408080;font-style:italic>//强转
</span><span style=color:#408080;font-style:italic></span>        Shop shop<span style=color:#666>=</span>JSONUtil<span style=color:#666>.</span><span style=color:#7d9029>toBean</span><span style=color:#666>(</span>data<span style=color:#666>,</span>Shop<span style=color:#666>.</span><span style=color:#7d9029>class</span><span style=color:#666>);</span><span style=color:#408080;font-style:italic>//因为之前的是RedisData.data是object类型
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#408080;font-style:italic>//合并为
</span><span style=color:#408080;font-style:italic>//        Shop shop=JSONUtil.toBean((JSONObject) redisData.getData(),Shop.class);
</span><span style=color:#408080;font-style:italic></span>        LocalDateTime expireTime <span style=color:#666>=</span> redisData<span style=color:#666>.</span><span style=color:#7d9029>getExpireTime</span><span style=color:#666>();</span>
        <span style=color:#408080;font-style:italic>//5判断是否过期
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>expireTime<span style=color:#666>.</span><span style=color:#7d9029>isAfter</span><span style=color:#666>(</span>LocalDateTime<span style=color:#666>.</span><span style=color:#7d9029>now</span><span style=color:#666>())){</span>
            <span style=color:#408080;font-style:italic>//5.1未过期，直接返回店铺信息
</span><span style=color:#408080;font-style:italic></span>            <span style=color:green;font-weight:700>return</span> shop<span style=color:#666>;</span>
        <span style=color:#666>}</span>
        <span style=color:#408080;font-style:italic>//5.2已过期，需要缓存重建
</span><span style=color:#408080;font-style:italic></span>
        <span style=color:#408080;font-style:italic>//6.缓存重建
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#408080;font-style:italic>//6.1获得互斥锁
</span><span style=color:#408080;font-style:italic></span>        String lockkey<span style=color:#666>=</span>LOCK_SHOP_KEY<span style=color:#666>+</span>id<span style=color:#666>;</span>
        Boolean isLock <span style=color:#666>=</span> tryLock<span style=color:#666>(</span>lockkey<span style=color:#666>);</span>
        <span style=color:#408080;font-style:italic>//6.2判断获取锁是否成功
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>isLock<span style=color:#666>){</span>
            <span style=color:#408080;font-style:italic>//6.3成功，开启新线程，实现缓存重建
</span><span style=color:#408080;font-style:italic></span>            CACHE_REBULD_EXECUTOR<span style=color:#666>.</span><span style=color:#7d9029>submit</span><span style=color:#666>(()</span> <span style=color:#666>-&gt;{</span>
                <span style=color:green;font-weight:700>try</span> <span style=color:#666>{</span>
                    <span style=color:green;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#7d9029>saveShop2Redis</span><span style=color:#666>(</span>id<span style=color:#666>,</span>20L<span style=color:#666>);</span>
                <span style=color:#666>}</span> <span style=color:green;font-weight:700>catch</span> <span style=color:#666>(</span>Exception e<span style=color:#666>)</span> <span style=color:#666>{</span>
                   <span style=color:green;font-weight:700>throw</span>  <span style=color:green;font-weight:700>new</span> RuntimeException<span style=color:#666>(</span>e<span style=color:#666>);</span>
                <span style=color:#666>}</span> <span style=color:green;font-weight:700>finally</span> <span style=color:#666>{</span>
                    <span style=color:#408080;font-style:italic>//释放锁
</span><span style=color:#408080;font-style:italic></span>                    unLock<span style=color:#666>(</span>lockkey<span style=color:#666>);</span>
                <span style=color:#666>}</span>

            <span style=color:#666>});</span>
            <span style=color:#408080;font-style:italic>//注意获取锁成功的时候应该再次检车redis缓存是否过期，做doublecheck
</span><span style=color:#408080;font-style:italic></span>            <span style=color:#408080;font-style:italic>//如果存在则无需重建缓存
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#666>}</span>

        <span style=color:#408080;font-style:italic>//6.4返回过期商铺信息
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>return</span> shop<span style=color:#666>;</span>
    <span style=color:#666>}</span>



    <span style=color:green;font-weight:700>private</span> Boolean <span style=color:#00f>tryLock</span><span style=color:#666>(</span>String key<span style=color:#666>){</span>
        Boolean flag <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>().</span>
                setIfAbsent<span style=color:#666>(</span>key<span style=color:#666>,</span> <span style=color:#ba2121>&#34;1&#34;</span><span style=color:#666>,</span> 10<span style=color:#666>,</span> TimeUnit<span style=color:#666>.</span><span style=color:#7d9029>SECONDS</span><span style=color:#666>);</span>

        <span style=color:green;font-weight:700>return</span> BooleanUtil<span style=color:#666>.</span><span style=color:#7d9029>isTrue</span><span style=color:#666>(</span>flag<span style=color:#666>);</span>
    <span style=color:#666>}</span>
    <span style=color:green;font-weight:700>private</span> <span style=color:#b00040>void</span> <span style=color:#00f>unLock</span><span style=color:#666>(</span>String key<span style=color:#666>){</span>
        stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>delete</span><span style=color:#666>(</span>key<span style=color:#666>);</span>
   
</code></pre></div><h3 id=总结逻辑过期解决缓存穿透>总结逻辑过期解决缓存穿透<a href=#总结逻辑过期解决缓存穿透 class=header-anchor arialabel=Anchor> #</a></h3><blockquote><p>前期准备：</p><blockquote><p>1.存入的redis数据，value是RedisDate封装类（含data属性（shop)和time(逻辑过期时间)）</p><p>（ redisData.setExpireTime(LocalDateTime.now().plusSeconds(expireSeconds));）</p></blockquote><ol><li><p>调用queryById(id)方法，进行逻辑过期的方法queryWithLogicalExpire(Long id)</p><blockquote><p>查询redis中的数据，不存在直接返回（注意因为redisData没有设置ttl，如果没有就不存在）</p><p>存在，将缓存数据redisdata反序列化为对象，根据data获得shop</p><p>判断携带的逻辑过期时间与此刻时间比较，如果存在就返回</p><p>如果此刻时间已经过期，开始缓存重建</p></blockquote><p>2.进行缓存重建</p><blockquote><p>获得互斥锁，如果互斥锁获得不成功，返回旧数据。</p><p>获得互斥锁成功，开启新线程（从线程池中得到）</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:green;font-weight:700>private</span> <span style=color:green;font-weight:700>static</span> <span style=color:green;font-weight:700>final</span> ExecutorService CACHE_REBUILD_EXECUTOR <span style=color:#666>=</span> Executors<span style=color:#666>.</span><span style=color:#7d9029>newFixedThreadPool</span><span style=color:#666>(</span>10<span style=color:#666>);</span>
</code></pre></div><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#408080;font-style:italic>//6.3成功，开启新线程，实现缓存重建
</span><span style=color:#408080;font-style:italic></span>         CACHE_REBULD_EXECUTOR<span style=color:#666>.</span><span style=color:#7d9029>submit</span><span style=color:#666>(()</span> <span style=color:#666>-&gt;{</span>
             <span style=color:green;font-weight:700>try</span> <span style=color:#666>{</span>
                 <span style=color:green;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#7d9029>saveShop2Redis</span><span style=color:#666>(</span>id<span style=color:#666>,</span>20L<span style=color:#666>);</span>
             <span style=color:#666>}</span> <span style=color:green;font-weight:700>catch</span> <span style=color:#666>(</span>Exception e<span style=color:#666>)</span> <span style=color:#666>{</span>
                <span style=color:green;font-weight:700>throw</span>  <span style=color:green;font-weight:700>new</span> RuntimeException<span style=color:#666>(</span>e<span style=color:#666>);</span>
             <span style=color:#666>}</span> <span style=color:green;font-weight:700>finally</span> <span style=color:#666>{</span>
                 <span style=color:#408080;font-style:italic>//释放锁
</span><span style=color:#408080;font-style:italic></span>                 unLock<span style=color:#666>(</span>lockkey<span style=color:#666>);</span>
             <span style=color:#666>}</span>
</code></pre></div><p>新线程执行 this.saveShop2Redis(id,20L);存入数据和逻辑过期时间到redis缓存</p><p>释放锁</p></blockquote><blockquote><p>关于返回值的问题：</p><p>submit：有返回值，返回值（包括异常）被封装于FutureTask对象。适用于有返回结果的任务。
execute：void类型的函数，没有返回值，适用于没有返回的任务。
关于异常处理的问题吗，在业务逻辑必定出异常的情况下：</p><p>submit：submit的时候并不会抛出异常（此时线程可能处于就绪状态）。只有在get操作的时候会抛出。因为get操作会阻塞等待线程的执行完毕。
execute：在执行的时候会直接抛出。可以通过实现UncaughtExceptionHandler接口来完成异常的捕获。</p></blockquote></li></ol></blockquote><h3 id=31封装redis工具类>3.1、封装Redis工具类<a href=#31封装redis工具类 class=header-anchor arialabel=Anchor> #</a></h3><p>基于StringRedisTemplate封装一个缓存工具类，满足下列需求：</p><ul><li>方法1：将任意Java对象序列化为json并存储在string类型的key中，并且可以设置TTL过期时间</li><li>方法2：将任意Java对象序列化为json并存储在string类型的key中，并且可以设置逻辑过期时间，用于处理缓</li></ul><p>存击穿问题</p><ul><li>方法3：根据指定的key查询缓存，并反序列化为指定类型，利用缓存空值的方式解决缓存穿透问题</li><li>方法4：根据指定的key查询缓存，并反序列化为指定类型，需要利用逻辑过期解决缓存击穿问题</li></ul><p>将逻辑进行封装</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@Slf4j</span>
<span style=color:#a2f>@Component</span>
<span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>CacheClient</span> <span style=color:#666>{</span>

    <span style=color:green;font-weight:700>private</span> <span style=color:green;font-weight:700>final</span> StringRedisTemplate stringRedisTemplate<span style=color:#666>;</span>

    <span style=color:green;font-weight:700>private</span> <span style=color:green;font-weight:700>static</span> <span style=color:green;font-weight:700>final</span> ExecutorService CACHE_REBUILD_EXECUTOR <span style=color:#666>=</span> Executors<span style=color:#666>.</span><span style=color:#7d9029>newFixedThreadPool</span><span style=color:#666>(</span>10<span style=color:#666>);</span>

    <span style=color:green;font-weight:700>public</span> <span style=color:#00f>CacheClient</span><span style=color:#666>(</span>StringRedisTemplate stringRedisTemplate<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:green;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#7d9029>stringRedisTemplate</span> <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>;</span>
    <span style=color:#666>}</span>

    <span style=color:green;font-weight:700>public</span> <span style=color:#b00040>void</span> <span style=color:#00f>set</span><span style=color:#666>(</span>String key<span style=color:#666>,</span> Object value<span style=color:#666>,</span> Long time<span style=color:#666>,</span> TimeUnit unit<span style=color:#666>)</span> <span style=color:#666>{</span>
        stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>().</span><span style=color:#7d9029>set</span><span style=color:#666>(</span>key<span style=color:#666>,</span> JSONUtil<span style=color:#666>.</span><span style=color:#7d9029>toJsonStr</span><span style=color:#666>(</span>value<span style=color:#666>),</span> time<span style=color:#666>,</span> unit<span style=color:#666>);</span>
    <span style=color:#666>}</span>

    <span style=color:green;font-weight:700>public</span> <span style=color:#b00040>void</span> <span style=color:#00f>setWithLogicalExpire</span><span style=color:#666>(</span>String key<span style=color:#666>,</span> Object value<span style=color:#666>,</span> Long time<span style=color:#666>,</span> TimeUnit unit<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 设置逻辑过期
</span><span style=color:#408080;font-style:italic></span>        RedisData redisData <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> RedisData<span style=color:#666>();</span>
        redisData<span style=color:#666>.</span><span style=color:#7d9029>setData</span><span style=color:#666>(</span>value<span style=color:#666>);</span>
        redisData<span style=color:#666>.</span><span style=color:#7d9029>setExpireTime</span><span style=color:#666>(</span>LocalDateTime<span style=color:#666>.</span><span style=color:#7d9029>now</span><span style=color:#666>().</span><span style=color:#7d9029>plusSeconds</span><span style=color:#666>(</span>unit<span style=color:#666>.</span><span style=color:#7d9029>toSeconds</span><span style=color:#666>(</span>time<span style=color:#666>)));</span>
        <span style=color:#408080;font-style:italic>// 写入Redis
</span><span style=color:#408080;font-style:italic></span>        stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>().</span><span style=color:#7d9029>set</span><span style=color:#666>(</span>key<span style=color:#666>,</span> JSONUtil<span style=color:#666>.</span><span style=color:#7d9029>toJsonStr</span><span style=color:#666>(</span>redisData<span style=color:#666>));</span>
    <span style=color:#666>}</span>

    <span style=color:green;font-weight:700>public</span> <span style=color:#666>&lt;</span>R<span style=color:#666>,</span>ID<span style=color:#666>&gt;</span> R <span style=color:#00f>queryWithPassThrough</span><span style=color:#666>(</span>
            String keyPrefix<span style=color:#666>,</span> ID id<span style=color:#666>,</span> Class<span style=color:#666>&lt;</span>R<span style=color:#666>&gt;</span> type<span style=color:#666>,</span> Function<span style=color:#666>&lt;</span>ID<span style=color:#666>,</span> R<span style=color:#666>&gt;</span> dbFallback<span style=color:#666>,</span> Long time<span style=color:#666>,</span> TimeUnit unit<span style=color:#666>){</span>
        String key <span style=color:#666>=</span> keyPrefix <span style=color:#666>+</span> id<span style=color:#666>;</span>
        <span style=color:#408080;font-style:italic>// 1.从redis查询商铺缓存
</span><span style=color:#408080;font-style:italic></span>        String json <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>().</span><span style=color:#7d9029>get</span><span style=color:#666>(</span>key<span style=color:#666>);</span>
        <span style=color:#408080;font-style:italic>// 2.判断是否存在
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>StrUtil<span style=color:#666>.</span><span style=color:#7d9029>isNotBlank</span><span style=color:#666>(</span>json<span style=color:#666>))</span> <span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>// 3.存在，直接返回
</span><span style=color:#408080;font-style:italic></span>            <span style=color:green;font-weight:700>return</span> JSONUtil<span style=color:#666>.</span><span style=color:#7d9029>toBean</span><span style=color:#666>(</span>json<span style=color:#666>,</span> type<span style=color:#666>);</span>
        <span style=color:#666>}</span>
        <span style=color:#408080;font-style:italic>// 判断命中的是否是空值
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>json <span style=color:#666>!=</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>// 返回一个错误信息
</span><span style=color:#408080;font-style:italic></span>            <span style=color:green;font-weight:700>return</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>;</span>
        <span style=color:#666>}</span>

        <span style=color:#408080;font-style:italic>// 4.不存在，根据id查询数据库
</span><span style=color:#408080;font-style:italic></span>        R r <span style=color:#666>=</span> dbFallback<span style=color:#666>.</span><span style=color:#7d9029>apply</span><span style=color:#666>(</span>id<span style=color:#666>);</span>
        <span style=color:#408080;font-style:italic>// 5.不存在，返回错误
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>r <span style=color:#666>==</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>// 将空值写入redis
</span><span style=color:#408080;font-style:italic></span>            stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>().</span><span style=color:#7d9029>set</span><span style=color:#666>(</span>key<span style=color:#666>,</span> <span style=color:#ba2121>&#34;&#34;</span><span style=color:#666>,</span> CACHE_NULL_TTL<span style=color:#666>,</span> TimeUnit<span style=color:#666>.</span><span style=color:#7d9029>MINUTES</span><span style=color:#666>);</span>
            <span style=color:#408080;font-style:italic>// 返回错误信息
</span><span style=color:#408080;font-style:italic></span>            <span style=color:green;font-weight:700>return</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>;</span>
        <span style=color:#666>}</span>
        <span style=color:#408080;font-style:italic>// 6.存在，写入redis
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#7d9029>set</span><span style=color:#666>(</span>key<span style=color:#666>,</span> r<span style=color:#666>,</span> time<span style=color:#666>,</span> unit<span style=color:#666>);</span>
        <span style=color:green;font-weight:700>return</span> r<span style=color:#666>;</span>
    <span style=color:#666>}</span>

    <span style=color:green;font-weight:700>public</span> <span style=color:#666>&lt;</span>R<span style=color:#666>,</span> ID<span style=color:#666>&gt;</span> R <span style=color:#00f>queryWithLogicalExpire</span><span style=color:#666>(</span>
            String keyPrefix<span style=color:#666>,</span> ID id<span style=color:#666>,</span> Class<span style=color:#666>&lt;</span>R<span style=color:#666>&gt;</span> type<span style=color:#666>,</span> Function<span style=color:#666>&lt;</span>ID<span style=color:#666>,</span> R<span style=color:#666>&gt;</span> dbFallback<span style=color:#666>,</span> Long time<span style=color:#666>,</span> TimeUnit unit<span style=color:#666>)</span> <span style=color:#666>{</span>
        String key <span style=color:#666>=</span> keyPrefix <span style=color:#666>+</span> id<span style=color:#666>;</span>
        <span style=color:#408080;font-style:italic>// 1.从redis查询商铺缓存
</span><span style=color:#408080;font-style:italic></span>        String json <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>().</span><span style=color:#7d9029>get</span><span style=color:#666>(</span>key<span style=color:#666>);</span>
        <span style=color:#408080;font-style:italic>// 2.判断是否存在
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>StrUtil<span style=color:#666>.</span><span style=color:#7d9029>isBlank</span><span style=color:#666>(</span>json<span style=color:#666>))</span> <span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>// 3.存在，直接返回
</span><span style=color:#408080;font-style:italic></span>            <span style=color:green;font-weight:700>return</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>;</span>
        <span style=color:#666>}</span>
        <span style=color:#408080;font-style:italic>// 4.命中，需要先把json反序列化为对象
</span><span style=color:#408080;font-style:italic></span>        RedisData redisData <span style=color:#666>=</span> JSONUtil<span style=color:#666>.</span><span style=color:#7d9029>toBean</span><span style=color:#666>(</span>json<span style=color:#666>,</span> RedisData<span style=color:#666>.</span><span style=color:#7d9029>class</span><span style=color:#666>);</span>
        R r <span style=color:#666>=</span> JSONUtil<span style=color:#666>.</span><span style=color:#7d9029>toBean</span><span style=color:#666>((</span>JSONObject<span style=color:#666>)</span> redisData<span style=color:#666>.</span><span style=color:#7d9029>getData</span><span style=color:#666>(),</span> type<span style=color:#666>);</span>
        LocalDateTime expireTime <span style=color:#666>=</span> redisData<span style=color:#666>.</span><span style=color:#7d9029>getExpireTime</span><span style=color:#666>();</span>
        <span style=color:#408080;font-style:italic>// 5.判断是否过期
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span><span style=color:#666>(</span>expireTime<span style=color:#666>.</span><span style=color:#7d9029>isAfter</span><span style=color:#666>(</span>LocalDateTime<span style=color:#666>.</span><span style=color:#7d9029>now</span><span style=color:#666>()))</span> <span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>// 5.1.未过期，直接返回店铺信息
</span><span style=color:#408080;font-style:italic></span>            <span style=color:green;font-weight:700>return</span> r<span style=color:#666>;</span>
        <span style=color:#666>}</span>
        <span style=color:#408080;font-style:italic>// 5.2.已过期，需要缓存重建
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#408080;font-style:italic>// 6.缓存重建
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#408080;font-style:italic>// 6.1.获取互斥锁
</span><span style=color:#408080;font-style:italic></span>        String lockKey <span style=color:#666>=</span> LOCK_SHOP_KEY <span style=color:#666>+</span> id<span style=color:#666>;</span>
        <span style=color:#b00040>boolean</span> isLock <span style=color:#666>=</span> tryLock<span style=color:#666>(</span>lockKey<span style=color:#666>);</span>
        <span style=color:#408080;font-style:italic>// 6.2.判断是否获取锁成功
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>isLock<span style=color:#666>){</span>
            <span style=color:#408080;font-style:italic>// 6.3.成功，开启独立线程，实现缓存重建
</span><span style=color:#408080;font-style:italic></span>            CACHE_REBUILD_EXECUTOR<span style=color:#666>.</span><span style=color:#7d9029>submit</span><span style=color:#666>(()</span> <span style=color:#666>-&gt;</span> <span style=color:#666>{</span>
                <span style=color:green;font-weight:700>try</span> <span style=color:#666>{</span>
                    <span style=color:#408080;font-style:italic>// 查询数据库
</span><span style=color:#408080;font-style:italic></span>                    R newR <span style=color:#666>=</span> dbFallback<span style=color:#666>.</span><span style=color:#7d9029>apply</span><span style=color:#666>(</span>id<span style=color:#666>);</span>
                    <span style=color:#408080;font-style:italic>// 重建缓存
</span><span style=color:#408080;font-style:italic></span>                    <span style=color:green;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#7d9029>setWithLogicalExpire</span><span style=color:#666>(</span>key<span style=color:#666>,</span> newR<span style=color:#666>,</span> time<span style=color:#666>,</span> unit<span style=color:#666>);</span>
                <span style=color:#666>}</span> <span style=color:green;font-weight:700>catch</span> <span style=color:#666>(</span>Exception e<span style=color:#666>)</span> <span style=color:#666>{</span>
                    <span style=color:green;font-weight:700>throw</span> <span style=color:green;font-weight:700>new</span> RuntimeException<span style=color:#666>(</span>e<span style=color:#666>);</span>
                <span style=color:#666>}</span><span style=color:green;font-weight:700>finally</span> <span style=color:#666>{</span>
                    <span style=color:#408080;font-style:italic>// 释放锁
</span><span style=color:#408080;font-style:italic></span>                    unlock<span style=color:#666>(</span>lockKey<span style=color:#666>);</span>
                <span style=color:#666>}</span>
            <span style=color:#666>});</span>
        <span style=color:#666>}</span>
        <span style=color:#408080;font-style:italic>// 6.4.返回过期的商铺信息
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>return</span> r<span style=color:#666>;</span>
    <span style=color:#666>}</span>

    <span style=color:green;font-weight:700>public</span> <span style=color:#666>&lt;</span>R<span style=color:#666>,</span> ID<span style=color:#666>&gt;</span> R <span style=color:#00f>queryWithMutex</span><span style=color:#666>(</span>
            String keyPrefix<span style=color:#666>,</span> ID id<span style=color:#666>,</span> Class<span style=color:#666>&lt;</span>R<span style=color:#666>&gt;</span> type<span style=color:#666>,</span> Function<span style=color:#666>&lt;</span>ID<span style=color:#666>,</span> R<span style=color:#666>&gt;</span> dbFallback<span style=color:#666>,</span> Long time<span style=color:#666>,</span> TimeUnit unit<span style=color:#666>)</span> <span style=color:#666>{</span>
        String key <span style=color:#666>=</span> keyPrefix <span style=color:#666>+</span> id<span style=color:#666>;</span>
        <span style=color:#408080;font-style:italic>// 1.从redis查询商铺缓存
</span><span style=color:#408080;font-style:italic></span>        String shopJson <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>().</span><span style=color:#7d9029>get</span><span style=color:#666>(</span>key<span style=color:#666>);</span>
        <span style=color:#408080;font-style:italic>// 2.判断是否存在
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>StrUtil<span style=color:#666>.</span><span style=color:#7d9029>isNotBlank</span><span style=color:#666>(</span>shopJson<span style=color:#666>))</span> <span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>// 3.存在，直接返回
</span><span style=color:#408080;font-style:italic></span>            <span style=color:green;font-weight:700>return</span> JSONUtil<span style=color:#666>.</span><span style=color:#7d9029>toBean</span><span style=color:#666>(</span>shopJson<span style=color:#666>,</span> type<span style=color:#666>);</span>
        <span style=color:#666>}</span>
        <span style=color:#408080;font-style:italic>// 判断命中的是否是空值
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>shopJson <span style=color:#666>!=</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>// 返回一个错误信息
</span><span style=color:#408080;font-style:italic></span>            <span style=color:green;font-weight:700>return</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>;</span>
        <span style=color:#666>}</span>

        <span style=color:#408080;font-style:italic>// 4.实现缓存重建
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#408080;font-style:italic>// 4.1.获取互斥锁
</span><span style=color:#408080;font-style:italic></span>        String lockKey <span style=color:#666>=</span> LOCK_SHOP_KEY <span style=color:#666>+</span> id<span style=color:#666>;</span>
        R r <span style=color:#666>=</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>;</span>
        <span style=color:green;font-weight:700>try</span> <span style=color:#666>{</span>
            <span style=color:#b00040>boolean</span> isLock <span style=color:#666>=</span> tryLock<span style=color:#666>(</span>lockKey<span style=color:#666>);</span>
            <span style=color:#408080;font-style:italic>// 4.2.判断是否获取成功
</span><span style=color:#408080;font-style:italic></span>            <span style=color:green;font-weight:700>if</span> <span style=color:#666>(!</span>isLock<span style=color:#666>)</span> <span style=color:#666>{</span>
                <span style=color:#408080;font-style:italic>// 4.3.获取锁失败，休眠并重试
</span><span style=color:#408080;font-style:italic></span>                Thread<span style=color:#666>.</span><span style=color:#7d9029>sleep</span><span style=color:#666>(</span>50<span style=color:#666>);</span>
                <span style=color:green;font-weight:700>return</span> queryWithMutex<span style=color:#666>(</span>keyPrefix<span style=color:#666>,</span> id<span style=color:#666>,</span> type<span style=color:#666>,</span> dbFallback<span style=color:#666>,</span> time<span style=color:#666>,</span> unit<span style=color:#666>);</span>
            <span style=color:#666>}</span>
            <span style=color:#408080;font-style:italic>// 4.4.获取锁成功，根据id查询数据库
</span><span style=color:#408080;font-style:italic></span>            r <span style=color:#666>=</span> dbFallback<span style=color:#666>.</span><span style=color:#7d9029>apply</span><span style=color:#666>(</span>id<span style=color:#666>);</span>
            <span style=color:#408080;font-style:italic>// 5.不存在，返回错误
</span><span style=color:#408080;font-style:italic></span>            <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>r <span style=color:#666>==</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
                <span style=color:#408080;font-style:italic>// 将空值写入redis
</span><span style=color:#408080;font-style:italic></span>                stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>().</span><span style=color:#7d9029>set</span><span style=color:#666>(</span>key<span style=color:#666>,</span> <span style=color:#ba2121>&#34;&#34;</span><span style=color:#666>,</span> CACHE_NULL_TTL<span style=color:#666>,</span> TimeUnit<span style=color:#666>.</span><span style=color:#7d9029>MINUTES</span><span style=color:#666>);</span>
                <span style=color:#408080;font-style:italic>// 返回错误信息
</span><span style=color:#408080;font-style:italic></span>                <span style=color:green;font-weight:700>return</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>;</span>
            <span style=color:#666>}</span>
            <span style=color:#408080;font-style:italic>// 6.存在，写入redis
</span><span style=color:#408080;font-style:italic></span>            <span style=color:green;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#7d9029>set</span><span style=color:#666>(</span>key<span style=color:#666>,</span> r<span style=color:#666>,</span> time<span style=color:#666>,</span> unit<span style=color:#666>);</span>
        <span style=color:#666>}</span> <span style=color:green;font-weight:700>catch</span> <span style=color:#666>(</span>InterruptedException e<span style=color:#666>)</span> <span style=color:#666>{</span>
            <span style=color:green;font-weight:700>throw</span> <span style=color:green;font-weight:700>new</span> RuntimeException<span style=color:#666>(</span>e<span style=color:#666>);</span>
        <span style=color:#666>}</span><span style=color:green;font-weight:700>finally</span> <span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>// 7.释放锁
</span><span style=color:#408080;font-style:italic></span>            unlock<span style=color:#666>(</span>lockKey<span style=color:#666>);</span>
        <span style=color:#666>}</span>
        <span style=color:#408080;font-style:italic>// 8.返回
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>return</span> r<span style=color:#666>;</span>
    <span style=color:#666>}</span>

    <span style=color:green;font-weight:700>private</span> <span style=color:#b00040>boolean</span> <span style=color:#00f>tryLock</span><span style=color:#666>(</span>String key<span style=color:#666>)</span> <span style=color:#666>{</span>
        Boolean flag <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>().</span><span style=color:#7d9029>setIfAbsent</span><span style=color:#666>(</span>key<span style=color:#666>,</span> <span style=color:#ba2121>&#34;1&#34;</span><span style=color:#666>,</span> 10<span style=color:#666>,</span> TimeUnit<span style=color:#666>.</span><span style=color:#7d9029>SECONDS</span><span style=color:#666>);</span>
        <span style=color:green;font-weight:700>return</span> BooleanUtil<span style=color:#666>.</span><span style=color:#7d9029>isTrue</span><span style=color:#666>(</span>flag<span style=color:#666>);</span>
    <span style=color:#666>}</span>

    <span style=color:green;font-weight:700>private</span> <span style=color:#b00040>void</span> <span style=color:#00f>unlock</span><span style=color:#666>(</span>String key<span style=color:#666>)</span> <span style=color:#666>{</span>
        stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>delete</span><span style=color:#666>(</span>key<span style=color:#666>);</span>
    <span style=color:#666>}</span>
<span style=color:#666>}</span>
</code></pre></div><p>在ShopServiceImpl 中</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@Resource</span>
<span style=color:green;font-weight:700>private</span> CacheClient cacheClient<span style=color:#666>;</span>

 <span style=color:#a2f>@Override</span>
    <span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>queryById</span><span style=color:#666>(</span>Long id<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 解决缓存穿透
</span><span style=color:#408080;font-style:italic></span>        Shop shop <span style=color:#666>=</span> cacheClient
                <span style=color:#666>.</span><span style=color:#7d9029>queryWithPassThrough</span><span style=color:#666>(</span>CACHE_SHOP_KEY<span style=color:#666>,</span> id<span style=color:#666>,</span> Shop<span style=color:#666>.</span><span style=color:#7d9029>class</span><span style=color:#666>,</span> <span style=color:green;font-weight:700>this</span><span style=color:#666>::</span>getById<span style=color:#666>,</span> CACHE_SHOP_TTL<span style=color:#666>,</span> TimeUnit<span style=color:#666>.</span><span style=color:#7d9029>MINUTES</span><span style=color:#666>);</span>

        <span style=color:#408080;font-style:italic>// 互斥锁解决缓存击穿
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#408080;font-style:italic>// Shop shop = cacheClient
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#408080;font-style:italic>//         .queryWithMutex(CACHE_SHOP_KEY, id, Shop.class, this::getById, CACHE_SHOP_TTL, TimeUnit.MINUTES);
</span><span style=color:#408080;font-style:italic></span>
        <span style=color:#408080;font-style:italic>// 逻辑过期解决缓存击穿
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#408080;font-style:italic>// Shop shop = cacheClient
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#408080;font-style:italic>//         .queryWithLogicalExpire(CACHE_SHOP_KEY, id, Shop.class, this::getById, 20L, TimeUnit.SECONDS);
</span><span style=color:#408080;font-style:italic></span>
        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>shop <span style=color:#666>==</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
            <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;店铺不存在！&#34;</span><span style=color:#666>);</span>
        <span style=color:#666>}</span>
        <span style=color:#408080;font-style:italic>// 7.返回
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>shop<span style=color:#666>);</span>
    <span style=color:#666>}</span>
</code></pre></div><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>
<span style=color:#408080;font-style:italic>//Function&lt;ID,R&gt; dbFallback  是函数，参数ID ，返回值R
</span><span style=color:#408080;font-style:italic>//isnotBlank只有&#34;abc&#34;true,null &#34;&#34; \t\n都是false
</span><span style=color:#408080;font-style:italic></span> <span style=color:#408080;font-style:italic>//lobandaB表达式 id2 -&gt; getById(id2)简写this::getById
</span><span style=color:#408080;font-style:italic></span> <span style=color:#408080;font-style:italic>//4.命中，先把json反序列化为对象，
</span><span style=color:#408080;font-style:italic></span>        RedisData redisData <span style=color:#666>=</span> JSONUtil<span style=color:#666>.</span><span style=color:#7d9029>toBean</span><span style=color:#666>(</span>json<span style=color:#666>,</span> RedisData<span style=color:#666>.</span><span style=color:#7d9029>class</span><span style=color:#666>);</span>
        JSONObject data <span style=color:#666>=</span> <span style=color:#666>(</span>JSONObject<span style=color:#666>)</span>redisData<span style=color:#666>.</span><span style=color:#7d9029>getData</span><span style=color:#666>();</span><span style=color:#408080;font-style:italic>//强转
</span><span style=color:#408080;font-style:italic></span>       R r<span style=color:#666>=</span>JSONUtil<span style=color:#666>.</span><span style=color:#7d9029>toBean</span><span style=color:#666>(</span>data<span style=color:#666>,</span>type<span style=color:#666>);</span><span style=color:#408080;font-style:italic>//因为之前的是RedisData.data是object类型
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#408080;font-style:italic>//合并为
</span><span style=color:#408080;font-style:italic>//        Shop shop=JSONUtil.toBean((JSONObject) redisData.getData(),Shop.class);
</span><span style=color:#408080;font-style:italic></span>        LocalDateTime expireTime <span style=color:#666>=</span> redisData<span style=color:#666>.</span><span style=color:#7d9029>getExpireTime</span><span style=color:#666>();</span>
        <span style=color:#408080;font-style:italic>//5判断是否过期
</span><span style=color:#408080;font-style:italic></span> 
  
</code></pre></div><h2 id=3优惠卷秒杀>3、优惠卷秒杀<a href=#3优惠卷秒杀 class=header-anchor arialabel=Anchor> #</a></h2><h3 id=31--全局唯一id>3.1 -全局唯一ID<a href=#31--全局唯一id class=header-anchor arialabel=Anchor> #</a></h3><p>每个店铺都可以发布优惠券：</p><p><strong>全局ID生成器</strong>，是一种在分布式系统下用来生成全局唯一ID的工具，一般要满足下列特性：</p><p><img src=https://img-blog.csdnimg.cn/db54a1b770684901baddf79bc743cf93.png#pic_center alt=在这里插入图片描述></p><p>为了增加ID的安全性，我们可以不直接使用Redis自增的数值，而是拼接一些其它信息：</p><blockquote><p>8个字节，64个bit</p></blockquote><p><img src=https://img-blog.csdnimg.cn/bc26ce89b3714be5ad8ea0829eb81b6e.png#pic_center alt=在这里插入图片描述></p><p>ID的组成部分：符号位：1bit，永远为0</p><p>时间戳：31bit，以秒为单位，可以使用69年</p><p>序列号：32bit，秒内的计数器，支持每秒产生2^32个不同ID</p><h3 id=32--redis实现全局唯一id>3.2 -Redis实现全局唯一Id<a href=#32--redis实现全局唯一id class=header-anchor arialabel=Anchor> #</a></h3><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@Component</span>
<span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>RedisIdWorker</span> <span style=color:#666>{</span>
    <span style=color:#408080;font-style:italic>/**
</span><span style=color:#408080;font-style:italic>     * 开始时间戳
</span><span style=color:#408080;font-style:italic>     */</span>
    <span style=color:green;font-weight:700>private</span> <span style=color:green;font-weight:700>static</span> <span style=color:green;font-weight:700>final</span> <span style=color:#b00040>long</span> BEGIN_TIMESTAMP <span style=color:#666>=</span> 1640995200L<span style=color:#666>;</span>
    <span style=color:#408080;font-style:italic>/**
</span><span style=color:#408080;font-style:italic>     * 序列号的位数
</span><span style=color:#408080;font-style:italic>     */</span>
    <span style=color:green;font-weight:700>private</span> <span style=color:green;font-weight:700>static</span> <span style=color:green;font-weight:700>final</span> <span style=color:#b00040>int</span> COUNT_BITS <span style=color:#666>=</span> 32<span style=color:#666>;</span>

    <span style=color:green;font-weight:700>private</span> StringRedisTemplate stringRedisTemplate<span style=color:#666>;</span>

    <span style=color:green;font-weight:700>public</span> <span style=color:#00f>RedisIdWorker</span><span style=color:#666>(</span>StringRedisTemplate stringRedisTemplate<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:green;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#7d9029>stringRedisTemplate</span> <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>;</span>
    <span style=color:#666>}</span>

    <span style=color:green;font-weight:700>public</span> <span style=color:#b00040>long</span> <span style=color:#00f>nextId</span><span style=color:#666>(</span>String keyPrefix<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 1.生成时间戳
</span><span style=color:#408080;font-style:italic></span>        LocalDateTime now <span style=color:#666>=</span> LocalDateTime<span style=color:#666>.</span><span style=color:#7d9029>now</span><span style=color:#666>();</span>
        <span style=color:#b00040>long</span> nowSecond <span style=color:#666>=</span> now<span style=color:#666>.</span><span style=color:#7d9029>toEpochSecond</span><span style=color:#666>(</span>ZoneOffset<span style=color:#666>.</span><span style=color:#7d9029>UTC</span><span style=color:#666>);</span>
        <span style=color:#b00040>long</span> timestamp <span style=color:#666>=</span> nowSecond <span style=color:#666>-</span> BEGIN_TIMESTAMP<span style=color:#666>;</span>

        <span style=color:#408080;font-style:italic>// 2.生成序列号
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#408080;font-style:italic>// 2.1.获取当前日期，精确到天
</span><span style=color:#408080;font-style:italic></span>        String date <span style=color:#666>=</span> now<span style=color:#666>.</span><span style=color:#7d9029>format</span><span style=color:#666>(</span>DateTimeFormatter<span style=color:#666>.</span><span style=color:#7d9029>ofPattern</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;yyyy:MM:dd&#34;</span><span style=color:#666>));</span>
        <span style=color:#408080;font-style:italic>// 2.2.自增长
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#b00040>long</span> count <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>().</span><span style=color:#7d9029>increment</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;icr:&#34;</span> <span style=color:#666>+</span> keyPrefix <span style=color:#666>+</span> <span style=color:#ba2121>&#34;:&#34;</span> <span style=color:#666>+</span> date<span style=color:#666>);</span>

        <span style=color:#408080;font-style:italic>// 3.拼接并返回
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>return</span> timestamp <span style=color:#666>&lt;&lt;</span> COUNT_BITS <span style=color:#666>|</span> count<span style=color:#666>;</span>
    <span style=color:#666>}</span>
<span style=color:#666>}</span>
</code></pre></div><p>测试类</p><blockquote><p>知识小贴士：关于countdownlatch</p></blockquote><blockquote><p>countdownlatch名为信号枪：主要的作用是同步协调在多线程的等待于唤醒问题</p></blockquote><blockquote><p>我们如果没有CountDownLatch ，那么由于程序是异步的，当异步程序没有执行完时，主线程就已经执行完了，然后我们期望的是分线程全部走完之后，主线程再走，所以我们此时需要使用到CountDownLatch</p></blockquote><blockquote><p>CountDownLatch 中有两个最重要的方法</p></blockquote><blockquote><p>1、countDown</p></blockquote><blockquote><p>2、await</p></blockquote><blockquote><p>await 方法 是阻塞方法，我们担心分线程没有执行完时，main线程就先执行，所以使用await可以让main线程阻塞，那么什么时候main线程不再阻塞呢？当CountDownLatch 内部维护的 变量变为0时，就不再阻塞，直接放行，那么什么时候CountDownLatch 维护的变量变为0 呢，我们只需要调用一次countDown ，内部变量就减少1，我们让分线程和变量绑定， 执行完一个分线程就减少一个变量，当分线程全部走完，CountDownLatch 维护的变量就是0，此时await就不再阻塞，统计出来的时间也就是所有分线程执行完后的时间。</p></blockquote><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@Test</span>
<span style=color:#b00040>void</span> <span style=color:#00f>testIdWorker</span><span style=color:#666>()</span> <span style=color:green;font-weight:700>throws</span> InterruptedException <span style=color:#666>{</span>
    CountDownLatch latch <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> CountDownLatch<span style=color:#666>(</span>300<span style=color:#666>);</span>

    Runnable task <span style=color:#666>=</span> <span style=color:#666>()</span> <span style=color:#666>-&gt;</span> <span style=color:#666>{</span>
        <span style=color:green;font-weight:700>for</span> <span style=color:#666>(</span><span style=color:#b00040>int</span> i <span style=color:#666>=</span> 0<span style=color:#666>;</span> i <span style=color:#666>&lt;</span> 100<span style=color:#666>;</span> i<span style=color:#666>++)</span> <span style=color:#666>{</span>
            <span style=color:#b00040>long</span> id <span style=color:#666>=</span> redisIdWorker<span style=color:#666>.</span><span style=color:#7d9029>nextId</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;order&#34;</span><span style=color:#666>);</span>
            System<span style=color:#666>.</span><span style=color:#7d9029>out</span><span style=color:#666>.</span><span style=color:#7d9029>println</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;id = &#34;</span> <span style=color:#666>+</span> id<span style=color:#666>);</span>
        <span style=color:#666>}</span>
        latch<span style=color:#666>.</span><span style=color:#7d9029>countDown</span><span style=color:#666>();</span>
    <span style=color:#666>};</span>
    <span style=color:#b00040>long</span> begin <span style=color:#666>=</span> System<span style=color:#666>.</span><span style=color:#7d9029>currentTimeMillis</span><span style=color:#666>();</span>
    <span style=color:green;font-weight:700>for</span> <span style=color:#666>(</span><span style=color:#b00040>int</span> i <span style=color:#666>=</span> 0<span style=color:#666>;</span> i <span style=color:#666>&lt;</span> 300<span style=color:#666>;</span> i<span style=color:#666>++)</span> <span style=color:#666>{</span>
        es<span style=color:#666>.</span><span style=color:#7d9029>submit</span><span style=color:#666>(</span>task<span style=color:#666>);</span>
    <span style=color:#666>}</span>
    latch<span style=color:#666>.</span><span style=color:#7d9029>await</span><span style=color:#666>();</span>
    <span style=color:#b00040>long</span> end <span style=color:#666>=</span> System<span style=color:#666>.</span><span style=color:#7d9029>currentTimeMillis</span><span style=color:#666>();</span>
    System<span style=color:#666>.</span><span style=color:#7d9029>out</span><span style=color:#666>.</span><span style=color:#7d9029>println</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;time = &#34;</span> <span style=color:#666>+</span> <span style=color:#666>(</span>end <span style=color:#666>-</span> begin<span style=color:#666>));</span>
<span style=color:#666>}</span>
</code></pre></div><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span>#</span>自写
    
<span style=color:green;font-weight:700>package</span> <span style=color:#00f;font-weight:700>com.hmdp.utils</span><span style=color:#666>;</span>
<span style=color:green;font-weight:700>import</span> <span style=color:#00f;font-weight:700>lombok.extern.slf4j.Slf4j</span><span style=color:#666>;</span>
<span style=color:green;font-weight:700>import</span> <span style=color:#00f;font-weight:700>org.springframework.data.redis.core.StringRedisTemplate</span><span style=color:#666>;</span>
<span style=color:green;font-weight:700>import</span> <span style=color:#00f;font-weight:700>org.springframework.stereotype.Component</span><span style=color:#666>;</span>
<span style=color:green;font-weight:700>import</span> <span style=color:#00f;font-weight:700>javax.annotation.Resource</span><span style=color:#666>;</span>
<span style=color:green;font-weight:700>import</span> <span style=color:#00f;font-weight:700>java.time.LocalDateTime</span><span style=color:#666>;</span>
<span style=color:green;font-weight:700>import</span> <span style=color:#00f;font-weight:700>java.time.ZoneOffset</span><span style=color:#666>;</span>
<span style=color:green;font-weight:700>import</span> <span style=color:#00f;font-weight:700>java.time.format.DateTimeFormatter</span><span style=color:#666>;</span>

<span style=color:#a2f>@Component</span>
<span style=color:#a2f>@Slf4j</span>
<span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>RedisIdWorker2</span> <span style=color:#666>{</span>
    <span style=color:#408080;font-style:italic>/**
</span><span style=color:#408080;font-style:italic>     * 开始时间戳
</span><span style=color:#408080;font-style:italic>     * @param keyPrefix
</span><span style=color:#408080;font-style:italic>     * @return
</span><span style=color:#408080;font-style:italic>     */</span>
    <span style=color:green;font-weight:700>private</span> <span style=color:green;font-weight:700>static</span>  <span style=color:green;font-weight:700>final</span> <span style=color:#b00040>long</span> BEGIN_TIMESTAMP<span style=color:#666>=</span>1640995200L<span style=color:#666>;</span>
    <span style=color:#408080;font-style:italic>/**
</span><span style=color:#408080;font-style:italic>     * 序列号的位数
</span><span style=color:#408080;font-style:italic>     */</span>
    <span style=color:green;font-weight:700>private</span> <span style=color:green;font-weight:700>static</span> <span style=color:green;font-weight:700>final</span> <span style=color:#b00040>int</span> COUNT_BITS<span style=color:#666>=</span>32<span style=color:#666>;</span>
    <span style=color:#a2f>@Resource</span>
    <span style=color:green;font-weight:700>private</span> StringRedisTemplate stringRedisTemplate<span style=color:#666>;</span>
    <span style=color:green;font-weight:700>public</span> <span style=color:#b00040>long</span> <span style=color:#00f>nextId</span><span style=color:#666>(</span>String keyPrefix<span style=color:#666>){</span>
        <span style=color:#408080;font-style:italic>//1.生成时间戳
</span><span style=color:#408080;font-style:italic></span>        LocalDateTime now <span style=color:#666>=</span> LocalDateTime<span style=color:#666>.</span><span style=color:#7d9029>now</span><span style=color:#666>();</span>
        <span style=color:#b00040>long</span> nowSecond <span style=color:#666>=</span> now<span style=color:#666>.</span><span style=color:#7d9029>toEpochSecond</span><span style=color:#666>(</span>ZoneOffset<span style=color:#666>.</span><span style=color:#7d9029>UTC</span><span style=color:#666>);</span>
        <span style=color:#b00040>long</span> timestamp <span style=color:#666>=</span>  nowSecond <span style=color:#666>-</span> BEGIN_TIMESTAMP<span style=color:#666>;</span>
        <span style=color:#408080;font-style:italic>//2.生成序列号
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#408080;font-style:italic>//2.1获取当前的日期，精确到天
</span><span style=color:#408080;font-style:italic></span>        String data <span style=color:#666>=</span> now<span style=color:#666>.</span><span style=color:#7d9029>format</span><span style=color:#666>(</span>DateTimeFormatter<span style=color:#666>.</span><span style=color:#7d9029>ofPattern</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;yyyy:MM:dd&#34;</span><span style=color:#666>));</span>
        <span style=color:#408080;font-style:italic>//2.2自增长
</span><span style=color:#408080;font-style:italic></span>        Long count <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>().</span><span style=color:#7d9029>increment</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;icr:&#34;</span> <span style=color:#666>+</span> keyPrefix <span style=color:#666>+</span> <span style=color:#ba2121>&#34;:&#34;</span> <span style=color:#666>+</span> data<span style=color:#666>);</span>

        <span style=color:#408080;font-style:italic>//3.拼接且返回
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>return</span> timestamp <span style=color:#666>&lt;&lt;</span> COUNT_BITS <span style=color:#666>|</span> count<span style=color:#666>;</span>
        <span style=color:#408080;font-style:italic>//利用的是位运算，（UUID是16进制的长串值，是字符串而且不是自增，用的比较少）
</span><span style=color:#408080;font-style:italic></span>    <span style=color:#666>}</span>

<span style=color:#408080;font-style:italic>//    public static void main(String[] args) {
</span><span style=color:#408080;font-style:italic>//        LocalDateTime time = LocalDateTime.of(2022, 1, 1, 0, 0);
</span><span style=color:#408080;font-style:italic>//        long secend = time.toEpochSecond(ZoneOffset.UTC);
</span><span style=color:#408080;font-style:italic>//        System.out.println(secend);
</span><span style=color:#408080;font-style:italic>//
</span><span style=color:#408080;font-style:italic>//
</span><span style=color:#408080;font-style:italic>//    }
</span><span style=color:#408080;font-style:italic></span><span style=color:#666>}</span>
<span>#</span>测试

    <span style=color:green;font-weight:700>private</span> ExecutorService es <span style=color:#666>=</span> Executors<span style=color:#666>.</span><span style=color:#7d9029>newFixedThreadPool</span><span style=color:#666>(</span>300<span style=color:#666>);</span>
    <span style=color:#a2f>@Resource</span>
    <span style=color:green;font-weight:700>private</span> RedisIdWorker2 redisIdWorker2<span style=color:#666>;</span>

    <span style=color:#408080;font-style:italic>/**
</span><span style=color:#408080;font-style:italic>     * 自测
</span><span style=color:#408080;font-style:italic>     * @throws InterruptedException
</span><span style=color:#408080;font-style:italic>     */</span>
    <span style=color:#a2f>@Test</span>
    <span style=color:#b00040>void</span> <span style=color:#00f>testIDwoker2</span><span style=color:#666>()</span> <span style=color:green;font-weight:700>throws</span> InterruptedException <span style=color:#666>{</span>
        CountDownLatch latch <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> CountDownLatch<span style=color:#666>(</span>300<span style=color:#666>);</span>
        Runnable task<span style=color:#666>=()</span> <span style=color:#666>-&gt;{</span>
            <span style=color:green;font-weight:700>for</span> <span style=color:#666>(</span><span style=color:#b00040>int</span> i <span style=color:#666>=</span> 0<span style=color:#666>;</span> i <span style=color:#666>&lt;</span>100 <span style=color:#666>;</span> i<span style=color:#666>++)</span> <span style=color:#666>{</span>
                <span style=color:#b00040>long</span> id <span style=color:#666>=</span> redisIdWorker2<span style=color:#666>.</span><span style=color:#7d9029>nextId</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;order&#34;</span><span style=color:#666>);</span>
                System<span style=color:#666>.</span><span style=color:#7d9029>out</span><span style=color:#666>.</span><span style=color:#7d9029>println</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;id=&#34;</span><span style=color:#666>+</span>id<span style=color:#666>);</span>
            <span style=color:#666>}</span>
            latch<span style=color:#666>.</span><span style=color:#7d9029>countDown</span><span style=color:#666>();</span>
        <span style=color:#666>};</span>
        <span style=color:#b00040>long</span> begin <span style=color:#666>=</span> System<span style=color:#666>.</span><span style=color:#7d9029>currentTimeMillis</span><span style=color:#666>();</span>
        <span style=color:green;font-weight:700>for</span> <span style=color:#666>(</span><span style=color:#b00040>int</span> i <span style=color:#666>=</span> 0<span style=color:#666>;</span> i <span style=color:#666>&lt;</span>300 <span style=color:#666>;</span> i<span style=color:#666>++)</span> <span style=color:#666>{</span>
            es<span style=color:#666>.</span><span style=color:#7d9029>submit</span><span style=color:#666>(</span>task<span style=color:#666>);</span>
        <span style=color:#666>}</span>
      latch<span style=color:#666>.</span><span style=color:#7d9029>await</span><span style=color:#666>();</span>
        <span style=color:#b00040>long</span> end <span style=color:#666>=</span> System<span style=color:#666>.</span><span style=color:#7d9029>currentTimeMillis</span><span style=color:#666>();</span>
        System<span style=color:#666>.</span><span style=color:#7d9029>out</span><span style=color:#666>.</span><span style=color:#7d9029>println</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;time=&#34;</span><span style=color:#666>+(</span>end<span style=color:#666>-</span>begin<span style=color:#666>));</span>
    <span style=color:#666>}</span>
    
</code></pre></div><h3 id=总结生成订单号>总结生成订单号<a href=#总结生成订单号 class=header-anchor arialabel=Anchor> #</a></h3><blockquote><p>1.利用8个字节，64个bits :0+31时间戳+32序列hao</p><p>2.利用时间戳，利用天数的自增长做序号</p><p>3.做位运算实现拼接</p></blockquote><h3 id=33-添加优惠卷>3.3 添加优惠卷<a href=#33-添加优惠卷 class=header-anchor arialabel=Anchor> #</a></h3><p>每个店铺都可以发布优惠券，分为平价券和特价券。平价券可以任意购买，而特价券需要秒杀抢购：</p><p>tb_voucher：优惠券的基本信息，优惠金额、使用规则等
tb_seckill_voucher：优惠券的库存、开始抢购时间，结束抢购时间。特价优惠券才需要填写这些信息</p><p>平价卷由于优惠力度并不是很大，所以是可以任意领取</p><p>而代金券由于优惠力度大，所以像第二种卷，就得限制数量，从表结构上也能看出，特价卷除了具有优惠卷的基本信息以外，还具有库存，抢购时间，结束时间等等字段</p><blockquote><blockquote><blockquote><p>接下来我们来看@TableField(exist=false)的作用</p><p>比如在实体类中有一个属性为remark，但是在数据库中没有这个字段，但是在执行插入操作时给实体类的remark属性赋值了，那么可以通过在实体类的remark属性上添加</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@TableField</span><span style=color:#666>(</span>exist<span style=color:#666>=</span><span style=color:green;font-weight:700>false</span><span style=color:#666>)</span>
<span style=color:green;font-weight:700>private</span> String remark<span style=color:#666>;</span>
</code></pre></div></blockquote></blockquote></blockquote><p>**新增普通卷代码： **VoucherController</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@PostMapping</span>
<span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>addVoucher</span><span style=color:#666>(</span><span style=color:#a2f>@RequestBody</span> Voucher voucher<span style=color:#666>)</span> <span style=color:#666>{</span>
    voucherService<span style=color:#666>.</span><span style=color:#7d9029>save</span><span style=color:#666>(</span>voucher<span style=color:#666>);</span>
    <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>voucher<span style=color:#666>.</span><span style=color:#7d9029>getId</span><span style=color:#666>());</span>
<span style=color:#666>}</span>
</code></pre></div><p><strong>新增秒杀卷代码：</strong></p><p><strong>VoucherController</strong></p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@PostMapping</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;seckill&#34;</span><span style=color:#666>)</span>
<span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>addSeckillVoucher</span><span style=color:#666>(</span><span style=color:#a2f>@RequestBody</span> Voucher voucher<span style=color:#666>)</span> <span style=color:#666>{</span>
    voucherService<span style=color:#666>.</span><span style=color:#7d9029>addSeckillVoucher</span><span style=color:#666>(</span>voucher<span style=color:#666>);</span>
    <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>voucher<span style=color:#666>.</span><span style=color:#7d9029>getId</span><span style=color:#666>());</span>
<span style=color:#666>}</span>
</code></pre></div><p><strong>VoucherServiceImpl</strong></p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@Override</span>
<span style=color:#a2f>@Transactional</span>
<span style=color:green;font-weight:700>public</span> <span style=color:#b00040>void</span> <span style=color:#00f>addSeckillVoucher</span><span style=color:#666>(</span>Voucher voucher<span style=color:#666>)</span> <span style=color:#666>{</span>
    <span style=color:#408080;font-style:italic>// 保存优惠券
</span><span style=color:#408080;font-style:italic></span>    save<span style=color:#666>(</span>voucher<span style=color:#666>);</span>
    <span style=color:#408080;font-style:italic>// 保存秒杀信息
</span><span style=color:#408080;font-style:italic></span>    SeckillVoucher seckillVoucher <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> SeckillVoucher<span style=color:#666>();</span>
    seckillVoucher<span style=color:#666>.</span><span style=color:#7d9029>setVoucherId</span><span style=color:#666>(</span>voucher<span style=color:#666>.</span><span style=color:#7d9029>getId</span><span style=color:#666>());</span>
    seckillVoucher<span style=color:#666>.</span><span style=color:#7d9029>setStock</span><span style=color:#666>(</span>voucher<span style=color:#666>.</span><span style=color:#7d9029>getStock</span><span style=color:#666>());</span>
    seckillVoucher<span style=color:#666>.</span><span style=color:#7d9029>setBeginTime</span><span style=color:#666>(</span>voucher<span style=color:#666>.</span><span style=color:#7d9029>getBeginTime</span><span style=color:#666>());</span>
    seckillVoucher<span style=color:#666>.</span><span style=color:#7d9029>setEndTime</span><span style=color:#666>(</span>voucher<span style=color:#666>.</span><span style=color:#7d9029>getEndTime</span><span style=color:#666>());</span>
    seckillVoucherService<span style=color:#666>.</span><span style=color:#7d9029>save</span><span style=color:#666>(</span>seckillVoucher<span style=color:#666>);</span>
    <span style=color:#408080;font-style:italic>// 保存秒杀库存到Redis中
</span><span style=color:#408080;font-style:italic></span>    stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>().</span><span style=color:#7d9029>set</span><span style=color:#666>(</span>SECKILL_STOCK_KEY <span style=color:#666>+</span> voucher<span style=color:#666>.</span><span style=color:#7d9029>getId</span><span style=color:#666>(),</span> voucher<span style=color:#666>.</span><span style=color:#7d9029>getStock</span><span style=color:#666>().</span><span style=color:#7d9029>toString</span><span style=color:#666>());</span>
<span style=color:#666>}</span>
</code></pre></div><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span>#</span>利用postman做增加优惠券
post    http<span style=color:#666>:</span><span style=color:#408080;font-style:italic>//localhost:8081/voucher/seckill
</span><span style=color:#408080;font-style:italic></span><span style=color:#666>{</span>
    <span style=color:#ba2121>&#34;shopId&#34;</span><span style=color:#666>:</span>1<span style=color:#666>,</span>
    <span style=color:#ba2121>&#34;title&#34;</span><span style=color:#666>:</span><span style=color:#ba2121>&#34;3300秒杀&#34;</span><span style=color:#666>,</span>
    <span style=color:#ba2121>&#34;subTitle&#34;</span><span style=color:#666>:</span><span style=color:#ba2121>&#34;周1&#34;</span><span style=color:#666>,</span>
     <span style=color:#ba2121>&#34;rules&#34;</span><span style=color:#666>:</span><span style=color:#ba2121>&#34;全场通用&#34;</span><span style=color:#666>,</span>
      <span style=color:#ba2121>&#34;payValue&#34;</span><span style=color:#666>:</span>8000<span style=color:#666>,</span>
       <span style=color:#ba2121>&#34;actualValue&#34;</span><span style=color:#666>:</span>10000<span style=color:#666>,</span>
        <span style=color:#ba2121>&#34;type&#34;</span><span style=color:#666>:</span>1<span style=color:#666>,</span>
         <span style=color:#ba2121>&#34;stock&#34;</span><span style=color:#666>:</span>200<span style=color:#666>,</span>
         <span style=color:#ba2121>&#34;beginTime&#34;</span><span style=color:#666>:</span><span style=color:#ba2121>&#34;2022-11-10T10:09:17&#34;</span><span style=color:#666>,</span>
         <span style=color:#ba2121>&#34;endTime&#34;</span><span style=color:#666>:</span><span style=color:#ba2121>&#34;2022-12-01T14:09:17&#34;</span>
<span style=color:#666>}</span>
注意这个endtime要长于你的真实事件<span>，</span>不然不显示
</code></pre></div><h3 id=34-实现秒杀下单>3.4 实现秒杀下单<a href=#34-实现秒杀下单 class=header-anchor arialabel=Anchor> #</a></h3><p>下单时需要判断两点：</p><ul><li>秒杀是否开始或结束，如果尚未开始或已经结束则无法下单</li><li>库存是否充足，不足则无法下单</li></ul><p>下单核心逻辑分析：</p><p>当用户开始进行下单，我们应当去查询优惠卷信息，查询到优惠卷信息，判断是否满足秒杀条件</p><p>比如时间是否充足，如果时间充足，则进一步判断库存是否足够，如果两者都满足，则扣减库存，创建订单，然后返回订单id，如果有一个条件不满足则直接结束。</p><p><img src=https://img-blog.csdnimg.cn/72da0c7288f34879a338213f65cd4703.png#pic_center alt=在这里插入图片描述></p><p>VoucherOrderServiceImpl</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@Override</span>
<span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>seckillVoucher</span><span style=color:#666>(</span>Long voucherId<span style=color:#666>)</span> <span style=color:#666>{</span>
    <span style=color:#408080;font-style:italic>// 1.查询优惠券
</span><span style=color:#408080;font-style:italic></span>    SeckillVoucher voucher <span style=color:#666>=</span> seckillVoucherService<span style=color:#666>.</span><span style=color:#7d9029>getById</span><span style=color:#666>(</span>voucherId<span style=color:#666>);</span>
    <span style=color:#408080;font-style:italic>// 2.判断秒杀是否开始
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>voucher<span style=color:#666>.</span><span style=color:#7d9029>getBeginTime</span><span style=color:#666>().</span><span style=color:#7d9029>isAfter</span><span style=color:#666>(</span>LocalDateTime<span style=color:#666>.</span><span style=color:#7d9029>now</span><span style=color:#666>()))</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 尚未开始
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;秒杀尚未开始！&#34;</span><span style=color:#666>);</span>
    <span style=color:#666>}</span>
    <span style=color:#408080;font-style:italic>// 3.判断秒杀是否已经结束
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>voucher<span style=color:#666>.</span><span style=color:#7d9029>getEndTime</span><span style=color:#666>().</span><span style=color:#7d9029>isBefore</span><span style=color:#666>(</span>LocalDateTime<span style=color:#666>.</span><span style=color:#7d9029>now</span><span style=color:#666>()))</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 尚未开始
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;秒杀已经结束！&#34;</span><span style=color:#666>);</span>
    <span style=color:#666>}</span>
    <span style=color:#408080;font-style:italic>// 4.判断库存是否充足
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>voucher<span style=color:#666>.</span><span style=color:#7d9029>getStock</span><span style=color:#666>()</span> <span style=color:#666>&lt;</span> 1<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 库存不足
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;库存不足！&#34;</span><span style=color:#666>);</span>
    <span style=color:#666>}</span>
    <span style=color:#408080;font-style:italic>//5，扣减库存
</span><span style=color:#408080;font-style:italic></span>    <span style=color:#b00040>boolean</span> success <span style=color:#666>=</span> seckillVoucherService<span style=color:#666>.</span><span style=color:#7d9029>update</span><span style=color:#666>()</span>
            <span style=color:#666>.</span><span style=color:#7d9029>setSql</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;stock= stock -1&#34;</span><span style=color:#666>)</span>
            <span style=color:#666>.</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;voucher_id&#34;</span><span style=color:#666>,</span> voucherId<span style=color:#666>).</span><span style=color:#7d9029>update</span><span style=color:#666>();</span>
    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(!</span>success<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>//扣减库存
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;库存不足！&#34;</span><span style=color:#666>);</span>
    <span style=color:#666>}</span>
    <span style=color:#408080;font-style:italic>//6.创建订单
</span><span style=color:#408080;font-style:italic></span>    VoucherOrder voucherOrder <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> VoucherOrder<span style=color:#666>();</span>
    <span style=color:#408080;font-style:italic>// 6.1.订单id
</span><span style=color:#408080;font-style:italic></span>    <span style=color:#b00040>long</span> orderId <span style=color:#666>=</span> redisIdWorker<span style=color:#666>.</span><span style=color:#7d9029>nextId</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;order&#34;</span><span style=color:#666>);</span>
    voucherOrder<span style=color:#666>.</span><span style=color:#7d9029>setId</span><span style=color:#666>(</span>orderId<span style=color:#666>);</span>
    <span style=color:#408080;font-style:italic>// 6.2.用户id
</span><span style=color:#408080;font-style:italic></span>    Long userId <span style=color:#666>=</span> UserHolder<span style=color:#666>.</span><span style=color:#7d9029>getUser</span><span style=color:#666>().</span><span style=color:#7d9029>getId</span><span style=color:#666>();</span>
    voucherOrder<span style=color:#666>.</span><span style=color:#7d9029>setUserId</span><span style=color:#666>(</span>userId<span style=color:#666>);</span>
    <span style=color:#408080;font-style:italic>// 6.3.代金券id
</span><span style=color:#408080;font-style:italic></span>    voucherOrder<span style=color:#666>.</span><span style=color:#7d9029>setVoucherId</span><span style=color:#666>(</span>voucherId<span style=color:#666>);</span>
    save<span style=color:#666>(</span>voucherOrder<span style=color:#666>);</span>

    <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>orderId<span style=color:#666>);</span>

<span style=color:#666>}</span>
</code></pre></div><h3 id=35-库存超卖问题分析>3.5 库存超卖问题分析<a href=#35-库存超卖问题分析 class=header-anchor arialabel=Anchor> #</a></h3><p>有关超卖问题分析：在我们原有代码中是这么写的</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>voucher<span style=color:#666>.</span><span style=color:#7d9029>getStock</span><span style=color:#666>()</span> <span style=color:#666>&lt;</span> 1<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 库存不足
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;库存不足！&#34;</span><span style=color:#666>);</span>
    <span style=color:#666>}</span>
    <span style=color:#408080;font-style:italic>//5，扣减库存
</span><span style=color:#408080;font-style:italic></span>    <span style=color:#b00040>boolean</span> success <span style=color:#666>=</span> seckillVoucherService<span style=color:#666>.</span><span style=color:#7d9029>update</span><span style=color:#666>()</span>
            <span style=color:#666>.</span><span style=color:#7d9029>setSql</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;stock= stock -1&#34;</span><span style=color:#666>)</span>
            <span style=color:#666>.</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;voucher_id&#34;</span><span style=color:#666>,</span> voucherId<span style=color:#666>).</span><span style=color:#7d9029>update</span><span style=color:#666>();</span>
    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(!</span>success<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>//扣减库存
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;库存不足！&#34;</span><span style=color:#666>);</span>
    <span style=color:#666>}</span>
</code></pre></div><p>假设线程1过来查询库存，判断出来库存大于1，正准备去扣减库存，但是还没有来得及去扣减，此时线程2过来，线程2也去查询库存，发现这个数量一定也大于1，那么这两个线程都会去扣减库存，最终多个线程相当于一起去扣减库存，此时就会出现库存的超卖问题。</p><p><img src=https://img-blog.csdnimg.cn/f89ad52a72b64daca4e9357af9033840.png#pic_center alt=在这里插入图片描述></p><p><img src=https://img-blog.csdnimg.cn/353b7dd46a004d51b52a75af9063cc40.png#pic_center alt=在这里插入图片描述></p><p>超卖问题是典型的多线程安全问题，针对这一问题的常见解决方案就是加锁：而对于加锁，我们通常有两种解决方案：见下图：</p><p><strong>悲观锁：</strong></p><blockquote><p>悲观锁可以实现对于数据的串行化执行， Synchronized、Lock 都属于悲观锁都是悲观锁的代表，同时，悲观锁中又可以再细分为公平锁，非公平锁，可重入锁，等等</p></blockquote><p><strong>乐观锁：</strong></p><blockquote><p>认为线程安全问题不一定会发生，因此不加锁，只是在更新数据时去判断有没有其它线程对数据做了修改。如果没有修改则认为是安全的，自己才更新数据。</p><p>如果已经被其它线程修改说明发生了安全问题，此时可以重试或异常</p><p>乐观锁的关键是判断之前查询得到的数据是否有被修改过，常见的处理方式有两种：版本号 和 CAS</p></blockquote><blockquote><p>乐观锁：会有一个版本号，每次操作数据会对版本号+1，再提交回数据时，会去校验是否比之前的版本大1 ，如果大1 ，则进行操作成功，这套机制的核心逻辑在于，如果在操作过程中，版本号只比原来大1 ，那么就意味着操作过程中没有人对他进行过修改，他的操作就是安全的，如果不大1，则数据被修改过，当然乐观锁还有一些变种的处理方式比如cas</p></blockquote><blockquote><p>CAS是英文单词<code>Compare And Swap</code>的缩写，翻译过来就是<strong>比较并替换</strong>。
CAS机制当中使用了3个基本操作数：内存地址V，旧的预期值A，要修改的新值B。
更新一个变量的时候，只有当变量的预期值A和内存地址V当中的实际值相同时，才会将内存地址V对应的值修改为B。</p></blockquote><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#b00040>int</span> var5<span style=color:#666>;</span>
<span style=color:green;font-weight:700>do</span> <span style=color:#666>{</span>
    var5 <span style=color:#666>=</span> <span style=color:green;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#7d9029>getIntVolatile</span><span style=color:#666>(</span>var1<span style=color:#666>,</span> var2<span style=color:#666>);</span>
<span style=color:#666>}</span> <span style=color:green;font-weight:700>while</span><span style=color:#666>(!</span><span style=color:green;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#7d9029>compareAndSwapInt</span><span style=color:#666>(</span>var1<span style=color:#666>,</span> var2<span style=color:#666>,</span> var5<span style=color:#666>,</span> var5 <span style=color:#666>+</span> var4<span style=color:#666>));</span>

<span style=color:green;font-weight:700>return</span> var5<span style=color:#666>;</span>
</code></pre></div><p><strong>课程中的使用方式：</strong></p><p>课程中的使用方式是没有像cas一样带自旋的操作，也没有对version的版本号+1 ，他的操作逻辑是在操作时，对版本号进行+1 操作，然后要求version 如果是1 的情况下，才能操作，那么第一个线程在操作后，数据库中的version变成了2，但是他自己满足version=1 ，所以没有问题，此时线程2执行，线程2 最后也需要加上条件version =1 ，但是现在由于线程1已经操作过了，所以线程2，操作时就不满足version=1 的条件了，所以线程2无法执行成功</p><blockquote><p>给数据添加一个 version，当该数据被修改时，version 数值就会被加一。</p><p>比如下图的情况：线程一修改过数据，version 已经变成了 2；线程二再去查找 version，发现已经不为 1 了，不会再修改数据了。</p></blockquote><p><img src=https://img-blog.csdnimg.cn/247913db761a40aab2b447c1e8918863.png#pic_center alt=在这里插入图片描述></p><h3 id=36-乐观锁解决超卖问题>3.6 乐观锁解决超卖问题<a href=#36-乐观锁解决超卖问题 class=header-anchor arialabel=Anchor> #</a></h3><p><strong>修改代码方案一、</strong></p><p>VoucherOrderServiceImpl 在扣减库存时，改为：</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#b00040>boolean</span> success <span style=color:#666>=</span> seckillVoucherService<span style=color:#666>.</span><span style=color:#7d9029>update</span><span style=color:#666>()</span>
            <span style=color:#666>.</span><span style=color:#7d9029>setSql</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;stock= stock -1&#34;</span><span style=color:#666>)</span> <span style=color:#408080;font-style:italic>//set stock = stock -1
</span><span style=color:#408080;font-style:italic></span>            <span style=color:#666>.</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;voucher_id&#34;</span><span style=color:#666>,</span> voucherId<span style=color:#666>).</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;stock&#34;</span><span style=color:#666>,</span>voucher<span style=color:#666>.</span><span style=color:#7d9029>getStock</span><span style=color:#666>()).</span><span style=color:#7d9029>update</span><span style=color:#666>();</span> <span style=color:#408080;font-style:italic>//where id = ？ and stock = ?
</span></code></pre></div><p>以上逻辑的核心含义是：只要我扣减库存时的库存和之前我查询到的库存是一样的，就意味着没有人在中间修改过库存，那么此时就是安全的，但是以上这种方式通过测试发现会有很多失败的情况，失败的原因在于：在使用乐观锁过程中假设100个线程同时都拿到了100的库存，然后大家一起去进行扣减，但是100个人中只有1个人能扣减成功，其他的人在处理时，他们在扣减时，库存已经被修改过了，所以此时其他线程都会失败</p><p><strong>修改代码方案二、</strong></p><p>之前的方式要修改前后都保持一致，但是这样我们分析过，成功的概率太低，所以我们的乐观锁需要变一下，改成stock大于0 即可</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#b00040>boolean</span> success <span style=color:#666>=</span> seckillVoucherService<span style=color:#666>.</span><span style=color:#7d9029>update</span><span style=color:#666>()</span>
            <span style=color:#666>.</span><span style=color:#7d9029>setSql</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;stock= stock -1&#34;</span><span style=color:#666>)</span>
            <span style=color:#666>.</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;voucher_id&#34;</span><span style=color:#666>,</span> voucherId<span style=color:#666>).</span><span style=color:#7d9029>update</span><span style=color:#666>().</span><span style=color:#7d9029>gt</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;stock&#34;</span><span style=color:#666>,</span>0<span style=color:#666>);</span> <span style=color:#408080;font-style:italic>//where id = ? and stock &gt; 0
</span></code></pre></div><p><strong>知识小扩展：</strong></p><blockquote><p>针对cas中的自旋压力过大，我们可以使用Longaddr这个类去解决</p><p>Java8 提供的一个对AtomicLong改进后的一个类，LongAdder</p><p>大量线程并发更新一个原子性的时候，天然的问题就是自旋，会导致并发性问题，当然这也比我们直接使用syn来的好</p><p>所以利用这么一个类，LongAdder来进行优化</p><p>如果获取某个值，则会对cell和base的值进行递增，最后返回一个完整的值</p></blockquote><p><img src=.%5CRedis%E5%AE%9E%E6%88%98%E7%AF%87.assets%5C1653370271627.png alt=1653370271627></p><blockquote><p>CAS的缺点：</p><p>1.CPU开销较大
在并发量比较高的情况下，如果许多线程反复尝试更新某一个变量，却又一直更新不成功，循环往复，会给CPU带来很大的压力。</p><p>2.不能保证代码块的原子性
CAS机制所保证的只是一个变量的原子性操作，而不能保证整个代码块的原子性。比如需要保证3个变量共同进行原子性的更新，就不得不使用Synchronized了。</p></blockquote><h3 id=36-优惠券秒杀-一人一单>3.6 优惠券秒杀-一人一单<a href=#36-优惠券秒杀-一人一单 class=header-anchor arialabel=Anchor> #</a></h3><p>需求：修改秒杀业务，要求同一个优惠券，一个用户只能下一单</p><p><strong>现在的问题在于：</strong></p><p>优惠卷是为了引流，但是目前的情况是，一个人可以无限制的抢这个优惠卷，所以我们应当增加一层逻辑，让一个用户只能下一个单，而不是让一个用户下多个单</p><p>具体操作逻辑如下：比如时间是否充足，如果时间充足，则进一步判断库存是否足够，然后再根据优惠卷id和用户id查询是否已经下过这个订单，如果下过这个订单，则不再下单，否则进行下单</p><p><img src=https://itsawaysu.oss-cn-shanghai.aliyuncs.com/note/%E4%B8%80%E4%BA%BA%E4%B8%80%E5%8D%95.jpg alt=一人一单></p><p>VoucherOrderServiceImpl</p><p><strong>初步代码：增加一人一单逻辑</strong></p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@Override</span>
<span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>seckillVoucher</span><span style=color:#666>(</span>Long voucherId<span style=color:#666>)</span> <span style=color:#666>{</span>
    <span style=color:#408080;font-style:italic>// 1.查询优惠券
</span><span style=color:#408080;font-style:italic></span>    SeckillVoucher voucher <span style=color:#666>=</span> seckillVoucherService<span style=color:#666>.</span><span style=color:#7d9029>getById</span><span style=color:#666>(</span>voucherId<span style=color:#666>);</span>
    <span style=color:#408080;font-style:italic>// 2.判断秒杀是否开始
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>voucher<span style=color:#666>.</span><span style=color:#7d9029>getBeginTime</span><span style=color:#666>().</span><span style=color:#7d9029>isAfter</span><span style=color:#666>(</span>LocalDateTime<span style=color:#666>.</span><span style=color:#7d9029>now</span><span style=color:#666>()))</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 尚未开始
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;秒杀尚未开始！&#34;</span><span style=color:#666>);</span>
    <span style=color:#666>}</span>
    <span style=color:#408080;font-style:italic>// 3.判断秒杀是否已经结束
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>voucher<span style=color:#666>.</span><span style=color:#7d9029>getEndTime</span><span style=color:#666>().</span><span style=color:#7d9029>isBefore</span><span style=color:#666>(</span>LocalDateTime<span style=color:#666>.</span><span style=color:#7d9029>now</span><span style=color:#666>()))</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 尚未开始
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;秒杀已经结束！&#34;</span><span style=color:#666>);</span>
    <span style=color:#666>}</span>
    <span style=color:#408080;font-style:italic>// 4.判断库存是否充足
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>voucher<span style=color:#666>.</span><span style=color:#7d9029>getStock</span><span style=color:#666>()</span> <span style=color:#666>&lt;</span> 1<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 库存不足
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;库存不足！&#34;</span><span style=color:#666>);</span>
    <span style=color:#666>}</span>
    <span style=color:#408080;font-style:italic>// 5.一人一单逻辑
</span><span style=color:#408080;font-style:italic></span>    <span style=color:#408080;font-style:italic>// 5.1.用户id
</span><span style=color:#408080;font-style:italic></span>    Long userId <span style=color:#666>=</span> UserHolder<span style=color:#666>.</span><span style=color:#7d9029>getUser</span><span style=color:#666>().</span><span style=color:#7d9029>getId</span><span style=color:#666>();</span>
    <span style=color:#b00040>int</span> count <span style=color:#666>=</span> query<span style=color:#666>().</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;user_id&#34;</span><span style=color:#666>,</span> userId<span style=color:#666>).</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;voucher_id&#34;</span><span style=color:#666>,</span> voucherId<span style=color:#666>).</span><span style=color:#7d9029>count</span><span style=color:#666>();</span>
    <span style=color:#408080;font-style:italic>// 5.2.判断是否存在
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>count <span style=color:#666>&gt;</span> 0<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 用户已经购买过了
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;用户已经购买过一次！&#34;</span><span style=color:#666>);</span>
    <span style=color:#666>}</span>

    <span style=color:#408080;font-style:italic>//6，扣减库存
</span><span style=color:#408080;font-style:italic></span>    <span style=color:#b00040>boolean</span> success <span style=color:#666>=</span> seckillVoucherService<span style=color:#666>.</span><span style=color:#7d9029>update</span><span style=color:#666>()</span>
            <span style=color:#666>.</span><span style=color:#7d9029>setSql</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;stock= stock -1&#34;</span><span style=color:#666>)</span>
            <span style=color:#666>.</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;voucher_id&#34;</span><span style=color:#666>,</span> voucherId<span style=color:#666>).</span><span style=color:#7d9029>update</span><span style=color:#666>();</span>
    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(!</span>success<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>//扣减库存
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;库存不足！&#34;</span><span style=color:#666>);</span>
    <span style=color:#666>}</span>
    <span style=color:#408080;font-style:italic>//7.创建订单
</span><span style=color:#408080;font-style:italic></span>    VoucherOrder voucherOrder <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> VoucherOrder<span style=color:#666>();</span>
    <span style=color:#408080;font-style:italic>// 7.1.订单id
</span><span style=color:#408080;font-style:italic></span>    <span style=color:#b00040>long</span> orderId <span style=color:#666>=</span> redisIdWorker<span style=color:#666>.</span><span style=color:#7d9029>nextId</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;order&#34;</span><span style=color:#666>);</span>
    voucherOrder<span style=color:#666>.</span><span style=color:#7d9029>setId</span><span style=color:#666>(</span>orderId<span style=color:#666>);</span>

    voucherOrder<span style=color:#666>.</span><span style=color:#7d9029>setUserId</span><span style=color:#666>(</span>userId<span style=color:#666>);</span>
    <span style=color:#408080;font-style:italic>// 7.3.代金券id
</span><span style=color:#408080;font-style:italic></span>    voucherOrder<span style=color:#666>.</span><span style=color:#7d9029>setVoucherId</span><span style=color:#666>(</span>voucherId<span style=color:#666>);</span>
    save<span style=color:#666>(</span>voucherOrder<span style=color:#666>);</span>

    <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>orderId<span style=color:#666>);</span>

<span style=color:#666>}</span>
</code></pre></div><p>**存在问题：**高并发的情况下，查询数据库时，都不存在订单，仍然会出现一人多单的情况，仍需加锁。乐观锁比较适合更新操作，此处的插入操作选择悲观锁。</p><p>**注意：**在这里提到了非常多的问题，我们需要慢慢的来思考，首先我们的初始方案是封装了一个createVoucherOrder方法，同时为了确保他线程安全。首先，初始方案是在 createVoucherOrder 方法上添加 synchronized，这样导致锁的粒度过大。</p><p>在seckillVoucher 方法中，添加以下逻辑，这样就能保证事务的特性，同时也控制了锁的粒度</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>synchronized</span> Result <span style=color:#00f>createVoucherOrder</span><span style=color:#666>(</span>Long voucherId<span style=color:#666>)</span> <span style=color:#666>{</span> 
<span style=color:#666>}</span>
</code></pre></div><p>于是选择 “一个用户一把锁” 这样的方案。但是必须先保证 锁是同一把：userId.toString() 方法锁获取到的字符串是不同的对象，底层是 new 出来的，intern() 方法是从常量池里获取数据，保证了同一个用户的 userId.toString() 值相同。</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@Transactional</span>
<span style=color:#a2f>@Override</span>
<span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>createVoucherOrder</span><span style=color:#666>(</span>Long voucherId<span style=color:#666>)</span> <span style=color:#666>{</span>
    Long userId <span style=color:#666>=</span> UserHolder<span style=color:#666>.</span><span style=color:#7d9029>getUser</span><span style=color:#666>().</span><span style=color:#7d9029>getId</span><span style=color:#666>();</span>
  	<span style=color:green;font-weight:700>synchronized</span><span style=color:#666>(</span>userId<span style=color:#666>.</span><span style=color:#7d9029>toString</span><span style=color:#666>().</span><span style=color:#7d9029>intern</span><span style=color:#666>())</span> <span style=color:#666>{</span>
      	<span style=color:#666>...</span>
    <span style=color:#666>}</span>
<span style=color:#666>}</span>
</code></pre></div><p>此外，还需要注意一个点，我们需要将 createVoucherOrder 方法整体包裹起来，确保事务不会出问题；否则会出现 “synchronized 包裹的代码片段执行完毕，事务还未提交，但是锁已经释放了” 的情况。</p><p>但是以上代码还是存在问题，问题的原因在于当前方法被spring的事务控制，如果你在方法内部加锁，可能会导致当前方法事务还没有提交，但是锁已经释放也会导致问题，所以我们选择将当前方法整体包裹起来，确保事务不会出现问题：如下：</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:green;font-weight:700>synchronized</span> <span style=color:#666>(</span>userId<span style=color:#666>.</span><span style=color:#7d9029>toString</span><span style=color:#666>().</span><span style=color:#7d9029>intern</span><span style=color:#666>())</span> <span style=color:#666>{</span>
		<span style=color:green;font-weight:700>return</span> createVoucherOrder<span style=color:#666>(</span>voucherId<span style=color:#666>);</span>
<span style=color:#666>}</span>
</code></pre></div><p>最后，createVoucherOrder 方法实际上是通过 this.createVoucherOrder() 的方式调用的，this 拿到的是原始对象，没有经过动态代理，事务要生效，需要使用代理对象来执行。</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:green;font-weight:700>synchronized</span> <span style=color:#666>(</span>userId<span style=color:#666>.</span><span style=color:#7d9029>toString</span><span style=color:#666>().</span><span style=color:#7d9029>intern</span><span style=color:#666>())</span> <span style=color:#666>{</span>
    <span style=color:#408080;font-style:italic>// 获取代理对象
</span><span style=color:#408080;font-style:italic></span>    VoucherOrderService currentProxy <span style=color:#666>=</span> <span style=color:#666>(</span>VoucherOrderService<span style=color:#666>)</span> AopContext<span style=color:#666>.</span><span style=color:#7d9029>currentProxy</span><span style=color:#666>();</span>
    <span style=color:green;font-weight:700>return</span> currentProxy<span style=color:#666>.</span><span style=color:#7d9029>createVoucherOrder</span><span style=color:#666>(</span>voucherId<span style=color:#666>);</span>
<span style=color:#666>}</span>
</code></pre></div><blockquote><p>终极版本</p></blockquote><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@Override</span>
<span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>seckillVoucher</span><span style=color:#666>(</span>Long voucherId<span style=color:#666>)</span> <span style=color:#666>{</span>
    <span style=color:#408080;font-style:italic>// 1. 根据 优惠券 id 查询数据库
</span><span style=color:#408080;font-style:italic></span>    SeckillVoucher seckillVoucher <span style=color:#666>=</span> seckillVoucherService<span style=color:#666>.</span><span style=color:#7d9029>getById</span><span style=color:#666>(</span>voucherId<span style=color:#666>);</span>
    
  	<span style=color:#408080;font-style:italic>// 2. 判断秒杀是否开始或结束（未开始或已结束，返回异常结果）
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>LocalDateTime<span style=color:#666>.</span><span style=color:#7d9029>now</span><span style=color:#666>().</span><span style=color:#7d9029>isBefore</span><span style=color:#666>(</span>seckillVoucher<span style=color:#666>.</span><span style=color:#7d9029>getBeginTime</span><span style=color:#666>()))</span> <span style=color:#666>{</span>
        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;秒杀尚未开始..&#34;</span><span style=color:#666>);</span>
    <span style=color:#666>}</span>
    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>LocalDateTime<span style=color:#666>.</span><span style=color:#7d9029>now</span><span style=color:#666>().</span><span style=color:#7d9029>isAfter</span><span style=color:#666>(</span>seckillVoucher<span style=color:#666>.</span><span style=color:#7d9029>getEndTime</span><span style=color:#666>()))</span> <span style=color:#666>{</span>
        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;秒杀已经结束..&#34;</span><span style=color:#666>);</span>
    <span style=color:#666>}</span>
  	
    <span style=color:#408080;font-style:italic>// 3. 判断库存是否充足（不充足返回异常结果）
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>seckillVoucher<span style=color:#666>.</span><span style=color:#7d9029>getStock</span><span style=color:#666>()</span> <span style=color:#666>&lt;</span> 1<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;库存不足..&#34;</span><span style=color:#666>);</span>
    <span style=color:#666>}</span>
  	
    Long userId <span style=color:#666>=</span> UserHolder<span style=color:#666>.</span><span style=color:#7d9029>getUser</span><span style=color:#666>().</span><span style=color:#7d9029>getId</span><span style=color:#666>();</span>
    <span style=color:green;font-weight:700>synchronized</span> <span style=color:#666>(</span>userId<span style=color:#666>.</span><span style=color:#7d9029>toString</span><span style=color:#666>().</span><span style=color:#7d9029>intern</span><span style=color:#666>())</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 获取代理对象
</span><span style=color:#408080;font-style:italic></span>        VoucherOrderService currentProxy <span style=color:#666>=</span> <span style=color:#666>(</span>VoucherOrderService<span style=color:#666>)</span> AopContext<span style=color:#666>.</span><span style=color:#7d9029>currentProxy</span><span style=color:#666>();</span>
        <span style=color:green;font-weight:700>return</span> currentProxy<span style=color:#666>.</span><span style=color:#7d9029>createVoucherOrder</span><span style=color:#666>(</span>voucherId<span style=color:#666>);</span>
    <span style=color:#666>}</span>
<span style=color:#666>}</span>

<span style=color:#a2f>@Transactional</span>
<span style=color:#a2f>@Override</span>
<span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>createVoucherOrder</span><span style=color:#666>(</span>Long voucherId<span style=color:#666>)</span> <span style=color:#666>{</span>
    Long userId <span style=color:#666>=</span> UserHolder<span style=color:#666>.</span><span style=color:#7d9029>getUser</span><span style=color:#666>().</span><span style=color:#7d9029>getId</span><span style=color:#666>();</span>
    <span style=color:#408080;font-style:italic>// 4. 一人一单（根据 优惠券id 和 用户id 查询订单；存在，则直接返回）
</span><span style=color:#408080;font-style:italic></span>    Integer count <span style=color:#666>=</span> query<span style=color:#666>().</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;voucher_id&#34;</span><span style=color:#666>,</span> voucherId<span style=color:#666>).</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;user_id&#34;</span><span style=color:#666>,</span> userId<span style=color:#666>).</span><span style=color:#7d9029>count</span><span style=color:#666>();</span>
    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>count <span style=color:#666>&gt;</span> 0<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;不可重复下单！&#34;</span><span style=color:#666>);</span>
    <span style=color:#666>}</span>
  	
    <span style=color:#408080;font-style:italic>// 5. 减扣库存
</span><span style=color:#408080;font-style:italic></span>    <span style=color:#b00040>boolean</span> isAccomplished <span style=color:#666>=</span> seckillVoucherService<span style=color:#666>.</span><span style=color:#7d9029>update</span><span style=color:#666>()</span>
            <span style=color:#408080;font-style:italic>// SET stock= stock - 1
</span><span style=color:#408080;font-style:italic></span>            <span style=color:#666>.</span><span style=color:#7d9029>setSql</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;stock = stock - 1&#34;</span><span style=color:#666>)</span>
            <span style=color:#408080;font-style:italic>// WHERE  voucher_id = ? AND stock &gt; 0
</span><span style=color:#408080;font-style:italic></span>            <span style=color:#666>.</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;voucher_id&#34;</span><span style=color:#666>,</span> voucherId<span style=color:#666>).</span><span style=color:#7d9029>gt</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;stock&#34;</span><span style=color:#666>,</span> 0<span style=color:#666>)</span>
            <span style=color:#666>.</span><span style=color:#7d9029>update</span><span style=color:#666>();</span>
    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(!</span>isAccomplished<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;库存不足..&#34;</span><span style=color:#666>);</span>
    <span style=color:#666>}</span>
  	
    <span style=color:#408080;font-style:italic>// 6. 创建订单
</span><span style=color:#408080;font-style:italic></span>    VoucherOrder voucherOrder <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> VoucherOrder<span style=color:#666>();</span>
    <span style=color:#b00040>long</span> orderId <span style=color:#666>=</span> redisIdWorker<span style=color:#666>.</span><span style=color:#7d9029>nextId</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;order&#34;</span><span style=color:#666>);</span>
    voucherOrder<span style=color:#666>.</span><span style=color:#7d9029>setId</span><span style=color:#666>(</span>orderId<span style=color:#666>);</span>
    voucherOrder<span style=color:#666>.</span><span style=color:#7d9029>setUserId</span><span style=color:#666>(</span>userId<span style=color:#666>);</span>
    voucherOrder<span style=color:#666>.</span><span style=color:#7d9029>setVoucherId</span><span style=color:#666>(</span>voucherId<span style=color:#666>);</span>
    <span style=color:#b00040>boolean</span> isSaved <span style=color:#666>=</span> save<span style=color:#666>(</span>voucherOrder<span style=color:#666>);</span>
    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(!</span>isSaved<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;下单失败..&#34;</span><span style=color:#666>);</span>
    <span style=color:#666>}</span>
  	
    <span style=color:#408080;font-style:italic>// 7. 返回 订单 id
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>orderId<span style=color:#666>);</span>
<span style=color:#666>}</span>

</code></pre></div><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span>#</span>自写
            Long usrId <span style=color:#666>=</span> UserHolder<span style=color:#666>.</span><span style=color:#7d9029>getUser</span><span style=color:#666>().</span><span style=color:#7d9029>getId</span><span style=color:#666>();</span>
        <span style=color:green;font-weight:700>synchronized</span><span style=color:#666>(</span>usrId<span style=color:#666>.</span><span style=color:#7d9029>toString</span><span style=color:#666>().</span><span style=color:#7d9029>intern</span><span style=color:#666>())</span> <span style=color:#666>{</span>
            IVoucherOrderService proxy <span style=color:#666>=</span> <span style=color:#666>(</span>IVoucherOrderService<span style=color:#666>)</span>AopContext<span style=color:#666>.</span><span style=color:#7d9029>currentProxy</span><span style=color:#666>();</span>
            <span style=color:green;font-weight:700>return</span> proxy<span style=color:#666>.</span><span style=color:#7d9029>createVoucherOrder</span><span style=color:#666>(</span>voucherId<span style=color:#666>);</span>
        <span style=color:#666>}</span>
        <span style=color:#408080;font-style:italic>//但是这个时候的事务优点问题调用的是this剩下，拿到当前的oder对象不是代理对象，
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#408080;font-style:italic>// 所以没有事务功能，所以拿到事务的代理对象
</span><span style=color:#408080;font-style:italic></span>同时在pom<span style=color:#666>.</span><span style=color:#7d9029>xml引入依赖</span>
    <span style=color:#666>&lt;!--</span> https<span style=color:#666>:</span><span style=color:#408080;font-style:italic>//mvnrepository.com/artifact/org.aspectj/aspectjweaver --&gt;
</span><span style=color:#408080;font-style:italic></span><span style=color:#666>&lt;</span>dependency<span style=color:#666>&gt;</span>
    <span style=color:#666>&lt;</span>groupId<span style=color:#666>&gt;</span>org<span style=color:#666>.</span><span style=color:#7d9029>aspectj</span><span style=color:#666>&lt;/</span>groupId<span style=color:#666>&gt;</span>
    <span style=color:#666>&lt;</span>artifactId<span style=color:#666>&gt;</span>aspectjweaver<span style=color:#666>&lt;/</span>artifactId<span style=color:#666>&gt;</span>
    <span style=color:#666>&lt;</span>version<span style=color:#666>&gt;</span>1<span style=color:#666>.</span><span style=color:#7d9029>9</span><span style=color:#666>.</span><span style=color:#7d9029>9</span><span style=color:#666>.</span><span style=color:#7d9029>1</span><span style=color:#666>&lt;/</span>version<span style=color:#666>&gt;</span>
    <span style=color:#666>&lt;</span>scope<span style=color:#666>&gt;</span>runtime<span style=color:#666>&lt;/</span>scope<span style=color:#666>&gt;</span>
<span style=color:#666>&lt;/</span>dependency<span style=color:#666>&gt;</span>
<span>#</span> 同时在springboot开注解
<span style=color:#a2f>@EnableAspectJAutoProxy</span><span style=color:#666>(</span>exposeProxy <span style=color:#666>=</span> <span style=color:green;font-weight:700>true</span><span style=color:#666>)</span>
</code></pre></div><p><img src=https://itsawaysu.oss-cn-shanghai.aliyuncs.com/note/%E4%B8%80%E4%BA%BA%E4%B8%80%E5%8D%95%E7%9A%84%E5%B9%B6%E5%8F%91%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98.jpg alt=一人一单的并发安全问题></p><h3 id=总结超卖和一人一单>总结超卖和一人一单<a href=#总结超卖和一人一单 class=header-anchor arialabel=Anchor> #</a></h3><blockquote><p>超卖：</p><blockquote><p>悲观锁一定发生</p><p>乐观锁：认为线程安全不一定会发生因此不加锁，只是在更新数据时去判断有没有其它线程对数据做了修改。如果没有修改则认为是安全的，自己才更新数据。如果已经被其它线程修改说明发生了安全问题，此时可以重试或异常</p><p>乐观锁的关键是判断之前查询得到的数据是否有被修改过，常见的处理方式有两种：版本号 和 CAS</p><p>CAS机制当中使用了3个基本操作数：内存地址V，旧的预期值A，要修改的新值B。
更新一个变量的时候，只有当变量的预期值A和内存地址V当中的实际值相同时，才会将内存地址V对应的值修改为B。</p><p>但是1.CPU开销较大
在并发量比较高的情况下，如果许多线程反复尝试更新某一个变量，却又一直更新不成功，循环往复，会给CPU带来很大的压力。</p><p>2.不能保证代码块的原子性
CAS机制所保证的只是一个变量的原子性操作，而不能保证整个代码块的原子性。比如需要保证3个变量共同进行原子性的更新，就不得不使用Synchronized了。</p></blockquote><ol><li><p>seckillVoucher（Long voucherId） 根据id查询数据库找到秒杀的券，判断时间，库存</p></li><li><p>获得当前用户，进入synchronized锁,</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    Long userId <span style=color:#666>=</span> UserHolder<span style=color:#666>.</span><span style=color:#7d9029>getUser</span><span style=color:#666>().</span><span style=color:#7d9029>getId</span><span style=color:#666>();</span>
    <span style=color:green;font-weight:700>synchronized</span> <span style=color:#666>(</span>userId<span style=color:#666>.</span><span style=color:#7d9029>toString</span><span style=color:#666>().</span><span style=color:#7d9029>intern</span><span style=color:#666>())</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 获取代理对象
</span><span style=color:#408080;font-style:italic></span>        VoucherOrderService currentProxy <span style=color:#666>=</span> <span style=color:#666>(</span>VoucherOrderService<span style=color:#666>)</span> AopContext<span style=color:#666>.</span><span style=color:#7d9029>currentProxy</span><span style=color:#666>();</span>
        <span style=color:green;font-weight:700>return</span> currentProxy<span style=color:#666>.</span><span style=color:#7d9029>createVoucherOrder</span><span style=color:#666>(</span>voucherId<span style=color:#666>);</span>
    <span style=color:#666>}</span>
</code></pre></div><p>(userId.toString() 方法锁获取到的字符串是不同的对象，底层是 new 出来的，intern() 方法是从常量池里获取数据，保证了同一个用户的 userId.toString() 值相同。</p><p>createVoucherOrder 方法实际上是通过 this.createVoucherOrder() 的方式调用的，this 拿到的是原始对象，没有经过动态代理，事务要生效，需要使用代理对象来执行。)</p></li><li><p>调用.createVoucherOrder(voucherId)方法，实现1人1单</p></li><li><p>查询当前用户，找数据库中是否已经存在订单。没有订单开始创建然后返回。</p></li></ol></blockquote><h3 id=37-集群环境下的并发问题>3.7 集群环境下的并发问题<a href=#37-集群环境下的并发问题 class=header-anchor arialabel=Anchor> #</a></h3><p>通过加锁可以解决在单机情况下的一人一单安全问题，但是在集群模式下就不行了。</p><p>1、我们将服务启动两份，端口分别为8081和8082：</p><p>2、然后修改nginx的conf目录下的nginx.conf文件，配置反向代理和负载均衡：</p><p><strong>具体操作(略)</strong></p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span>#</span> 自写
    service找到该项目的<span style=color:#666>/</span>8081 ctrl<span style=color:#666>+</span>d  在VM options输入 <span style=color:#666>-</span>Dserver<span style=color:#666>.</span><span style=color:#7d9029>port</span><span style=color:#666>=</span>8082
    在not start 会找到两个<span>，</span>一起启动形成集群
  一个81 一个80
    
    <span>#</span>修改server之后如上
    注意要把下面两个的注释修改<span>，</span>不然没用
                <span>#</span>proxy_pass http<span style=color:#666>:</span><span style=color:#408080;font-style:italic>//127.0.0.1:8081;
</span><span style=color:#408080;font-style:italic></span>            proxy_pass http<span style=color:#666>:</span><span style=color:#408080;font-style:italic>//backend;
</span><span style=color:#408080;font-style:italic></span>    cmd中加载
    nginx<span style=color:#666>.</span><span style=color:#7d9029>exe</span> <span style=color:#666>-</span>s reload
</code></pre></div><p><strong>有关锁失效原因分析</strong>。</p><p>一人一单的集群环境下的并发安全问题</p><blockquote><p>由于部署了多个 Tomcat，每个 Tomcat 中都有属于自己的 JVM。</p><p>在 服务器A 的 Tomcat 内部，有两个线程，这两个线程使用的是同一份代码，他们的锁对象是同一个，可以实现互斥（线程1 和 线程2）；
在 服务器B 的 Tomcat 内部，有两个线程，这两个线程使用的是同一份代码，他们的锁对象是同一个，可以实现互斥（线程3 和 线程4）；
线程1/2 和 线程3/4 使用的不是同一份代码，锁对象不是同一个，于是线程1/2 与 线程3/4 之间无法实现互斥；导致 synchronized 锁失效，这种情况下就需要 分布式锁 来解决。</p><p>通过加锁可以解决在单机情况下的一人一单安全问题，但是在集群模式下就不行了（<strong>每个jvm都有自己的锁监视器，集群模式下各个服务器的锁不共享</strong>）。
因此，我们的解决方案就是实现一个共享的锁监视器，即：
<strong>分布式锁</strong>：满足分布式系统或集群模式下多进程可见并且互斥的锁。</p></blockquote><p><img src=https://itsawaysu.oss-cn-shanghai.aliyuncs.com/note/%E4%B8%80%E4%BA%BA%E4%B8%80%E5%8D%95%E7%9A%84%E9%9B%86%E7%BE%A4%E7%8E%AF%E5%A2%83%E4%B8%8B%E5%B9%B6%E5%8F%91%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98.jpg alt=一人一单的集群环境下并发的安全问题></p><h2 id=4分布式锁>4、分布式锁<a href=#4分布式锁 class=header-anchor arialabel=Anchor> #</a></h2><h3 id=41-基本原理和实现方式对比>4.1 、基本原理和实现方式对比<a href=#41-基本原理和实现方式对比 class=header-anchor arialabel=Anchor> #</a></h3><blockquote><p>分布式锁：满足分布式系统或集群模式下的多进程可见并互斥的锁。
分布式锁的核心思想：所有线程都使用同一把锁，让程序串行执行。
分布式锁需要满足的条件
可见行：多个线程都能看到相同的结果，也就是感知到变化；
互斥：分布式锁的最基本条件，为了让程序串行执行；
高可用：保证程序不易崩溃；
高性能：加锁本身会让性能降低，因此需要分布式锁具有较高的加锁性能和释放锁性能；
安全性。</p></blockquote><p><img src=https://itsawaysu.oss-cn-shanghai.aliyuncs.com/note/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81.jpg alt=分布式锁></p><p>常见的分布式锁有三种</p><p>常见的分布式锁</p><blockquote><p>MySQL：MySQL 本身带有锁机制，但是由于 MySQL 性能一般，所以采用分布式锁的情况下，使用 MySQL 作为分布式锁比较少见。
Redis：Redis 作为分布式锁比较常见，利用 setnx 方法，如果 Key 插入成功，则表示获取到锁，插入失败则表示无法获取到锁。
Zookeeper：Zookeeper 也是企业级开发中比较好的一个实现分布式锁的方案。</p></blockquote><table><thead><tr><th>MySQL</th><th>Redis</th><th>Zookeeper</th><th></th></tr></thead><tbody><tr><td><strong>互斥</strong></td><td>利用 MySQL 本身的互斥锁机制</td><td>利用 <code>setnx</code> 互斥命令</td><td>利用节点的唯一性和有序性</td></tr><tr><td><strong>高可用</strong></td><td>好</td><td>好</td><td>好</td></tr><tr><td><strong>高性能</strong></td><td>一般</td><td>好</td><td>一般</td></tr><tr><td><strong>安全性</strong></td><td>断开链接，自动释放锁</td><td>利用锁超时时间，到期释放</td><td>临时节点，断开链接自动释放</td></tr></tbody></table><h3 id=42-redis分布式锁的实现核心思路>4.2 、Redis分布式锁的实现核心思路<a href=#42-redis分布式锁的实现核心思路 class=header-anchor arialabel=Anchor> #</a></h3><p>实现分布式锁时需要实现的两个基本方法：</p><ul><li><p>获取锁：</p><ul><li><p>互斥：确保只能有一个线程获取锁</p></li><li><p>非阻塞：尝试一次，成功返回true，失败返回false</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#408080;font-style:italic># 添加锁  NX 互斥 EX 设置超时时间</span>
SET lock thread1 NX EX <span style=color:#666>10</span>
    
</code></pre></div></li></ul></li><li><p>释放锁：</p><ul><li><p>手动释放</p></li><li><p>超时释放：获取锁时添加一个超时时间</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>del key
</code></pre></div></li></ul></li></ul><p>核心思路：</p><p>我们利用redis 的setNx 方法，当有多个线程进入时，我们就利用该方法，第一个线程进入时，redis 中就有这个key 了，返回了1，如果结果是1，则表示他抢到了锁，那么他去执行业务，然后再删除锁，退出锁逻辑，没有抢到锁的哥们，等待一定时间后重试即可</p><p>![基于 Redis 的分布式锁的实现思路](https://itsawaysu.oss-cn-shanghai.aliyuncs.com/note/基于 Redis 的分布式锁的实现思路.jpg)</p><h3 id=43-实现分布式锁版本>4.3 实现分布式锁版本<a href=#43-实现分布式锁版本 class=header-anchor arialabel=Anchor> #</a></h3><ul><li>加锁逻辑</li></ul><p><strong>锁的基本接口</strong></p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>interface</span> <span style=color:#00f;font-weight:700>DistributedLock</span> <span style=color:#666>{</span>
    <span style=color:#408080;font-style:italic>/**
</span><span style=color:#408080;font-style:italic>     * 尝试获取锁
</span><span style=color:#408080;font-style:italic>     * @param timeoutSeconds 锁的超时时间，过期后自动释放
</span><span style=color:#408080;font-style:italic>     * @return true 代表获取锁成功；false 代表获取锁失败
</span><span style=color:#408080;font-style:italic>     */</span>
    <span style=color:#b00040>boolean</span> <span style=color:#00f>tryLock</span><span style=color:#666>(</span><span style=color:#b00040>long</span> timeoutSeconds<span style=color:#666>);</span>

    <span style=color:#408080;font-style:italic>/**
</span><span style=color:#408080;font-style:italic>     * 释放锁
</span><span style=color:#408080;font-style:italic>     */</span>
    <span style=color:#b00040>void</span> <span style=color:#00f>unlock</span><span style=color:#666>();</span>
<span style=color:#666>}</span>

</code></pre></div><p><strong>SimpleRedisLock</strong></p><blockquote><p>利用setnx方法进行加锁，同时增加过期时间，防止死锁，此方法可以保证加锁和增加过期时间具有原子性</p></blockquote><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>SimpleDistributedLockBasedOnRedis</span> <span style=color:green;font-weight:700>implements</span> DistributedLock <span style=color:#666>{</span>
    <span style=color:green;font-weight:700>private</span> String name<span style=color:#666>;</span>
    <span style=color:green;font-weight:700>private</span> StringRedisTemplate stringRedisTemplate<span style=color:#666>;</span>

    <span style=color:green;font-weight:700>public</span> <span style=color:#00f>SimpleDistributedLockBasedOnRedis</span><span style=color:#666>(</span>String name<span style=color:#666>,</span> StringRedisTemplate stringRedisTemplate<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:green;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#7d9029>name</span> <span style=color:#666>=</span> name<span style=color:#666>;</span>
        <span style=color:green;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#7d9029>stringRedisTemplate</span> <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>;</span>
    <span style=color:#666>}</span>

    <span style=color:green;font-weight:700>private</span> <span style=color:green;font-weight:700>static</span> <span style=color:green;font-weight:700>final</span> String KEY_PREFIX <span style=color:#666>=</span> <span style=color:#ba2121>&#34;lock:&#34;</span><span style=color:#666>;</span>

    <span style=color:#a2f>@Override</span>
    <span style=color:green;font-weight:700>public</span> <span style=color:#b00040>boolean</span> <span style=color:#00f>tryLock</span><span style=color:#666>(</span><span style=color:#b00040>long</span> timeoutSeconds<span style=color:#666>)</span> <span style=color:#666>{</span>
        String threadName <span style=color:#666>=</span> Thread<span style=color:#666>.</span><span style=color:#7d9029>currentThread</span><span style=color:#666>().</span><span style=color:#7d9029>getId</span><span style=color:#666>();</span>
        Boolean isSucceeded <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>().</span><span style=color:#7d9029>setIfAbsent</span><span style=color:#666>(</span>KEY_PREFIX <span style=color:#666>+</span> name<span style=color:#666>,</span> threadName<span style=color:#666>,</span> timeoutSeconds<span style=color:#666>,</span> TimeUnit<span style=color:#666>.</span><span style=color:#7d9029>SECONDS</span><span style=color:#666>);</span>
        <span style=color:green;font-weight:700>return</span> Boolean<span style=color:#666>.</span><span style=color:#7d9029>TRUE</span><span style=color:#666>.</span><span style=color:#7d9029>equals</span><span style=color:#666>(</span>isSucceeded<span style=color:#666>);</span>
    <span style=color:#666>}</span>

    <span style=color:#a2f>@Override</span>
    <span style=color:green;font-weight:700>public</span> <span style=color:#b00040>void</span> <span style=color:#00f>unlock</span><span style=color:#666>()</span> <span style=color:#666>{</span>
        stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>delete</span><span style=color:#666>(</span>KEY_PREFIX <span style=color:#666>+</span> name<span style=color:#666>);</span>
    <span style=color:#666>}</span>
<span style=color:#666>}</span>

</code></pre></div><blockquote><p>测试</p><p>将断点打到 “判断是否获取到锁” 处，发送两次 http://localhost:8080/api/voucher-order/seckill/10 请求，第一次请求打到 8081，第二次请求打到 8082。
8081 获取到的 isLocked 为 true，8082 获取到 isLocked 为 false；
Redis 中存储的 Key 为 lock:order:userId，Value 为 http-nio-8081-exec-1。</p></blockquote><ul><li>修改业务代码</li></ul><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#a2f>@Override</span>
    <span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>seckillVoucher</span><span style=color:#666>(</span>Long voucherId<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 1.查询优惠券
</span><span style=color:#408080;font-style:italic></span>        SeckillVoucher voucher <span style=color:#666>=</span> seckillVoucherService<span style=color:#666>.</span><span style=color:#7d9029>getById</span><span style=color:#666>(</span>voucherId<span style=color:#666>);</span>
        <span style=color:#408080;font-style:italic>// 2.判断秒杀是否开始
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>voucher<span style=color:#666>.</span><span style=color:#7d9029>getBeginTime</span><span style=color:#666>().</span><span style=color:#7d9029>isAfter</span><span style=color:#666>(</span>LocalDateTime<span style=color:#666>.</span><span style=color:#7d9029>now</span><span style=color:#666>()))</span> <span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>// 尚未开始
</span><span style=color:#408080;font-style:italic></span>            <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;秒杀尚未开始！&#34;</span><span style=color:#666>);</span>
        <span style=color:#666>}</span>
        <span style=color:#408080;font-style:italic>// 3.判断秒杀是否已经结束
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>voucher<span style=color:#666>.</span><span style=color:#7d9029>getEndTime</span><span style=color:#666>().</span><span style=color:#7d9029>isBefore</span><span style=color:#666>(</span>LocalDateTime<span style=color:#666>.</span><span style=color:#7d9029>now</span><span style=color:#666>()))</span> <span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>// 尚未开始
</span><span style=color:#408080;font-style:italic></span>            <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;秒杀已经结束！&#34;</span><span style=color:#666>);</span>
        <span style=color:#666>}</span>
        <span style=color:#408080;font-style:italic>// 4.判断库存是否充足
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>voucher<span style=color:#666>.</span><span style=color:#7d9029>getStock</span><span style=color:#666>()</span> <span style=color:#666>&lt;</span> 1<span style=color:#666>)</span> <span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>// 库存不足
</span><span style=color:#408080;font-style:italic></span>            <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;库存不足！&#34;</span><span style=color:#666>);</span>
        <span style=color:#666>}</span>
        Long userId <span style=color:#666>=</span> UserHolder<span style=color:#666>.</span><span style=color:#7d9029>getUser</span><span style=color:#666>().</span><span style=color:#7d9029>getId</span><span style=color:#666>();</span>
        <span style=color:#408080;font-style:italic>//创建锁对象(新增代码)
</span><span style=color:#408080;font-style:italic></span>        SimpleRedisLock lock <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> SimpleRedisLock<span style=color:#666>(</span><span style=color:#ba2121>&#34;order:&#34;</span> <span style=color:#666>+</span> userId<span style=color:#666>,</span> stringRedisTemplate<span style=color:#666>);</span>
        <span style=color:#408080;font-style:italic>//获取锁对象
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#b00040>boolean</span> isLock <span style=color:#666>=</span> lock<span style=color:#666>.</span><span style=color:#7d9029>tryLock</span><span style=color:#666>(</span>1200<span style=color:#666>);</span>
		<span style=color:#408080;font-style:italic>//加锁失败
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(!</span>isLock<span style=color:#666>)</span> <span style=color:#666>{</span>
            <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;不允许重复下单&#34;</span><span style=color:#666>);</span>
        <span style=color:#666>}</span>
        <span style=color:green;font-weight:700>try</span> <span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>//获取代理对象(事务)
</span><span style=color:#408080;font-style:italic></span>            IVoucherOrderService proxy <span style=color:#666>=</span> <span style=color:#666>(</span>IVoucherOrderService<span style=color:#666>)</span> AopContext<span style=color:#666>.</span><span style=color:#7d9029>currentProxy</span><span style=color:#666>();</span>
            <span style=color:green;font-weight:700>return</span> proxy<span style=color:#666>.</span><span style=color:#7d9029>createVoucherOrder</span><span style=color:#666>(</span>voucherId<span style=color:#666>);</span>
        <span style=color:#666>}</span> <span style=color:green;font-weight:700>finally</span> <span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>//释放锁
</span><span style=color:#408080;font-style:italic></span>            lock<span style=color:#666>.</span><span style=color:#7d9029>unlock</span><span style=color:#666>();</span>
        <span style=color:#666>}</span>
    <span style=color:#666>}</span>
</code></pre></div><blockquote><p>将rediss锁代替悲观锁</p></blockquote><h3 id=44-redis分布式锁误删情况说明>4.4 Redis分布式锁误删情况说明<a href=#44-redis分布式锁误删情况说明 class=header-anchor arialabel=Anchor> #</a></h3><p>逻辑说明：</p><blockquote><p>线程1 获取到锁，持有锁的线程碰到了业务阻塞，业务阻塞的时间超过了该锁的超时时间，触发锁的超时释放。
此时，线程2 获取到锁，执行业务；在线程2 执行业务的过程中，线程1 的业务执行完毕并且释放锁，但是释放的是线程2 的锁。
之后，线程3 获取到锁，执行业务；导致此时有两个线程同时在并行执行业务。</p></blockquote><p>![Redis 分布式锁的误删问题](https://itsawaysu.oss-cn-shanghai.aliyuncs.com/note/Redis 分布式锁的误删问题.jpg)</p><p>解决方案：</p><blockquote><p>解决方案：在每个线程释放锁的时候，需要判断一下当前这把锁是否属于自己，如果不属于自己，就不会进行锁的释放（删除）。</p><p>线程1 获取到锁，持有锁的线程碰到了业务阻塞，业务阻塞的时间超过了该锁的超时时间，触发锁的超时释放。
此时，线程2 获取到锁，执行业务；在线程2 执行业务的过程中，线程1 的业务执行完毕并且释放锁，但是此时线程1 需要判断当前这把锁是否属于自己，不属于则不会删除锁。于是线程2 一直持有这把锁直至其业务执行结束后才会释放，并且在释放的时候也需要判断当前要释放的锁是否属于自己。
之后，线程3 获取到锁，执行业务。</p></blockquote><p>![解决Redis 分布式锁误删问题](https://itsawaysu.oss-cn-shanghai.aliyuncs.com/note/解决Redis 分布式锁误删问题.jpg)</p><h3 id=45-解决redis分布式锁误删问题>4.5 解决Redis分布式锁误删问题<a href=#45-解决redis分布式锁误删问题 class=header-anchor arialabel=Anchor> #</a></h3><p>核心逻辑：在存入锁时，放入自己线程的标识，在删除锁时，判断当前这把锁的标识是不是自己存入的，如果是，则进行删除，如果不是，则不进行删除。</p><blockquote><p>改进 Redis 分布式锁：</p><ul><li>在获取锁的时候存入线程标识（用 UUID 表示）；</li><li>在释放锁时先获取锁中的线程标识，判断是否与当前的线程标识一致；<ul><li>一致则释放锁；</li><li>不一致则不释放锁。</li></ul></li></ul></blockquote><p><img src=.%5CRedis%E5%AE%9E%E6%88%98%E7%AF%87.assets%5C1653387398820.png alt=1653387398820></p><p>具体代码如下：加锁</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:green;font-weight:700>private</span> <span style=color:green;font-weight:700>static</span> <span style=color:green;font-weight:700>final</span> String ID_PREFIX <span style=color:#666>=</span> UUID<span style=color:#666>.</span><span style=color:#7d9029>randomUUID</span><span style=color:#666>().</span><span style=color:#7d9029>toString</span><span style=color:#666>(</span><span style=color:green;font-weight:700>true</span><span style=color:#666>)</span> <span style=color:#666>+</span> <span style=color:#ba2121>&#34;-&#34;</span><span style=color:#666>;</span>
<span style=color:#a2f>@Override</span>
<span style=color:green;font-weight:700>public</span> <span style=color:#b00040>boolean</span> <span style=color:#00f>tryLock</span><span style=color:#666>(</span><span style=color:#b00040>long</span> timeoutSec<span style=color:#666>)</span> <span style=color:#666>{</span>
   <span style=color:#408080;font-style:italic>// 获取线程标示
</span><span style=color:#408080;font-style:italic></span>   String threadId <span style=color:#666>=</span> ID_PREFIX <span style=color:#666>+</span> Thread<span style=color:#666>.</span><span style=color:#7d9029>currentThread</span><span style=color:#666>().</span><span style=color:#7d9029>getId</span><span style=color:#666>();</span>
   <span style=color:#408080;font-style:italic>// 获取锁
</span><span style=color:#408080;font-style:italic></span>   Boolean success <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>()</span>
                <span style=color:#666>.</span><span style=color:#7d9029>setIfAbsent</span><span style=color:#666>(</span>KEY_PREFIX <span style=color:#666>+</span> name<span style=color:#666>,</span> threadId<span style=color:#666>,</span> timeoutSec<span style=color:#666>,</span> TimeUnit<span style=color:#666>.</span><span style=color:#7d9029>SECONDS</span><span style=color:#666>);</span>
   <span style=color:green;font-weight:700>return</span> Boolean<span style=color:#666>.</span><span style=color:#7d9029>TRUE</span><span style=color:#666>.</span><span style=color:#7d9029>equals</span><span style=color:#666>(</span>success<span style=color:#666>);</span>
<span style=color:#666>}</span>
</code></pre></div><p>释放锁</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:green;font-weight:700>public</span> <span style=color:#b00040>void</span> <span style=color:#00f>unlock</span><span style=color:#666>()</span> <span style=color:#666>{</span>
    <span style=color:#408080;font-style:italic>// 获取线程标示
</span><span style=color:#408080;font-style:italic></span>    String threadId <span style=color:#666>=</span> ID_PREFIX <span style=color:#666>+</span> Thread<span style=color:#666>.</span><span style=color:#7d9029>currentThread</span><span style=color:#666>().</span><span style=color:#7d9029>getId</span><span style=color:#666>();</span>
    <span style=color:#408080;font-style:italic>// 获取锁中的标示
</span><span style=color:#408080;font-style:italic></span>    String id <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>().</span><span style=color:#7d9029>get</span><span style=color:#666>(</span>KEY_PREFIX <span style=color:#666>+</span> name<span style=color:#666>);</span>
    <span style=color:#408080;font-style:italic>// 判断标示是否一致
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>if</span><span style=color:#666>(</span>threadId<span style=color:#666>.</span><span style=color:#7d9029>equals</span><span style=color:#666>(</span>id<span style=color:#666>))</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 释放锁
</span><span style=color:#408080;font-style:italic></span>        stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>delete</span><span style=color:#666>(</span>KEY_PREFIX <span style=color:#666>+</span> name<span style=color:#666>);</span>
    <span style=color:#666>}</span>
<span style=color:#666>}</span>
</code></pre></div><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>SimpleDistributedLockBasedOnRedis</span> <span style=color:green;font-weight:700>implements</span> DistributedLock <span style=color:#666>{</span>
    <span style=color:green;font-weight:700>private</span> String name<span style=color:#666>;</span>
    <span style=color:green;font-weight:700>private</span> StringRedisTemplate stringRedisTemplate<span style=color:#666>;</span>

    <span style=color:green;font-weight:700>public</span> <span style=color:#00f>SimpleDistributedLockBasedOnRedis</span><span style=color:#666>(</span>String name<span style=color:#666>,</span> StringRedisTemplate stringRedisTemplate<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:green;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#7d9029>name</span> <span style=color:#666>=</span> name<span style=color:#666>;</span>
        <span style=color:green;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#7d9029>stringRedisTemplate</span> <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>;</span>
    <span style=color:#666>}</span>

    <span style=color:green;font-weight:700>private</span> <span style=color:green;font-weight:700>static</span> <span style=color:green;font-weight:700>final</span> String KEY_PREFIX <span style=color:#666>=</span> <span style=color:#ba2121>&#34;lock:&#34;</span><span style=color:#666>;</span>

    <span style=color:green;font-weight:700>private</span> <span style=color:green;font-weight:700>static</span> <span style=color:green;font-weight:700>final</span> String ID_PREFIX <span style=color:#666>=</span> UUID<span style=color:#666>.</span><span style=color:#7d9029>randomUUID</span><span style=color:#666>().</span><span style=color:#7d9029>toString</span><span style=color:#666>(</span><span style=color:green;font-weight:700>true</span><span style=color:#666>)</span> <span style=color:#666>+</span> <span style=color:#ba2121>&#34;-&#34;</span><span style=color:#666>;</span>

    <span style=color:#408080;font-style:italic>/**
</span><span style=color:#408080;font-style:italic>     * 获取锁
</span><span style=color:#408080;font-style:italic>     */</span>
    <span style=color:#a2f>@Override</span>
    <span style=color:green;font-weight:700>public</span> <span style=color:#b00040>boolean</span> <span style=color:#00f>tryLock</span><span style=color:#666>(</span><span style=color:#b00040>long</span> timeoutSeconds<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 线程标识
</span><span style=color:#408080;font-style:italic></span>        String threadIdentifier <span style=color:#666>=</span> ID_PREFIX <span style=color:#666>+</span> Thread<span style=color:#666>.</span><span style=color:#7d9029>currentThread</span><span style=color:#666>().</span><span style=color:#7d9029>getId</span><span style=color:#666>();</span>
        Boolean isSucceeded <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>()</span>
                <span style=color:#666>.</span><span style=color:#7d9029>setIfAbsent</span><span style=color:#666>(</span>KEY_PREFIX <span style=color:#666>+</span> name<span style=color:#666>,</span> threadIdentifier<span style=color:#666>,</span> timeoutSeconds<span style=color:#666>,</span> TimeUnit<span style=color:#666>.</span><span style=color:#7d9029>SECONDS</span><span style=color:#666>);</span>
        <span style=color:green;font-weight:700>return</span> Boolean<span style=color:#666>.</span><span style=color:#7d9029>TRUE</span><span style=color:#666>.</span><span style=color:#7d9029>equals</span><span style=color:#666>(</span>isSucceeded<span style=color:#666>);</span>
    <span style=color:#666>}</span>

    <span style=color:#408080;font-style:italic>/**
</span><span style=color:#408080;font-style:italic>     * 释放锁
</span><span style=color:#408080;font-style:italic>     */</span>
    <span style=color:#a2f>@Override</span>
    <span style=color:green;font-weight:700>public</span> <span style=color:#b00040>void</span> <span style=color:#00f>unlock</span><span style=color:#666>()</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 线程标识
</span><span style=color:#408080;font-style:italic></span>        String threadIdentifier <span style=color:#666>=</span> ID_PREFIX <span style=color:#666>+</span> Thread<span style=color:#666>.</span><span style=color:#7d9029>currentThread</span><span style=color:#666>().</span><span style=color:#7d9029>getId</span><span style=color:#666>();</span>
        String threadIdentifierFromRedis <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>().</span><span style=color:#7d9029>get</span><span style=color:#666>(</span>KEY_PREFIX <span style=color:#666>+</span> name<span style=color:#666>);</span>
        <span style=color:#408080;font-style:italic>// 比较 锁中的线程标识 与 当前的线程标识 是否一致
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>StrUtil<span style=color:#666>.</span><span style=color:#7d9029>equals</span><span style=color:#666>(</span>threadIdentifier<span style=color:#666>,</span> threadIdentifierFromRedis<span style=color:#666>))</span> <span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>// 释放锁标识
</span><span style=color:#408080;font-style:italic></span>            stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>delete</span><span style=color:#666>(</span>KEY_PREFIX <span style=color:#666>+</span> name<span style=color:#666>);</span>
        <span style=color:#666>}</span>
    <span style=color:#666>}</span>
<span style=color:#666>}</span>

</code></pre></div><p><strong>有关代码实操说明：</strong></p><p>在我们修改完此处代码后，我们重启工程，然后启动两个线程，第一个线程持有锁后，手动释放锁，第二个线程 此时进入到锁内部，再放行第一个线程，此时第一个线程由于锁的value值并非是自己，所以不能释放锁，也就无法删除别人的锁，此时第二个线程能够正确释放锁，通过这个案例初步说明我们解决了锁误删的问题。</p><h3 id=46-分布式锁的原子性问题>4.6 分布式锁的原子性问题<a href=#46-分布式锁的原子性问题 class=header-anchor arialabel=Anchor> #</a></h3><blockquote><p>分布式锁的原子性问题</p><p>线程1 执行业务并且判断 “当前 Redis 中的线程标识 与 获取锁时存入 Redis 的线程标识” 一致后，执行 释放锁操作 时出现阻塞，导致锁并未释放。在阻塞的过程中，又因为超时原因导致锁的释放。
此时 线程2 获取到锁，并且执行业务，执行业务的过程锁被中线程 1 释放。
于是 线程3 也能够获取到锁，并且执行业务。最终，又一次导致此时有两个线程同时在并行执行业务。
因此，需要保证 “判断线程标识的一致性 与 释放锁” 操作的原子性。
<img src=https://itsawaysu.oss-cn-shanghai.aliyuncs.com/note/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E5%8E%9F%E5%AD%90%E6%80%A7%E9%97%AE%E9%A2%98.jpg alt=分布式锁的原子性问题></p></blockquote><h3 id=47-lua脚本解决多条命令原子性问题>4.7 Lua脚本解决多条命令原子性问题<a href=#47-lua脚本解决多条命令原子性问题 class=header-anchor arialabel=Anchor> #</a></h3><p>Redis提供了Lua脚本功能，在一个脚本中编写多条Redis命令，确保多条命令执行时的原子性。Lua是一种编程语言，它的基本语法大家可以参考网站：https://www.runoob.com/lua/lua-tutorial.html，这里重点介绍Redis提供的调用函数，我们可以使用lua去操作redis，又能保证他的原子性，这样就可以实现拿锁比锁删锁是一个原子性动作了，作为Java程序员这一块并不作一个简单要求，并不需要大家过于精通，只需要知道他有什么作用即可。</p><p>这里重点介绍Redis提供的调用函数，语法如下：</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua>redis.call(<span style=color:#ba2121>&#39;命令名称&#39;</span>, <span style=color:#ba2121>&#39;key&#39;</span>, <span style=color:#ba2121>&#39;其它参数&#39;</span>, ...)
</code></pre></div><p>例如，我们要执行set name jack，则脚本是这样：</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=color:#666>#</span> <span>执行</span> set name jack
redis.call(<span style=color:#ba2121>&#39;set&#39;</span>, <span style=color:#ba2121>&#39;name&#39;</span>, <span style=color:#ba2121>&#39;jack&#39;</span>)
</code></pre></div><p>例如，我们要先执行set name Rose，再执行get name，则脚本如下：</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=color:#666>#</span> <span>先执行</span> set name jack
redis.call(<span style=color:#ba2121>&#39;set&#39;</span>, <span style=color:#ba2121>&#39;name&#39;</span>, <span style=color:#ba2121>&#39;Rose&#39;</span>)
<span style=color:#666>#</span> <span>再执行</span> get name
<span style=color:green;font-weight:700>local</span> name <span style=color:#666>=</span> redis.call(<span style=color:#ba2121>&#39;get&#39;</span>, <span style=color:#ba2121>&#39;name&#39;</span>)
<span style=color:#666>#</span> <span>返回</span>
<span style=color:green;font-weight:700>return</span> name
</code></pre></div><p>编写完脚本后，需要使用 Redis 命令来调用脚本：<code>EVAL script numkeys key [key ...] arg [arg ...]</code></p><ul><li><p>执行 <code>redis.call('set', 'name', 'Michael')</code></p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span>#</span> 双引号中间的值为 脚本<span>；</span>后面的 0 代表的是 脚本需要的 Key 类型的参数个数
127<span style=color:#666>.</span><span style=color:#7d9029>0</span><span style=color:#666>.</span><span style=color:#7d9029>0</span><span style=color:#666>.</span><span style=color:#7d9029>1</span><span style=color:#666>:</span>6379<span style=color:#666>&gt;</span> EVAL <span style=color:#ba2121>&#34;return redis.call(&#39;set&#39;, &#39;name&#39;, &#39;Michael&#39;)&#34;</span> 0
OK
127<span style=color:#666>.</span><span style=color:#7d9029>0</span><span style=color:#666>.</span><span style=color:#7d9029>0</span><span style=color:#666>.</span><span style=color:#7d9029>1</span><span style=color:#666>:</span>6379<span style=color:#666>&gt;</span> get name
<span style=color:#ba2121>&#34;Michael&#34;</span>
</code></pre></div></li></ul><p>如果脚本中的key、value不想写死，可以作为参数传递。key类型参数会放入KEYS数组，其它参数会放入ARGV数组，在脚本中可以从KEYS和ARGV数组获取这些参数：</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span>#</span> name <span style=color:#666>==&gt;</span> KEYS<span style=color:#666>[</span>1<span style=color:#666>]</span> <span>、</span>Annabelle <span style=color:#666>==&gt;</span> ARGV<span style=color:#666>[</span>1<span style=color:#666>]</span>  <span>（</span>Lua 的数组下标从 1 开始<span>）</span>
127<span style=color:#666>.</span><span style=color:#7d9029>0</span><span style=color:#666>.</span><span style=color:#7d9029>0</span><span style=color:#666>.</span><span style=color:#7d9029>1</span><span style=color:#666>:</span>6379<span style=color:#666>&gt;</span> EVAL <span style=color:#ba2121>&#34;return redis.call(&#39;set&#39;, KEYS[1], ARGV[1])&#34;</span> 1 name Annabelle
OK
127<span style=color:#666>.</span><span style=color:#7d9029>0</span><span style=color:#666>.</span><span style=color:#7d9029>0</span><span style=color:#666>.</span><span style=color:#7d9029>1</span><span style=color:#666>:</span>6379<span style=color:#666>&gt;</span> get name
<span style=color:#ba2121>&#34;Annabelle&#34;</span>

</code></pre></div><p>接下来我们来回一下我们释放锁的逻辑：</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span>#</span>自写
 EVAL <span style=color:#ba2121>&#34;return redis.call(&#39;set&#39;,&#39;name&#39;,&#39;jack&#39;)&#34;</span> 0
    
 EVAL  <span style=color:#ba2121>&#34;return  redis.call(&#39;set&#39;,KEYS[1],ARGV[1])&#34;</span> 1 name rose

</code></pre></div><p>释放锁的业务流程是这样的</p><p>​ 1、获取锁中的线程标示</p><p>​ 2、判断是否与指定的标示（当前线程标示）一致</p><p>​ 3、如果一致则释放锁（删除）</p><p>​ 4、如果不一致则什么都不做</p><p>如果用Lua脚本来表示则是这样的：</p><p>最终我们操作redis的拿锁比锁删锁的lua脚本就会变成这样</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=color:#408080;font-style:italic>-- 这里的 KEYS[1] 就是锁的key，这里的ARGV[1] 就是当前线程标示</span>
<span style=color:#408080;font-style:italic>-- 获取锁中的标示，判断是否与当前线程标示一致</span>
<span style=color:green;font-weight:700>if</span> (redis.call(<span style=color:#ba2121>&#39;GET&#39;</span>, KEYS[<span style=color:#666>1</span>]) <span style=color:#666>==</span> ARGV[<span style=color:#666>1</span>]) <span style=color:green;font-weight:700>then</span>
  <span style=color:#408080;font-style:italic>-- 一致，则删除锁</span>
  <span style=color:green;font-weight:700>return</span> redis.call(<span style=color:#ba2121>&#39;DEL&#39;</span>, KEYS[<span style=color:#666>1</span>])
<span style=color:green;font-weight:700>end</span>
<span style=color:#408080;font-style:italic>-- 不一致，则直接返回</span>
<span style=color:green;font-weight:700>return</span> <span style=color:#666>0</span>
</code></pre></div><h3 id=48-利用java代码调用lua脚本改造分布式锁>4.8 利用Java代码调用Lua脚本改造分布式锁<a href=#48-利用java代码调用lua脚本改造分布式锁 class=header-anchor arialabel=Anchor> #</a></h3><p>lua脚本本身并不需要大家花费太多时间去研究，只需要知道如何调用，大致是什么意思即可，所以在笔记中并不会详细的去解释这些lua表达式的含义。</p><p>我们的RedisTemplate中，可以利用execute方法去执行lua脚本，参数对应关系就如下图股</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#666>--</span> 锁的 Key
<span style=color:#666>--</span> local key <span style=color:#666>=</span> <span style=color:#ba2121>&#34;lock:order:10&#34;</span>
<span style=color:#666>--</span> local key <span style=color:#666>=</span> KEYS<span style=color:#666>[</span>1<span style=color:#666>]</span>

<span style=color:#666>--</span> 最初存入 Redis 中的线程标识
<span style=color:#666>--</span> local threadIdentifier <span style=color:#666>=</span> <span style=color:#ba2121>&#34;uuid-http-nio-8081-exec-1&#34;</span>
<span style=color:#666>--</span> local threadIdentifier <span style=color:#666>=</span> ARGV<span style=color:#666>[</span>1<span style=color:#666>]</span>

<span style=color:#666>--</span> 锁中的线程标识
local threadIdentifierFromRedis <span style=color:#666>=</span> redis<span style=color:#666>.</span><span style=color:#7d9029>call</span><span style=color:#666>(</span><span>&#39;</span>get<span>&#39;</span><span style=color:#666>,</span> KEYS<span style=color:#666>[</span>1<span style=color:#666>])</span>

<span style=color:#666>--</span> 比较 最初存入 Redis 中的线程标识 与 目前 Redis 中存储的线程标识 是否一致
<span style=color:#00f>if</span> <span style=color:#666>(</span>threadIdentifierFromRedis <span style=color:#666>==</span> ARGV<span style=color:#666>[</span>1<span style=color:#666>])</span> then
    <span style=color:#666>--</span> 一致<span>，</span>则释放锁 del key
    <span style=color:green;font-weight:700>return</span> redis<span style=color:#666>.</span><span style=color:#7d9029>call</span><span style=color:#666>(</span><span>&#39;</span>del<span>&#39;</span><span style=color:#666>,</span> KEYS<span style=color:#666>[</span>1<span style=color:#666>])</span>
end
<span style=color:#666>--</span> 若不一致<span>，</span>则返回 0
<span style=color:green;font-weight:700>return</span> 0

    
    
<span style=color:#666>--</span> 比较线程标示与锁中的标示是否一致
<span style=color:#00f>if</span><span style=color:#666>(</span>redis<span style=color:#666>.</span><span style=color:#7d9029>call</span><span style=color:#666>(</span><span>&#39;</span>get<span>&#39;</span><span style=color:#666>,</span> KEYS<span style=color:#666>[</span>1<span style=color:#666>])</span> <span style=color:#666>==</span>  ARGV<span style=color:#666>[</span>1<span style=color:#666>])</span> then
    <span style=color:#666>--</span> 释放锁 del key
    <span style=color:green;font-weight:700>return</span> redis<span style=color:#666>.</span><span style=color:#7d9029>call</span><span style=color:#666>(</span><span>&#39;</span>del<span>&#39;</span><span style=color:#666>,</span> KEYS<span style=color:#666>[</span>1<span style=color:#666>])</span>
end
<span style=color:green;font-weight:700>return</span> 0
    
    
</code></pre></div><p><strong>Java代码</strong></p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  
        
经过以上代码改造后<span>，</span>我们就能够实现 拿锁比锁删锁的原子性动作了<span style=color:#666>~</span>
    
ublic <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>SimpleRedisLock</span> <span style=color:green;font-weight:700>implements</span> ILock <span style=color:#666>{</span>

    <span style=color:green;font-weight:700>private</span> String name<span style=color:#666>;</span>
    <span style=color:green;font-weight:700>private</span> StringRedisTemplate stringRedisTemplate<span style=color:#666>;</span>

    <span style=color:green;font-weight:700>public</span> <span style=color:#00f>SimpleRedisLock</span><span style=color:#666>(</span>String name<span style=color:#666>,</span> StringRedisTemplate stringRedisTemplate<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:green;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#7d9029>name</span> <span style=color:#666>=</span> name<span style=color:#666>;</span>
        <span style=color:green;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#7d9029>stringRedisTemplate</span> <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>;</span>
    <span style=color:#666>}</span>

    <span style=color:green;font-weight:700>private</span> <span style=color:green;font-weight:700>static</span> <span style=color:green;font-weight:700>final</span> String KEY_PREFIX <span style=color:#666>=</span> <span style=color:#ba2121>&#34;lock:&#34;</span><span style=color:#666>;</span>
    <span style=color:green;font-weight:700>private</span> <span style=color:green;font-weight:700>static</span> <span style=color:green;font-weight:700>final</span> String ID_PREFIX <span style=color:#666>=</span> UUID<span style=color:#666>.</span><span style=color:#7d9029>randomUUID</span><span style=color:#666>().</span><span style=color:#7d9029>toString</span><span style=color:#666>(</span><span style=color:green;font-weight:700>true</span><span style=color:#666>)</span> <span style=color:#666>+</span> <span style=color:#ba2121>&#34;-&#34;</span><span style=color:#666>;</span>
    <span style=color:green;font-weight:700>private</span> <span style=color:green;font-weight:700>static</span> <span style=color:green;font-weight:700>final</span> DefaultRedisScript<span style=color:#666>&lt;</span>Long<span style=color:#666>&gt;</span> UNLOCK_SCRIPT<span style=color:#666>;</span>
 <span>#</span>基本用的static代码块进行加载
    <span style=color:green;font-weight:700>static</span> <span style=color:#666>{</span>
        UNLOCK_SCRIPT <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> DefaultRedisScript<span style=color:#666>&lt;&gt;();</span>
        UNLOCK_SCRIPT<span style=color:#666>.</span><span style=color:#7d9029>setLocation</span><span style=color:#666>(</span><span style=color:green;font-weight:700>new</span> ClassPathResource<span style=color:#666>(</span><span style=color:#ba2121>&#34;unlock.lua&#34;</span><span style=color:#666>));</span>
        UNLOCK_SCRIPT<span style=color:#666>.</span><span style=color:#7d9029>setResultType</span><span style=color:#666>(</span>Long<span style=color:#666>.</span><span style=color:#7d9029>class</span><span style=color:#666>);</span>
    <span style=color:#666>}</span>

    <span style=color:#a2f>@Override</span>
    <span style=color:green;font-weight:700>public</span> <span style=color:#b00040>boolean</span> <span style=color:#00f>tryLock</span><span style=color:#666>(</span><span style=color:#b00040>long</span> timeoutSec<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 获取线程标示
</span><span style=color:#408080;font-style:italic></span>        String threadId <span style=color:#666>=</span> ID_PREFIX <span style=color:#666>+</span> Thread<span style=color:#666>.</span><span style=color:#7d9029>currentThread</span><span style=color:#666>().</span><span style=color:#7d9029>getId</span><span style=color:#666>();</span>
        <span style=color:#408080;font-style:italic>// 获取锁
</span><span style=color:#408080;font-style:italic></span>        Boolean success <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>()</span>
                <span style=color:#666>.</span><span style=color:#7d9029>setIfAbsent</span><span style=color:#666>(</span>KEY_PREFIX <span style=color:#666>+</span> name<span style=color:#666>,</span> threadId<span style=color:#666>,</span> timeoutSec<span style=color:#666>,</span> TimeUnit<span style=color:#666>.</span><span style=color:#7d9029>SECONDS</span><span style=color:#666>);</span>
        <span style=color:green;font-weight:700>return</span> Boolean<span style=color:#666>.</span><span style=color:#7d9029>TRUE</span><span style=color:#666>.</span><span style=color:#7d9029>equals</span><span style=color:#666>(</span>success<span style=color:#666>);</span>
    <span style=color:#666>}</span>

    <span style=color:#a2f>@Override</span>
    <span style=color:green;font-weight:700>public</span> <span style=color:#b00040>void</span> <span style=color:#00f>unlock</span><span style=color:#666>()</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 调用lua脚本
</span><span style=color:#408080;font-style:italic></span>        stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>execute</span><span style=color:#666>(</span>
                      UNLOCK_SCRIPT<span style=color:#666>,</span>  <span style=color:#408080;font-style:italic>// SCRIPT
</span><span style=color:#408080;font-style:italic></span>            Collections<span style=color:#666>.</span><span style=color:#7d9029>singletonList</span><span style=color:#666>(</span>KEY_PREFIX <span style=color:#666>+</span> name<span style=color:#666>),</span>   <span style=color:#408080;font-style:italic>// KEY[1]
</span><span style=color:#408080;font-style:italic></span>            ID_PREFIX <span style=color:#666>+</span> Thread<span style=color:#666>.</span><span style=color:#7d9029>currentThread</span><span style=color:#666>().</span><span style=color:#7d9029>getId</span><span style=color:#666>()</span>    <span style=color:#408080;font-style:italic>// ARGV[1]
</span><span style=color:#408080;font-style:italic></span>    <span style=color:#666>}</span>

<span style=color:#666>}</span>

</code></pre></div><p>小总结：</p><p>基于Redis的分布式锁实现思路：</p><ul><li>利用set nx ex获取锁，并设置过期时间，保存线程标示</li><li>释放锁时先判断线程标示是否与自己一致，一致则删除锁<ul><li>特性：<ul><li>利用set nx满足互斥性</li><li>利用set ex保证故障时锁依然能释放，避免死锁，提高安全性</li><li>利用Redis集群保证高可用和高并发特性</li></ul></li></ul></li></ul><p>笔者总结：我们一路走来，利用添加过期时间，防止死锁问题的发生，但是有了过期时间之后，可能出现误删别人锁的问题，这个问题我们开始是利用删之前 通过拿锁，比锁，删锁这个逻辑来解决的，也就是删之前判断一下当前这把锁是否是属于自己的，但是现在还有原子性问题，也就是我们没法保证拿锁比锁删锁是一个原子性的动作，最后通过lua表达式来解决这个问题</p><p><strong>测试逻辑：</strong></p><p>第一个线程进来，得到了锁，手动删除锁，模拟锁超时了，其他线程会执行lua来抢锁，当第一天线程利用lua删除锁时，lua能保证他不能删除他的锁，第二个线程删除锁时，利用lua同样可以保证不会删除别人的锁，同时还能保证原子性。</p><h3 id=总结分布式锁>总结分布式锁：<a href=#总结分布式锁 class=header-anchor arialabel=Anchor> #</a></h3><blockquote><ol><li><p>redis锁代替悲观锁，解决分布式锁的问题（创建新的simpleredislock对象+代理对象调用方法）</p><p>此时出现问题删除锁的时候多线程可能出现锁的误删</p></li><li><p>在获取锁的时候存入线程标识（用 UUID 表示）；</p><blockquote><p>在释放锁时先获取锁中的线程标识，判断是否与当前的线程标识一致；</p><p>出现问题“判断线程标识的一致性 与 释放锁” 操作的需要原子性。</p></blockquote></li><li><p>用lua脚本执行多条命令的原子性</p><blockquote><p>在判断线程标识和释放锁的操作是lua脚本保证原子性</p></blockquote></li></ol></blockquote><h2 id=5分布式锁-redission>5、分布式锁-redission<a href=#5分布式锁-redission class=header-anchor arialabel=Anchor> #</a></h2><h3 id=51-分布式锁-redission功能介绍>5.1 分布式锁-redission功能介绍<a href=#51-分布式锁-redission功能介绍 class=header-anchor arialabel=Anchor> #</a></h3><p>基于setnx实现的分布式锁存在下面的问题：</p><p><strong>重入问题</strong>：重入问题是指 获得锁的线程可以再次进入到相同的锁的代码块中，可重入锁的意义在于防止死锁。假设在 方法A 中调用 方法B。方法A 中，需要先获取锁，执行业务、调用方法B；而方法B 中，又需要获取同一把锁。
此时如果是不可重入锁，调用方法B 时无法获取锁，就会等待锁的释放，而锁无法释放，因为 方法A 还没有执行完毕，造成死锁。所以可重入锁他的主要意义是防止死锁，我们的synchronized和Lock锁都是可重入的。</p><p><strong>不可重试</strong>：是指目前的分布式只能尝试一次，我们认为合理的情况是：当线程在获得锁失败后，他应该能再次尝试获得锁。</p><p>**超时释放：**我们在加锁时增加了过期时间，这样的我们可以防止死锁，但是如果卡顿的时间超长，虽然我们采用了lua表达式防止删锁的时候，误删别人的锁，但是如果锁住的时间太长导致其他线程都在等待，或者锁住的时间太短导致业务未执行完毕锁就释放等隐患。</p><p><strong>主从一致性：</strong> 如果Redis提供了主从集群，当我们向集群写数据时，主机需要异步的将数据同步给从机，而万一在同步过去之前，主机宕机了，就会出现死锁问题。</p><p>![基于 setnx 实现的分布式锁存在的问题](https://itsawaysu.oss-cn-shanghai.aliyuncs.com/note/基于 setnx 实现的分布式锁存在的问题.jpg)</p><p><strong>Redisson 是一个在 Redis 基础上实现的分布式工具集合。</strong></p><p>Redisson是一个在Redis的基础上实现的Java驻内存数据网格（In-Memory Data Grid）。它不仅提供了一系列的分布式的Java常用对象，还提供了许多分布式服务，其中就包含了各种分布式锁的实现。</p><p>Redission提供了分布式锁的多种多样的功能</p><p>Redisson 是一个在 Redis 的基础上实现的 Java 驻内存数据网格（In-Memory Data Grid）。</p><p>它不仅提供了一系列的分布式的 Java 常用对象，还提供了许多分布式服务，其中就包含了各种分布式锁的实现。</p><blockquote><p>分布式锁（Lock）和同步器（Synchronizer）</p><p>可重入锁（Reentrant Lock）
公平锁（Fair Lock）
联锁（MultiLock）
红锁（RedLock）
读写锁（ReadWriteLock）
信号量（Semaphore）
可过期性信号量（PermitExpirableSemaphore）
闭锁（CountDownLatch）</p></blockquote><h3 id=52-分布式锁-redission快速入门>5.2 分布式锁-Redission快速入门<a href=#52-分布式锁-redission快速入门 class=header-anchor arialabel=Anchor> #</a></h3><p>1.引入依赖：</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:green;font-weight:700>&lt;dependency&gt;</span>
	<span style=color:green;font-weight:700>&lt;groupId&gt;</span>org.redisson<span style=color:green;font-weight:700>&lt;/groupId&gt;</span>
	<span style=color:green;font-weight:700>&lt;artifactId&gt;</span>redisson<span style=color:green;font-weight:700>&lt;/artifactId&gt;</span>
	<span style=color:green;font-weight:700>&lt;version&gt;</span>3.13.6<span style=color:green;font-weight:700>&lt;/version&gt;</span>
<span style=color:green;font-weight:700>&lt;/dependency&gt;</span>
</code></pre></div><p>2.配置Redisson客户端：</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@Configuration</span>
<span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>RedissonConfig</span> <span style=color:#666>{</span>

    <span style=color:#a2f>@Bean</span>
    <span style=color:green;font-weight:700>public</span> RedissonClient <span style=color:#00f>redissonClient</span><span style=color:#666>(){</span>
         <span style=color:#408080;font-style:italic>// 配置类
</span><span style=color:#408080;font-style:italic></span>        Config config <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> Config<span style=color:#666>();</span>
        <span style=color:#408080;font-style:italic>// 添加 Redis 地址：此处是单节点地址，也可以通过 config.useClusterServers() 添加集群地址
</span><span style=color:#408080;font-style:italic></span>        config<span style=color:#666>.</span><span style=color:#7d9029>useSingleServer</span><span style=color:#666>().</span><span style=color:#7d9029>setAddress</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;182.168.8.130:6379&#34;</span><span style=color:#666>).</span><span style=color:#7d9029>setPassword</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;yangroot&#34;</span><span style=color:#666>);</span>
        <span style=color:#408080;font-style:italic>// 创建客户端
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>return</span> Redisson<span style=color:#666>.</span><span style=color:#7d9029>create</span><span style=color:#666>(</span>config<span style=color:#666>);</span>
    <span style=color:#666>}</span>
<span style=color:#666>}</span>

</code></pre></div><p>3.如何使用Redission的分布式锁</p><blockquote><p>按照名称返回 Lock 实例：RLock lock = redissonClient.getLock(name);
尝试获取锁：boolean isLocked = lock.tryLock(1, 10, TimeUnit.SECONDS);
获取锁失败，失败后的最大等待时间，期间会重试：默认为 -1，即不等待；
锁的自动施放时间：30；
时间单位：秒。</p></blockquote><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@Resource</span>
<span style=color:green;font-weight:700>private</span> RedissionClient redissonClient<span style=color:#666>;</span>

<span style=color:#a2f>@Test</span>
<span style=color:#b00040>void</span> <span style=color:#00f>testRedisson</span><span style=color:#666>()</span> <span style=color:green;font-weight:700>throws</span> Exception<span style=color:#666>{</span>
    <span style=color:#408080;font-style:italic>//获取锁(可重入)，指定锁的名称
</span><span style=color:#408080;font-style:italic></span>    RLock lock <span style=color:#666>=</span> redissonClient<span style=color:#666>.</span><span style=color:#7d9029>getLock</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;anyLock&#34;</span><span style=color:#666>);</span>
    <span style=color:#408080;font-style:italic>//尝试获取锁，参数分别是：获取锁的最大等待时间(期间会重试)，锁自动释放时间，时间单位
</span><span style=color:#408080;font-style:italic></span>    <span style=color:#b00040>boolean</span> isLock <span style=color:#666>=</span> lock<span style=color:#666>.</span><span style=color:#7d9029>tryLock</span><span style=color:#666>(</span>1<span style=color:#666>,</span>10<span style=color:#666>,</span>TimeUnit<span style=color:#666>.</span><span style=color:#7d9029>SECONDS</span><span style=color:#666>);</span>
    <span style=color:#408080;font-style:italic>//判断获取锁成功
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>if</span><span style=color:#666>(</span>isLock<span style=color:#666>){</span>
        <span style=color:green;font-weight:700>try</span><span style=color:#666>{</span>
            System<span style=color:#666>.</span><span style=color:#7d9029>out</span><span style=color:#666>.</span><span style=color:#7d9029>println</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;执行业务&#34;</span><span style=color:#666>);</span>          
        <span style=color:#666>}</span><span style=color:green;font-weight:700>finally</span><span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>//释放锁
</span><span style=color:#408080;font-style:italic></span>            lock<span style=color:#666>.</span><span style=color:#7d9029>unlock</span><span style=color:#666>();</span>
        <span style=color:#666>}</span>
        
    <span style=color:#666>}</span>

</code></pre></div><p>在 VoucherOrderServiceImpl</p><p>注入RedissonClient</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@Resource</span>
<span style=color:green;font-weight:700>private</span> RedissonClient redissonClient<span style=color:#666>;</span>

<span style=color:#a2f>@Override</span>
<span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>seckillVoucher</span><span style=color:#666>(</span>Long voucherId<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 1.查询优惠券
</span><span style=color:#408080;font-style:italic></span>        SeckillVoucher voucher <span style=color:#666>=</span> seckillVoucherService<span style=color:#666>.</span><span style=color:#7d9029>getById</span><span style=color:#666>(</span>voucherId<span style=color:#666>);</span>
        <span style=color:#408080;font-style:italic>// 2.判断秒杀是否开始
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>voucher<span style=color:#666>.</span><span style=color:#7d9029>getBeginTime</span><span style=color:#666>().</span><span style=color:#7d9029>isAfter</span><span style=color:#666>(</span>LocalDateTime<span style=color:#666>.</span><span style=color:#7d9029>now</span><span style=color:#666>()))</span> <span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>// 尚未开始
</span><span style=color:#408080;font-style:italic></span>            <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;秒杀尚未开始！&#34;</span><span style=color:#666>);</span>
        <span style=color:#666>}</span>
        <span style=color:#408080;font-style:italic>// 3.判断秒杀是否已经结束
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>voucher<span style=color:#666>.</span><span style=color:#7d9029>getEndTime</span><span style=color:#666>().</span><span style=color:#7d9029>isBefore</span><span style=color:#666>(</span>LocalDateTime<span style=color:#666>.</span><span style=color:#7d9029>now</span><span style=color:#666>()))</span> <span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>// 尚未开始
</span><span style=color:#408080;font-style:italic></span>            <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;秒杀已经结束！&#34;</span><span style=color:#666>);</span>
        <span style=color:#666>}</span>
        <span style=color:#408080;font-style:italic>// 4.判断库存是否充足
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>voucher<span style=color:#666>.</span><span style=color:#7d9029>getStock</span><span style=color:#666>()</span> <span style=color:#666>&lt;</span> 1<span style=color:#666>)</span> <span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>// 库存不足
</span><span style=color:#408080;font-style:italic></span>            <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;库存不足！&#34;</span><span style=color:#666>);</span>
        <span style=color:#666>}</span>
        Long userId <span style=color:#666>=</span> UserHolder<span style=color:#666>.</span><span style=color:#7d9029>getUser</span><span style=color:#666>().</span><span style=color:#7d9029>getId</span><span style=color:#666>();</span>
        <span style=color:#408080;font-style:italic>//创建锁对象 这个代码不用了，因为我们现在要使用分布式锁
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#408080;font-style:italic>//SimpleRedisLock lock = new SimpleRedisLock(&#34;order:&#34; + userId, stringRedisTemplate);
</span><span style=color:#408080;font-style:italic></span>        RLock lock <span style=color:#666>=</span> redissonClient<span style=color:#666>.</span><span style=color:#7d9029>getLock</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;lock:order:&#34;</span> <span style=color:#666>+</span> userId<span style=color:#666>);</span>
        <span style=color:#408080;font-style:italic>//获取锁对象
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#b00040>boolean</span> isLock <span style=color:#666>=</span> lock<span style=color:#666>.</span><span style=color:#7d9029>tryLock</span><span style=color:#666>();</span> <span style=color:#408080;font-style:italic>////参数可以三个，第一个重试时间，释放锁，单位
</span><span style=color:#408080;font-style:italic></span>       
		<span style=color:#408080;font-style:italic>//加锁失败
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(!</span>isLock<span style=color:#666>)</span> <span style=color:#666>{</span>
            <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;不允许重复下单&#34;</span><span style=color:#666>);</span>
        <span style=color:#666>}</span>
        <span style=color:green;font-weight:700>try</span> <span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>//获取代理对象(事务)
</span><span style=color:#408080;font-style:italic></span>            IVoucherOrderService proxy <span style=color:#666>=</span> <span style=color:#666>(</span>IVoucherOrderService<span style=color:#666>)</span> AopContext<span style=color:#666>.</span><span style=color:#7d9029>currentProxy</span><span style=color:#666>();</span>
            <span style=color:green;font-weight:700>return</span> proxy<span style=color:#666>.</span><span style=color:#7d9029>createVoucherOrder</span><span style=color:#666>(</span>voucherId<span style=color:#666>);</span>
        <span style=color:#666>}</span> <span style=color:green;font-weight:700>finally</span> <span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>//释放锁
</span><span style=color:#408080;font-style:italic></span>            lock<span style=color:#666>.</span><span style=color:#7d9029>unlock</span><span style=color:#666>();</span>
        <span style=color:#666>}</span>
 <span style=color:#666>}</span>
</code></pre></div><h3 id=53-分布式锁-redission可重入锁原理>5.3 分布式锁-redission可重入锁原理<a href=#53-分布式锁-redission可重入锁原理 class=header-anchor arialabel=Anchor> #</a></h3><blockquote><p>在Lock锁中，他是借助于底层的一个voaltile的一个state变量来记录重入的状态的，比如当前没有人持有这把锁，那么state=0，假如有人持有这把锁，那么state=1，如果持有这把锁的人再次持有这把锁，那么state就会+1 ，如果是对于synchronized而言，他在c语言代码中会有一个count，原理和state类似，也是重入一次就加一，释放一次就-1 ，直到减少成0 时，表示当前这把锁没有被人持有。</p></blockquote><blockquote><p>在redission中，我们的也支持支持可重入锁</p></blockquote><blockquote><p>在分布式锁中，他采用hash结构用来存储锁，其中大key表示这把锁是否存在，用小key表示当前这把锁被哪个线程持有，所以接下来我们一起分析一下当前的这个lua表达式</p></blockquote><p>这个地方一共有3个参数</p><p><strong>KEYS[1] ： 锁名称</strong></p><p><strong>ARGV[1]： 锁失效时间</strong></p><p><strong>ARGV[2]： id + &ldquo;:&rdquo; + threadId; 锁的小key</strong></p><blockquote><p>exists: 判断数据是否存在 name：是lock是否存在,如果==0，就表示当前这把锁不存在</p></blockquote><blockquote><p>redis.call(&lsquo;hset&rsquo;, KEYS[1], ARGV[2], 1);此时他就开始往redis里边去写数据 ，写成一个hash结构</p></blockquote><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>Lock<span style=color:#666>{</span>
 id <span style=color:#666>+</span> <span style=color:#666>**</span><span style=color:#ba2121>&#34;:&#34;</span><span style=color:#666>**</span> <span style=color:#666>+</span> threadId <span style=color:#666>:</span>  1

<span style=color:#666>}</span>
</code></pre></div><p>如果当前这把锁存在，则第一个条件不满足，再判断</p><p>redis.call(&lsquo;hexists&rsquo;, KEYS[1], ARGV[2]) == 1</p><p>此时需要通过大key+小key判断当前这把锁是否是属于自己的，如果是自己的，则进行</p><p>redis.call(&lsquo;hincrby&rsquo;, KEYS[1], ARGV[2], 1)</p><p>将当前这个锁的value进行+1 ，redis.call(&lsquo;pexpire&rsquo;, KEYS[1], ARGV[1]); 然后再对其设置过期时间，如果以上两个条件都不满足，则表示当前这把锁抢锁失败，最后返回pttl，即为当前这把锁的失效时间</p><p>如果小伙帮们看了前边的源码， 你会发现他会去判断当前这个方法的返回值是否为null，如果是null，则对应则前两个if对应的条件，退出抢锁逻辑，如果返回的不是null，即走了第三个分支，在源码处会进行while(true)的自旋抢锁。</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua>
<span style=color:#ba2121>&#34;if (redis.call(&#39;exists&#39;, KEYS[1]) == 0) then &#34;</span> <span style=color:#666>+</span>
                  <span style=color:#ba2121>&#34;redis.call(&#39;hset&#39;, KEYS[1], ARGV[2], 1); &#34;</span> <span style=color:#666>+</span>
                  <span style=color:#ba2121>&#34;redis.call(&#39;pexpire&#39;, KEYS[1], ARGV[1]); &#34;</span> <span style=color:#666>+</span>
                  <span style=color:#ba2121>&#34;return nil; &#34;</span> <span style=color:#666>+</span>
              <span style=color:#ba2121>&#34;end; &#34;</span> <span style=color:#666>+</span>
              <span style=color:#ba2121>&#34;if (redis.call(&#39;hexists&#39;, KEYS[1], ARGV[2]) == 1) then &#34;</span> <span style=color:#666>+</span>
                  <span style=color:#ba2121>&#34;redis.call(&#39;hincrby&#39;, KEYS[1], ARGV[2], 1); &#34;</span> <span style=color:#666>+</span>
                  <span style=color:#ba2121>&#34;redis.call(&#39;pexpire&#39;, KEYS[1], ARGV[1]); &#34;</span> <span style=color:#666>+</span>
                  <span style=color:#ba2121>&#34;return nil; &#34;</span> <span style=color:#666>+</span>
              <span style=color:#ba2121>&#34;end; &#34;</span> <span style=color:#666>+</span>
              <span style=color:#ba2121>&#34;return redis.call(&#39;pttl&#39;, KEYS[1]);&#34;</span>
</code></pre></div><blockquote><p>之前jdk的之前判断，是否同一个线程，会记录线程的标识和重入次数+1</p><p>释放锁的时候将value-1，还要判断是否value=0</p><p>用hash结构</p><p>所以需要lua脚本保证完整性</p></blockquote><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua>locak key<span style=color:#666>-=</span>KEYS[<span style=color:#666>1</span>]; <span style=color:#408080;font-style:italic>-- 锁的key</span>
locak ThreadID<span style=color:#666>-=</span>AGRV[<span style=color:#666>1</span>]; <span style=color:#408080;font-style:italic>-- 线程的唯一标识</span>
<span style=color:green;font-weight:700>local</span> releaseTime<span style=color:#666>=</span>AGRV[<span style=color:#666>2</span>];<span style=color:#408080;font-style:italic>-- 锁的自动释放时间</span>
<span style=color:#408080;font-style:italic>--locak key-=KEYS[1]; -- 锁的key</span>
<span style=color:#408080;font-style:italic>--locak ThreadID-=AGRV[1]; -- 线程的唯一标识</span>
<span style=color:#408080;font-style:italic>--local releaseTime=AGRV[2];-- 锁的自动释放时间</span>

<span style=color:green;font-weight:700>if</span>(redis.call(<span style=color:#ba2121>&#39;exists&#39;</span>,key) <span style=color:#666>==</span><span style=color:#666>0</span>) <span style=color:green;font-weight:700>then</span>
<span style=color:#408080;font-style:italic>--不存在获取锁</span>
  redis.call(<span style=color:#ba2121>&#39;hset&#39;</span>,key,ThreadID,<span style=color:#ba2121>&#39;1&#39;</span>);
  <span style=color:#408080;font-style:italic>--设置有效期</span>
  redis.call(<span style=color:#ba2121>&#39;expire&#39;</span>,key,releaseTime);
  <span style=color:green;font-weight:700>return</span> <span style=color:#666>1</span>;<span style=color:#408080;font-style:italic>--返回结果</span>
<span style=color:green;font-weight:700>end</span>;

<span style=color:#408080;font-style:italic>--锁已经存在判断是否是自己的</span>
<span style=color:green;font-weight:700>if</span>(redis.call(<span style=color:#ba2121>&#39;hexists&#39;</span>,key,ThreadID) <span style=color:#666>==</span><span style=color:#666>1</span>) <span style=color:green;font-weight:700>then</span>
<span style=color:#408080;font-style:italic>--是自己，获取锁，重入次数+1</span>
  redis.call(<span style=color:#ba2121>&#39;hincrby&#39;</span>,key,ThreadID,<span style=color:#ba2121>&#39;1&#39;</span>);
  <span style=color:#408080;font-style:italic>--设置有效期</span>
  redis.call(<span style=color:#ba2121>&#39;expire&#39;</span>,key,releaseTime);
  <span style=color:green;font-weight:700>return</span> <span style=color:#666>1</span>;<span style=color:#408080;font-style:italic>--返回结果</span>
<span style=color:green;font-weight:700>end</span>;
<span style=color:green;font-weight:700>return</span> <span style=color:#666>0</span>; <span style=color:#408080;font-style:italic>--不是自己的锁</span>

</code></pre></div><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=color:#408080;font-style:italic>-- 释放锁</span>
<span style=color:green;font-weight:700>if</span>(redis.call(<span style=color:#ba2121>&#39;HEXISTS&#39;</span>,key,ThreadID)<span style=color:#666>==</span><span style=color:#666>0</span>) <span style=color:green;font-weight:700>then</span>
 <span style=color:green;font-weight:700>return</span> <span style=color:green;font-weight:700>nil</span>; <span style=color:#408080;font-style:italic>--如果已经不是自己的，直接返回</span>
<span style=color:green;font-weight:700>end</span>;
 <span style=color:#408080;font-style:italic>--是自己的锁，重入次数-1</span>
<span style=color:green;font-weight:700>local</span> count<span style=color:#666>=</span>redis.call(<span style=color:#ba2121>&#39;HINCRBY&#39;</span>,key,ThreadID,<span style=color:#666>-</span><span style=color:#666>1</span>);
<span style=color:#408080;font-style:italic>--判断是否重入的次数已经位0</span>
<span style=color:green;font-weight:700>if</span>(count <span style=color:#666>&gt;</span><span style=color:#666>0</span>) <span style=color:green;font-weight:700>then</span>
  <span style=color:#408080;font-style:italic>--大于0说明不能释放锁，重置有效期然后返回</span>
  redis.call(<span style=color:#ba2121>&#39;EXPIRE&#39;</span>,key,releaseTime);
  <span style=color:green;font-weight:700>return</span> <span style=color:green;font-weight:700>nil</span>;
<span style=color:green;font-weight:700>else</span> <span style=color:#408080;font-style:italic>--等于0说明可以释放锁</span>
  redis.call(<span style=color:#ba2121>&#39;DEL&#39;</span>,key);
  <span style=color:green;font-weight:700>return</span> <span style=color:green;font-weight:700>nil</span>;
<span style=color:green;font-weight:700>end</span>;
</code></pre></div><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@Slf4j</span>
<span style=color:#a2f>@SpringBootTest</span>
<span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>RedissonTest</span> <span style=color:#666>{</span>

    <span style=color:#a2f>@Resource</span>
    <span style=color:green;font-weight:700>private</span> RedissonClient redissonClient<span style=color:#666>;</span>

    <span style=color:green;font-weight:700>private</span> RLock lock<span style=color:#666>;</span>

    <span style=color:#a2f>@BeforeEach</span>     <span style=color:#408080;font-style:italic>// 创建 Lock 实例（可重入）
</span><span style=color:#408080;font-style:italic></span>    <span style=color:#b00040>void</span> <span style=color:#00f>setUp</span><span style=color:#666>()</span> <span style=color:#666>{</span>
        lock <span style=color:#666>=</span> redissonClient<span style=color:#666>.</span><span style=color:#7d9029>getLock</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;anyLock&#34;</span><span style=color:#666>);</span>
    <span style=color:#666>}</span>

    <span style=color:#a2f>@Test</span>
    <span style=color:#b00040>void</span> <span style=color:#00f>methodOne</span><span style=color:#666>()</span> <span style=color:green;font-weight:700>throws</span> InterruptedException <span style=color:#666>{</span>
        <span style=color:#b00040>boolean</span> isLocked <span style=color:#666>=</span> lock<span style=color:#666>.</span><span style=color:#7d9029>tryLock</span><span style=color:#666>();</span>
        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(!</span>isLocked<span style=color:#666>)</span> <span style=color:#666>{</span>
            log<span style=color:#666>.</span><span style=color:#7d9029>error</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;Fail To Get Lock~&#34;</span><span style=color:#666>);</span>
            <span style=color:green;font-weight:700>return</span><span style=color:#666>;</span>
        <span style=color:#666>}</span>
        <span style=color:green;font-weight:700>try</span> <span style=color:#666>{</span>
            log<span style=color:#666>.</span><span style=color:#7d9029>info</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;Get Lock Successfully~&#34;</span><span style=color:#666>);</span>
            methodTwo<span style=color:#666>();</span>
        <span style=color:#666>}</span> <span style=color:green;font-weight:700>finally</span> <span style=color:#666>{</span>
            log<span style=color:#666>.</span><span style=color:#7d9029>info</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;Release Lock~&#34;</span><span style=color:#666>);</span>
            lock<span style=color:#666>.</span><span style=color:#7d9029>unlock</span><span style=color:#666>();</span>
        <span style=color:#666>}</span>
    <span style=color:#666>}</span>

    <span style=color:#a2f>@Test</span>
    <span style=color:#b00040>void</span> <span style=color:#00f>methodTwo</span><span style=color:#666>()</span> <span style=color:green;font-weight:700>throws</span> InterruptedException <span style=color:#666>{</span>
        <span style=color:#b00040>boolean</span> isLocked <span style=color:#666>=</span> lock<span style=color:#666>.</span><span style=color:#7d9029>tryLock</span><span style=color:#666>();</span>
        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(!</span>isLocked<span style=color:#666>)</span> <span style=color:#666>{</span>
            log<span style=color:#666>.</span><span style=color:#7d9029>error</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;Fail To Get Lock!&#34;</span><span style=color:#666>);</span>
            <span style=color:green;font-weight:700>return</span><span style=color:#666>;</span>
        <span style=color:#666>}</span>
        <span style=color:green;font-weight:700>try</span> <span style=color:#666>{</span>
            log<span style=color:#666>.</span><span style=color:#7d9029>info</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;Get Lock Successfully!&#34;</span><span style=color:#666>);</span>
        <span style=color:#666>}</span> <span style=color:green;font-weight:700>finally</span> <span style=color:#666>{</span>
            log<span style=color:#666>.</span><span style=color:#7d9029>info</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;Release Lock!&#34;</span><span style=color:#666>);</span>
            lock<span style=color:#666>.</span><span style=color:#7d9029>unlock</span><span style=color:#666>();</span>
        <span style=color:#666>}</span>
    <span style=color:#666>}</span>
<span style=color:#666>}</span>

</code></pre></div><blockquote><p><strong>可重入锁的实现思路</strong></p></blockquote><blockquote><ul><li>在 Lock 锁中，借助于一个 state 变量来记录重入的状态，如果当前没有人持有该把锁，state = 0；若有人持有该把锁，state = 1；如果持有该把锁的人再次持有这把锁，state + 1。</li><li>对于 synchronized 而言，底层 C 语言代码中有一个 count，与 state 原理类似，重入一次加一，释放一次减一，直至为 0，表示当前这把锁无人持有。</li><li>释放锁（删除）的时机：state 为 0。</li><li>采用 Hash 结构存储锁：Key 中存储锁名称、Field 中存储线程标识、Value 中存储重入数，即 state。
使用 可重入锁 执行上述代码：</li></ul><p>methodOne() 中获取到锁后 state + 1 ==> state = 1；调用 methodTwo()，在 methodTwo() 中获取到锁后再次 state + 1 ===> state = 2；
methodTwo() 中执行业务后释放锁 state - 1 ===> state = 1；methodOne() 中执行业务后 state - 1 ===> state = 0，此时 Redis 中的锁已经被删除。</p></blockquote><h3 id=54-分布式锁-redission锁重试和watchdog机制>5.4 分布式锁-redission锁重试和WatchDog机制<a href=#54-分布式锁-redission锁重试和watchdog机制 class=header-anchor arialabel=Anchor> #</a></h3><blockquote><p>锁重试</p></blockquote><p><img src=http://itsawaysu.oss-cn-shanghai.aliyuncs.com/note/Redisson%23tryLock%20%E9%94%81%E9%87%8D%E8%AF%95.png alt="Redisson#tryLock 锁重试"></p><p><strong>说明</strong>：由于课程中已经说明了有关tryLock的源码解析以及其看门狗原理，所以笔者在这里给大家分析lock()方法的源码解析，希望大家在学习过程中，能够掌握更多的知识</p><p>抢锁过程中，获得当前线程，通过tryAcquire进行抢锁，该抢锁逻辑和之前逻辑相同</p><p>1、先判断当前这把锁是否存在，如果不存在，插入一把锁，返回null</p><p>2、判断当前这把锁是否是属于当前线程，如果是，则返回null</p><p>所以如果返回是null，则代表着当前这哥们已经抢锁完毕，或者可重入完毕，但是如果以上两个条件都不满足，则进入到第三个条件，返回的是锁的失效时间，同学们可以自行往下翻一点点，你能发现有个while( true) 再次进行tryAcquire进行抢锁</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#b00040>long</span> threadId <span style=color:#666>=</span> Thread<span style=color:#666>.</span><span style=color:#7d9029>currentThread</span><span style=color:#666>().</span><span style=color:#7d9029>getId</span><span style=color:#666>();</span>
Long ttl <span style=color:#666>=</span> tryAcquire<span style=color:#666>(-</span>1<span style=color:#666>,</span> leaseTime<span style=color:#666>,</span> unit<span style=color:#666>,</span> threadId<span style=color:#666>);</span>
<span style=color:#408080;font-style:italic>// lock acquired
</span><span style=color:#408080;font-style:italic></span><span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>ttl <span style=color:#666>==</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
    <span style=color:green;font-weight:700>return</span><span style=color:#666>;</span>
<span style=color:#666>}</span>
</code></pre></div><p>接下来会有一个条件分支，因为lock方法有重载方法，一个是带参数，一个是不带参数，如果带带参数传入的值是-1，如果传入参数，则leaseTime是他本身，所以如果传入了参数，此时leaseTime != -1 则会进去抢锁，抢锁的逻辑就是之前说的那三个逻辑</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>leaseTime <span style=color:#666>!=</span> <span style=color:#666>-</span>1<span style=color:#666>)</span> <span style=color:#666>{</span>
    <span style=color:green;font-weight:700>return</span> tryLockInnerAsync<span style=color:#666>(</span>waitTime<span style=color:#666>,</span> leaseTime<span style=color:#666>,</span> unit<span style=color:#666>,</span> threadId<span style=color:#666>,</span> RedisCommands<span style=color:#666>.</span><span style=color:#7d9029>EVAL_LONG</span><span style=color:#666>);</span>
<span style=color:#666>}</span>
</code></pre></div><p>如果是没有传入时间，则此时也会进行抢锁， 而且抢锁时间是默认看门狗时间 commandExecutor.getConnectionManager().getCfg().getLockWatchdogTimeout()</p><p>ttlRemainingFuture.onComplete((ttlRemaining, e) 这句话相当于对以上抢锁进行了监听，也就是说当上边抢锁完毕后，此方法会被调用，具体调用的逻辑就是去后台开启一个线程，进行续约逻辑，也就是看门狗线程</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>RFuture<span style=color:#666>&lt;</span>Long<span style=color:#666>&gt;</span> ttlRemainingFuture <span style=color:#666>=</span> tryLockInnerAsync<span style=color:#666>(</span>waitTime<span style=color:#666>,</span>
                                        commandExecutor<span style=color:#666>.</span><span style=color:#7d9029>getConnectionManager</span><span style=color:#666>().</span><span style=color:#7d9029>getCfg</span><span style=color:#666>().</span><span style=color:#7d9029>getLockWatchdogTimeout</span><span style=color:#666>(),</span>
                                        TimeUnit<span style=color:#666>.</span><span style=color:#7d9029>MILLISECONDS</span><span style=color:#666>,</span> threadId<span style=color:#666>,</span> RedisCommands<span style=color:#666>.</span><span style=color:#7d9029>EVAL_LONG</span><span style=color:#666>);</span>
ttlRemainingFuture<span style=color:#666>.</span><span style=color:#7d9029>onComplete</span><span style=color:#666>((</span>ttlRemaining<span style=color:#666>,</span> e<span style=color:#666>)</span> <span style=color:#666>-&gt;</span> <span style=color:#666>{</span>
    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>e <span style=color:#666>!=</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:green;font-weight:700>return</span><span style=color:#666>;</span>
    <span style=color:#666>}</span>

    <span style=color:#408080;font-style:italic>// lock acquired
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>ttlRemaining <span style=color:#666>==</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
        scheduleExpirationRenewal<span style=color:#666>(</span>threadId<span style=color:#666>);</span>
    <span style=color:#666>}</span>
<span style=color:#666>});</span>
<span style=color:green;font-weight:700>return</span> ttlRemainingFuture<span style=color:#666>;</span>
</code></pre></div><p>此逻辑就是续约逻辑，注意看commandExecutor.getConnectionManager().newTimeout（） 此方法</p><p>Method( <strong>new</strong> TimerTask() {},参数2 ，参数3 )</p><p>指的是：通过参数2，参数3 去描述什么时候去做参数1的事情，现在的情况是：10s之后去做参数一的事情</p><p>因为锁的失效时间是30s，当10s之后，此时这个timeTask 就触发了，他就去进行续约，把当前这把锁续约成30s，如果操作成功，那么此时就会递归调用自己，再重新设置一个timeTask()，于是再过10s后又再设置一个timerTask，完成不停的续约</p><p>那么大家可以想一想，假设我们的线程出现了宕机他还会续约吗？当然不会，因为没有人再去调用renewExpiration这个方法，所以等到时间之后自然就释放了。</p><blockquote><p>WatchDog</p></blockquote><blockquote><p>对抢锁过程进行监听，抢锁完毕后，scheduleExpirationRenewal(threadId) 方法会被调用来对锁的过期时间进行续约，在后台开启一个线程，进行续约逻辑，也就是看门狗线程。</p></blockquote><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#408080;font-style:italic>// 续约逻辑
</span><span style=color:#408080;font-style:italic></span>commandExecutor<span style=color:#666>.</span><span style=color:#7d9029>getConnectionManager</span><span style=color:#666>().</span><span style=color:#7d9029>newTimeout</span><span style=color:#666>(</span><span style=color:green;font-weight:700>new</span> TimerTask<span style=color:#666>()</span> <span style=color:#666>{...</span> <span style=color:#666>},</span> 锁失效时间 <span style=color:#666>/</span> 3<span style=color:#666>,</span> TimeUnit<span style=color:#666>.</span><span style=color:#7d9029>MILLISECONDS</span><span style=color:#666>);</span>

Method<span style=color:#666>(</span><span style=color:green;font-weight:700>new</span> TimerTask<span style=color:#666>(){},</span> 参数2<span style=color:#666>,</span> 参数3<span style=color:#666>)</span>

</code></pre></div><blockquote><p>通过参数2、参数3 去描述，什么时候做参数1 的事情。</p></blockquote><blockquote><p>锁的失效时间为 30s，10s 后这个 TimerTask 就会被触发，于是进行续约，将其续约为 30s；
若操作成功，则递归调用自己，重新设置一个 TimerTask 并且在 10s 后触发；循环往复，不停的续约</p></blockquote><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:green;font-weight:700>private</span> <span style=color:#b00040>void</span> <span style=color:#00f>renewExpiration</span><span style=color:#666>()</span> <span style=color:#666>{</span>
    ExpirationEntry ee <span style=color:#666>=</span> EXPIRATION_RENEWAL_MAP<span style=color:#666>.</span><span style=color:#7d9029>get</span><span style=color:#666>(</span>getEntryName<span style=color:#666>());</span>
    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>ee <span style=color:#666>==</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:green;font-weight:700>return</span><span style=color:#666>;</span>
    <span style=color:#666>}</span>
    
    Timeout task <span style=color:#666>=</span> commandExecutor<span style=color:#666>.</span><span style=color:#7d9029>getConnectionManager</span><span style=color:#666>().</span><span style=color:#7d9029>newTimeout</span><span style=color:#666>(</span><span style=color:green;font-weight:700>new</span> TimerTask<span style=color:#666>()</span> <span style=color:#666>{</span>
        <span style=color:#a2f>@Override</span>
        <span style=color:green;font-weight:700>public</span> <span style=color:#b00040>void</span> <span style=color:#00f>run</span><span style=color:#666>(</span>Timeout timeout<span style=color:#666>)</span> <span style=color:green;font-weight:700>throws</span> Exception <span style=color:#666>{</span>
            ExpirationEntry ent <span style=color:#666>=</span> EXPIRATION_RENEWAL_MAP<span style=color:#666>.</span><span style=color:#7d9029>get</span><span style=color:#666>(</span>getEntryName<span style=color:#666>());</span>
            <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>ent <span style=color:#666>==</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
                <span style=color:green;font-weight:700>return</span><span style=color:#666>;</span>
            <span style=color:#666>}</span>
            Long threadId <span style=color:#666>=</span> ent<span style=color:#666>.</span><span style=color:#7d9029>getFirstThreadId</span><span style=color:#666>();</span>
            <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>threadId <span style=color:#666>==</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
                <span style=color:green;font-weight:700>return</span><span style=color:#666>;</span>
            <span style=color:#666>}</span>
            
            RFuture<span style=color:#666>&lt;</span>Boolean<span style=color:#666>&gt;</span> future <span style=color:#666>=</span> renewExpirationAsync<span style=color:#666>(</span>threadId<span style=color:#666>);</span>
            future<span style=color:#666>.</span><span style=color:#7d9029>onComplete</span><span style=color:#666>((</span>res<span style=color:#666>,</span> e<span style=color:#666>)</span> <span style=color:#666>-&gt;</span> <span style=color:#666>{</span>
                <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>e <span style=color:#666>!=</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
                    log<span style=color:#666>.</span><span style=color:#7d9029>error</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;Can&#39;t update lock &#34;</span> <span style=color:#666>+</span> getName<span style=color:#666>()</span> <span style=color:#666>+</span> <span style=color:#ba2121>&#34; expiration&#34;</span><span style=color:#666>,</span> e<span style=color:#666>);</span>
                    <span style=color:green;font-weight:700>return</span><span style=color:#666>;</span>
                <span style=color:#666>}</span>
                
                <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>res<span style=color:#666>)</span> <span style=color:#666>{</span>
                    <span style=color:#408080;font-style:italic>// reschedule itself
</span><span style=color:#408080;font-style:italic></span>                    renewExpiration<span style=color:#666>();</span>
                <span style=color:#666>}</span>
            <span style=color:#666>});</span>
        <span style=color:#666>}</span>
    <span style=color:#666>},</span> internalLockLeaseTime <span style=color:#666>/</span> 3<span style=color:#666>,</span> TimeUnit<span style=color:#666>.</span><span style=color:#7d9029>MILLISECONDS</span><span style=color:#666>);</span>
    
    ee<span style=color:#666>.</span><span style=color:#7d9029>setTimeout</span><span style=color:#666>(</span>task<span style=color:#666>);</span>
<span style=color:#666>}</span>
</code></pre></div><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span>#</span>自写
Radisson分布式锁原理<span>：</span>
可重入<span>：</span>利用hash结构记录线程id和重入次数
可重试<span>：</span>利用信号量和PubSub功能实现等待<span>、</span>唤醒<span>，</span>获取锁失败的重试机制
超时续约<span>：</span>利用watchDog<span>，</span>每隔一段时间<span>（</span>releaseTime <span style=color:#666>/</span> 3<span>），</span>重置超时时间

</code></pre></div><p><img src=https://itsawaysu.oss-cn-shanghai.aliyuncs.com/note/Redisson%20%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%8E%9F%E7%90%86.jpg alt="Redisson 分布式锁原理"></p><h3 id=总结redission分布式锁>总结redission分布式锁<a href=#总结redission分布式锁 class=header-anchor arialabel=Anchor> #</a></h3><blockquote><p>1.引入依赖</p><p>2.配置redission客户端</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@Configuration</span>
<span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>RedissonConfig</span> <span style=color:#666>{</span>

<span style=color:#a2f>@Bean</span>
<span style=color:green;font-weight:700>public</span> RedissonClient <span style=color:#00f>redissonClient</span><span style=color:#666>(){</span>
<span style=color:#408080;font-style:italic>// 配置类
</span><span style=color:#408080;font-style:italic></span>Config config <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> Config<span style=color:#666>();</span>
<span style=color:#408080;font-style:italic>// 添加 Redis 地址：此处是单节点地址，也可以通过 config.useClusterServers() 添加集群地址
</span><span style=color:#408080;font-style:italic></span>config<span style=color:#666>.</span><span style=color:#7d9029>useSingleServer</span><span style=color:#666>().</span><span style=color:#7d9029>setAddress</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;182.168.8.130:6379&#34;</span><span style=color:#666>).</span><span style=color:#7d9029>setPassword</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;yangroot&#34;</span><span style=color:#666>);</span>
<span style=color:#408080;font-style:italic>// 创建客户端
</span><span style=color:#408080;font-style:italic></span><span style=color:green;font-weight:700>return</span> Redisson<span style=color:#666>.</span><span style=color:#7d9029>create</span><span style=color:#666>(</span>config<span style=color:#666>);</span>
<span style=color:#666>}</span>
<span style=color:#666>}</span>

</code></pre></div><p>3.将原来的simpleredislocky锁换成redissonClient.getLock（）；</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#408080;font-style:italic>// 创建锁对象
</span><span style=color:#408080;font-style:italic></span>RLock redisLock <span style=color:#666>=</span> redissonClient<span style=color:#666>.</span><span style=color:#7d9029>getLock</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;lock:order:&#34;</span> <span style=color:#666>+</span> userId<span style=color:#666>);</span>
<span style=color:#408080;font-style:italic>// 尝试获取锁
</span><span style=color:#408080;font-style:italic></span><span style=color:#b00040>boolean</span> isLock <span style=color:#666>=</span> redisLock<span style=color:#666>.</span><span style=color:#7d9029>tryLock</span><span style=color:#666>();</span>
</code></pre></div><blockquote><p>1.redissonClient 将Hash结构存储锁，key是判断锁是否存在，小key 判断这个锁是否是自己的，value判断入重数</p><p>(Key 中存储锁名称、Field 中存储线程标识、Value 中存储重入数，即 state)</p></blockquote><blockquote><ol start=2><li></li></ol><p>可重入：利用hash结构记录线程id和重入次数
可重试：利用信号量和PubSub功能实现等待、唤醒，获取锁失败的重试机制
超时续约:利用watchDog,每隔一段时间（releaseTime /3）,重置超时时间</p></blockquote><blockquote><p>3.可重试：</p><blockquote><p>1.抢锁过程中，获得当前线程，通过tryAcquire进行抢锁，该抢锁逻辑和之前逻辑相同</p><p>1、先判断当前这把锁是否存在，如果不存在，插入一把锁，返回null</p><p>2、判断当前这把锁是否是属于当前线程，如果是，则返回null</p><p>所以如果返回是null，则代表着当前这哥们已经抢锁完毕，或者可重入完毕，但是如果以上两个条件都不满足，则进入到第三个条件，返回的是锁的失效时间，while( true) 再次进行tryAcquire进行抢锁</p><p>接下来会有一个条件分支，因为lock方法有重载方法，一个是带参数，一个是不带参数，如果带带参数传入的值是-1，如果传入参数，则leaseTime是他本身，所以如果传入了参数，此时leaseTime != -1 则会进去抢锁，抢锁的逻辑就是之前说的那三个逻辑</p><p>如果是没有传入时间，则此时也会进行抢锁， 而且抢锁时间是默认看门狗时间 commandExecutor.getConnectionManager().getCfg().getLockWatchdogTimeout()</p><p>ttlRemainingFuture.onComplete((ttlRemaining, e) 这句话相当于对以上抢锁进行了监听，也就是说当上边抢锁完毕后，此方法会被调用，具体调用的逻辑就是去后台开启一个线程，进行续约逻辑，也就是看门狗线程</p></blockquote></blockquote></blockquote><h3 id=55-分布式锁-redission锁的mutilock原理>5.5 分布式锁-redission锁的MutiLock原理<a href=#55-分布式锁-redission锁的mutilock原理 class=header-anchor arialabel=Anchor> #</a></h3><p>为了提高redis的可用性，我们会搭建集群或者主从，现在以主从为例</p><p>此时我们去写命令，写在主机上， 主机会将数据同步给从机，但是假设在主机还没有来得及把数据写入到从机去的时候，此时主机宕机，哨兵会发现主机宕机，并且选举一个slave变成master，而此时新的master中实际上并没有锁信息，此时锁信息就已经丢掉了。</p><p>为了解决这个问题，redission提出来了MutiLock锁，使用这把锁咱们就不使用主从了，每个节点的地位都是一样的， 这把锁加锁的逻辑需要写入到每一个主丛节点上，只有所有的服务器都写入成功，此时才是加锁成功，假设现在某个节点挂了，那么他去获得锁的时候，只要有一个节点拿不到，都不能算是加锁成功，就保证了加锁的可靠性。</p><p>那么MutiLock 加锁原理是什么呢？笔者画了一幅图来说明</p><p>当我们去设置了多个锁时，redission会将多个锁添加到一个集合中，然后用while循环去不停去尝试拿锁，但是会有一个总共的加锁时间，这个时间是用需要加锁的个数 * 1500ms ，假设有3个锁，那么时间就是4500ms，假设在这4500ms内，所有的锁都加锁成功， 那么此时才算是加锁成功，如果在4500ms有线程加锁失败，则会再次去进行重试.</p><p><img src=https://itsawaysu.oss-cn-shanghai.aliyuncs.com/note/Redisson%20%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E4%B8%BB%E4%BB%8E%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98.jpg alt="Redisson 分布式锁主从一致性问题"></p><h3 id=总结mutilock锁>总结MutiLock锁<a href=#总结mutilock锁 class=header-anchor arialabel=Anchor> #</a></h3><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>#自写
    1.在redisCilent 做三个虚拟机的redisNode 
   2.引入redisCilent，1redisCilent2，redisCilent3
    3.在beforeacher获得三个getlock()
    4.lock1,lock2,lock3
    5.创建联锁
    lock=redisCilent.getMultilock(lock1,lock2,lock3).(成为一个集合)
    (底层是new RedissonMulitiLOck(lock1..))

</code></pre></div><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span>#</span>配置客户端
<span style=color:#a2f>@Configuration</span>
<span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>RedisConfiguration</span> <span style=color:#666>{</span>
    <span style=color:#a2f>@Bean</span>
    <span style=color:green;font-weight:700>public</span> RedissonClient <span style=color:#00f>redissonClient</span><span style=color:#666>()</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 配置类
</span><span style=color:#408080;font-style:italic></span>        Config config <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> Config<span style=color:#666>();</span>
        <span style=color:#408080;font-style:italic>// 添加 Redis 地址：此处是单节点地址，也可以通过 config.useClusterServers() 添加集群地址
</span><span style=color:#408080;font-style:italic></span>        config<span style=color:#666>.</span><span style=color:#7d9029>useSingleServer</span><span style=color:#666>().</span><span style=color:#7d9029>setAddress</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;redis://127.0.0.1:6379&#34;</span><span style=color:#666>).</span><span style=color:#7d9029>setPassword</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;root&#34;</span><span style=color:#666>);</span>
        <span style=color:#408080;font-style:italic>// 创建客户端
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>return</span> Redisson<span style=color:#666>.</span><span style=color:#7d9029>create</span><span style=color:#666>(</span>config<span style=color:#666>);</span>
    <span style=color:#666>}</span>

    <span style=color:#a2f>@Bean</span>
    <span style=color:green;font-weight:700>public</span> RedissonClient <span style=color:#00f>redissonClientTwo</span><span style=color:#666>()</span> <span style=color:#666>{</span>
        Config config <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> Config<span style=color:#666>();</span>
        config<span style=color:#666>.</span><span style=color:#7d9029>useSingleServer</span><span style=color:#666>().</span><span style=color:#7d9029>setAddress</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;redis://127.0.0.1:6380&#34;</span><span style=color:#666>).</span><span style=color:#7d9029>setPassword</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;root&#34;</span><span style=color:#666>);</span>
        <span style=color:green;font-weight:700>return</span> Redisson<span style=color:#666>.</span><span style=color:#7d9029>create</span><span style=color:#666>(</span>config<span style=color:#666>);</span>
    <span style=color:#666>}</span>

    <span style=color:#a2f>@Bean</span>
    <span style=color:green;font-weight:700>public</span> RedissonClient <span style=color:#00f>redissonClientThree</span><span style=color:#666>()</span> <span style=color:#666>{</span>
        Config config <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> Config<span style=color:#666>();</span>
        config<span style=color:#666>.</span><span style=color:#7d9029>useSingleServer</span><span style=color:#666>().</span><span style=color:#7d9029>setAddress</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;redis://127.0.0.1:6381&#34;</span><span style=color:#666>).</span><span style=color:#7d9029>setPassword</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;root&#34;</span><span style=color:#666>);</span>
        <span style=color:green;font-weight:700>return</span> Redisson<span style=color:#666>.</span><span style=color:#7d9029>create</span><span style=color:#666>(</span>config<span style=color:#666>);</span>
    <span style=color:#666>}</span>
<span style=color:#666>}</span>
<span>#</span> 创建联锁并且进行测试
<span style=color:#a2f>@Slf4j</span>
<span style=color:#a2f>@SpringBootTest</span>
<span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>RedissonTest</span> <span style=color:#666>{</span>

    <span style=color:#a2f>@Resource</span>
    <span style=color:green;font-weight:700>private</span> RedissonClient redissonClient<span style=color:#666>;</span>

    <span style=color:#a2f>@Resource</span>
    <span style=color:green;font-weight:700>private</span> RedissonClient redissonClientTwo<span style=color:#666>;</span>

    <span style=color:#a2f>@Resource</span>
    <span style=color:green;font-weight:700>private</span> RedissonClient redissonClientThree<span style=color:#666>;</span>

    RLock multiLock<span style=color:#666>;</span>

    <span style=color:#a2f>@BeforeEach</span>
    <span style=color:#b00040>void</span> <span style=color:#00f>setUp</span><span style=color:#666>()</span> <span style=color:#666>{</span>
        RLock lock <span style=color:#666>=</span> redissonClient<span style=color:#666>.</span><span style=color:#7d9029>getLock</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;anyLock&#34;</span><span style=color:#666>);</span>
        RLock lockTwo <span style=color:#666>=</span> redissonClientTwo<span style=color:#666>.</span><span style=color:#7d9029>getLock</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;anyLock&#34;</span><span style=color:#666>);</span>
        RLock lockThree <span style=color:#666>=</span> redissonClientThree<span style=color:#666>.</span><span style=color:#7d9029>getLock</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;anyLock&#34;</span><span style=color:#666>);</span>
        <span style=color:#408080;font-style:italic>// 创建联锁 MultiLock
</span><span style=color:#408080;font-style:italic></span>        RLock multiLock <span style=color:#666>=</span> redissonClient<span style=color:#666>.</span><span style=color:#7d9029>getMultiLock</span><span style=color:#666>(</span>lock<span style=color:#666>,</span> lockTwo<span style=color:#666>,</span> lockThree<span style=color:#666>);</span>
    <span style=color:#666>}</span>

    <span style=color:#a2f>@Test</span>
    <span style=color:#b00040>void</span> <span style=color:#00f>methodOne</span><span style=color:#666>()</span> <span style=color:green;font-weight:700>throws</span> InterruptedException <span style=color:#666>{</span>
        <span style=color:#b00040>boolean</span> isLocked <span style=color:#666>=</span> multiLock<span style=color:#666>.</span><span style=color:#7d9029>tryLock</span><span style=color:#666>(</span>1L<span style=color:#666>,</span> TimeUnit<span style=color:#666>.</span><span style=color:#7d9029>SECONDS</span><span style=color:#666>);</span>
        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(!</span>isLocked<span style=color:#666>)</span> <span style=color:#666>{</span>
            log<span style=color:#666>.</span><span style=color:#7d9029>error</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;Fail To Get Lock~&#34;</span><span style=color:#666>);</span>
            <span style=color:green;font-weight:700>return</span><span style=color:#666>;</span>
        <span style=color:#666>}</span>
        <span style=color:green;font-weight:700>try</span> <span style=color:#666>{</span>
            log<span style=color:#666>.</span><span style=color:#7d9029>info</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;Get Lock Successfully~&#34;</span><span style=color:#666>);</span>
            methodTwo<span style=color:#666>();</span>
        <span style=color:#666>}</span> <span style=color:green;font-weight:700>finally</span> <span style=color:#666>{</span>
            log<span style=color:#666>.</span><span style=color:#7d9029>info</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;Release Lock~&#34;</span><span style=color:#666>);</span>
            multiLock<span style=color:#666>.</span><span style=color:#7d9029>unlock</span><span style=color:#666>();</span>
        <span style=color:#666>}</span>
    <span style=color:#666>}</span>

    <span style=color:#a2f>@Test</span>
    <span style=color:#b00040>void</span> <span style=color:#00f>methodTwo</span><span style=color:#666>()</span> <span style=color:green;font-weight:700>throws</span> InterruptedException <span style=color:#666>{</span>
        <span style=color:#b00040>boolean</span> isLocked <span style=color:#666>=</span> multiLock<span style=color:#666>.</span><span style=color:#7d9029>tryLock</span><span style=color:#666>(</span>1L<span style=color:#666>,</span> TimeUnit<span style=color:#666>.</span><span style=color:#7d9029>SECONDS</span><span style=color:#666>);</span>
        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(!</span>isLocked<span style=color:#666>)</span> <span style=color:#666>{</span>
            log<span style=color:#666>.</span><span style=color:#7d9029>error</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;Fail To Get Lock!&#34;</span><span style=color:#666>);</span>
            <span style=color:green;font-weight:700>return</span><span style=color:#666>;</span>
        <span style=color:#666>}</span>
        <span style=color:green;font-weight:700>try</span> <span style=color:#666>{</span>
            log<span style=color:#666>.</span><span style=color:#7d9029>info</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;Get Lock Successfully!&#34;</span><span style=color:#666>);</span>
        <span style=color:#666>}</span> <span style=color:green;font-weight:700>finally</span> <span style=color:#666>{</span>
            log<span style=color:#666>.</span><span style=color:#7d9029>info</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;Release Lock!&#34;</span><span style=color:#666>);</span>
            multiLock<span style=color:#666>.</span><span style=color:#7d9029>unlock</span><span style=color:#666>();</span>
        <span style=color:#666>}</span>
    <span style=color:#666>}</span>
<span style=color:#666>}</span>

</code></pre></div><blockquote><ul><li>1）不可重入Redis分布式锁：
原理：利用setnx的互斥性；利用ex避免死锁；释放锁时判断线程标示
缺陷：不可重入、无法重试、锁超时失效</li><li>2）可重入的Redis分布式锁：
原理：利用hash结构，记录线程标示和重入次数；利用watchDog延续锁时间；利用信号量控制锁重试等待
缺陷：redis宕机引起锁失效问题</li><li>3）Redisson的multiLock：
原理：多个独立的Redis节点，必须在所有节点都获取重入锁，才算获取锁成功
缺陷：运维成本高、实现复杂</li></ul></blockquote><h2 id=6秒杀优化>6、秒杀优化<a href=#6秒杀优化 class=header-anchor arialabel=Anchor> #</a></h2><h3 id=61-秒杀优化-异步秒杀思路>6.1 秒杀优化-异步秒杀思路<a href=#61-秒杀优化-异步秒杀思路 class=header-anchor arialabel=Anchor> #</a></h3><p>我们来回顾一下下单流程</p><p>当用户发起请求，此时会请求nginx，nginx会访问到tomcat，而tomcat中的程序，会进行串行操作，分成如下几个步骤</p><p>1、查询优惠卷</p><p>2、判断秒杀库存是否足够</p><p>3、查询订单</p><p>4、校验是否是一人一单</p><p>5、扣减库存</p><p>6、创建订单</p><blockquote><p>以上操作都是串行执行的，并且 1、3、5、6 的操作都需要与数据库进行交互，从而导致程序执行的很慢。</p></blockquote><blockquote><p><strong>秒杀优化方案</strong></p></blockquote><blockquote><p>将耗时较短的逻辑判断放到 Redis 中，比如 2、4 中的操作，只要这样的逻辑能够完成，意味着一定能够完成下单，只需要进行快速的逻辑判断，无需等待下单逻辑全部走完即可返回成功；再在后台开一个线程，后台线程负责慢慢的执行 Queue 中的消息。</p></blockquote><p><img src=https://itsawaysu.oss-cn-shanghai.aliyuncs.com/note/%E7%A7%92%E6%9D%80%E4%BC%98%E5%8C%96%E6%96%B9%E6%A1%88.jpg alt=秒杀优化方案></p><blockquote><p>秒杀优化的实现思路</p></blockquote><ul><li>新增优惠券的同时，将优惠券信息保存到 Redis 中；
基于 Lua 脚本，判断秒杀库存、一人一单，决定用户是否抢购成功，如果 Lua 执行返回 0，则有购买资格；</li><li>用户下单后，判断库存是否充足，只需要在 Redis 中根据 Key 去找到对应的 Value 是否大于 0 即可。</li><li>若不充足，直接结束；若充足，则继续在 Redis 中判断用户是否可以下单，如果 Set 集合中不存在这个 Value（用户 ID），说明该用户可以下单。</li><li>如果有购买资格，将订单信息存入阻塞队列，并且返回 订单 ID（此时已经秒杀业务已经结束，何时进行异步下单操作数据库不再重要）；</li><li>开启线程任务，不断从阻塞队列中获取信息，实现异步下单。</li></ul><p><img src=https://itsawaysu.oss-cn-shanghai.aliyuncs.com/note/%E7%A7%92%E6%9D%80%E4%BC%98%E5%8C%96%E6%96%B9%E6%A1%88%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF.jpg alt=秒杀优化方案的实现思路></p><h3 id=62-秒杀优化-redis完成秒杀资格判断>6.2 秒杀优化-Redis完成秒杀资格判断<a href=#62-秒杀优化-redis完成秒杀资格判断 class=header-anchor arialabel=Anchor> #</a></h3><p>需求：</p><ul><li><p>新增秒杀优惠券的同时，将优惠券信息保存到Redis中</p></li><li><p>基于Lua脚本，判断秒杀库存、一人一单，决定用户是否抢购成功</p></li><li><p>如果抢购成功，将优惠券id和用户id封装后存入阻塞队列</p></li><li><p>开启线程任务，不断从阻塞队列中获取信息，实现异步下单功能</p></li></ul><p>VoucherServiceImpl</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@Override</span>
<span style=color:#a2f>@Transactional</span>
<span style=color:green;font-weight:700>public</span> <span style=color:#b00040>void</span> <span style=color:#00f>addSeckillVoucher</span><span style=color:#666>(</span>Voucher voucher<span style=color:#666>)</span> <span style=color:#666>{</span>
    <span style=color:#408080;font-style:italic>// 保存优惠券
</span><span style=color:#408080;font-style:italic></span>    save<span style=color:#666>(</span>voucher<span style=color:#666>);</span>
    <span style=color:#408080;font-style:italic>// 保存秒杀信息
</span><span style=color:#408080;font-style:italic></span>    SeckillVoucher seckillVoucher <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> SeckillVoucher<span style=color:#666>();</span>
    seckillVoucher<span style=color:#666>.</span><span style=color:#7d9029>setVoucherId</span><span style=color:#666>(</span>voucher<span style=color:#666>.</span><span style=color:#7d9029>getId</span><span style=color:#666>());</span>
    seckillVoucher<span style=color:#666>.</span><span style=color:#7d9029>setStock</span><span style=color:#666>(</span>voucher<span style=color:#666>.</span><span style=color:#7d9029>getStock</span><span style=color:#666>());</span>
    seckillVoucher<span style=color:#666>.</span><span style=color:#7d9029>setBeginTime</span><span style=color:#666>(</span>voucher<span style=color:#666>.</span><span style=color:#7d9029>getBeginTime</span><span style=color:#666>());</span>
    seckillVoucher<span style=color:#666>.</span><span style=color:#7d9029>setEndTime</span><span style=color:#666>(</span>voucher<span style=color:#666>.</span><span style=color:#7d9029>getEndTime</span><span style=color:#666>());</span>
    seckillVoucherService<span style=color:#666>.</span><span style=color:#7d9029>save</span><span style=color:#666>(</span>seckillVoucher<span style=color:#666>);</span>
    <span style=color:#408080;font-style:italic>// 保存秒杀库存到Redis中
</span><span style=color:#408080;font-style:italic></span>    <span style=color:#408080;font-style:italic>//SECKILL_STOCK_KEY 这个变量定义在RedisConstans中
</span><span style=color:#408080;font-style:italic></span>    <span style=color:#408080;font-style:italic>//private static final String SECKILL_STOCK_KEY =&#34;seckill:stock:&#34;
</span><span style=color:#408080;font-style:italic></span>    stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>().</span><span style=color:#7d9029>set</span><span style=color:#666>(</span>SECKILL_STOCK_KEY <span style=color:#666>+</span> voucher<span style=color:#666>.</span><span style=color:#7d9029>getId</span><span style=color:#666>(),</span> voucher<span style=color:#666>.</span><span style=color:#7d9029>getStock</span><span style=color:#666>().</span><span style=color:#7d9029>toString</span><span style=color:#666>());</span>
<span style=color:#666>}</span>
</code></pre></div><p>完整lua表达式</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=color:#408080;font-style:italic>-- 1.参数列表</span>
<span style=color:#408080;font-style:italic>-- 1.1.优惠券id</span>
<span style=color:green;font-weight:700>local</span> voucherId <span style=color:#666>=</span> ARGV[<span style=color:#666>1</span>]
<span style=color:#408080;font-style:italic>-- 1.2.用户id</span>
<span style=color:green;font-weight:700>local</span> userId <span style=color:#666>=</span> ARGV[<span style=color:#666>2</span>]
<span style=color:#408080;font-style:italic>-- 1.3.订单id</span>
<span style=color:green;font-weight:700>local</span> orderId <span style=color:#666>=</span> ARGV[<span style=color:#666>3</span>]

<span style=color:#408080;font-style:italic>-- 2.数据key</span>
<span style=color:#408080;font-style:italic>-- 2.1.库存key</span>
<span style=color:green;font-weight:700>local</span> stockKey <span style=color:#666>=</span> <span style=color:#ba2121>&#39;seckill:stock:&#39;</span> <span style=color:#666>..</span> voucherId
<span style=color:#408080;font-style:italic>-- 2.2.订单key</span>
<span style=color:green;font-weight:700>local</span> orderKey <span style=color:#666>=</span> <span style=color:#ba2121>&#39;seckill:order:&#39;</span> <span style=color:#666>..</span> voucherId

<span style=color:#408080;font-style:italic>-- 3.脚本业务</span>
<span style=color:#408080;font-style:italic>-- 3.1.判断库存是否充足 get stockKey</span>
<span style=color:green;font-weight:700>if</span>(tonumber(redis.call(<span style=color:#ba2121>&#39;get&#39;</span>, stockKey)) <span style=color:#666>&lt;=</span> <span style=color:#666>0</span>) <span style=color:green;font-weight:700>then</span>
    <span style=color:#408080;font-style:italic>-- 3.2.库存不足，返回1</span>
    <span style=color:green;font-weight:700>return</span> <span style=color:#666>1</span>
<span style=color:green;font-weight:700>end</span>
<span style=color:#408080;font-style:italic>-- 3.2.判断用户是否下单 SISMEMBER orderKey userId</span>
<span style=color:green;font-weight:700>if</span>(redis.call(<span style=color:#ba2121>&#39;sismember&#39;</span>, orderKey, userId) <span style=color:#666>==</span> <span style=color:#666>1</span>) <span style=color:green;font-weight:700>then</span>
    <span style=color:#408080;font-style:italic>-- 3.3.存在，说明是重复下单，返回2</span>
    <span style=color:green;font-weight:700>return</span> <span style=color:#666>2</span>
<span style=color:green;font-weight:700>end</span>
<span style=color:#408080;font-style:italic>-- 3.4.扣库存 incrby stockKey -1</span>
redis.call(<span style=color:#ba2121>&#39;incrby&#39;</span>, stockKey, <span style=color:#666>-</span><span style=color:#666>1</span>)
<span style=color:#408080;font-style:italic>-- 3.5.下单（保存用户）sadd orderKey userId</span>
redis.call(<span style=color:#ba2121>&#39;sadd&#39;</span>, orderKey, userId)
<span style=color:#408080;font-style:italic>-- 3.6.发送消息到队列中， XADD stream.orders * k1 v1 k2 v2 ...</span>
redis.call(<span style=color:#ba2121>&#39;xadd&#39;</span>, <span style=color:#ba2121>&#39;stream.orders&#39;</span>, <span style=color:#ba2121>&#39;*&#39;</span>, <span style=color:#ba2121>&#39;userId&#39;</span>, userId, <span style=color:#ba2121>&#39;voucherId&#39;</span>, voucherId, <span style=color:#ba2121>&#39;id&#39;</span>, orderId)
<span style=color:green;font-weight:700>return</span> <span style=color:#666>0</span>
</code></pre></div><p>当以上lua表达式执行完毕后，剩下的就是根据步骤3,4来执行我们接下来的任务了</p><p>VoucherOrderServiceImpl</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@Override</span>
<span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>seckillVoucher</span><span style=color:#666>(</span>Long voucherId<span style=color:#666>)</span> <span style=color:#666>{</span>
    <span style=color:#408080;font-style:italic>//获取用户
</span><span style=color:#408080;font-style:italic></span>    Long userId <span style=color:#666>=</span> UserHolder<span style=color:#666>.</span><span style=color:#7d9029>getUser</span><span style=color:#666>().</span><span style=color:#7d9029>getId</span><span style=color:#666>();</span>
    <span style=color:#b00040>long</span> orderId <span style=color:#666>=</span> redisIdWorker<span style=color:#666>.</span><span style=color:#7d9029>nextId</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;order&#34;</span><span style=color:#666>);</span>
    <span style=color:#408080;font-style:italic>// 1.执行lua脚本
</span><span style=color:#408080;font-style:italic></span>    Long result <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>execute</span><span style=color:#666>(</span>
            SECKILL_SCRIPT<span style=color:#666>,</span>
            Collections<span style=color:#666>.</span><span style=color:#7d9029>emptyList</span><span style=color:#666>(),</span>
            voucherId<span style=color:#666>.</span><span style=color:#7d9029>toString</span><span style=color:#666>(),</span> userId<span style=color:#666>.</span><span style=color:#7d9029>toString</span><span style=color:#666>(),</span> String<span style=color:#666>.</span><span style=color:#7d9029>valueOf</span><span style=color:#666>(</span>orderId<span style=color:#666>)</span>
    <span style=color:#666>);</span>
    <span style=color:#b00040>int</span> r <span style=color:#666>=</span> result<span style=color:#666>.</span><span style=color:#7d9029>intValue</span><span style=color:#666>();</span>
    <span style=color:#408080;font-style:italic>// 2.判断结果是否为0
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>r <span style=color:#666>!=</span> 0<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 2.1.不为0 ，代表没有购买资格
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span>r <span style=color:#666>==</span> 1 <span style=color:#666>?</span> <span style=color:#ba2121>&#34;库存不足&#34;</span> <span style=color:#666>:</span> <span style=color:#ba2121>&#34;不能重复下单&#34;</span><span style=color:#666>);</span>
    <span style=color:#666>}</span>
    <span style=color:#408080;font-style:italic>//TODO 保存阻塞队列
</span><span style=color:#408080;font-style:italic></span>    <span style=color:#408080;font-style:italic>// 3.返回订单id
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>orderId<span style=color:#666>);</span>
<span style=color:#666>}</span>
</code></pre></div><h3 id=63-秒杀优化-基于阻塞队列实现秒杀优化>6.3 秒杀优化-基于阻塞队列实现秒杀优化<a href=#63-秒杀优化-基于阻塞队列实现秒杀优化 class=header-anchor arialabel=Anchor> #</a></h3><p>VoucherOrderServiceImpl</p><blockquote><p>判断是否有购买资格，如果有购买资格，将订单信息存入阻塞队列，并且返回 订单 ID。</p><p>开启线程任务，不断从阻塞队列中获取信息，实现异步下单。</p></blockquote><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@Service</span>
<span style=color:#a2f>@SuppressWarnings</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;ALL&#34;</span><span style=color:#666>)</span>
<span style=color:#a2f>@Slf4j</span>
<span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>VoucherOrderServiceImpl</span> <span style=color:green;font-weight:700>extends</span> ServiceImpl<span style=color:#666>&lt;</span>VoucherOrderMapper<span style=color:#666>,</span> VoucherOrder<span style=color:#666>&gt;</span> <span style=color:green;font-weight:700>implements</span> VoucherOrderService <span style=color:#666>{</span>

    <span style=color:#a2f>@Resource</span>
    <span style=color:green;font-weight:700>private</span> SeckillVoucherService seckillVoucherService<span style=color:#666>;</span>

    <span style=color:#a2f>@Resource</span>
    <span style=color:green;font-weight:700>private</span> RedisIdWorker redisIdWorker<span style=color:#666>;</span>

    <span style=color:#a2f>@Resource</span>
    <span style=color:green;font-weight:700>private</span> StringRedisTemplate stringRedisTemplate<span style=color:#666>;</span>

    <span style=color:#a2f>@Resource</span>
    <span style=color:green;font-weight:700>private</span> RedissonClient redissonClient<span style=color:#666>;</span>

    <span style=color:#408080;font-style:italic>// Lua 脚本
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>private</span> <span style=color:green;font-weight:700>static</span> <span style=color:green;font-weight:700>final</span> DefaultRedisScript<span style=color:#666>&lt;</span>Long<span style=color:#666>&gt;</span> SECKILL_SCRIPT<span style=color:#666>;</span>
    <span style=color:green;font-weight:700>static</span> <span style=color:#666>{</span>
        SECKILL_SCRIPT <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> DefaultRedisScript<span style=color:#666>&lt;&gt;();</span>
        SECKILL_SCRIPT<span style=color:#666>.</span><span style=color:#7d9029>setLocation</span><span style=color:#666>(</span><span style=color:green;font-weight:700>new</span> ClassPathResource<span style=color:#666>(</span><span style=color:#ba2121>&#34;SeckillVoucher.lua&#34;</span><span style=color:#666>));</span>
        SECKILL_SCRIPT<span style=color:#666>.</span><span style=color:#7d9029>setResultType</span><span style=color:#666>(</span>Long<span style=color:#666>.</span><span style=color:#7d9029>class</span><span style=color:#666>);</span>
    <span style=color:#666>}</span>

    <span style=color:#408080;font-style:italic>// 异步处理线程池,此处获得是单线程
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>private</span> <span style=color:green;font-weight:700>static</span> <span style=color:green;font-weight:700>final</span> ExecutorService SECKILL_ORDER_EXECUTOR <span style=color:#666>=</span> Executors<span style=color:#666>.</span><span style=color:#7d9029>newSingleThreadExecutor</span><span style=color:#666>();</span>

    <span style=color:#408080;font-style:italic>// 在当前类初始完毕后执行 VoucherOrderHandler 中的 run 方法
</span><span style=color:#408080;font-style:italic></span>    <span style=color:#a2f>@PostConstruct</span> <span style=color:#408080;font-style:italic>//在类初始化之后执行，因为当这个类初始化好了之后，随时都是有可能要执行的
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>public</span> <span style=color:#b00040>void</span> <span style=color:#00f>init</span><span style=color:#666>()</span> <span style=color:#666>{</span>
        SECKILL_ORDER_EXECUTOR<span style=color:#666>.</span><span style=color:#7d9029>submit</span><span style=color:#666>(</span><span style=color:green;font-weight:700>new</span> VoucherOrderHandler<span style=color:#666>());</span>
    <span style=color:#666>}</span>

    <span style=color:#408080;font-style:italic>// 阻塞队列：当一个线程尝试从队列中获取元素时：若队列中没有元素线程就会被阻塞，直到队列中有元素时线程才会被唤醒并且去获取元素。
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>private</span> BlockingQueue<span style=color:#666>&lt;</span>VoucherOrder<span style=color:#666>&gt;</span> orderTasks <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> ArrayBlockingQueue<span style=color:#666>&lt;&gt;(</span>1024 <span style=color:#666>*</span> 1024<span style=color:#666>);</span>

    <span style=color:#408080;font-style:italic>// 从队列中获取信息
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>VoucherOrderHandler</span> <span style=color:green;font-weight:700>implements</span> Runnable <span style=color:#666>{</span>
        <span style=color:#a2f>@Override</span>
        <span style=color:green;font-weight:700>public</span> <span style=color:#b00040>void</span> <span style=color:#00f>run</span><span style=color:#666>()</span> <span style=color:#666>{</span>
            <span style=color:green;font-weight:700>while</span> <span style=color:#666>(</span><span style=color:green;font-weight:700>true</span><span style=color:#666>)</span> <span style=color:#666>{</span>
                <span style=color:green;font-weight:700>try</span> <span style=color:#666>{</span>
                    <span style=color:#408080;font-style:italic>// 获取队列中的订单信息
</span><span style=color:#408080;font-style:italic></span>                    VoucherOrder voucherOrder <span style=color:#666>=</span> orderTasks<span style=color:#666>.</span><span style=color:#7d9029>take</span><span style=color:#666>();</span>
                    <span style=color:#408080;font-style:italic>// 创建订单
</span><span style=color:#408080;font-style:italic></span>                    handleVoucherOrder<span style=color:#666>(</span>voucherOrder<span style=color:#666>);</span>
                <span style=color:#666>}</span> <span style=color:green;font-weight:700>catch</span> <span style=color:#666>(</span>Exception e<span style=color:#666>)</span> <span style=color:#666>{</span>
                    log<span style=color:#666>.</span><span style=color:#7d9029>error</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;订单处理异常&#34;</span><span style=color:#666>,</span> e<span style=color:#666>);</span>
                <span style=color:#666>}</span>
            <span style=color:#666>}</span>
        <span style=color:#666>}</span>

        <span style=color:green;font-weight:700>private</span> <span style=color:#b00040>void</span> <span style=color:#00f>handleVoucherOrder</span><span style=color:#666>(</span>VoucherOrder voucherOrder<span style=color:#666>)</span> <span style=color:#666>{</span>
            Long userId <span style=color:#666>=</span> voucherOrder<span style=color:#666>.</span><span style=color:#7d9029>getUserId</span><span style=color:#666>();</span>
            RLock lock <span style=color:#666>=</span> redissonClient<span style=color:#666>.</span><span style=color:#7d9029>getLock</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;lock:order:&#34;</span> <span style=color:#666>+</span> userId<span style=color:#666>);</span>
            <span style=color:#b00040>boolean</span> isLocked <span style=color:#666>=</span> lock<span style=color:#666>.</span><span style=color:#7d9029>tryLock</span><span style=color:#666>();</span>
            <span style=color:green;font-weight:700>if</span> <span style=color:#666>(!</span>isLocked<span style=color:#666>)</span> <span style=color:#666>{</span>
                log<span style=color:#666>.</span><span style=color:#7d9029>error</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;不允许重复下单！&#34;</span><span style=color:#666>);</span>
                <span style=color:green;font-weight:700>return</span><span style=color:#666>;</span>
            <span style=color:#666>}</span>
            <span style=color:green;font-weight:700>try</span> <span style=color:#666>{</span>
                <span style=color:#408080;font-style:italic>// 该方法非主线程调用，代理对象需要在主线程中获取。
</span><span style=color:#408080;font-style:italic>//注意：由于是spring的事务是放在threadLocal中，此时的是多线程，事务会失效
</span><span style=color:#408080;font-style:italic></span>                <span style=color:#408080;font-style:italic>// //目前属于子线程代理对象拿不到，所以我们应该在主线程拿到代理对象(自己加的)
</span><span style=color:#408080;font-style:italic></span>                currentProxy<span style=color:#666>.</span><span style=color:#7d9029>createVoucherOrder</span><span style=color:#666>(</span>voucherOrder<span style=color:#666>);</span>
            <span style=color:#666>}</span> <span style=color:green;font-weight:700>finally</span> <span style=color:#666>{</span>
                lock<span style=color:#666>.</span><span style=color:#7d9029>unlock</span><span style=color:#666>();</span>
            <span style=color:#666>}</span>
        <span style=color:#666>}</span>
    <span style=color:#666>}</span>

    <span style=color:#408080;font-style:italic>// 代理对象
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>private</span> VoucherOrderService currentProxy<span style=color:#666>;</span>

    <span style=color:#a2f>@Override</span>
    <span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>seckillVoucher</span><span style=color:#666>(</span>Long voucherId<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 1. 执行 Lua 脚本
</span><span style=color:#408080;font-style:italic></span>        Long userId <span style=color:#666>=</span> UserHolder<span style=color:#666>.</span><span style=color:#7d9029>getUser</span><span style=color:#666>().</span><span style=color:#7d9029>getId</span><span style=color:#666>();</span>
        <span style=color:#b00040>long</span> orderId <span style=color:#666>=</span> redisIdWorker<span style=color:#666>.</span><span style=color:#7d9029>nextId</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;order&#34;</span><span style=color:#666>);</span>
        Long executeResult <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>execute</span><span style=color:#666>(</span>
                SECKILL_SCRIPT<span style=color:#666>,</span>
                Collections<span style=color:#666>.</span><span style=color:#7d9029>emptyList</span><span style=color:#666>(),</span>
                voucherId<span style=color:#666>.</span><span style=color:#7d9029>toString</span><span style=color:#666>(),</span> userId<span style=color:#666>.</span><span style=color:#7d9029>toString</span><span style=color:#666>()</span>
        <span style=color:#666>);</span>

        <span style=color:#408080;font-style:italic>// 2. Lua 脚本的执行结果不为 0 则没有购买资格
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#b00040>int</span> result <span style=color:#666>=</span> executeResult<span style=color:#666>.</span><span style=color:#7d9029>intValue</span><span style=color:#666>();</span>
        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>result <span style=color:#666>!=</span> 0<span style=color:#666>)</span> <span style=color:#666>{</span>
            <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span>result <span style=color:#666>==</span> 1 <span style=color:#666>?</span> <span style=color:#ba2121>&#34;库存不足！&#34;</span> <span style=color:#666>:</span> <span style=color:#ba2121>&#34;请勿重复下单！&#34;</span><span style=color:#666>);</span>
        <span style=color:#666>}</span>

        <span style=color:#408080;font-style:italic>// 3. 将下单信息保存到阻塞队列中
</span><span style=color:#408080;font-style:italic></span>        VoucherOrder voucherOrder <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> VoucherOrder<span style=color:#666>();</span>
        voucherOrder<span style=color:#666>.</span><span style=color:#7d9029>setId</span><span style=color:#666>(</span>orderId<span style=color:#666>);</span>
        voucherOrder<span style=color:#666>.</span><span style=color:#7d9029>setUserId</span><span style=color:#666>(</span>userId<span style=color:#666>);</span>
        voucherOrder<span style=color:#666>.</span><span style=color:#7d9029>setVoucherId</span><span style=color:#666>(</span>voucherId<span style=color:#666>);</span>
        orderTasks<span style=color:#666>.</span><span style=color:#7d9029>add</span><span style=color:#666>(</span>voucherOrder<span style=color:#666>);</span>

        <span style=color:#408080;font-style:italic>// 4. 获取代理对象
</span><span style=color:#408080;font-style:italic></span>        currentProxy <span style=color:#666>=</span> <span style=color:#666>(</span>VoucherOrderService<span style=color:#666>)</span> AopContext<span style=color:#666>.</span><span style=color:#7d9029>currentProxy</span><span style=color:#666>();</span>

        <span style=color:#408080;font-style:italic>// 5. 返回订单号（告诉用户下单成功，业务结束；执行异步下单操作数据库）
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>orderId<span style=color:#666>);</span>
    <span style=color:#666>}</span>

    <span style=color:#a2f>@Transactional</span>
    <span style=color:#a2f>@Override</span>
    <span style=color:green;font-weight:700>public</span> <span style=color:#b00040>void</span> <span style=color:#00f>createVoucherOrder</span><span style=color:#666>(</span>VoucherOrder voucherOrder<span style=color:#666>)</span> <span style=color:#666>{</span>
        Long userId <span style=color:#666>=</span> voucherOrder<span style=color:#666>.</span><span style=color:#7d9029>getUserId</span><span style=color:#666>();</span>
        <span style=color:#408080;font-style:italic>// 1. 一人一单
</span><span style=color:#408080;font-style:italic></span>        Integer count <span style=color:#666>=</span> query<span style=color:#666>()</span>
                <span style=color:#666>.</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;voucher_id&#34;</span><span style=color:#666>,</span> voucherOrder<span style=color:#666>.</span><span style=color:#7d9029>getVoucherId</span><span style=color:#666>())</span>
                <span style=color:#666>.</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;user_id&#34;</span><span style=color:#666>,</span> userId<span style=color:#666>)</span>
                <span style=color:#666>.</span><span style=color:#7d9029>count</span><span style=color:#666>();</span>
        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>count <span style=color:#666>&gt;</span> 0<span style=color:#666>)</span> <span style=color:#666>{</span>
            log<span style=color:#666>.</span><span style=color:#7d9029>error</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;不可重复下单！&#34;</span><span style=color:#666>);</span>
            <span style=color:green;font-weight:700>return</span><span style=color:#666>;</span>
        <span style=color:#666>}</span>

        <span style=color:#408080;font-style:italic>// 2. 减扣库存
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#b00040>boolean</span> isAccomplished <span style=color:#666>=</span> seckillVoucherService<span style=color:#666>.</span><span style=color:#7d9029>update</span><span style=color:#666>()</span>
                <span style=color:#666>.</span><span style=color:#7d9029>setSql</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;stock = stock - 1&#34;</span><span style=color:#666>)</span>
                <span style=color:#666>.</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;voucher_id&#34;</span><span style=color:#666>,</span> voucherOrder<span style=color:#666>.</span><span style=color:#7d9029>getVoucherId</span><span style=color:#666>()).</span><span style=color:#7d9029>gt</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;stock&#34;</span><span style=color:#666>,</span> 0<span style=color:#666>)</span>
                <span style=color:#666>.</span><span style=color:#7d9029>update</span><span style=color:#666>();</span>
        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(!</span>isAccomplished<span style=color:#666>)</span> <span style=color:#666>{</span>
            log<span style=color:#666>.</span><span style=color:#7d9029>error</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;库存不足！&#34;</span><span style=color:#666>);</span>
            <span style=color:green;font-weight:700>return</span><span style=color:#666>;</span>
        <span style=color:#666>}</span>

        <span style=color:#408080;font-style:italic>// 3. 下单
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#b00040>boolean</span> isSaved <span style=color:#666>=</span> save<span style=color:#666>(</span>voucherOrder<span style=color:#666>);</span>
        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(!</span>isSaved<span style=color:#666>)</span> <span style=color:#666>{</span>
            log<span style=color:#666>.</span><span style=color:#7d9029>error</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;下单失败！&#34;</span><span style=color:#666>);</span>
            <span style=color:green;font-weight:700>return</span><span style=color:#666>;</span>
        <span style=color:#666>}</span>
    <span style=color:#666>}</span>
<span style=color:#666>}</span>

</code></pre></div><h3 id=总结秒杀优化>总结秒杀优化<a href=#总结秒杀优化 class=header-anchor arialabel=Anchor> #</a></h3><blockquote><ol><li>新增秒杀优惠券的同时，将优惠券信息保存到 Redis 中</li><li>基于 Lua 脚本，判断秒杀库存、一人一单，决定用户是否抢购成功</li><li>如果抢购成功，将优惠券 id 和用户 id 封装后存入阻塞队列</li><li>开启线程任务，不断从阻塞队列中获取信息，实现异步下单功能</li></ol><blockquote><ol><li>voucherOrderService.seckillVoucher(voucherId);在seckillVoucher(voucherId)方法下</li><li>先进行static{}代码库，执行lua脚本</li><li>然后进行@PostConstruct的init()方法</li></ol><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:green;font-weight:700>public</span> <span style=color:#b00040>void</span> <span style=color:#00f>init</span><span style=color:#666>()</span> <span style=color:#666>{</span>
        SECKILL_ORDER_EXECUTOR<span style=color:#666>.</span><span style=color:#7d9029>submit</span><span style=color:#666>(</span><span style=color:green;font-weight:700>new</span> VoucherOrderHandler<span style=color:#666>());</span>
    <span style=color:#666>}</span>
<span style=color:green;font-weight:700>private</span> <span style=color:green;font-weight:700>static</span> <span style=color:green;font-weight:700>final</span> ExecutorService SECKILL_ORDER_EXECUTOR <span style=color:#666>=</span> Executors<span style=color:#666>.</span><span style=color:#7d9029>newSingleThreadExecutor</span><span style=color:#666>();</span><span style=color:#408080;font-style:italic>//单线程
</span><span style=color:#408080;font-style:italic>//submit和execute都是提交任务的方法
</span><span style=color:#408080;font-style:italic>//execute()只能是runnable参数，任务不可返回执行结果
</span><span style=color:#408080;font-style:italic>//submit()可以callable和runnable参数，callable任务可返回执行结果 
</span><span style=color:#408080;font-style:italic>//开启执行new VoucherOrderHandler()
</span><span style=color:#408080;font-style:italic></span>
</code></pre></div><p>4.执行new VoucherOrderHandler()</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#408080;font-style:italic>// 从队列中获取信息
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>VoucherOrderHandler</span> <span style=color:green;font-weight:700>implements</span> Runnable <span style=color:#666>{</span>
        <span style=color:#a2f>@Override</span>
        <span style=color:green;font-weight:700>public</span> <span style=color:#b00040>void</span> <span style=color:#00f>run</span><span style=color:#666>()</span> <span style=color:#666>{</span>
            <span style=color:green;font-weight:700>while</span> <span style=color:#666>(</span><span style=color:green;font-weight:700>true</span><span style=color:#666>)</span> <span style=color:#666>{</span>
                <span style=color:green;font-weight:700>try</span> <span style=color:#666>{</span>
                    <span style=color:#408080;font-style:italic>// 获取队列中的订单信息
</span><span style=color:#408080;font-style:italic></span>                    VoucherOrder voucherOrder <span style=color:#666>=</span> orderTasks<span style=color:#666>.</span><span style=color:#7d9029>take</span><span style=color:#666>();</span>
                    <span style=color:#408080;font-style:italic>// 创建订单
</span><span style=color:#408080;font-style:italic></span>                    handleVoucherOrder<span style=color:#666>(</span>voucherOrder<span style=color:#666>);</span>
                <span style=color:#666>}</span> <span style=color:green;font-weight:700>catch</span> <span style=color:#666>(</span>Exception e<span style=color:#666>)</span> <span style=color:#666>{</span>
                    log<span style=color:#666>.</span><span style=color:#7d9029>error</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;订单处理异常&#34;</span><span style=color:#666>,</span> e<span style=color:#666>);</span>
                <span style=color:#666>}</span>
            <span style=color:#666>}</span>
        <span style=color:#666>}</span>
       <span style=color:#408080;font-style:italic>// 阻塞队列：当一个线程尝试从队列中获取元素时：若队列中没有元素线程就会被阻塞，直到队列中有元素时线程才会被唤醒并且去获取元素。
</span><span style=color:#408080;font-style:italic></span>   <span style=color:#408080;font-style:italic>// private BlockingQueue&lt;VoucherOrder&gt; orderTasks = new ArrayBlockingQueue&lt;&gt;(1024 * 1024);
</span><span style=color:#408080;font-style:italic></span>       <span style=color:#408080;font-style:italic>//创建阻塞队列执行task()方法 orderTasks.take();
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#408080;font-style:italic>//take(基于阻塞的方式获取队列中的元素，如果队列未空，则task方法一直阻塞，直到队列中有新的数据可以消费
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#408080;font-style:italic>//执行// 创建订单
</span><span style=color:#408080;font-style:italic></span>          <span style=color:#408080;font-style:italic>//handleVoucherOrder(voucherOrder);
</span><span style=color:#408080;font-style:italic></span>
</code></pre></div></blockquote><p>5.handleVoucherOrder()</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>   <span style=color:green;font-weight:700>private</span> <span style=color:#b00040>void</span> <span style=color:#00f>handleVoucherOrder</span><span style=color:#666>(</span>VoucherOrder voucherOrder<span style=color:#666>)</span> <span style=color:#666>{</span>
            Long userId <span style=color:#666>=</span> voucherOrder<span style=color:#666>.</span><span style=color:#7d9029>getUserId</span><span style=color:#666>();</span>
            RLock lock <span style=color:#666>=</span> redissonClient<span style=color:#666>.</span><span style=color:#7d9029>getLock</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;lock:order:&#34;</span> <span style=color:#666>+</span> userId<span style=color:#666>);</span>
            <span style=color:#b00040>boolean</span> isLocked <span style=color:#666>=</span> lock<span style=color:#666>.</span><span style=color:#7d9029>tryLock</span><span style=color:#666>();</span>
            <span style=color:green;font-weight:700>if</span> <span style=color:#666>(!</span>isLocked<span style=color:#666>)</span> <span style=color:#666>{</span>
                log<span style=color:#666>.</span><span style=color:#7d9029>error</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;不允许重复下单！&#34;</span><span style=color:#666>);</span>
                <span style=color:green;font-weight:700>return</span><span style=color:#666>;</span>
            <span style=color:#666>}</span>
            <span style=color:green;font-weight:700>try</span> <span style=color:#666>{</span>
                <span style=color:#408080;font-style:italic>// 该方法非主线程调用，代理对象需要在主线程中获取。
</span><span style=color:#408080;font-style:italic>//注意：由于是spring的事务是放在threadLocal中，此时的是多线程，事务会失效
</span><span style=color:#408080;font-style:italic></span>                <span style=color:#408080;font-style:italic>// //目前属于子线程代理对象拿不到，所以我们应该在主线程拿到代理对象(自己加的)
</span><span style=color:#408080;font-style:italic></span>                currentProxy<span style=color:#666>.</span><span style=color:#7d9029>createVoucherOrder</span><span style=color:#666>(</span>voucherOrder<span style=color:#666>);</span>
            <span style=color:#666>}</span> <span style=color:green;font-weight:700>finally</span> <span style=color:#666>{</span>
                lock<span style=color:#666>.</span><span style=color:#7d9029>unlock</span><span style=color:#666>();</span>
            <span style=color:#666>}</span>
        <span style=color:#666>}</span>
    <span style=color:#666>}</span>
<span style=color:#408080;font-style:italic>//主线程执行  currentProxy.createVoucherOrder(voucherOrder);
</span></code></pre></div><p>6.执行订单方法 createVoucherOrder(VoucherOrder voucherOrder)</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>   <span style=color:#a2f>@Transactional</span>
    <span style=color:#a2f>@Override</span>
    <span style=color:green;font-weight:700>public</span> <span style=color:#b00040>void</span> <span style=color:#00f>createVoucherOrder</span><span style=color:#666>(</span>VoucherOrder voucherOrder<span style=color:#666>)</span> <span style=color:#666>{</span>
        Long userId <span style=color:#666>=</span> voucherOrder<span style=color:#666>.</span><span style=color:#7d9029>getUserId</span><span style=color:#666>();</span>
        <span style=color:#408080;font-style:italic>// 1. 一人一单
</span><span style=color:#408080;font-style:italic></span>        Integer count <span style=color:#666>=</span> query<span style=color:#666>()</span>
                <span style=color:#666>.</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;voucher_id&#34;</span><span style=color:#666>,</span> voucherOrder<span style=color:#666>.</span><span style=color:#7d9029>getVoucherId</span><span style=color:#666>())</span>
                <span style=color:#666>.</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;user_id&#34;</span><span style=color:#666>,</span> userId<span style=color:#666>)</span>
                <span style=color:#666>.</span><span style=color:#7d9029>count</span><span style=color:#666>();</span>
        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>count <span style=color:#666>&gt;</span> 0<span style=color:#666>)</span> <span style=color:#666>{</span>
            log<span style=color:#666>.</span><span style=color:#7d9029>error</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;不可重复下单！&#34;</span><span style=color:#666>);</span>
            <span style=color:green;font-weight:700>return</span><span style=color:#666>;</span>
        <span style=color:#666>}</span>

        <span style=color:#408080;font-style:italic>// 2. 减扣库存
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#b00040>boolean</span> isAccomplished <span style=color:#666>=</span> seckillVoucherService<span style=color:#666>.</span><span style=color:#7d9029>update</span><span style=color:#666>()</span>
                <span style=color:#666>.</span><span style=color:#7d9029>setSql</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;stock = stock - 1&#34;</span><span style=color:#666>)</span>
                <span style=color:#666>.</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;voucher_id&#34;</span><span style=color:#666>,</span> voucherOrder<span style=color:#666>.</span><span style=color:#7d9029>getVoucherId</span><span style=color:#666>()).</span><span style=color:#7d9029>gt</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;stock&#34;</span><span style=color:#666>,</span> 0<span style=color:#666>)</span>
                <span style=color:#666>.</span><span style=color:#7d9029>update</span><span style=color:#666>();</span>
        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(!</span>isAccomplished<span style=color:#666>)</span> <span style=color:#666>{</span>
            log<span style=color:#666>.</span><span style=color:#7d9029>error</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;库存不足！&#34;</span><span style=color:#666>);</span>
            <span style=color:green;font-weight:700>return</span><span style=color:#666>;</span>
        <span style=color:#666>}</span>

        <span style=color:#408080;font-style:italic>// 3. 下单
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#b00040>boolean</span> isSaved <span style=color:#666>=</span> save<span style=color:#666>(</span>voucherOrder<span style=color:#666>);</span>
        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(!</span>isSaved<span style=color:#666>)</span> <span style=color:#666>{</span>
            log<span style=color:#666>.</span><span style=color:#7d9029>error</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;下单失败！&#34;</span><span style=color:#666>);</span>
            <span style=color:green;font-weight:700>return</span><span style=color:#666>;</span>
        <span style=color:#666>}</span>
    <span style=color:#666>}</span>
</code></pre></div><p>7.完成init之后，执行seckillVoucher(voucherId)</p><p>8.执行脚本返回资格，如果有资格进行创建订单，将订单加入到阻塞队列中，返回订单号。</p></blockquote><p><strong>小总结：</strong></p><p>秒杀业务的优化思路是什么？</p><ul><li>先利用Redis完成库存余量、一人一单判断，完成抢单业务</li><li>再将下单业务放入阻塞队列，利用独立线程异步下单</li><li>基于阻塞队列的异步秒杀存在哪些问题？<ul><li>内存限制问题</li><li>数据安全问题</li></ul></li></ul><h2 id=7redis消息队列>7、Redis消息队列<a href=#7redis消息队列 class=header-anchor arialabel=Anchor> #</a></h2><h3 id=71-redis消息队列-认识消息队列>7.1 Redis消息队列-认识消息队列<a href=#71-redis消息队列-认识消息队列 class=header-anchor arialabel=Anchor> #</a></h3><p>什么是消息队列：字面意思就是存放消息的队列。最简单的消息队列模型包括3个角色：</p><ul><li>消息队列：存储和管理消息，也被称为消息代理（Message Broker）</li><li>生产者：发送消息到消息队列</li><li>消费者：从消息队列获取消息并处理消息</li></ul><p><img src=https://img-blog.csdnimg.cn/725f05c418e24fe89ab9f35f9169b7f2.png#pic_center alt=在这里插入图片描述></p><blockquote><p>使用队列的好处在于 **解耦：**所谓解耦，举一个生活中的例子就是：快递员(生产者)把快递放到快递柜里边(Message Queue)去，我们(消费者)从快递柜里边去拿东西，这就是一个异步，如果耦合，那么这个快递员相当于直接把快递交给你，这事固然好，但是万一你不在家，那么快递员就会一直等你，这就浪费了快递员的时间，所以这种思想在我们日常开发中，是非常有必要的。</p></blockquote><blockquote><p>这种场景在我们秒杀中就变成了：我们下单之后，利用redis去进行校验下单条件，再通过队列把消息发送出去，然后再启动一个线程去消费这个消息，完成解耦，同时也加快我们的响应速度。</p></blockquote><blockquote><p>这里我们可以使用一些现成的mq，比如kafka，rabbitmq等等，但是呢，如果没有安装mq，我们也可以直接使用redis提供的mq方案，降低我们的部署和学习成本。</p></blockquote><h3 id=72-redis消息队列-基于list实现消息队列>7.2 Redis消息队列-基于List实现消息队列<a href=#72-redis消息队列-基于list实现消息队列 class=header-anchor arialabel=Anchor> #</a></h3><p><strong>基于List结构模拟消息队列</strong></p><p>消息队列（Message Queue），字面意思就是存放消息的队列。而Redis的list数据结构是一个双向链表，很容易模拟出队列效果。</p><p>队列是入口和出口不在一边，因此我们可以利用：LPUSH 结合 RPOP、或者 RPUSH 结合 LPOP来实现。
不过要注意的是，当队列中没有消息时RPOP或LPOP操作会返回null，并不像JVM的阻塞队列那样会阻塞并等待消息。因此这里应该使用BRPOP或者BLPOP来实现阻塞效果。</p><p><img src=https://img-blog.csdnimg.cn/1f93c5f285734a5d800cedc5809a05f0.png#pic_center alt=在这里插入图片描述></p><p>基于List的消息队列有哪些优缺点？
优点：</p><ul><li>利用Redis存储，不受限于JVM内存上限</li><li>基于Redis的持久化机制，数据安全性有保证</li><li>可以满足消息有序性</li></ul><p>缺点：</p><ul><li><p>无法避免消息丢失</p></li><li><p>只支持单消费者</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JAVA data-lang=JAVA><span>#</span> 自写
    redis<span style=color:#666>-</span>cli <span style=color:#666>-</span>h 192<span style=color:#666>.</span><span style=color:#7d9029>168</span><span style=color:#666>.</span><span style=color:#7d9029>8</span><span style=color:#666>.</span><span style=color:#7d9029>130</span> <span style=color:#666>-</span>p 6379 <span style=color:#666>-</span>a yangroot
      
1<span>：</span> BRPOP l1 20
2<span>：</span>LPUSH l1 1 2
</code></pre></div></li></ul><h3 id=73-redis消息队列-基于pubsub的消息队列>7.3 Redis消息队列-基于PubSub的消息队列<a href=#73-redis消息队列-基于pubsub的消息队列 class=header-anchor arialabel=Anchor> #</a></h3><p>PubSub（发布订阅）是Redis2.0版本引入的消息传递模型。顾名思义，消费者可以订阅一个或多个channel，生产者向对应channel发送消息后，所有订阅者都能收到相关消息。</p><blockquote><p>SUBSCRIBE channel [channel] ：订阅一个或多个频道
PUBLISH channel msg ：向一个频道发送消息
PSUBSCRIBE pattern[pattern] ：订阅与pattern格式匹配的所有频道</p></blockquote><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>使用 SUBSCRIBE 命令<span>，</span>启动两个消费者并且订阅同一个队列<span>；</span>此时两个消费者都会被堵塞住<span>，</span>等待新消息的到来<span>。</span>

127<span style=color:#666>.</span><span style=color:#7d9029>0</span><span style=color:#666>.</span><span style=color:#7d9029>0</span><span style=color:#666>.</span><span style=color:#7d9029>1</span><span style=color:#666>:</span>6379<span style=color:#666>&gt;</span> SUBSCRIBE queue
Reading messages<span style=color:#666>...</span> <span style=color:#666>(</span>press Ctrl<span style=color:#666>-</span>C to quit<span style=color:#666>)</span>
1<span style=color:#666>)</span> <span style=color:#ba2121>&#34;subscribe&#34;</span>
2<span style=color:#666>)</span> <span style=color:#ba2121>&#34;queue&#34;</span>
3<span style=color:#666>)</span> <span style=color:#666>(</span>integer<span style=color:#666>)</span> 1

使用 PUBLISH 命令启动一个生产者<span>，</span>发布一条消息<span>。</span>

127<span style=color:#666>.</span><span style=color:#7d9029>0</span><span style=color:#666>.</span><span style=color:#7d9029>0</span><span style=color:#666>.</span><span style=color:#7d9029>1</span><span style=color:#666>:</span>6379<span style=color:#666>&gt;</span> PUBLISH queue <span style=color:#00f>msg1</span>
<span style=color:#666>(</span>integer<span style=color:#666>)</span> 1
1
2
两个消费者解除堵塞<span>，</span>收到生产者发送的新消息<span>。</span>

127<span style=color:#666>.</span><span style=color:#7d9029>0</span><span style=color:#666>.</span><span style=color:#7d9029>0</span><span style=color:#666>.</span><span style=color:#7d9029>1</span><span style=color:#666>:</span>6379<span style=color:#666>&gt;</span> SUBSCRIBE queue
Reading messages<span style=color:#666>...</span> <span style=color:#666>(</span>press Ctrl<span style=color:#666>-</span>C to quit<span style=color:#666>)</span>
1<span style=color:#666>)</span> <span style=color:#ba2121>&#34;subscribe&#34;</span>
2<span style=color:#666>)</span> <span style=color:#ba2121>&#34;queue&#34;</span>
3<span style=color:#666>)</span> <span style=color:#666>(</span>integer<span style=color:#666>)</span> 1
1<span style=color:#666>)</span> <span style=color:#ba2121>&#34;message&#34;</span>
2<span style=color:#666>)</span> <span style=color:#ba2121>&#34;queue&#34;</span>
3<span style=color:#666>)</span> <span style=color:#ba2121>&#34;msg1&#34;</span>
消费者使用 PSUBSCRIBE 命令 订阅 queue<span style=color:#666>.*</span> 相关的队列信息<span>，</span>之后生产者分别向 queue<span style=color:#666>.</span><span style=color:#7d9029>p1</span> 和 queue<span style=color:#666>.</span><span style=color:#7d9029>p2</span> 发布消息<span>。</span>


</code></pre></div><p><img src=https://itsawaysu.oss-cn-shanghai.aliyuncs.com/note/Pub:Sub01.jpg alt=Pub:Sub01></p><p><img src=https://img-blog.csdnimg.cn/88d90e83d13c4a8eb9765e37d1d794a0.png#pic_center alt=在这里插入图片描述></p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>Pub<span style=color:#666>/</span>Sub 的最大优点 <span>：</span>支持 多组生产者<span>、</span>消费者处理消息<span>；</span>
Pub<span style=color:#666>/</span>Sub 的最大缺点 <span>：</span>丢数据<span>。</span>
消费者下线<span>、</span>Redis 宕机<span>、</span>消息堆积 都会导致数据丢失<span>。</span>
Pub<span style=color:#666>/</span>Sub 的实现十分简单<span>，</span>没有基于任何数据结构<span>，</span>也没有任何的数据存储<span>，</span>只是单纯的为生产者和消费者建立 数据转发通道<span>，</span>将符合规则的数据<span>，</span>从一端发到另一端<span>。</span>
一个完整的发布<span>、</span>订阅消息处理流程
消费者订阅指定队列<span>，</span>Redis 就会记录一个映射关系 <span>——</span> 队列 <span>—</span> 消费者<span>；</span>
生产者向这个队列发布消息<span>，</span>从 Redis 的映射关系中找出对应的消费者<span>，</span>将消息转发给消费者<span>。</span>
注意<span>：</span>消费者必须先订阅队列<span>，</span>生产者才能发布消息<span>，</span>否则消息会丢失<span>。</span>
</code></pre></div><p>基于PubSub的消息队列有哪些优缺点？
优点：</p><ul><li>采用发布订阅模型，支持多生产、多消费</li></ul><p>缺点：</p><ul><li>不支持数据持久化</li><li>无法避免消息丢失</li><li>消息堆积有上限，超出时数据丢失</li></ul><h3 id=74-redis消息队列-基于stream的消息队列>7.4 Redis消息队列-基于Stream的消息队列<a href=#74-redis消息队列-基于stream的消息队列 class=header-anchor arialabel=Anchor> #</a></h3><p>Stream 是 Redis5.0 引入的一种新的 <strong>数据类型</strong>，可以实现一个功能非常完善的消息队列。</p><p>Stream 通过 <code>XADD</code>（发布消息） 和 <code>XREAD</code>（读取消息） 完成最简单的生产、消费模型。</p><p><strong>发送消息的命令： <code>XADD key [NOMKSTREAM] [MAXLEN|MINID [=|~] threshold [LIMIT count]] \*|ID field value [field value ...]</code></strong></p><ul><li><code>key</code> ：队列名称；</li><li><code>[NOMKSTREAM]</code> ：若队列不存在，是否自动创建队列，默认自动创建（不用管）；</li><li><code>[MAXLEN|MINID [=|~] threshold [LIMIT count]]</code> ：设置消息队列的最大消息数量（不用管）；</li><li><code>*|ID</code> ：消息的唯一 ID，<code>*</code> 代表由 Redis 自动生成，格式是 <code>时间戳-递增数字</code>，例如：<code>1666161469358-0</code>；</li><li><code>field value [field value ...]</code> ：发送到队列中的消息，称为 Entry。格式为多个 Key-Value 键值对。</li></ul><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#408080;font-style:italic># 创建名为 users 的队列并向该队列送一个消息，ID 由 Redis 自动生成；内容为： { name: Jack, age: 21}</span>
XADD users * name Jack age <span style=color:#666>21</span>

127.0.0.1:6379&gt; XADD users * name Jack
<span style=color:#ba2121>&#34;1666169070359-0&#34;</span>
127.0.0.1:6379&gt; XADD users * name Rose
<span style=color:#ba2121>&#34;1666169072899-0&#34;</span>
<span style=color:#666>1234567</span>
</code></pre></div><p><strong>读取消息的方式之一：<code>XREAD [COUNT count] [BLOCK milliseconds] STREAMS key [key ...] ID [ID ...]</code></strong></p><ul><li><code>[COUNT count]</code> ：每次读取消息的最大数量；</li><li><code>[BLOCK milliseconds]</code> ：当没有消息时，是否阻塞 和 阻塞时长；</li><li><code>STREAMS key [key ...]</code> ：从哪个队列读取消息，Key 就是队列名；</li><li><code>ID [ID ...]</code> ：起始ID，只返回大于该 ID 的消息；0 代表从第一个消息开始，$ 代表从最新的消息开始。</li></ul><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>127.0.0.1:6379&gt; XREAD COUNT <span style=color:#666>1</span> STREAMS users <span style=color:#666>0</span>
1<span style=color:#666>)</span> 1<span style=color:#666>)</span> <span style=color:#ba2121>&#34;queue&#34;</span>
   2<span style=color:#666>)</span> 1<span style=color:#666>)</span> 1<span style=color:#666>)</span> <span style=color:#ba2121>&#34;1666169070359-0&#34;</span>
         2<span style=color:#666>)</span> 1<span style=color:#666>)</span> <span style=color:#ba2121>&#34;name&#34;</span>
            2<span style=color:#666>)</span> <span style=color:#ba2121>&#34;Jack&#34;</span>
127.0.0.1:6379&gt; XREAD COUNT <span style=color:#666>2</span> STREAMS users <span style=color:#666>0</span>
1<span style=color:#666>)</span> 1<span style=color:#666>)</span> <span style=color:#ba2121>&#34;queue&#34;</span>
   2<span style=color:#666>)</span> 1<span style=color:#666>)</span> 1<span style=color:#666>)</span> <span style=color:#ba2121>&#34;1666169070359-0&#34;</span>
         2<span style=color:#666>)</span> 1<span style=color:#666>)</span> <span style=color:#ba2121>&#34;name&#34;</span>
            2<span style=color:#666>)</span> <span style=color:#ba2121>&#34;Jack&#34;</span>
      2<span style=color:#666>)</span> 1<span style=color:#666>)</span> <span style=color:#ba2121>&#34;1666169072899-0&#34;</span>
         2<span style=color:#666>)</span> 1<span style=color:#666>)</span> <span style=color:#ba2121>&#34;name&#34;</span>
            2<span style=color:#666>)</span> <span style=color:#ba2121>&#34;Rose&#34;</span>
<span style=color:#666>12345678910111213</span>
</code></pre></div><p><strong>阻塞读取最新消息</strong>：<code>XREAD COUNT 1 BLOCK STREAMS queue $</code></p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#408080;font-style:italic>// 业务开发中可以循环调用 XREAD 的阻塞读取方式查询最新消息，从而实现持续监听队列的效果（伪代码）
</span><span style=color:#408080;font-style:italic></span><span style=color:green;font-weight:700>while</span><span style=color:#666>(</span><span style=color:green;font-weight:700>true</span><span style=color:#666>)</span> <span style=color:#666>{</span>
  	<span style=color:#408080;font-style:italic>// 尝试获取队列中的最新消息，最多阻塞 2s
</span><span style=color:#408080;font-style:italic></span>  	Object msg <span style=color:#666>=</span> redis<span style=color:#666>.</span><span style=color:#7d9029>execute</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;XREAD COUNT 1 BLOCK 2000 STREAMS queue $&#34;</span><span style=color:#666>);</span>
  	<span style=color:#408080;font-style:italic>// 2s 内未获取到消息，继续循环
</span><span style=color:#408080;font-style:italic></span>  	<span style=color:green;font-weight:700>if</span><span style=color:#666>(</span>msg <span style=color:#666>==</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
      	<span style=color:green;font-weight:700>continue</span><span style=color:#666>;</span>
    <span style=color:#666>}</span>
  	handleMessage<span style=color:#666>(</span>msg<span style=color:#666>);</span>
<span style=color:#666>}</span>
12345678910
</code></pre></div><p><strong>注意</strong>：指定起始 ID 为 <code>$</code> 时，代表读取最新消息，如果处理一条消息的过程中，又有超过一条以上的消息到达队列，则下次获取时也只能获取到最新的一条，出现 <strong>漏读</strong> 问题。</p><p><strong>STREAM 类型消息队列的 XREAD 命令的特点</strong>：</p><ul><li>永久保存在队列中，消息可回溯；</li><li>一个消息可以被多个消费者读取；</li><li>可以阻塞读取；</li><li>有消息漏读风险。</li></ul><h3 id=75-stream-的-消费者组模式>7.5 Stream 的 消费者组模式<a href=#75-stream-的-消费者组模式 class=header-anchor arialabel=Anchor> #</a></h3><p><strong>消费者组（Consumer Group）</strong>：<strong>将多个消费者划分到一个组中，监听同一个队列</strong>。具备以下特点：</p><ul><li><p><strong>消息分流</strong>：队列中的 <strong>消息会分流给组内不同的消费者</strong>，而不是重复消费，从而加快消息处理的速度。</p></li><li><p><strong>消息标示</strong>：消费者组会维护一个标示，<strong>记录最后一个被处理的消息</strong>，即使消费者宕机重启，还会从标示之后读取消息，确保每一个消息都会被消费。（解决漏读问题）</p></li><li><p><strong>消息确认</strong>：消费者获取消息后，消息处于 <code>pending</code> 状态，并存入一个 <code>pending-list</code>。当处理完成后需要通过 <strong>XACK</strong> 命令来确认消息，标记消息为已处理，才会从 <code>pending-list</code> 中移除。（解决消息丢失问题）</p></li><li><p><strong>创建消费组</strong>：<code>XGROUP CREATE key groupName ID [MKSTREAM]</code></p><ul><li><code>key</code> ：队列名称；</li><li><code>groupName</code> ：消费组名称；</li><li><code>ID</code> ：起始 ID 标示，<code>$</code> 代表队列中的最后一个消息，<code>0</code> 代表队列中的第一个消息；</li><li><code>[MKSTREAM]</code> ：队列中不存在时自动创建队列。</li></ul></li><li><p><strong>其他命令</strong>：</p><ul><li><strong>删除指定的消费组</strong>：<code>XGROUP DESTROY key groupName</code></li><li><strong>给指定的消费组添加消费者</strong>：<code>XGROUP CREATECONSUMER key groupName consumerName</code></li><li><strong>删除消费组中的指定消费者</strong>：<code>XGROUP DELCONSUMER key groupName consumerName</code></li></ul></li><li><p><strong>从消费者组中读取消息</strong>：<code>XREADGROUP GROUP group consumer [COUNT count] [BLOCK milliseconds] [NOACK] STREAMS key [key ...] ID [ID ...]</code></p><ul><li><p><code>group</code>：消费组名称；</p></li><li><p><code>consumer</code>：消费者名称，如果消费者不存在，会自动创建一个消费者；</p></li><li><p><code>count</code>：本次查询的最大数量；</p></li><li><p><code>BLOCK milliseconds</code>：当没有消息时的最长等待时间；</p></li><li><p><code>NOACK</code>：无需手动 ACK，获取到消息后自动确认；</p></li><li><p><code>STREAMS key</code>：指定队列名称；</p></li><li><pre><code>ID
</code></pre><p>：获取消息的起始ID：</p><ul><li><code>></code>：从下一个未消费的消息开始；</li><li>其他：根据 ID 从 <code>pending-list</code> 中获取已消费但未确认的消息；例如0，从 <code>pending-list</code> 中的第一个消息开始。</li></ul></li></ul><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#408080;font-style:italic># 发送消息到队列</span>
127.0.0.1:6379&gt; XADD queue * name Jack
<span style=color:#ba2121>&#34;1666172276809-0&#34;</span>
127.0.0.1:6379&gt; xadd queue * name Rose
<span style=color:#ba2121>&#34;1666172286673-0&#34;</span>
  
<span style=color:#408080;font-style:italic># 读取队列中的消息</span>
127.0.0.1:6379&gt; XREAD COUNT <span style=color:#666>2</span> STREAMS queue <span style=color:#666>0</span>
1<span style=color:#666>)</span> 1<span style=color:#666>)</span> <span style=color:#ba2121>&#34;queue&#34;</span>
   2<span style=color:#666>)</span> 1<span style=color:#666>)</span> 1<span style=color:#666>)</span> <span style=color:#ba2121>&#34;1666172276809-0&#34;</span>
         2<span style=color:#666>)</span> 1<span style=color:#666>)</span> <span style=color:#ba2121>&#34;name&#34;</span>
            2<span style=color:#666>)</span> <span style=color:#ba2121>&#34;Jack&#34;</span>
      2<span style=color:#666>)</span> 1<span style=color:#666>)</span> <span style=color:#ba2121>&#34;1666172286673-0&#34;</span>
         2<span style=color:#666>)</span> 1<span style=color:#666>)</span> <span style=color:#ba2121>&#34;name&#34;</span>
            2<span style=color:#666>)</span> <span style=color:#ba2121>&#34;Rose&#34;</span>
  
<span style=color:#408080;font-style:italic># 创建消费者组</span>
127.0.0.1:6379&gt; XGROUP CREATE queue queueGroup <span style=color:#666>0</span>
OK
  
<span style=color:#408080;font-style:italic># 从消费者组中读取消息</span>
<span style=color:#408080;font-style:italic># 监听 queue 队列：消费者组为 queueGroup、消费者为 consumerOne（若不存在则自动创建）、每次读取 1 条消息、阻塞时间为 2s、从下一个未消费消息开始。</span>
127.0.0.1:6379&gt; XREADGROUP GROUP queueGroup consumerOne COUNT <span style=color:#666>1</span> BLOCK <span style=color:#666>2000</span> STREAMS queue &gt;
1<span style=color:#666>)</span> 1<span style=color:#666>)</span> <span style=color:#ba2121>&#34;queue&#34;</span>
   2<span style=color:#666>)</span> 1<span style=color:#666>)</span> 1<span style=color:#666>)</span> <span style=color:#ba2121>&#34;1666172276809-0&#34;</span>
         2<span style=color:#666>)</span> 1<span style=color:#666>)</span> <span style=color:#ba2121>&#34;name&#34;</span>
            2<span style=color:#666>)</span> <span style=color:#ba2121>&#34;Jack&#34;</span>
  
<span style=color:#408080;font-style:italic># 消费者为 consumerTwo</span>
127.0.0.1:6379&gt; XREADGROUP GROUP queueGroup consumerTwo COUNT <span style=color:#666>1</span> BLOCK <span style=color:#666>2000</span> STREAMS queue &gt;
1<span style=color:#666>)</span> 1<span style=color:#666>)</span> <span style=color:#ba2121>&#34;queue&#34;</span>
   2<span style=color:#666>)</span> 1<span style=color:#666>)</span> 1<span style=color:#666>)</span> <span style=color:#ba2121>&#34;1666172286673-0&#34;</span>
         2<span style=color:#666>)</span> 1<span style=color:#666>)</span> <span style=color:#ba2121>&#34;name&#34;</span>
            2<span style=color:#666>)</span> <span style=color:#ba2121>&#34;Rose&#34;</span>
  
<span style=color:#408080;font-style:italic># 消费者为 consumerThree</span>
127.0.0.1:6379&gt; XREADGROUP GROUP queueGroup consumerThree COUNT <span style=color:#666>1</span> BLOCK <span style=color:#666>2000</span> STREAMS queue &gt;
<span style=color:#666>(</span>nil<span style=color:#666>)</span>
<span style=color:#666>(</span>2.04s<span style=color:#666>)</span>
<span style=color:#666>123456789101112131415161718192021222324252627282930313233343536373839</span>
</code></pre></div></li><li><p>消费者获取到消息后，消息处于 <code>pending</code> 状态，将 <code>pending</code> 状态的消息标记为已处理并且从 <code>pending-list</code> 中删除（命令的返回值是成功确认的消息数）：<code>XACK key group ID [ID ...]</code></p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>127.0.0.1:6379&gt; XACK queue queueGroup 1666172276809-0 1666172286673-0
<span style=color:#666>(</span>integer<span style=color:#666>)</span> <span style=color:#666>2</span>
<span style=color:#666>12</span>
</code></pre></div></li></ul><p><strong>STREAM 类型消息队列的 XREADGROUP 命令的特点</strong>：</p><ul><li>永久保存在队列中，消息可回溯；</li><li>多消费者争抢消息，加快读取速度；</li><li>可以阻塞读取；</li><li>没有消息漏读风险；</li><li>有消息确认机制，能够保证消息至少被消费一次。</li></ul><table><thead><tr><th></th><th>List</th><th>PubSub</th><th>Stream</th></tr></thead><tbody><tr><td><strong>消息持久化</strong></td><td>支持</td><td>不支持</td><td>支持</td></tr><tr><td><strong>阻塞读取</strong></td><td>支持</td><td>支持</td><td>支持</td></tr><tr><td><strong>消息堆积处理</strong></td><td>受限于内存空间，可以利用多消费者加快处理</td><td>受限于消费者缓冲区</td><td>受限于队列长度，可以利用消费者组提高消费速度，减少堆积</td></tr><tr><td><strong>消息确认机制</strong></td><td>不支持</td><td>不支持</td><td>支持</td></tr><tr><td><strong>消息回溯</strong></td><td>不支持</td><td>不支持</td><td>支持</td></tr></tbody></table><blockquote><p><strong>消费者监听消息的基本思路（伪代码）</strong></p></blockquote><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:green;font-weight:700>while</span> <span style=color:#666>(</span><span style=color:green;font-weight:700>true</span><span style=color:#666>)</span> <span style=color:#666>{</span>
    <span style=color:#408080;font-style:italic>// 监听 queue 队列：消费者组为 queueGroup、消费者为 consumerOne（若不存在则自动创建）、每次读取 1 条消息、阻塞时间为 2s、从下一个未消费消息开始。
</span><span style=color:#408080;font-style:italic></span>    Object msg <span style=color:#666>=</span> redis<span style=color:#666>.</span><span style=color:#7d9029>call</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;XREADGROUP GROUP queueGroup consumerOne COUNT 1 BLOCK 2000 STREAMS queue &gt;&#34;</span><span style=color:#666>);</span>
    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>msg <span style=color:#666>==</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>  <span style=color:#408080;font-style:italic>// null 说明没有消息，继续下一次循环
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>continue</span><span style=color:#666>;</span>
    <span style=color:#666>}</span>
    <span style=color:green;font-weight:700>try</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 处理消息（处理完后必须 XACK）
</span><span style=color:#408080;font-style:italic></span>        HandleMessage<span style=color:#666>(</span>msg<span style=color:#666>);</span>
    <span style=color:#666>}</span> <span style=color:green;font-weight:700>catch</span> <span style=color:#666>(</span>Exception e<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:green;font-weight:700>while</span> <span style=color:#666>(</span><span style=color:green;font-weight:700>true</span><span style=color:#666>)</span> <span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>// 监听 queue 队列：消费者组为 queueGroup、消费者为 consumerOne（不存在则自动创建）、每次读取 1 条消息、从 pending-list 中的第一个消息开始。
</span><span style=color:#408080;font-style:italic></span>            Object msg <span style=color:#666>=</span> redis<span style=color:#666>.</span><span style=color:#7d9029>call</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;XREADGROUP GROUP queueGroup consumerOne COUNT 1 STREAMS queue 0&#34;</span><span style=color:#666>);</span>
            <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>msg <span style=color:#666>==</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>  <span style=color:#408080;font-style:italic>// null 说明没有异常，所有消息都已确认，结束循环
</span><span style=color:#408080;font-style:italic></span>                <span style=color:green;font-weight:700>break</span><span style=color:#666>;</span>
            <span style=color:#666>}</span>
            <span style=color:green;font-weight:700>try</span> <span style=color:#666>{</span>
                <span style=color:#408080;font-style:italic>// 处理消息（处理完后必须 XACK）
</span><span style=color:#408080;font-style:italic></span>                HandleMessage<span style=color:#666>(</span>msg<span style=color:#666>);</span>
            <span style=color:#666>}</span> <span style=color:green;font-weight:700>catch</span> <span style=color:#666>(</span>Exception e<span style=color:#666>)</span> <span style=color:#666>{</span>
                <span style=color:#408080;font-style:italic>// 再次出现异常，继续循环
</span><span style=color:#408080;font-style:italic></span>                <span style=color:green;font-weight:700>continue</span><span style=color:#666>;</span>
            <span style=color:#666>}</span>
        <span style=color:#666>}</span>
    <span style=color:#666>}</span>
<span style=color:#666>}</span>

</code></pre></div><h3 id=76-基于redis的stream结构作为消息队列实现异步秒杀下单>7.6 基于Redis的Stream结构作为消息队列，实现异步秒杀下单<a href=#76-基于redis的stream结构作为消息队列实现异步秒杀下单 class=header-anchor arialabel=Anchor> #</a></h3><blockquote><p>创建一个 Stream 类型的消息队列，名为 <code>stream.orders</code>。</p></blockquote><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>127.0.0.1:6379&gt; XGROUP CREATE stream.orders orderGroup <span style=color:#666>0</span> MKSTREAM
OK
<span style=color:#666>12</span>
</code></pre></div><blockquote><p>修改秒杀下单的 Lua 脚本，在认定有抢购资格后，直接向 <code>stream.orders</code> 中添加消息，内容包括 <code>voucherId</code>、<code>userId</code>、<code>orderId</code>。</p></blockquote><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=color:green;font-weight:700>local</span> voucherId <span style=color:#666>=</span> ARGV[<span style=color:#666>1</span>]
<span style=color:green;font-weight:700>local</span> userId <span style=color:#666>=</span> ARGV[<span style=color:#666>2</span>]
<span style=color:green;font-weight:700>local</span> orderId <span style=color:#666>=</span> ARGV[<span style=color:#666>3</span>]

<span style=color:green;font-weight:700>local</span> stockKey <span style=color:#666>=</span> <span style=color:#ba2121>&#34;seckill:stock:&#34;</span> <span style=color:#666>..</span> voucherId
<span style=color:green;font-weight:700>local</span> orderKey <span style=color:#666>=</span> <span style=color:#ba2121>&#34;seckill:order:&#34;</span> <span style=color:#666>..</span> voucherId

<span style=color:#408080;font-style:italic>-- 判断库存是否充足（不足，返回 1）</span>
<span style=color:green;font-weight:700>if</span> (tonumber(redis.call(<span style=color:#ba2121>&#39;GET&#39;</span>, stockKey)) <span style=color:#666>&lt;=</span> <span style=color:#666>0</span>) <span style=color:green;font-weight:700>then</span>
    <span style=color:green;font-weight:700>return</span> <span style=color:#666>1</span>;
<span style=color:green;font-weight:700>end</span>;

<span style=color:#408080;font-style:italic>-- 判断用户是否下单（重复下单，返回 2）</span>
<span style=color:green;font-weight:700>if</span> (redis.call(<span style=color:#ba2121>&#39;SISMEMBER&#39;</span>, orderKey, userId) <span style=color:#666>==</span> <span style=color:#666>1</span>) <span style=color:green;font-weight:700>then</span>
    <span style=color:green;font-weight:700>return</span> <span style=color:#666>2</span>;
<span style=color:green;font-weight:700>end</span>;

<span style=color:#408080;font-style:italic>-- 下单成功：扣减库存、保存用户。</span>
redis.call(<span style=color:#ba2121>&#39;INCRBY&#39;</span>, stockKey, <span style=color:#666>-</span><span style=color:#666>1</span>);
redis.call(<span style=color:#ba2121>&#39;SADD&#39;</span>, orderKey, userId);
<span style=color:#408080;font-style:italic>-- 发送消息到 stream.orders 队列中（*：消息的唯一ID 由 Redis 自动生成）：XADD stream.orders * key field ...</span>
redis.call(<span style=color:#ba2121>&#39;XADD&#39;</span>, <span style=color:#ba2121>&#39;stream.orders&#39;</span>, <span style=color:#ba2121>&#39;*&#39;</span>, <span style=color:#ba2121>&#39;userId&#39;</span>, userId, <span style=color:#ba2121>&#39;voucherId&#39;</span>, voucherId, <span style=color:#ba2121>&#39;id&#39;</span>, orderId);
<span style=color:green;font-weight:700>return</span> <span style=color:#666>0</span>;

<span>@</span>Override
public Result seckillVoucher(Long voucherId) {
    <span style=color:#666>//</span> <span style=color:#666>1.</span> <span>执行</span> Lua <span>脚本（有购买资格：向</span> stream.orders <span>中添加消息，内容包括</span> voucherId<span>、</span>userId<span>、</span>orderId<span>）</span>
    Long userId <span style=color:#666>=</span> UserHolder.getUser().getId();
    long orderId <span style=color:#666>=</span> redisIdWorker.nextId(<span style=color:#ba2121>&#34;order&#34;</span>);
    Long executeResult <span style=color:#666>=</span> stringRedisTemplate.execute(
            SECKILL_SCRIPT,
            Collections.emptyList(),
            voucherId.toString(), userId.toString(), String.valueOf(orderId)
    );
  	
    <span style=color:#666>//</span> <span style=color:#666>2.</span> Lua <span>脚本的执行结果不为</span> <span style=color:#666>0</span><span>，则没有购买资格</span>
    int result <span style=color:#666>=</span> executeResult.intValue();
    <span style=color:green;font-weight:700>if</span> (result <span>!</span><span style=color:#666>=</span> <span style=color:#666>0</span>) {
        <span style=color:green;font-weight:700>return</span> Result.fail(result <span style=color:#666>==</span> <span style=color:#666>1</span> <span>?</span> <span style=color:#ba2121>&#34;库存不足！&#34;</span> : <span style=color:#ba2121>&#34;请勿重复下单！&#34;</span>);
    }
  	
    <span style=color:#666>//</span> <span style=color:#666>3.</span> <span>获取代理对象</span>
    currentProxy <span style=color:#666>=</span> (VoucherOrderService) AopContext.currentProxy();
    
  	<span style=color:#666>//</span> <span style=color:#666>4.</span> <span>返回订单号（告诉用户下单成功，业务结束；执行异步下单操作数据库）</span>
    <span style=color:green;font-weight:700>return</span> Result.ok(orderId);
}

</code></pre></div><blockquote><p>项目启动时，开启一个线程任务，尝试获取 <code>stream.orders</code> 中的消息，完成下单。</p></blockquote><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#408080;font-style:italic>// 从队列中获取信息
</span><span style=color:#408080;font-style:italic></span><span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>VoucherOrderHandler</span> <span style=color:green;font-weight:700>implements</span> Runnable <span style=color:#666>{</span>
    String queueName <span style=color:#666>=</span> <span style=color:#ba2121>&#34;stream.orders&#34;</span><span style=color:#666>;</span>
    String groupName <span style=color:#666>=</span> <span style=color:#ba2121>&#34;orderGroup&#34;</span><span style=color:#666>;</span>
    String consumerName <span style=color:#666>=</span> <span style=color:#ba2121>&#34;consumerOne&#34;</span><span style=color:#666>;</span>
    <span style=color:#a2f>@Override</span>
    <span style=color:green;font-weight:700>public</span> <span style=color:#b00040>void</span> <span style=color:#00f>run</span><span style=color:#666>()</span> <span style=color:#666>{</span>
        <span style=color:green;font-weight:700>while</span> <span style=color:#666>(</span><span style=color:green;font-weight:700>true</span><span style=color:#666>)</span> <span style=color:#666>{</span>
            <span style=color:green;font-weight:700>try</span> <span style=color:#666>{</span>
                <span style=color:#408080;font-style:italic>// 1. 获取消息队列中的订单信息
</span><span style=color:#408080;font-style:italic></span>                <span style=color:#408080;font-style:italic>// XREAD GROUP orderGroup consumerOne COUNT 1 BLOCK 2000 STREAMS stream.orders &gt;
</span><span style=color:#408080;font-style:italic></span>                <span style=color:#408080;font-style:italic>// 队列 stream.orders、消费者组 orderGroup、消费者 consumerOne、每次读 1 条消息、阻塞时间 2s、从下一个未消费的消息开始。
</span><span style=color:#408080;font-style:italic></span>                List<span style=color:#666>&lt;</span>MapRecord<span style=color:#666>&lt;</span>String<span style=color:#666>,</span> Object<span style=color:#666>,</span> Object<span style=color:#666>&gt;&gt;</span> readingList <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForStream</span><span style=color:#666>().</span><span style=color:#7d9029>read</span><span style=color:#666>(</span>
                        Consumer<span style=color:#666>.</span><span style=color:#7d9029>from</span><span style=color:#666>(</span>groupName<span style=color:#666>,</span> consumerName<span style=color:#666>),</span>
                        StreamReadOptions<span style=color:#666>.</span><span style=color:#7d9029>empty</span><span style=color:#666>().</span><span style=color:#7d9029>count</span><span style=color:#666>(</span>1<span style=color:#666>).</span><span style=color:#7d9029>block</span><span style=color:#666>(</span>Duration<span style=color:#666>.</span><span style=color:#7d9029>ofSeconds</span><span style=color:#666>(</span>2<span style=color:#666>)),</span>
                        StreamOffset<span style=color:#666>.</span><span style=color:#7d9029>create</span><span style=color:#666>(</span>queueName<span style=color:#666>,</span> ReadOffset<span style=color:#666>.</span><span style=color:#7d9029>lastConsumed</span><span style=color:#666>())</span>
                <span style=color:#666>);</span>
                
              	<span style=color:#408080;font-style:italic>// 2. 判断消息是否获取成功
</span><span style=color:#408080;font-style:italic></span>                <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>readingList<span style=color:#666>.</span><span style=color:#7d9029>isEmpty</span><span style=color:#666>()</span> <span style=color:#666>||</span> readingList <span style=color:#666>==</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
                    <span style=color:#408080;font-style:italic>// 获取失败说明没有消息，则继续下一次循环
</span><span style=color:#408080;font-style:italic></span>                    <span style=color:green;font-weight:700>continue</span><span style=color:#666>;</span>
                <span style=color:#666>}</span>
                
              	<span style=color:#408080;font-style:italic>// 3. 解析消息中的订单信息
</span><span style=color:#408080;font-style:italic></span>                <span style=color:#408080;font-style:italic>// MapRecord：String 代表 消息ID；两个 Object 代表 消息队列中的 Key-Value
</span><span style=color:#408080;font-style:italic></span>                MapRecord<span style=color:#666>&lt;</span>String<span style=color:#666>,</span> Object<span style=color:#666>,</span> Object<span style=color:#666>&gt;</span> record <span style=color:#666>=</span> readingList<span style=color:#666>.</span><span style=color:#7d9029>get</span><span style=color:#666>(</span>0<span style=color:#666>);</span>
                Map<span style=color:#666>&lt;</span>Object<span style=color:#666>,</span> Object<span style=color:#666>&gt;</span> recordValue <span style=color:#666>=</span> record<span style=color:#666>.</span><span style=color:#7d9029>getValue</span><span style=color:#666>();</span>
                VoucherOrder voucherOrder <span style=color:#666>=</span> BeanUtil<span style=color:#666>.</span><span style=color:#7d9029>fillBeanWithMap</span><span style=color:#666>(</span>recordValue<span style=color:#666>,</span> <span style=color:green;font-weight:700>new</span> VoucherOrder<span style=color:#666>(),</span> <span style=color:green;font-weight:700>true</span><span style=color:#666>);</span>
                
              	<span style=color:#408080;font-style:italic>// 4. 获取成功则下单
</span><span style=color:#408080;font-style:italic></span>                handleVoucherOrder<span style=color:#666>(</span>voucherOrder<span style=color:#666>);</span>
                
              	<span style=color:#408080;font-style:italic>// 5. 确认消息 XACK stream.orders orderGroup id
</span><span style=color:#408080;font-style:italic></span>                stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForStream</span><span style=color:#666>().</span><span style=color:#7d9029>acknowledge</span><span style=color:#666>(</span>groupName<span style=color:#666>,</span> consumerName<span style=color:#666>,</span> record<span style=color:#666>.</span><span style=color:#7d9029>getId</span><span style=color:#666>());</span>
            <span style=color:#666>}</span> <span style=color:green;font-weight:700>catch</span> <span style=color:#666>(</span>Exception e<span style=color:#666>)</span> <span style=color:#666>{</span>
                log<span style=color:#666>.</span><span style=color:#7d9029>error</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;订单处理异常&#34;</span><span style=color:#666>,</span> e<span style=color:#666>);</span>
                handlePendingMessages<span style=color:#666>();</span>
            <span style=color:#666>}</span>
        <span style=color:#666>}</span>
    <span style=color:#666>}</span>
    <span style=color:green;font-weight:700>private</span> <span style=color:#b00040>void</span> <span style=color:#00f>handlePendingMessages</span><span style=color:#666>()</span> <span style=color:#666>{</span>
        <span style=color:green;font-weight:700>while</span> <span style=color:#666>(</span><span style=color:green;font-weight:700>true</span><span style=color:#666>)</span> <span style=color:#666>{</span>
            <span style=color:green;font-weight:700>try</span> <span style=color:#666>{</span>
                <span style=color:#408080;font-style:italic>// 1. 获取 pending-list 中的订单信息
</span><span style=color:#408080;font-style:italic></span>                <span style=color:#408080;font-style:italic>// XREAD GROUP orderGroup consumerOne COUNT 1 STREAM stream.orders 0
</span><span style=color:#408080;font-style:italic></span>                List<span style=color:#666>&lt;</span>MapRecord<span style=color:#666>&lt;</span>String<span style=color:#666>,</span> Object<span style=color:#666>,</span> Object<span style=color:#666>&gt;&gt;</span> readingList <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForStream</span><span style=color:#666>().</span><span style=color:#7d9029>read</span><span style=color:#666>(</span>
                        Consumer<span style=color:#666>.</span><span style=color:#7d9029>from</span><span style=color:#666>(</span>groupName<span style=color:#666>,</span> consumerName<span style=color:#666>),</span>
                        StreamReadOptions<span style=color:#666>.</span><span style=color:#7d9029>empty</span><span style=color:#666>().</span><span style=color:#7d9029>count</span><span style=color:#666>(</span>1<span style=color:#666>),</span>
                        StreamOffset<span style=color:#666>.</span><span style=color:#7d9029>create</span><span style=color:#666>(</span>queueName<span style=color:#666>,</span> ReadOffset<span style=color:#666>.</span><span style=color:#7d9029>from</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;0&#34;</span><span style=color:#666>))</span>
                <span style=color:#666>);</span>
                
              	<span style=color:#408080;font-style:italic>// 2. 判断消息是否获取成功
</span><span style=color:#408080;font-style:italic></span>                <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>readingList<span style=color:#666>.</span><span style=color:#7d9029>isEmpty</span><span style=color:#666>()</span> <span style=color:#666>||</span> readingList <span style=color:#666>==</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
                    <span style=color:#408080;font-style:italic>// 获取失败 pending-list 中没有异常消息，结束循环
</span><span style=color:#408080;font-style:italic></span>                    <span style=color:green;font-weight:700>break</span><span style=color:#666>;</span>
                <span style=color:#666>}</span>
                
              	<span style=color:#408080;font-style:italic>// 3. 解析消息中的订单信息并下单
</span><span style=color:#408080;font-style:italic></span>                MapRecord<span style=color:#666>&lt;</span>String<span style=color:#666>,</span> Object<span style=color:#666>,</span> Object<span style=color:#666>&gt;</span> record <span style=color:#666>=</span> readingList<span style=color:#666>.</span><span style=color:#7d9029>get</span><span style=color:#666>(</span>0<span style=color:#666>);</span>
                Map<span style=color:#666>&lt;</span>Object<span style=color:#666>,</span> Object<span style=color:#666>&gt;</span> recordValue <span style=color:#666>=</span> record<span style=color:#666>.</span><span style=color:#7d9029>getValue</span><span style=color:#666>();</span>
                VoucherOrder voucherOrder <span style=color:#666>=</span> BeanUtil<span style=color:#666>.</span><span style=color:#7d9029>fillBeanWithMap</span><span style=color:#666>(</span>recordValue<span style=color:#666>,</span> <span style=color:green;font-weight:700>new</span> VoucherOrder<span style=color:#666>(),</span> <span style=color:green;font-weight:700>true</span><span style=color:#666>);</span>
                handleVoucherOrder<span style=color:#666>(</span>voucherOrder<span style=color:#666>);</span>
                
              	<span style=color:#408080;font-style:italic>// 4. XACK
</span><span style=color:#408080;font-style:italic></span>                stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForStream</span><span style=color:#666>().</span><span style=color:#7d9029>acknowledge</span><span style=color:#666>(</span>queueName<span style=color:#666>,</span> groupName<span style=color:#666>,</span> record<span style=color:#666>.</span><span style=color:#7d9029>getId</span><span style=color:#666>());</span>
            <span style=color:#666>}</span> <span style=color:green;font-weight:700>catch</span> <span style=color:#666>(</span>Exception e<span style=color:#666>)</span> <span style=color:#666>{</span>
                log<span style=color:#666>.</span><span style=color:#7d9029>error</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;订单处理异常（pending-list）&#34;</span><span style=color:#666>,</span> e<span style=color:#666>);</span>
                <span style=color:green;font-weight:700>try</span> <span style=color:#666>{</span>
                    <span style=color:#408080;font-style:italic>// 稍微休眠一下再进行循环
</span><span style=color:#408080;font-style:italic></span>                    Thread<span style=color:#666>.</span><span style=color:#7d9029>sleep</span><span style=color:#666>(</span>20<span style=color:#666>);</span>
                <span style=color:#666>}</span> <span style=color:green;font-weight:700>catch</span> <span style=color:#666>(</span>Exception ex<span style=color:#666>)</span> <span style=color:#666>{</span>
                    ex<span style=color:#666>.</span><span style=color:#7d9029>printStackTrace</span><span style=color:#666>();</span>
                <span style=color:#666>}</span>
            <span style=color:#666>}</span>
        <span style=color:#666>}</span>
    <span style=color:#666>}</span>
  	<span style=color:#666>...</span>
<span style=color:#666>}</span>

</code></pre></div><h2 id=秒杀下单-ultimate-ver>秒杀下单 Ultimate VER<a href=#秒杀下单-ultimate-ver class=header-anchor arialabel=Anchor> #</a></h2><blockquote><p><strong>SeckillVoucher.lua</strong></p></blockquote><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=color:green;font-weight:700>local</span> voucherId <span style=color:#666>=</span> ARGV[<span style=color:#666>1</span>]
<span style=color:green;font-weight:700>local</span> userId <span style=color:#666>=</span> ARGV[<span style=color:#666>2</span>]
<span style=color:green;font-weight:700>local</span> orderId <span style=color:#666>=</span> ARGV[<span style=color:#666>3</span>]

<span style=color:green;font-weight:700>local</span> stockKey <span style=color:#666>=</span> <span style=color:#ba2121>&#34;seckill:stock:&#34;</span> <span style=color:#666>..</span> voucherId
<span style=color:green;font-weight:700>local</span> orderKey <span style=color:#666>=</span> <span style=color:#ba2121>&#34;seckill:order:&#34;</span> <span style=color:#666>..</span> voucherId

<span style=color:#408080;font-style:italic>-- 判断库存是否充足（不足，返回 1）</span>
<span style=color:green;font-weight:700>if</span> (tonumber(redis.call(<span style=color:#ba2121>&#39;GET&#39;</span>, stockKey)) <span style=color:#666>&lt;=</span> <span style=color:#666>0</span>) <span style=color:green;font-weight:700>then</span>
    <span style=color:green;font-weight:700>return</span> <span style=color:#666>1</span>;
<span style=color:green;font-weight:700>end</span>;

<span style=color:#408080;font-style:italic>-- 判断用户是否下单（重复下单，返回 2）</span>
<span style=color:green;font-weight:700>if</span> (redis.call(<span style=color:#ba2121>&#39;SISMEMBER&#39;</span>, orderKey, userId) <span style=color:#666>==</span> <span style=color:#666>1</span>) <span style=color:green;font-weight:700>then</span>
    <span style=color:green;font-weight:700>return</span> <span style=color:#666>2</span>;
<span style=color:green;font-weight:700>end</span>;

<span style=color:#408080;font-style:italic>-- 下单成功：扣减库存、保存用户。</span>
redis.call(<span style=color:#ba2121>&#39;INCRBY&#39;</span>, stockKey, <span style=color:#666>-</span><span style=color:#666>1</span>);
redis.call(<span style=color:#ba2121>&#39;SADD&#39;</span>, orderKey, userId);
<span style=color:#408080;font-style:italic>-- 发送消息到 stream.orders 队列中（*：消息的唯一ID 由 Redis 自动生成）：XADD stream.orders * key field ...</span>
redis.call(<span style=color:#ba2121>&#39;XADD&#39;</span>, <span style=color:#ba2121>&#39;stream.orders&#39;</span>, <span style=color:#ba2121>&#39;*&#39;</span>, <span style=color:#ba2121>&#39;userId&#39;</span>, userId, <span style=color:#ba2121>&#39;voucherId&#39;</span>, voucherId, <span style=color:#ba2121>&#39;id&#39;</span>, orderId);
<span style=color:green;font-weight:700>return</span> <span style=color:#666>0</span>;

</code></pre></div><blockquote><p><strong>VoucherOrderService</strong></p></blockquote><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@Service</span>
<span style=color:#a2f>@SuppressWarnings</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;ALL&#34;</span><span style=color:#666>)</span>
<span style=color:#a2f>@Slf4j</span>
<span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>VoucherOrderServiceImpl</span> <span style=color:green;font-weight:700>extends</span> ServiceImpl<span style=color:#666>&lt;</span>VoucherOrderMapper<span style=color:#666>,</span> VoucherOrder<span style=color:#666>&gt;</span> <span style=color:green;font-weight:700>implements</span> VoucherOrderService <span style=color:#666>{</span>

    <span style=color:#a2f>@Resource</span>
    <span style=color:green;font-weight:700>private</span> SeckillVoucherService seckillVoucherService<span style=color:#666>;</span>

    <span style=color:#a2f>@Resource</span>
    <span style=color:green;font-weight:700>private</span> RedisIdWorker redisIdWorker<span style=color:#666>;</span>

    <span style=color:#a2f>@Resource</span>
    <span style=color:green;font-weight:700>private</span> StringRedisTemplate stringRedisTemplate<span style=color:#666>;</span>

    <span style=color:#a2f>@Resource</span>
    <span style=color:green;font-weight:700>private</span> RedissonClient redissonClient<span style=color:#666>;</span>

    <span style=color:#408080;font-style:italic>// Lua 脚本
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>private</span> <span style=color:green;font-weight:700>static</span> <span style=color:green;font-weight:700>final</span> DefaultRedisScript<span style=color:#666>&lt;</span>Long<span style=color:#666>&gt;</span> SECKILL_SCRIPT<span style=color:#666>;</span>
    <span style=color:green;font-weight:700>static</span> <span style=color:#666>{</span>
        SECKILL_SCRIPT <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> DefaultRedisScript<span style=color:#666>&lt;&gt;();</span>
        SECKILL_SCRIPT<span style=color:#666>.</span><span style=color:#7d9029>setLocation</span><span style=color:#666>(</span><span style=color:green;font-weight:700>new</span> ClassPathResource<span style=color:#666>(</span><span style=color:#ba2121>&#34;SeckillVoucher.lua&#34;</span><span style=color:#666>));</span>
        SECKILL_SCRIPT<span style=color:#666>.</span><span style=color:#7d9029>setResultType</span><span style=color:#666>(</span>Long<span style=color:#666>.</span><span style=color:#7d9029>class</span><span style=color:#666>);</span>
    <span style=color:#666>}</span>

    <span style=color:#408080;font-style:italic>// 代理对象
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>private</span> VoucherOrderService currentProxy<span style=color:#666>;</span>

    <span style=color:#a2f>@Override</span>
    <span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>seckillVoucher</span><span style=color:#666>(</span>Long voucherId<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 1. 执行 Lua 脚本（有购买资格：向 stream.orders 中添加消息，内容包括 voucherId、userId、orderId）
</span><span style=color:#408080;font-style:italic></span>        Long userId <span style=color:#666>=</span> UserHolder<span style=color:#666>.</span><span style=color:#7d9029>getUser</span><span style=color:#666>().</span><span style=color:#7d9029>getId</span><span style=color:#666>();</span>
        <span style=color:#b00040>long</span> orderId <span style=color:#666>=</span> redisIdWorker<span style=color:#666>.</span><span style=color:#7d9029>nextId</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;order&#34;</span><span style=color:#666>);</span>
        Long executeResult <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>execute</span><span style=color:#666>(</span>
                SECKILL_SCRIPT<span style=color:#666>,</span>
                Collections<span style=color:#666>.</span><span style=color:#7d9029>emptyList</span><span style=color:#666>(),</span>
                voucherId<span style=color:#666>.</span><span style=color:#7d9029>toString</span><span style=color:#666>(),</span> userId<span style=color:#666>.</span><span style=color:#7d9029>toString</span><span style=color:#666>(),</span> String<span style=color:#666>.</span><span style=color:#7d9029>valueOf</span><span style=color:#666>(</span>orderId<span style=color:#666>)</span>
        <span style=color:#666>);</span>

        <span style=color:#408080;font-style:italic>// 2. Lua 脚本的执行结果不为 0，则没有购买资格
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#b00040>int</span> result <span style=color:#666>=</span> executeResult<span style=color:#666>.</span><span style=color:#7d9029>intValue</span><span style=color:#666>();</span>
        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>result <span style=color:#666>!=</span> 0<span style=color:#666>)</span> <span style=color:#666>{</span>
            <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span>result <span style=color:#666>==</span> 1 <span style=color:#666>?</span> <span style=color:#ba2121>&#34;库存不足！&#34;</span> <span style=color:#666>:</span> <span style=color:#ba2121>&#34;请勿重复下单！&#34;</span><span style=color:#666>);</span>
        <span style=color:#666>}</span>

        <span style=color:#408080;font-style:italic>// 3. 获取代理对象
</span><span style=color:#408080;font-style:italic></span>        currentProxy <span style=color:#666>=</span> <span style=color:#666>(</span>VoucherOrderService<span style=color:#666>)</span> AopContext<span style=color:#666>.</span><span style=color:#7d9029>currentProxy</span><span style=color:#666>();</span>

        <span style=color:#408080;font-style:italic>// 4. 返回订单号（告诉用户下单成功，业务结束；执行异步下单操作数据库）
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>orderId<span style=color:#666>);</span>
    <span style=color:#666>}</span>


    <span style=color:#408080;font-style:italic>// 异步处理线程池
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>private</span> <span style=color:green;font-weight:700>static</span> <span style=color:green;font-weight:700>final</span> ExecutorService SECKILL_ORDER_EXECUTOR <span style=color:#666>=</span> Executors<span style=color:#666>.</span><span style=color:#7d9029>newSingleThreadExecutor</span><span style=color:#666>();</span>

    <span style=color:#408080;font-style:italic>// 在当前类初始完毕后执行 VoucherOrderHandler 中的 run 方法
</span><span style=color:#408080;font-style:italic></span>    <span style=color:#a2f>@PostConstruct</span>
    <span style=color:green;font-weight:700>public</span> <span style=color:#b00040>void</span> <span style=color:#00f>init</span><span style=color:#666>()</span> <span style=color:#666>{</span>
        SECKILL_ORDER_EXECUTOR<span style=color:#666>.</span><span style=color:#7d9029>submit</span><span style=color:#666>(</span><span style=color:green;font-weight:700>new</span> VoucherOrderHandler<span style=color:#666>());</span>
    <span style=color:#666>}</span>
    
    <span style=color:#408080;font-style:italic>// 从队列中获取信息
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>VoucherOrderHandler</span> <span style=color:green;font-weight:700>implements</span> Runnable <span style=color:#666>{</span>
        String queueName <span style=color:#666>=</span> <span style=color:#ba2121>&#34;stream.orders&#34;</span><span style=color:#666>;</span>
        String groupName <span style=color:#666>=</span> <span style=color:#ba2121>&#34;orderGroup&#34;</span><span style=color:#666>;</span>
        String consumerName <span style=color:#666>=</span> <span style=color:#ba2121>&#34;consumerOne&#34;</span><span style=color:#666>;</span>

        <span style=color:#a2f>@Override</span>
        <span style=color:green;font-weight:700>public</span> <span style=color:#b00040>void</span> <span style=color:#00f>run</span><span style=color:#666>()</span> <span style=color:#666>{</span>
            <span style=color:green;font-weight:700>while</span> <span style=color:#666>(</span><span style=color:green;font-weight:700>true</span><span style=color:#666>)</span> <span style=color:#666>{</span>
                <span style=color:green;font-weight:700>try</span> <span style=color:#666>{</span>
                    <span style=color:#408080;font-style:italic>// 1. 获取消息队列中的订单信息
</span><span style=color:#408080;font-style:italic></span>                    <span style=color:#408080;font-style:italic>// XREAD GROUP orderGroup consumerOne COUNT 1 BLOCK 2000 STREAMS stream.orders &gt;
</span><span style=color:#408080;font-style:italic></span>                    <span style=color:#408080;font-style:italic>// 队列 stream.orders、消费者组 orderGroup、消费者 consumerOne、每次读 1 条消息、阻塞时间 2s、从下一个未消费的消息开始。
</span><span style=color:#408080;font-style:italic></span>                    List<span style=color:#666>&lt;</span>MapRecord<span style=color:#666>&lt;</span>String<span style=color:#666>,</span> Object<span style=color:#666>,</span> Object<span style=color:#666>&gt;&gt;</span> readingList <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForStream</span><span style=color:#666>().</span><span style=color:#7d9029>read</span><span style=color:#666>(</span>
                            Consumer<span style=color:#666>.</span><span style=color:#7d9029>from</span><span style=color:#666>(</span>groupName<span style=color:#666>,</span> consumerName<span style=color:#666>),</span>
                            StreamReadOptions<span style=color:#666>.</span><span style=color:#7d9029>empty</span><span style=color:#666>().</span><span style=color:#7d9029>count</span><span style=color:#666>(</span>1<span style=color:#666>).</span><span style=color:#7d9029>block</span><span style=color:#666>(</span>Duration<span style=color:#666>.</span><span style=color:#7d9029>ofSeconds</span><span style=color:#666>(</span>2<span style=color:#666>)),</span>
                            StreamOffset<span style=color:#666>.</span><span style=color:#7d9029>create</span><span style=color:#666>(</span>queueName<span style=color:#666>,</span> ReadOffset<span style=color:#666>.</span><span style=color:#7d9029>lastConsumed</span><span style=color:#666>())</span>
                    <span style=color:#666>);</span>

                    <span style=color:#408080;font-style:italic>// 2. 判断消息是否获取成功
</span><span style=color:#408080;font-style:italic></span>                    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>readingList<span style=color:#666>.</span><span style=color:#7d9029>isEmpty</span><span style=color:#666>()</span> <span style=color:#666>||</span> readingList <span style=color:#666>==</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
                        <span style=color:#408080;font-style:italic>// 获取失败说明没有消息，则继续下一次循环
</span><span style=color:#408080;font-style:italic></span>                        <span style=color:green;font-weight:700>continue</span><span style=color:#666>;</span>
                    <span style=color:#666>}</span>

                    <span style=color:#408080;font-style:italic>// 3. 解析消息中的订单信息
</span><span style=color:#408080;font-style:italic></span>                    <span style=color:#408080;font-style:italic>// MapRecord：String 代表 消息ID；两个 Object 代表 消息队列中的 Key-Value
</span><span style=color:#408080;font-style:italic></span>                    MapRecord<span style=color:#666>&lt;</span>String<span style=color:#666>,</span> Object<span style=color:#666>,</span> Object<span style=color:#666>&gt;</span> record <span style=color:#666>=</span> readingList<span style=color:#666>.</span><span style=color:#7d9029>get</span><span style=color:#666>(</span>0<span style=color:#666>);</span>
                    Map<span style=color:#666>&lt;</span>Object<span style=color:#666>,</span> Object<span style=color:#666>&gt;</span> recordValue <span style=color:#666>=</span> record<span style=color:#666>.</span><span style=color:#7d9029>getValue</span><span style=color:#666>();</span>
                    VoucherOrder voucherOrder <span style=color:#666>=</span> BeanUtil<span style=color:#666>.</span><span style=color:#7d9029>fillBeanWithMap</span><span style=color:#666>(</span>recordValue<span style=color:#666>,</span> <span style=color:green;font-weight:700>new</span> VoucherOrder<span style=color:#666>(),</span> <span style=color:green;font-weight:700>true</span><span style=color:#666>);</span>

                    <span style=color:#408080;font-style:italic>// 4. 获取成功则下单
</span><span style=color:#408080;font-style:italic></span>                    handleVoucherOrder<span style=color:#666>(</span>voucherOrder<span style=color:#666>);</span>

                    <span style=color:#408080;font-style:italic>// 5. 确认消息 XACK stream.orders orderGroup id
</span><span style=color:#408080;font-style:italic></span>                    stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForStream</span><span style=color:#666>().</span><span style=color:#7d9029>acknowledge</span><span style=color:#666>(</span>groupName<span style=color:#666>,</span> consumerName<span style=color:#666>,</span> record<span style=color:#666>.</span><span style=color:#7d9029>getId</span><span style=color:#666>());</span>
                <span style=color:#666>}</span> <span style=color:green;font-weight:700>catch</span> <span style=color:#666>(</span>Exception e<span style=color:#666>)</span> <span style=color:#666>{</span>
                    log<span style=color:#666>.</span><span style=color:#7d9029>error</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;订单处理异常&#34;</span><span style=color:#666>,</span> e<span style=color:#666>);</span>
                    handlePendingMessages<span style=color:#666>();</span>
                <span style=color:#666>}</span>
            <span style=color:#666>}</span>
        <span style=color:#666>}</span>

        <span style=color:green;font-weight:700>private</span> <span style=color:#b00040>void</span> <span style=color:#00f>handlePendingMessages</span><span style=color:#666>()</span> <span style=color:#666>{</span>
            <span style=color:green;font-weight:700>while</span> <span style=color:#666>(</span><span style=color:green;font-weight:700>true</span><span style=color:#666>)</span> <span style=color:#666>{</span>
                <span style=color:green;font-weight:700>try</span> <span style=color:#666>{</span>
                    <span style=color:#408080;font-style:italic>// 1. 获取 pending-list 中的订单信息
</span><span style=color:#408080;font-style:italic></span>                    <span style=color:#408080;font-style:italic>// XREAD GROUP orderGroup consumerOne COUNT 1 STREAM stream.orders 0
</span><span style=color:#408080;font-style:italic></span>                    List<span style=color:#666>&lt;</span>MapRecord<span style=color:#666>&lt;</span>String<span style=color:#666>,</span> Object<span style=color:#666>,</span> Object<span style=color:#666>&gt;&gt;</span> readingList <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForStream</span><span style=color:#666>().</span><span style=color:#7d9029>read</span><span style=color:#666>(</span>
                            Consumer<span style=color:#666>.</span><span style=color:#7d9029>from</span><span style=color:#666>(</span>groupName<span style=color:#666>,</span> consumerName<span style=color:#666>),</span>
                            StreamReadOptions<span style=color:#666>.</span><span style=color:#7d9029>empty</span><span style=color:#666>().</span><span style=color:#7d9029>count</span><span style=color:#666>(</span>1<span style=color:#666>),</span>
                            StreamOffset<span style=color:#666>.</span><span style=color:#7d9029>create</span><span style=color:#666>(</span>queueName<span style=color:#666>,</span> ReadOffset<span style=color:#666>.</span><span style=color:#7d9029>from</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;0&#34;</span><span style=color:#666>))</span>
                    <span style=color:#666>);</span>

                    <span style=color:#408080;font-style:italic>// 2. 判断消息是否获取成功
</span><span style=color:#408080;font-style:italic></span>                    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>readingList<span style=color:#666>.</span><span style=color:#7d9029>isEmpty</span><span style=color:#666>()</span> <span style=color:#666>||</span> readingList <span style=color:#666>==</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
                        <span style=color:#408080;font-style:italic>// 获取失败 pending-list 中没有异常消息，结束循环
</span><span style=color:#408080;font-style:italic></span>                        <span style=color:green;font-weight:700>break</span><span style=color:#666>;</span>
                    <span style=color:#666>}</span>

                    <span style=color:#408080;font-style:italic>// 3. 解析消息中的订单信息并下单
</span><span style=color:#408080;font-style:italic></span>                    MapRecord<span style=color:#666>&lt;</span>String<span style=color:#666>,</span> Object<span style=color:#666>,</span> Object<span style=color:#666>&gt;</span> record <span style=color:#666>=</span> readingList<span style=color:#666>.</span><span style=color:#7d9029>get</span><span style=color:#666>(</span>0<span style=color:#666>);</span>
                    Map<span style=color:#666>&lt;</span>Object<span style=color:#666>,</span> Object<span style=color:#666>&gt;</span> recordValue <span style=color:#666>=</span> record<span style=color:#666>.</span><span style=color:#7d9029>getValue</span><span style=color:#666>();</span>
                    VoucherOrder voucherOrder <span style=color:#666>=</span> BeanUtil<span style=color:#666>.</span><span style=color:#7d9029>fillBeanWithMap</span><span style=color:#666>(</span>recordValue<span style=color:#666>,</span> <span style=color:green;font-weight:700>new</span> VoucherOrder<span style=color:#666>(),</span> <span style=color:green;font-weight:700>true</span><span style=color:#666>);</span>
                    handleVoucherOrder<span style=color:#666>(</span>voucherOrder<span style=color:#666>);</span>

                    <span style=color:#408080;font-style:italic>// 4. XACK
</span><span style=color:#408080;font-style:italic></span>                    stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForStream</span><span style=color:#666>().</span><span style=color:#7d9029>acknowledge</span><span style=color:#666>(</span>queueName<span style=color:#666>,</span> groupName<span style=color:#666>,</span> record<span style=color:#666>.</span><span style=color:#7d9029>getId</span><span style=color:#666>());</span>
                <span style=color:#666>}</span> <span style=color:green;font-weight:700>catch</span> <span style=color:#666>(</span>Exception e<span style=color:#666>)</span> <span style=color:#666>{</span>
                    log<span style=color:#666>.</span><span style=color:#7d9029>error</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;订单处理异常（pending-list）&#34;</span><span style=color:#666>,</span> e<span style=color:#666>);</span>
                    <span style=color:green;font-weight:700>try</span> <span style=color:#666>{</span>
                        <span style=color:#408080;font-style:italic>// 稍微休眠一下再进行循环
</span><span style=color:#408080;font-style:italic></span>                        Thread<span style=color:#666>.</span><span style=color:#7d9029>sleep</span><span style=color:#666>(</span>20<span style=color:#666>);</span>
                    <span style=color:#666>}</span> <span style=color:green;font-weight:700>catch</span> <span style=color:#666>(</span>Exception ex<span style=color:#666>)</span> <span style=color:#666>{</span>
                        ex<span style=color:#666>.</span><span style=color:#7d9029>printStackTrace</span><span style=color:#666>();</span>
                    <span style=color:#666>}</span>
                <span style=color:#666>}</span>
            <span style=color:#666>}</span>

        <span style=color:#666>}</span>

        <span style=color:green;font-weight:700>private</span> <span style=color:#b00040>void</span> <span style=color:#00f>handleVoucherOrder</span><span style=color:#666>(</span>VoucherOrder voucherOrder<span style=color:#666>)</span> <span style=color:#666>{</span>
            Long userId <span style=color:#666>=</span> voucherOrder<span style=color:#666>.</span><span style=color:#7d9029>getUserId</span><span style=color:#666>();</span>
            RLock lock <span style=color:#666>=</span> redissonClient<span style=color:#666>.</span><span style=color:#7d9029>getLock</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;lock:order:&#34;</span> <span style=color:#666>+</span> userId<span style=color:#666>);</span>
            <span style=color:#b00040>boolean</span> isLocked <span style=color:#666>=</span> lock<span style=color:#666>.</span><span style=color:#7d9029>tryLock</span><span style=color:#666>();</span>
            <span style=color:green;font-weight:700>if</span> <span style=color:#666>(!</span>isLocked<span style=color:#666>)</span> <span style=color:#666>{</span>
                log<span style=color:#666>.</span><span style=color:#7d9029>error</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;不允许重复下单！&#34;</span><span style=color:#666>);</span>
                <span style=color:green;font-weight:700>return</span><span style=color:#666>;</span>
            <span style=color:#666>}</span>
            <span style=color:green;font-weight:700>try</span> <span style=color:#666>{</span>
                <span style=color:#408080;font-style:italic>// 该方法非主线程调用，代理对象需要在主线程中获取。
</span><span style=color:#408080;font-style:italic></span>                currentProxy<span style=color:#666>.</span><span style=color:#7d9029>createVoucherOrder</span><span style=color:#666>(</span>voucherOrder<span style=color:#666>);</span>
            <span style=color:#666>}</span> <span style=color:green;font-weight:700>finally</span> <span style=color:#666>{</span>
                lock<span style=color:#666>.</span><span style=color:#7d9029>unlock</span><span style=color:#666>();</span>
            <span style=color:#666>}</span>
        <span style=color:#666>}</span>
    <span style=color:#666>}</span>

    <span style=color:#a2f>@Transactional</span>
    <span style=color:#a2f>@Override</span>
    <span style=color:green;font-weight:700>public</span> <span style=color:#b00040>void</span> <span style=color:#00f>createVoucherOrder</span><span style=color:#666>(</span>VoucherOrder voucherOrder<span style=color:#666>)</span> <span style=color:#666>{</span>
        Long userId <span style=color:#666>=</span> voucherOrder<span style=color:#666>.</span><span style=color:#7d9029>getUserId</span><span style=color:#666>();</span>
        <span style=color:#408080;font-style:italic>// 1. 一人一单
</span><span style=color:#408080;font-style:italic></span>        Integer count <span style=color:#666>=</span> query<span style=color:#666>()</span>
                <span style=color:#666>.</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;voucher_id&#34;</span><span style=color:#666>,</span> voucherOrder<span style=color:#666>.</span><span style=color:#7d9029>getVoucherId</span><span style=color:#666>())</span>
                <span style=color:#666>.</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;user_id&#34;</span><span style=color:#666>,</span> userId<span style=color:#666>)</span>
                <span style=color:#666>.</span><span style=color:#7d9029>count</span><span style=color:#666>();</span>
        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>count <span style=color:#666>&gt;</span> 0<span style=color:#666>)</span> <span style=color:#666>{</span>
            log<span style=color:#666>.</span><span style=color:#7d9029>error</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;不可重复下单！&#34;</span><span style=color:#666>);</span>
            <span style=color:green;font-weight:700>return</span><span style=color:#666>;</span>
        <span style=color:#666>}</span>

        <span style=color:#408080;font-style:italic>// 2. 减扣库存
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#b00040>boolean</span> isAccomplished <span style=color:#666>=</span> seckillVoucherService<span style=color:#666>.</span><span style=color:#7d9029>update</span><span style=color:#666>()</span>
                <span style=color:#666>.</span><span style=color:#7d9029>setSql</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;stock = stock - 1&#34;</span><span style=color:#666>)</span>
                <span style=color:#666>.</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;voucher_id&#34;</span><span style=color:#666>,</span> voucherOrder<span style=color:#666>.</span><span style=color:#7d9029>getVoucherId</span><span style=color:#666>()).</span><span style=color:#7d9029>gt</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;stock&#34;</span><span style=color:#666>,</span> 0<span style=color:#666>)</span>
                <span style=color:#666>.</span><span style=color:#7d9029>update</span><span style=color:#666>();</span>
        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(!</span>isAccomplished<span style=color:#666>)</span> <span style=color:#666>{</span>
            log<span style=color:#666>.</span><span style=color:#7d9029>error</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;库存不足！&#34;</span><span style=color:#666>);</span>
            <span style=color:green;font-weight:700>return</span><span style=color:#666>;</span>
        <span style=color:#666>}</span>

        <span style=color:#408080;font-style:italic>// 3. 下单
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#b00040>boolean</span> isSaved <span style=color:#666>=</span> save<span style=color:#666>(</span>voucherOrder<span style=color:#666>);</span>
        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(!</span>isSaved<span style=color:#666>)</span> <span style=color:#666>{</span>
            log<span style=color:#666>.</span><span style=color:#7d9029>error</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;下单失败！&#34;</span><span style=color:#666>);</span>
            <span style=color:green;font-weight:700>return</span><span style=color:#666>;</span>
        <span style=color:#666>}</span>
    <span style=color:#666>}</span>
<span style=color:#666>}</span>

</code></pre></div><h3 id=总结基于消息队列进行异步秒杀>总结基于消息队列进行异步秒杀<a href=#总结基于消息队列进行异步秒杀 class=header-anchor arialabel=Anchor> #</a></h3><blockquote><p>之前用的是阻塞队列，现在用的是redis的stram消息队列</p></blockquote><h2 id=8-点赞相关>8. 点赞相关<a href=#8-点赞相关 class=header-anchor arialabel=Anchor> #</a></h2><h3 id=81-发布查看笔记>8.1 发布、查看笔记<a href=#81-发布查看笔记 class=header-anchor arialabel=Anchor> #</a></h3><blockquote><ul><li><code>tb_blog</code>：笔记表，包含比较重的标题、文字、图片等；</li><li><code>tb_blog_comments</code>：其他用户对笔记的评论。</li><li>上传图片接口地址：<code>http://localhost:8080/api/upload/blog</code></li><li>发布笔记接口地址：<code>http://localhost:8080/api/blog</code></li></ul></blockquote><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@Slf4j</span>
<span style=color:#a2f>@RestController</span>
<span style=color:#a2f>@RequestMapping</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;upload&#34;</span><span style=color:#666>)</span>
<span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>UploadController</span> <span style=color:#666>{</span>

    <span style=color:#a2f>@PostMapping</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;/blog&#34;</span><span style=color:#666>)</span>
    <span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>uploadImage</span><span style=color:#666>(</span><span style=color:#a2f>@RequestParam</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;file&#34;</span><span style=color:#666>)</span> MultipartFile image<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:green;font-weight:700>try</span> <span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>// 获取原始文件名称
</span><span style=color:#408080;font-style:italic></span>            String originalFilename <span style=color:#666>=</span> image<span style=color:#666>.</span><span style=color:#7d9029>getOriginalFilename</span><span style=color:#666>();</span>
            <span style=color:#408080;font-style:italic>// 生成新文件名
</span><span style=color:#408080;font-style:italic></span>            String fileName <span style=color:#666>=</span> createNewFileName<span style=color:#666>(</span>originalFilename<span style=color:#666>);</span>
            <span style=color:#408080;font-style:italic>// 保存文件
</span><span style=color:#408080;font-style:italic></span>            image<span style=color:#666>.</span><span style=color:#7d9029>transferTo</span><span style=color:#666>(</span><span style=color:green;font-weight:700>new</span> File<span style=color:#666>(</span>SystemConstants<span style=color:#666>.</span><span style=color:#7d9029>IMAGE_UPLOAD_DIR</span><span style=color:#666>,</span> fileName<span style=color:#666>));</span>
            <span style=color:#408080;font-style:italic>// 返回结果
</span><span style=color:#408080;font-style:italic></span>            log<span style=color:#666>.</span><span style=color:#7d9029>debug</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;文件上传成功，{}&#34;</span><span style=color:#666>,</span> fileName<span style=color:#666>);</span>
            <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>fileName<span style=color:#666>);</span>
        <span style=color:#666>}</span> <span style=color:green;font-weight:700>catch</span> <span style=color:#666>(</span>IOException e<span style=color:#666>)</span> <span style=color:#666>{</span>
            <span style=color:green;font-weight:700>throw</span> <span style=color:green;font-weight:700>new</span> RuntimeException<span style=color:#666>(</span><span style=color:#ba2121>&#34;文件上传失败&#34;</span><span style=color:#666>,</span> e<span style=color:#666>);</span>
        <span style=color:#666>}</span>
    <span style=color:#666>}</span>

<span style=color:#666>}</span>
</code></pre></div><p>目前需求：点击笔记，进入详情页面，实现该页面的查询接口。</p><table><thead><tr><th>请求方式</th><th>请求路径</th><th>请求参数</th><th>返回值</th></tr></thead><tbody><tr><td>GET</td><td><code>/blog/{id}</code></td><td>id（<code>@PathVariable</code>）</td><td>笔记信息（包含用户信息）</td></tr></tbody></table><p><code>Blog</code> 实体类中添加两个属性，<code>icon</code> 和 <code>name</code>，并且添加 <code>@TableField(exist = false)</code> 注解，表示该注解不属于 <code>tb_blog</code> 表中的字段。</p><p>注意操作时，需要修改SystemConstants.IMAGE_UPLOAD_DIR 自己图片所在的地址，在实际开发中图片一般会放在nginx上或者是云存储上。（此处可改为本地地址）</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#408080;font-style:italic>/**
</span><span style=color:#408080;font-style:italic> * 用户图标
</span><span style=color:#408080;font-style:italic> */</span>
<span style=color:#a2f>@TableField</span><span style=color:#666>(</span>exist <span style=color:#666>=</span> <span style=color:green;font-weight:700>false</span><span style=color:#666>)</span>
<span style=color:green;font-weight:700>private</span> String icon<span style=color:#666>;</span>

<span style=color:#408080;font-style:italic>/**
</span><span style=color:#408080;font-style:italic> * 用户姓名
</span><span style=color:#408080;font-style:italic> */</span>
<span style=color:#a2f>@TableField</span><span style=color:#666>(</span>exist <span style=color:#666>=</span> <span style=color:green;font-weight:700>false</span><span style=color:#666>)</span>
<span style=color:green;font-weight:700>private</span> String name<span style=color:#666>;</span>
1234567891011
<span style=color:#a2f>@GetMapping</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;/{id}&#34;</span><span style=color:#666>)</span>
<span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>queryById</span><span style=color:#666>(</span><span style=color:#a2f>@PathVariable</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;id&#34;</span><span style=color:#666>)</span> Long id<span style=color:#666>)</span> <span style=color:#666>{</span>
    <span style=color:green;font-weight:700>return</span> blogService<span style=color:#666>.</span><span style=color:#7d9029>queryById</span><span style=color:#666>(</span>id<span style=color:#666>);</span>
<span style=color:#666>}</span>

<span style=color:#408080;font-style:italic>// BlogService
</span><span style=color:#408080;font-style:italic></span><span style=color:#a2f>@Override</span>
<span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>queryById</span><span style=color:#666>(</span>Long id<span style=color:#666>)</span> <span style=color:#666>{</span>
    Blog blog <span style=color:#666>=</span> getById<span style=color:#666>(</span>id<span style=color:#666>);</span>
    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>blog <span style=color:#666>==</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;笔记不存在！&#34;</span><span style=color:#666>);</span>
    <span style=color:#666>}</span>
    queryBlogWithUserInfo<span style=color:#666>(</span>blog<span style=color:#666>);</span>
    <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>blog<span style=color:#666>);</span>
<span style=color:#666>}</span>

<span style=color:green;font-weight:700>private</span> <span style=color:#b00040>void</span> <span style=color:#00f>queryBlogWithUserInfo</span><span style=color:#666>(</span>Blog blog<span style=color:#666>)</span> <span style=color:#666>{</span>
    Long userId <span style=color:#666>=</span> blog<span style=color:#666>.</span><span style=color:#7d9029>getUserId</span><span style=color:#666>();</span>
    User user <span style=color:#666>=</span> userService<span style=color:#666>.</span><span style=color:#7d9029>getById</span><span style=color:#666>(</span>userId<span style=color:#666>);</span>
    blog<span style=color:#666>.</span><span style=color:#7d9029>setIcon</span><span style=color:#666>(</span>user<span style=color:#666>.</span><span style=color:#7d9029>getIcon</span><span style=color:#666>());</span>
    blog<span style=color:#666>.</span><span style=color:#7d9029>setName</span><span style=color:#666>(</span>user<span style=color:#666>.</span><span style=color:#7d9029>getNickName</span><span style=color:#666>());</span>
<span style=color:#666>}</span>
</code></pre></div><h3 id=82-点赞>8.2 点赞<a href=#82-点赞 class=header-anchor arialabel=Anchor> #</a></h3><blockquote><p><strong>初始代码：<code>http://localhost:8080/blog/like/{id}</code></strong></p><p>目前存在的问题：一个用户可以无限点赞，目前的逻辑发起的请求只是将 <code>liked</code> 字段的值 <code>+1</code>。</p></blockquote><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@PutMapping</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;/like/{id}&#34;</span><span style=color:#666>)</span>
<span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>likeBlog</span><span style=color:#666>(</span><span style=color:#a2f>@PathVariable</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;id&#34;</span><span style=color:#666>)</span> Long id<span style=color:#666>)</span> <span style=color:#666>{</span>
    <span style=color:green;font-weight:700>return</span> blogService<span style=color:#666>.</span><span style=color:#7d9029>likeBlog</span><span style=color:#666>(</span>id<span style=color:#666>);</span>
<span style=color:#666>}</span>

<span style=color:#a2f>@Override</span>
<span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>likeBlog</span><span style=color:#666>(</span>Long id<span style=color:#666>)</span> <span style=color:#666>{</span>
    <span style=color:#408080;font-style:italic>// update set tb_blog liked = liked + 1 where id = ?
</span><span style=color:#408080;font-style:italic></span>    update<span style=color:#666>().</span><span style=color:#7d9029>setSql</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;liked = liked + 1&#34;</span><span style=color:#666>).</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;id&#34;</span><span style=color:#666>,</span> id<span style=color:#666>).</span><span style=color:#7d9029>update</span><span style=color:#666>();</span>
    <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>();</span>
<span style=color:#666>}</span>

</code></pre></div><blockquote><p><strong>需求</strong></p></blockquote><ol><li>同一个用户只能点赞一次，再次点赞则取消点赞；</li><li>若当前用户已经点赞，则点赞按钮高亮显示（前段实现，判断 <code>Blog</code> 类中的 <code>isLike</code> 属性的值）。</li></ol><blockquote><p><strong>实现步骤</strong></p></blockquote><ol><li>为 Blog 类添加一个 <code>isLike</code> 属性，标识是否被当前用户点赞；</li><li>修改点赞功能，利用 Redis 的 Set 集合判断是否点过赞；用户点赞，未点过赞则点赞数 +1，已点过赞则点赞数 -1；<ul><li>Set 集合：无序不可重复，支持 交集、并集、差集等功能。</li></ul></li><li>修改根据 ID 查询 Blog 的业务，判断当前登录用户是否点过赞，赋值给 <code>isLike</code> 属性；</li><li>修改分页查询 Blog 业务，判断当前登录用户是否点过赞，赋值给 <code>isLike</code> 属性。</li></ol><blockquote><p><strong><code>Blog</code> 类中添加一个 <code>isLike</code> 属性</strong></p></blockquote><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#408080;font-style:italic>/**
</span><span style=color:#408080;font-style:italic> * 是否点赞
</span><span style=color:#408080;font-style:italic> */</span>
<span style=color:#a2f>@TableField</span><span style=color:#666>(</span>exist <span style=color:#666>=</span> <span style=color:green;font-weight:700>false</span><span style=color:#666>)</span>
<span style=color:green;font-weight:700>private</span> Boolean isLike<span style=color:#666>;</span>
12345
</code></pre></div><blockquote><p><strong>判断用户是否对该 Blog 点赞过</strong></p></blockquote><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#408080;font-style:italic>/**
</span><span style=color:#408080;font-style:italic> * 判断用户是否对该 Blog 点赞过
</span><span style=color:#408080;font-style:italic> */</span>
<span style=color:green;font-weight:700>private</span> <span style=color:#b00040>void</span> <span style=color:#00f>isBlogLiked</span><span style=color:#666>(</span>Blog blog<span style=color:#666>)</span> <span style=color:#666>{</span>
    String key <span style=color:#666>=</span> BLOG_LIKED_KEY <span style=color:#666>+</span> blog<span style=color:#666>.</span><span style=color:#7d9029>getId</span><span style=color:#666>();</span>
  	UserDTO user <span style=color:#666>=</span> UserHolder<span style=color:#666>.</span><span style=color:#7d9029>getUser</span><span style=color:#666>();</span>
    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>user <span style=color:#666>==</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 用户未登录，无需查询是否点过赞
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>return</span><span style=color:#666>;</span>
    <span style=color:#666>}</span>
    Long userId <span style=color:#666>=</span> user<span style=color:#666>.</span><span style=color:#7d9029>getId</span><span style=color:#666>();</span>
    Boolean isLiked <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForSet</span><span style=color:#666>().</span><span style=color:#7d9029>isMember</span><span style=color:#666>(</span>key<span style=color:#666>,</span> userId<span style=color:#666>.</span><span style=color:#7d9029>toString</span><span style=color:#666>());</span>
    blog<span style=color:#666>.</span><span style=color:#7d9029>setIsLike</span><span style=color:#666>(</span>BooleanUtil<span style=color:#666>.</span><span style=color:#7d9029>isTrue</span><span style=color:#666>(</span>isLiked<span style=color:#666>);</span>
<span style=color:#666>}</span>


<span style=color:#408080;font-style:italic>/**
</span><span style=color:#408080;font-style:italic> * 展示热门 Blog
</span><span style=color:#408080;font-style:italic> */</span>
<span style=color:#a2f>@Override</span>
<span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>queryHotBlog</span><span style=color:#666>(</span>Integer current<span style=color:#666>)</span> <span style=color:#666>{</span>
    Page<span style=color:#666>&lt;</span>Blog<span style=color:#666>&gt;</span> page <span style=color:#666>=</span> query<span style=color:#666>()</span>
            <span style=color:#666>.</span><span style=color:#7d9029>orderByDesc</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;liked&#34;</span><span style=color:#666>)</span>
            <span style=color:#666>.</span><span style=color:#7d9029>page</span><span style=color:#666>(</span><span style=color:green;font-weight:700>new</span> Page<span style=color:#666>&lt;&gt;(</span>current<span style=color:#666>,</span> SystemConstants<span style=color:#666>.</span><span style=color:#7d9029>MAX_PAGE_SIZE</span><span style=color:#666>));</span>
    List<span style=color:#666>&lt;</span>Blog<span style=color:#666>&gt;</span> records <span style=color:#666>=</span> page<span style=color:#666>.</span><span style=color:#7d9029>getRecords</span><span style=color:#666>();</span>
    records<span style=color:#666>.</span><span style=color:#7d9029>forEach</span><span style=color:#666>(</span>blog <span style=color:#666>-&gt;</span> <span style=color:#666>{</span>
        <span style=color:green;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#7d9029>queryBlogWithUserInfo</span><span style=color:#666>(</span>blog<span style=color:#666>);</span>
        <span style=color:green;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#7d9029>isBlogLiked</span><span style=color:#666>(</span>blog<span style=color:#666>);</span>
    <span style=color:#666>});</span>
    <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>records<span style=color:#666>);</span>
<span style=color:#666>}</span>

<span style=color:#408080;font-style:italic>/**
</span><span style=color:#408080;font-style:italic> * 展示 Blog 详情页（根据 ID）
</span><span style=color:#408080;font-style:italic> */</span>
<span style=color:#a2f>@Override</span>
<span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>queryById</span><span style=color:#666>(</span>Long id<span style=color:#666>)</span> <span style=color:#666>{</span>
    Blog blog <span style=color:#666>=</span> getById<span style=color:#666>(</span>id<span style=color:#666>);</span>
    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>blog <span style=color:#666>==</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;笔记不存在！&#34;</span><span style=color:#666>);</span>
    <span style=color:#666>}</span>
    queryBlogWithUserInfo<span style=color:#666>(</span>blog<span style=color:#666>);</span>
    isBlogLiked<span style=color:#666>(</span>blog<span style=color:#666>);</span>
    <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>blog<span style=color:#666>);</span>
<span style=color:#666>}</span>
</code></pre></div><blockquote><p><strong>实现点赞功能</strong></p></blockquote><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@Override</span>
<span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>likeBlog</span><span style=color:#666>(</span>Long id<span style=color:#666>)</span> <span style=color:#666>{</span>
    <span style=color:#408080;font-style:italic>// 1. 判断当前登录用户是否点过赞。
</span><span style=color:#408080;font-style:italic></span>    Long userId <span style=color:#666>=</span> UserHolder<span style=color:#666>.</span><span style=color:#7d9029>getUser</span><span style=color:#666>().</span><span style=color:#7d9029>getId</span><span style=color:#666>();</span>
    String key <span style=color:#666>=</span> BLOG_LIKED_KEY <span style=color:#666>+</span> id<span style=color:#666>;</span>
    Boolean isLiked <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForSet</span><span style=color:#666>().</span><span style=color:#7d9029>isMember</span><span style=color:#666>(</span>key<span style=color:#666>,</span> userId<span style=color:#666>.</span><span style=color:#7d9029>toString</span><span style=color:#666>());</span>
  	
    <span style=color:#408080;font-style:italic>// 2. 未点过赞：点赞，数据库点赞数 +1，将用户保存到 Redis 的 Set 集合中。
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>BooleanUtil<span style=color:#666>.</span><span style=color:#7d9029>isFalse</span><span style=color:#666>(</span>isLiked<span style=color:#666>))</span> <span style=color:#666>{</span>
        Boolean isSucceed <span style=color:#666>=</span> update<span style=color:#666>().</span><span style=color:#7d9029>setSql</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;liked = liked + 1&#34;</span><span style=color:#666>).</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;id&#34;</span><span style=color:#666>,</span> id<span style=color:#666>).</span><span style=color:#7d9029>update</span><span style=color:#666>();</span>
        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>BooleanUtil<span style=color:#666>.</span><span style=color:#7d9029>isTrue</span><span style=color:#666>(</span>isSucceed<span style=color:#666>))</span> <span style=color:#666>{</span>
            stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForSet</span><span style=color:#666>().</span><span style=color:#7d9029>add</span><span style=color:#666>(</span>key<span style=color:#666>,</span> userId<span style=color:#666>.</span><span style=color:#7d9029>toString</span><span style=color:#666>());</span>
        <span style=color:#666>}</span>
    <span style=color:#666>}</span> <span style=color:green;font-weight:700>else</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 3. 已点过赞：取消赞，数据库点赞数 -1，将用户从 Redis 的 Set 集合中移除。
</span><span style=color:#408080;font-style:italic></span>        Boolean isSucceed <span style=color:#666>=</span> update<span style=color:#666>().</span><span style=color:#7d9029>setSql</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;liked = liked - 1&#34;</span><span style=color:#666>).</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;id&#34;</span><span style=color:#666>,</span> id<span style=color:#666>).</span><span style=color:#7d9029>update</span><span style=color:#666>();</span>
        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>BooleanUtil<span style=color:#666>.</span><span style=color:#7d9029>isTrue</span><span style=color:#666>(</span>isSucceed<span style=color:#666>))</span> <span style=color:#666>{</span>
            stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForSet</span><span style=color:#666>().</span><span style=color:#7d9029>remove</span><span style=color:#666>(</span>key<span style=color:#666>,</span> userId<span style=color:#666>.</span><span style=color:#7d9029>toString</span><span style=color:#666>());</span>
        <span style=color:#666>}</span>
    <span style=color:#666>}</span>
    <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>();</span>
<span style=color:#666>}</span>

</code></pre></div><h3 id=83-点赞排行榜>8.3 点赞排行榜<a href=#83-点赞排行榜 class=header-anchor arialabel=Anchor> #</a></h3><blockquote><p>在笔记的详情页面，应该显示给该笔记点赞的人，比如：显示最早给该笔记点赞的用户的 TOP 5。</p><p>之前的点赞放在 Set 集合中，但是 Set 集合是无序不可重复的，此处需要使用可排序的 Set 集合，即 SortedSet。</p></blockquote><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span>#</span>自写
    用zadd z1 m1 z2 m2 z3 m3
    zscore z1 返回1
    zrange 0 3 返回m1 m2 m3
</code></pre></div><table><thead><tr><th></th><th>List</th><th>Set</th><th>SortedSet</th></tr></thead><tbody><tr><td><strong>排序方式</strong></td><td>按照顺序排序</td><td>无法排序</td><td>根据 score 值排序</td></tr><tr><td><strong>唯一性</strong></td><td>不唯一</td><td>唯一</td><td>唯一</td></tr><tr><td><strong>查找方式</strong></td><td>按照索引查找 或 首尾查找</td><td>根据元素查找</td><td>根据元素查找</td></tr></tbody></table><blockquote><p><strong>修改点赞业务逻辑</strong></p></blockquote><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:green;font-weight:700>private</span> <span style=color:#b00040>void</span> <span style=color:#00f>isBlogLiked</span><span style=color:#666>(</span>Blog blog<span style=color:#666>)</span> <span style=color:#666>{</span>
    String key <span style=color:#666>=</span> BLOG_LIKED_KEY <span style=color:#666>+</span> blog<span style=color:#666>.</span><span style=color:#7d9029>getId</span><span style=color:#666>();</span>
  	UserDTO user <span style=color:#666>=</span> UserHolder<span style=color:#666>.</span><span style=color:#7d9029>getUser</span><span style=color:#666>();</span>
    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>user <span style=color:#666>==</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 用户未登录，无需查询是否点过赞
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>return</span><span style=color:#666>;</span>
    <span style=color:#666>}</span>
    Long userId <span style=color:#666>=</span> user<span style=color:#666>.</span><span style=color:#7d9029>getId</span><span style=color:#666>();</span>
    Double score <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForZSet</span><span style=color:#666>().</span><span style=color:#7d9029>score</span><span style=color:#666>(</span>key<span style=color:#666>,</span> userId<span style=color:#666>.</span><span style=color:#7d9029>toString</span><span style=color:#666>());</span>
    blog<span style=color:#666>.</span><span style=color:#7d9029>setIsLike</span><span style=color:#666>(</span>score <span style=color:#666>!=</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>);</span>
<span style=color:#666>}</span>

<span style=color:#a2f>@Override</span>
<span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>likeBlog</span><span style=color:#666>(</span>Long id<span style=color:#666>)</span> <span style=color:#666>{</span>
    <span style=color:#408080;font-style:italic>// 1. 判断当前登录用户是否点过赞。
</span><span style=color:#408080;font-style:italic></span>    Long userId <span style=color:#666>=</span> UserHolder<span style=color:#666>.</span><span style=color:#7d9029>getUser</span><span style=color:#666>().</span><span style=color:#7d9029>getId</span><span style=color:#666>();</span>
    String key <span style=color:#666>=</span> BLOG_LIKED_KEY <span style=color:#666>+</span> id<span style=color:#666>;</span>
  	
    <span style=color:#408080;font-style:italic>// `ZSCORE key member` ：获取 SortedSet 中指定元素的 score 值（如果不存在，则代表未点过赞）。
</span><span style=color:#408080;font-style:italic></span>    Double score <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForZSet</span><span style=color:#666>().</span><span style=color:#7d9029>score</span><span style=color:#666>(</span>key<span style=color:#666>,</span> userId<span style=color:#666>.</span><span style=color:#7d9029>toString</span><span style=color:#666>());</span>
    
  	<span style=color:#408080;font-style:italic>// 2. 未点过赞：点赞，数据库点赞数 +1，将用户保存到 Redis 的 Set 集合中。
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>score <span style=color:#666>==</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
        Boolean isSucceed <span style=color:#666>=</span> update<span style=color:#666>().</span><span style=color:#7d9029>setSql</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;liked = liked + 1&#34;</span><span style=color:#666>).</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;id&#34;</span><span style=color:#666>,</span> id<span style=color:#666>).</span><span style=color:#7d9029>update</span><span style=color:#666>();</span>
        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>BooleanUtil<span style=color:#666>.</span><span style=color:#7d9029>isTrue</span><span style=color:#666>(</span>isSucceed<span style=color:#666>))</span> <span style=color:#666>{</span>
            stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForZSet</span><span style=color:#666>().</span><span style=color:#7d9029>add</span><span style=color:#666>(</span>key<span style=color:#666>,</span> userId<span style=color:#666>.</span><span style=color:#7d9029>toString</span><span style=color:#666>(),</span> System<span style=color:#666>.</span><span style=color:#7d9029>currentTimeMillis</span><span style=color:#666>());</span>
        <span style=color:#666>}</span>
    <span style=color:#666>}</span> <span style=color:green;font-weight:700>else</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 3. 已点过赞：取消赞，数据库点赞数 -1，将用户从 Redis 的 Set 集合中移除。
</span><span style=color:#408080;font-style:italic></span>        Boolean isSucceed <span style=color:#666>=</span> update<span style=color:#666>().</span><span style=color:#7d9029>setSql</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;liked = liked - 1&#34;</span><span style=color:#666>).</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;id&#34;</span><span style=color:#666>,</span> id<span style=color:#666>).</span><span style=color:#7d9029>update</span><span style=color:#666>();</span>
        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>BooleanUtil<span style=color:#666>.</span><span style=color:#7d9029>isTrue</span><span style=color:#666>(</span>isSucceed<span style=color:#666>))</span> <span style=color:#666>{</span>
            stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForZSet</span><span style=color:#666>().</span><span style=color:#7d9029>remove</span><span style=color:#666>(</span>key<span style=color:#666>,</span> userId<span style=color:#666>.</span><span style=color:#7d9029>toString</span><span style=color:#666>());</span>
        <span style=color:#666>}</span>
    <span style=color:#666>}</span>
    <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>();</span>
<span style=color:#666>}</span>

</code></pre></div><blockquote><p><strong>接口详情</strong></p></blockquote><table><thead><tr><th>请求方式</th><th>请求路径</th><th>请求参数</th><th>返回值</th></tr></thead><tbody><tr><td>GET</td><td><code>/blog/likes/{id}</code></td><td>id（<code>@PathVariable</code>）</td><td><code>List&lt;UserDeto></code>（给该笔记点赞的 TopN 用户的集合）</td></tr></tbody></table><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@GetMapping</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;/likes/{id}&#34;</span><span style=color:#666>)</span>
<span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>queryBlogLikes</span><span style=color:#666>(</span><span style=color:#a2f>@PathVariable</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;id&#34;</span><span style=color:#666>)</span> Long id<span style=color:#666>)</span> <span style=color:#666>{</span>
    <span style=color:green;font-weight:700>return</span> blogService<span style=color:#666>.</span><span style=color:#7d9029>queryBlogLikes</span><span style=color:#666>(</span>id<span style=color:#666>);</span>
<span style=color:#666>}</span>
1234
</code></pre></div><p><strong>注意：</strong></p><ul><li><code>select id from tb_user where id in (5, 2, 1)</code> 的查询结果顺序为：1、2、5；</li><li><code>select id from tb_user where id in (5, 2, 1) ORDER BY FIELD(id, 5, 2, 1);</code> 的查询结果顺序为：5、2、1，指定根据何种字段排序以及字段值。</li></ul><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#408080;font-style:italic>/**
</span><span style=color:#408080;font-style:italic> * Blog 详情页展示最早点赞的 5 个用户
</span><span style=color:#408080;font-style:italic> */</span>
<span style=color:#a2f>@Override</span>
<span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>queryBlogLikes</span><span style=color:#666>(</span>Long id<span style=color:#666>)</span> <span style=color:#666>{</span>
    String key <span style=color:#666>=</span> BLOG_LIKED_KEY <span style=color:#666>+</span> id<span style=color:#666>;</span>
    <span style=color:#408080;font-style:italic>// 1. 查询最早五个点赞的用户
</span><span style=color:#408080;font-style:italic></span>    Set<span style=color:#666>&lt;</span>String<span style=color:#666>&gt;</span> topFive <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForZSet</span><span style=color:#666>().</span><span style=color:#7d9029>range</span><span style=color:#666>(</span>key<span style=color:#666>,</span> 0<span style=color:#666>,</span> 4<span style=color:#666>);</span>
    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>topFive <span style=color:#666>==</span> <span style=color:green;font-weight:700>null</span> <span style=color:#666>||</span> topFive<span style=color:#666>.</span><span style=color:#7d9029>isEmpty</span><span style=color:#666>())</span> <span style=color:#666>{</span>
        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>Collections<span style=color:#666>.</span><span style=color:#7d9029>emptyList</span><span style=color:#666>());</span>
    <span style=color:#666>}</span>
    
  	<span style=color:#408080;font-style:italic>// 2. 解析出其中的 用户ID
</span><span style=color:#408080;font-style:italic></span>    List<span style=color:#666>&lt;</span>Long<span style=color:#666>&gt;</span> userIdList <span style=color:#666>=</span> topFive<span style=color:#666>.</span><span style=color:#7d9029>stream</span><span style=color:#666>()</span>
            <span style=color:#666>.</span><span style=color:#7d9029>map</span><span style=color:#666>(</span>Long<span style=color:#666>::</span>valueOf<span style=color:#666>)</span>
            <span style=color:#666>.</span><span style=color:#7d9029>collect</span><span style=color:#666>(</span>Collectors<span style=color:#666>.</span><span style=color:#7d9029>toList</span><span style=color:#666>());</span>
    String userIdStrWithComma <span style=color:#666>=</span> StrUtil<span style=color:#666>.</span><span style=color:#7d9029>join</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;, &#34;</span><span style=color:#666>,</span> userIdList<span style=color:#666>);</span>
    
  	<span style=color:#408080;font-style:italic>// 3. 根据 ID 批量查询
</span><span style=color:#408080;font-style:italic></span>    List<span style=color:#666>&lt;</span>UserDTO<span style=color:#666>&gt;</span> userDTOList <span style=color:#666>=</span> userService<span style=color:#666>.</span><span style=color:#7d9029>query</span><span style=color:#666>()</span>
            <span style=color:#666>.</span><span style=color:#7d9029>in</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;id&#34;</span><span style=color:#666>,</span> userIdList<span style=color:#666>)</span>
            <span style=color:#666>.</span><span style=color:#7d9029>last</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;ORDER BY FIELD(id, &#34;</span> <span style=color:#666>+</span> userIdStrWithComma <span style=color:#666>+</span> <span style=color:#ba2121>&#34;)&#34;</span><span style=color:#666>)</span>
            <span style=color:#666>.</span><span style=color:#7d9029>list</span><span style=color:#666>()</span>
            <span style=color:#666>.</span><span style=color:#7d9029>stream</span><span style=color:#666>()</span>
            <span style=color:#666>.</span><span style=color:#7d9029>map</span><span style=color:#666>(</span>user <span style=color:#666>-&gt;</span> BeanUtil<span style=color:#666>.</span><span style=color:#7d9029>copyProperties</span><span style=color:#666>(</span>user<span style=color:#666>,</span> UserDTO<span style=color:#666>.</span><span style=color:#7d9029>class</span><span style=color:#666>))</span>
            <span style=color:#666>.</span><span style=color:#7d9029>collect</span><span style=color:#666>(</span>Collectors<span style=color:#666>.</span><span style=color:#7d9029>toList</span><span style=color:#666>());</span>
    <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>userDTOList<span style=color:#666>);</span>
<span style=color:#666>}</span>
</code></pre></div><h3 id=总结点赞相关>总结点赞相关<a href=#总结点赞相关 class=header-anchor arialabel=Anchor> #</a></h3><blockquote><p>用的SortedSET，有score便于排序</p></blockquote><h2 id=9-关注相关>9. 关注相关<a href=#9-关注相关 class=header-anchor arialabel=Anchor> #</a></h2><h3 id=91-关注-和-取关>9.1 关注 和 取关<a href=#91-关注-和-取关 class=header-anchor arialabel=Anchor> #</a></h3><blockquote><p><strong>关注是 User 表之间的关系，通过 <code>tb_follow</code> 表进行标识；关注的实现需要通过两个接口实现：关注与取关、判断是否关注。</strong></p></blockquote><p>关注与取关：<code>http://localhost:8080/api/follow/{id}/{boolean}</code></p><p>判断是否关注：<code>http://localhost:8080/api/follow/or/not/{id}</code></p><p><code>tb_follow</code> 表：</p><table><thead><tr><th><code>id</code></th><th><code>user_id</code></th><th><code>follow_user_id</code></th></tr></thead><tbody><tr><td>主键ID</td><td>用户ID</td><td>关联的用户ID</td></tr></tbody></table><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@RestController</span>
<span style=color:#a2f>@RequestMapping</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;/follow&#34;</span><span style=color:#666>)</span>
<span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>FollowController</span> <span style=color:#666>{</span>

    <span style=color:#a2f>@Resource</span>
    <span style=color:green;font-weight:700>private</span> FollowService followService<span style=color:#666>;</span>

    <span style=color:#408080;font-style:italic>/**
</span><span style=color:#408080;font-style:italic>     * 关注或取关
</span><span style=color:#408080;font-style:italic>     * @param followUserId 需要关注 or 取关的 用户ID
</span><span style=color:#408080;font-style:italic>     * @param isFollowed 是否关注
</span><span style=color:#408080;font-style:italic>     */</span>
    <span style=color:#a2f>@PutMapping</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;/{id}/{isFollowed}&#34;</span><span style=color:#666>)</span>
    <span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>followOrNot</span><span style=color:#666>(</span><span style=color:#a2f>@PathVariable</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;id&#34;</span><span style=color:#666>)</span> Long followUserId<span style=color:#666>,</span> <span style=color:#a2f>@PathVariable</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;isFollowed&#34;</span><span style=color:#666>)</span> Boolean isFollowed<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:green;font-weight:700>return</span> followService<span style=color:#666>.</span><span style=color:#7d9029>followOrNot</span><span style=color:#666>(</span>followUserId<span style=color:#666>,</span> isFollowed<span style=color:#666>);</span>
    <span style=color:#666>}</span>

    <span style=color:#408080;font-style:italic>/**
</span><span style=color:#408080;font-style:italic>     * 判断是否关注该用户
</span><span style=color:#408080;font-style:italic>     * @param followUserId 关注用户的ID
</span><span style=color:#408080;font-style:italic>     */</span>
    <span style=color:#a2f>@GetMapping</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;/or/not/{id}&#34;</span><span style=color:#666>)</span>
    <span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>isFollowed</span><span style=color:#666>(</span><span style=color:#a2f>@PathVariable</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;id&#34;</span><span style=color:#666>)</span> Long followUserId<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:green;font-weight:700>return</span> followService<span style=color:#666>.</span><span style=color:#7d9029>isFollowed</span><span style=color:#666>(</span>followUserId<span style=color:#666>);</span>
    <span style=color:#666>}</span>
<span style=color:#666>}</span>
<span style=color:#a2f>@Override</span>
<span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>followOrNot</span><span style=color:#666>(</span>Long followUserId<span style=color:#666>,</span> Boolean isFollowed<span style=color:#666>)</span> <span style=color:#666>{</span>
    Long userId <span style=color:#666>=</span> UserHolder<span style=color:#666>.</span><span style=color:#7d9029>getUser</span><span style=color:#666>().</span><span style=color:#7d9029>getId</span><span style=color:#666>();</span>
    <span style=color:#408080;font-style:italic>// 判断是关注还是取关
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>BooleanUtil<span style=color:#666>.</span><span style=color:#7d9029>isTrue</span><span style=color:#666>(</span>isFollowed<span style=color:#666>))</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 关注，增加
</span><span style=color:#408080;font-style:italic></span>        Follow follow <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> Follow<span style=color:#666>();</span>
        follow<span style=color:#666>.</span><span style=color:#7d9029>setUserId</span><span style=color:#666>(</span>userId<span style=color:#666>);</span>
        follow<span style=color:#666>.</span><span style=color:#7d9029>setFollowUserId</span><span style=color:#666>(</span>followUserId<span style=color:#666>);</span>
        save<span style=color:#666>(</span>follow<span style=color:#666>);</span>
    <span style=color:#666>}</span> <span style=color:green;font-weight:700>else</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 取关，删除
</span><span style=color:#408080;font-style:italic></span>        remove<span style=color:#666>(</span><span style=color:green;font-weight:700>new</span> LambdaQueryWrapper<span style=color:#666>&lt;</span>Follow<span style=color:#666>&gt;().</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span>Follow<span style=color:#666>::</span>getUserId<span style=color:#666>,</span> userId<span style=color:#666>).</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span>
<span style=color:#a0a000>Follow:</span><span style=color:#666>:</span>getFollowUserId<span style=color:#666>,</span> followUserId<span style=color:#666>));</span>
    <span style=color:#666>}</span>
    <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>();</span>
<span style=color:#666>}</span>

<span style=color:#a2f>@Override</span>
<span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>isFollowed</span><span style=color:#666>(</span>Long followUserId<span style=color:#666>)</span> <span style=color:#666>{</span>
    Long userId <span style=color:#666>=</span> UserHolder<span style=color:#666>.</span><span style=color:#7d9029>getUser</span><span style=color:#666>().</span><span style=color:#7d9029>getId</span><span style=color:#666>();</span>
    Integer count <span style=color:#666>=</span> lambdaQuery<span style=color:#666>().</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span>Follow<span style=color:#666>::</span>getUserId<span style=color:#666>,</span> userId<span style=color:#666>).</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span>Follow<span style=color:#666>::</span>getFollowUserId<span style=color:#666>,</span> followUserId<span style=color:#666>).</span><span style=color:#7d9029>count</span><span style=color:#666>();</span>
    <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>count <span style=color:#666>&gt;</span> 0<span style=color:#666>);</span>
<span style=color:#666>}</span>
</code></pre></div><h3 id=92-共同关注>9.2 共同关注<a href=#92-共同关注 class=header-anchor arialabel=Anchor> #</a></h3><blockquote><p>关注时，将当前用户所关注的用户ID存入到 Redis 中：以当前用户的 ID 为 Key，关注用户的 ID 为 value。</p><p>取关时，将其从 Redis 中删除。</p></blockquote><p>注意：为了实现共同关注功能，使用 Set，因为 Set 中有 <code>SINTER - 交集</code>、<code>SDIFFER - 差集</code>、<code>SUNION - 并集</code> 命令。</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@Override</span>
<span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>followOrNot</span><span style=color:#666>(</span>Long followUserId<span style=color:#666>,</span> Boolean isFollowed<span style=color:#666>)</span> <span style=color:#666>{</span>
    Long userId <span style=color:#666>=</span> UserHolder<span style=color:#666>.</span><span style=color:#7d9029>getUser</span><span style=color:#666>().</span><span style=color:#7d9029>getId</span><span style=color:#666>();</span>
    String key <span style=color:#666>=</span> <span style=color:#ba2121>&#34;follow:&#34;</span> <span style=color:#666>+</span> userId<span style=color:#666>;</span>
    <span style=color:#408080;font-style:italic>// 判断是关注还是取关
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>BooleanUtil<span style=color:#666>.</span><span style=color:#7d9029>isTrue</span><span style=color:#666>(</span>isFollowed<span style=color:#666>))</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 关注，增加
</span><span style=color:#408080;font-style:italic></span>        Follow follow <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> Follow<span style=color:#666>();</span>
        follow<span style=color:#666>.</span><span style=color:#7d9029>setUserId</span><span style=color:#666>(</span>userId<span style=color:#666>);</span>
        follow<span style=color:#666>.</span><span style=color:#7d9029>setFollowUserId</span><span style=color:#666>(</span>followUserId<span style=color:#666>);</span>
        <span style=color:#b00040>boolean</span> isSucceed <span style=color:#666>=</span> save<span style=color:#666>(</span>follow<span style=color:#666>);</span>
      	<span style=color:#408080;font-style:italic>// 添加到 Redis 中（当前用户ID 为 key，关注用户ID 为 value）
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>Boolean<span style=color:#666>.</span><span style=color:#7d9029>TRUE</span><span style=color:#666>.</span><span style=color:#7d9029>equals</span><span style=color:#666>(</span>isSucceed<span style=color:#666>))</span> <span style=color:#666>{</span>
            stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForSet</span><span style=color:#666>().</span><span style=color:#7d9029>add</span><span style=color:#666>(</span>key<span style=color:#666>,</span> followUserId<span style=color:#666>.</span><span style=color:#7d9029>toString</span><span style=color:#666>());</span>
        <span style=color:#666>}</span>
    <span style=color:#666>}</span> <span style=color:green;font-weight:700>else</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 取关，删除
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#b00040>boolean</span> isSucceed <span style=color:#666>=</span> remove<span style=color:#666>(</span><span style=color:green;font-weight:700>new</span> LambdaQueryWrapper<span style=color:#666>&lt;</span>Follow<span style=color:#666>&gt;().</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span>Follow<span style=color:#666>::</span>getUserId<span style=color:#666>,</span> 
userId<span style=color:#666>).</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span>Follow<span style=color:#666>::</span>getFollowUserId<span style=color:#666>,</span> followUserId<span style=color:#666>));</span>
        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>BooleanUtil<span style=color:#666>.</span><span style=color:#7d9029>isTrue</span><span style=color:#666>(</span>isSucceed<span style=color:#666>))</span> <span style=color:#666>{</span>
          	<span style=color:#408080;font-style:italic>// 从 Redis 中删除
</span><span style=color:#408080;font-style:italic></span>            stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForSet</span><span style=color:#666>().</span><span style=color:#7d9029>remove</span><span style=color:#666>(</span>key<span style=color:#666>,</span> followUserId<span style=color:#666>.</span><span style=color:#7d9029>toString</span><span style=color:#666>());</span>
        <span style=color:#666>}</span>
    <span style=color:#666>}</span>
    <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>();</span>
<span style=color:#666>}</span>

<span style=color:#a2f>@Override</span>
<span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>isFollowed</span><span style=color:#666>(</span>Long followUserId<span style=color:#666>)</span> <span style=color:#666>{</span>
    Long userId <span style=color:#666>=</span> UserHolder<span style=color:#666>.</span><span style=color:#7d9029>getUser</span><span style=color:#666>().</span><span style=color:#7d9029>getId</span><span style=color:#666>();</span>
    Integer count <span style=color:#666>=</span> lambdaQuery<span style=color:#666>().</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span>Follow<span style=color:#666>::</span>getUserId<span style=color:#666>,</span> userId<span style=color:#666>).</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span>Follow<span style=color:#666>::</span>getFollowUserId<span style=color:#666>,</span> followUserId<span style=color:#666>).</span><span style=color:#7d9029>count</span><span style=color:#666>();</span>
    <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>count <span style=color:#666>&gt;</span> 0<span style=color:#666>);</span>
<span style=color:#666>}</span>

</code></pre></div><blockquote><p>使用 <code>SINTER key [key ...]</code> 求出两个用户间的共同关注。</p></blockquote><table><thead><tr><th>请求方式</th><th>请求路径</th><th>请求参数</th><th>返回值</th></tr></thead><tbody><tr><td>GET</td><td><code>/follow/common/{id}</code></td><td>id（目标用户ID，<code>@PathVariable</code>）</td><td><code>List&lt;UserDTO></code> 两个用户的共同关注</td></tr></tbody></table><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#408080;font-style:italic>/**
</span><span style=color:#408080;font-style:italic> * 获取两个用户之间的共同关注用户
</span><span style=color:#408080;font-style:italic> * @param followUserId 关注用户的ID
</span><span style=color:#408080;font-style:italic> */</span>
<span style=color:#a2f>@GetMapping</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;/common/{id}&#34;</span><span style=color:#666>)</span>
<span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>commonFollow</span><span style=color:#666>(</span><span style=color:#a2f>@PathVariable</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;id&#34;</span><span style=color:#666>)</span> Long followUserId<span style=color:#666>)</span> <span style=color:#666>{</span>
    <span style=color:green;font-weight:700>return</span> followService<span style=color:#666>.</span><span style=color:#7d9029>commonFollow</span><span style=color:#666>(</span>followUserId<span style=color:#666>);</span>
<span style=color:#666>}</span>

<span style=color:#a2f>@Override</span>
<span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>commonFollow</span><span style=color:#666>(</span>Long followUserId<span style=color:#666>)</span> <span style=color:#666>{</span>
    Long userId <span style=color:#666>=</span> UserHolder<span style=color:#666>.</span><span style=color:#7d9029>getUser</span><span style=color:#666>().</span><span style=color:#7d9029>getId</span><span style=color:#666>();</span>
    String selfKey <span style=color:#666>=</span> <span style=color:#ba2121>&#34;follow:&#34;</span> <span style=color:#666>+</span> userId<span style=color:#666>;</span>
    String aimKey <span style=color:#666>=</span> <span style=color:#ba2121>&#34;follow:&#34;</span> <span style=color:#666>+</span> followUserId<span style=color:#666>;</span>
    Set<span style=color:#666>&lt;</span>String<span style=color:#666>&gt;</span> userIdSet <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForSet</span><span style=color:#666>().</span><span style=color:#7d9029>intersect</span><span style=color:#666>(</span>selfKey<span style=color:#666>,</span> aimKey<span style=color:#666>);</span>
    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>userIdSet<span style=color:#666>.</span><span style=color:#7d9029>isEmpty</span><span style=color:#666>()</span> <span style=color:#666>||</span> userIdSet <span style=color:#666>==</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 无交集
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>Collections<span style=color:#666>.</span><span style=color:#7d9029>emptyList</span><span style=color:#666>());</span>
    <span style=color:#666>}</span>
    List<span style=color:#666>&lt;</span>UserDTO<span style=color:#666>&gt;</span> userDTOList <span style=color:#666>=</span> userService<span style=color:#666>.</span><span style=color:#7d9029>listByIds</span><span style=color:#666>(</span>userIdSet<span style=color:#666>)</span>
            <span style=color:#666>.</span><span style=color:#7d9029>stream</span><span style=color:#666>()</span>
            <span style=color:#666>.</span><span style=color:#7d9029>map</span><span style=color:#666>(</span>user <span style=color:#666>-&gt;</span> BeanUtil<span style=color:#666>.</span><span style=color:#7d9029>copyProperties</span><span style=color:#666>(</span>user<span style=color:#666>,</span> UserDTO<span style=color:#666>.</span><span style=color:#7d9029>class</span><span style=color:#666>))</span>
            <span style=color:#666>.</span><span style=color:#7d9029>collect</span><span style=color:#666>(</span>Collectors<span style=color:#666>.</span><span style=color:#7d9029>toList</span><span style=color:#666>());</span>
    <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>userDTOList<span style=color:#666>);</span>
<span style=color:#666>}</span>

</code></pre></div><h3 id=总结用关注setkey用户value关注用户名>总结用关注set(key用户，value关注用户名)<a href=#总结用关注setkey用户value关注用户名 class=header-anchor arialabel=Anchor> #</a></h3><blockquote><p>互相关注的时候用stringRedisTemplate.opsForSet().intersect(selfKey, aimKey);</p><p>注意：为了实现共同关注功能，使用 Set，因为 Set 中有 <code>SINTER - 交集</code>、<code>SDIFFER - 差集</code>、<code>SUNION - 并集</code> 命令。</p></blockquote><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@Override</span>
<span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>follow</span><span style=color:#666>(</span>Long followUserId<span style=color:#666>,</span> Boolean isFollow<span style=color:#666>)</span> <span style=color:#666>{</span>
    <span style=color:#408080;font-style:italic>// 1.获取登录用户
</span><span style=color:#408080;font-style:italic></span>    Long userId <span style=color:#666>=</span> UserHolder<span style=color:#666>.</span><span style=color:#7d9029>getUser</span><span style=color:#666>().</span><span style=color:#7d9029>getId</span><span style=color:#666>();</span>
    String key <span style=color:#666>=</span> <span style=color:#ba2121>&#34;follows:&#34;</span> <span style=color:#666>+</span> userId<span style=color:#666>;</span>
    <span style=color:#408080;font-style:italic>// 1.判断到底是关注还是取关
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>isFollow<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 2.关注，新增数据
</span><span style=color:#408080;font-style:italic></span>        Follow follow <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> Follow<span style=color:#666>();</span>
        follow<span style=color:#666>.</span><span style=color:#7d9029>setUserId</span><span style=color:#666>(</span>userId<span style=color:#666>);</span>
        follow<span style=color:#666>.</span><span style=color:#7d9029>setFollowUserId</span><span style=color:#666>(</span>followUserId<span style=color:#666>);</span>
        <span style=color:#b00040>boolean</span> isSuccess <span style=color:#666>=</span> save<span style=color:#666>(</span>follow<span style=color:#666>);</span>
        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>isSuccess<span style=color:#666>)</span> <span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>// 把关注用户的id，放入redis的set集合 sadd userId followerUserId
</span><span style=color:#408080;font-style:italic></span>            stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForSet</span><span style=color:#666>().</span><span style=color:#7d9029>add</span><span style=color:#666>(</span>key<span style=color:#666>,</span> followUserId<span style=color:#666>.</span><span style=color:#7d9029>toString</span><span style=color:#666>());</span>
        <span style=color:#666>}</span>
    <span style=color:#666>}</span> <span style=color:green;font-weight:700>else</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 3.取关，删除 delete from tb_follow where user_id = ? and follow_user_id = ?
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#b00040>boolean</span> isSuccess <span style=color:#666>=</span> remove<span style=color:#666>(</span><span style=color:green;font-weight:700>new</span> QueryWrapper<span style=color:#666>&lt;</span>Follow<span style=color:#666>&gt;()</span>
                <span style=color:#666>.</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;user_id&#34;</span><span style=color:#666>,</span> userId<span style=color:#666>).</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;follow_user_id&#34;</span><span style=color:#666>,</span> followUserId<span style=color:#666>));</span>
        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>isSuccess<span style=color:#666>)</span> <span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>// 把关注用户的id从Redis集合中移除
</span><span style=color:#408080;font-style:italic></span>            stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForSet</span><span style=color:#666>().</span><span style=color:#7d9029>remove</span><span style=color:#666>(</span>key<span style=color:#666>,</span> followUserId<span style=color:#666>.</span><span style=color:#7d9029>toString</span><span style=color:#666>());</span>
        <span style=color:#666>}</span>
    <span style=color:#666>}</span>
    <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>();</span>
<span style=color:#666>}</span>
</code></pre></div><p><strong>具体的关注代码：</strong></p><p>FollowServiceImpl</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@Override</span>
<span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>followCommons</span><span style=color:#666>(</span>Long id<span style=color:#666>)</span> <span style=color:#666>{</span>
    <span style=color:#408080;font-style:italic>// 1.获取当前用户
</span><span style=color:#408080;font-style:italic></span>    Long userId <span style=color:#666>=</span> UserHolder<span style=color:#666>.</span><span style=color:#7d9029>getUser</span><span style=color:#666>().</span><span style=color:#7d9029>getId</span><span style=color:#666>();</span>
    String key <span style=color:#666>=</span> <span style=color:#ba2121>&#34;follows:&#34;</span> <span style=color:#666>+</span> userId<span style=color:#666>;</span>
    <span style=color:#408080;font-style:italic>// 2.求交集
</span><span style=color:#408080;font-style:italic></span>    String key2 <span style=color:#666>=</span> <span style=color:#ba2121>&#34;follows:&#34;</span> <span style=color:#666>+</span> id<span style=color:#666>;</span>
    Set<span style=color:#666>&lt;</span>String<span style=color:#666>&gt;</span> intersect <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForSet</span><span style=color:#666>().</span><span style=color:#7d9029>intersect</span><span style=color:#666>(</span>key<span style=color:#666>,</span> key2<span style=color:#666>);</span>
    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>intersect <span style=color:#666>==</span> <span style=color:green;font-weight:700>null</span> <span style=color:#666>||</span> intersect<span style=color:#666>.</span><span style=color:#7d9029>isEmpty</span><span style=color:#666>())</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 无交集
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>Collections<span style=color:#666>.</span><span style=color:#7d9029>emptyList</span><span style=color:#666>());</span>
    <span style=color:#666>}</span>
    <span style=color:#408080;font-style:italic>// 3.解析id集合
</span><span style=color:#408080;font-style:italic></span>    List<span style=color:#666>&lt;</span>Long<span style=color:#666>&gt;</span> ids <span style=color:#666>=</span> intersect<span style=color:#666>.</span><span style=color:#7d9029>stream</span><span style=color:#666>().</span><span style=color:#7d9029>map</span><span style=color:#666>(</span>Long<span style=color:#666>::</span>valueOf<span style=color:#666>).</span><span style=color:#7d9029>collect</span><span style=color:#666>(</span>Collectors<span style=color:#666>.</span><span style=color:#7d9029>toList</span><span style=color:#666>());</span>
    <span style=color:#408080;font-style:italic>// 4.查询用户
</span><span style=color:#408080;font-style:italic></span>    List<span style=color:#666>&lt;</span>UserDTO<span style=color:#666>&gt;</span> users <span style=color:#666>=</span> userService<span style=color:#666>.</span><span style=color:#7d9029>listByIds</span><span style=color:#666>(</span>ids<span style=color:#666>)</span>
            <span style=color:#666>.</span><span style=color:#7d9029>stream</span><span style=color:#666>()</span>
            <span style=color:#666>.</span><span style=color:#7d9029>map</span><span style=color:#666>(</span>user <span style=color:#666>-&gt;</span> BeanUtil<span style=color:#666>.</span><span style=color:#7d9029>copyProperties</span><span style=color:#666>(</span>user<span style=color:#666>,</span> UserDTO<span style=color:#666>.</span><span style=color:#7d9029>class</span><span style=color:#666>))</span>
            <span style=color:#666>.</span><span style=color:#7d9029>collect</span><span style=color:#666>(</span>Collectors<span style=color:#666>.</span><span style=color:#7d9029>toList</span><span style=color:#666>());</span>
    <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>users<span style=color:#666>);</span>
<span style=color:#666>}</span>
</code></pre></div><h3 id=93-关注推送---feed-流>9.3 关注推送 - Feed 流<a href=#93-关注推送---feed-流 class=header-anchor arialabel=Anchor> #</a></h3><p>关注推送也叫做 <strong>Feed 流（投喂）</strong>，通过无线下拉刷新获取新的信息。</p><ul><li><strong>传统模式</strong>：需要用户通过搜索引擎或其他方式检索自己需要的内容；</li><li><strong>Feed 模式</strong>：通过系统分析用户想要什么，直接将内容推送给用户，从而使用户能更加节约时间，不需要再主动寻找。</li></ul><p><img src=https://itsawaysu.oss-cn-shanghai.aliyuncs.com/note/%E4%BC%A0%E7%BB%9F%E6%A8%A1%E5%BC%8F%20VS%20Feed%E6%A8%A1%E5%BC%8F.jpg alt="传统模式 VS Feed模式"></p><h3 id=931-feed-流的实现方案>9.3.1 Feed 流的实现方案<a href=#931-feed-流的实现方案 class=header-anchor arialabel=Anchor> #</a></h3><blockquote><p>Feed流的实现有两种模式：</p></blockquote><blockquote><p>Feed流产品有两种常见模式：
Timeline：不做内容筛选，简单的按照内容发布时间排序，常用于好友或关注。例如朋友圈</p></blockquote><ul><li>优点：信息全面，不会有缺失。并且实现也相对简单</li><li>缺点：信息噪音较多，用户不一定感兴趣，内容获取效率低</li></ul><blockquote><p>智能排序：利用智能算法屏蔽掉违规的、用户不感兴趣的内容。推送用户感兴趣信息来吸引用户</p></blockquote><ul><li>优点：投喂用户感兴趣信息，用户粘度很高，容易沉迷</li><li>缺点：如果算法不精准，可能起到反作用
本例中的个人页面，是基于关注的好友来做Feed流，因此采用Timeline的模式。该模式的实现方案有三种：</li></ul><p>我们本次针对好友的操作，采用的就是Timeline的方式，只需要拿到我们关注用户的信息，然后按照时间排序即可</p><p>本例中的个人页面，是基于关注的好友来做 Feed 流，因此采用 Timeline 的模式。</p><ul><li><p>该模式的实现方案有三种：拉模式、推模式、推拉结合</p></li><li><p><strong>拉模式</strong>：也叫做读扩散</p></li></ul><p><img src=https://img-blog.csdnimg.cn/82aeae67d1004bf4bbf008779f31ead5.png#pic_center alt=在这里插入图片描述></p><ul><li>推模式：也叫做写扩散。</li></ul><p><img src=https://img-blog.csdnimg.cn/e2652ff1c7ae4769a9016f1b07f3c5d3.png#pic_center alt=在这里插入图片描述></p><ul><li><strong>推拉结合模式</strong>：也叫做读写混合，兼具推和拉两种模式的优点。</li></ul><p><img src=https://img-blog.csdnimg.cn/505e32080a9949b99acf213bf81c578c.png#pic_center alt=在这里插入图片描述></p><ul><li>Feed 流的实现方案</li></ul><table><thead><tr><th></th><th><strong>拉模式</strong></th><th><strong>推模式</strong></th><th><strong>推拉结合</strong></th></tr></thead><tbody><tr><td><strong>写比例</strong></td><td>低</td><td>高</td><td>中</td></tr><tr><td><strong>读比例</strong></td><td>高</td><td>低</td><td>中</td></tr><tr><td><strong>用户读取延迟</strong></td><td>高</td><td>低</td><td>低</td></tr><tr><td><strong>实现难度</strong></td><td>复杂</td><td>简单</td><td>很复杂</td></tr><tr><td><strong>使用场景</strong></td><td>很少使用</td><td>用户量少、没有大V</td><td>过千万的用户量，有大V</td></tr></tbody></table><h3 id=94-好友关注-推送到粉丝收件箱>9.4 好友关注-推送到粉丝收件箱<a href=#94-好友关注-推送到粉丝收件箱 class=header-anchor arialabel=Anchor> #</a></h3><p>需求：</p><ul><li>修改新增探店笔记的业务，在保存blog到数据库的同时，推送到粉丝的收件箱</li><li>收件箱满足可以根据时间戳排序，必须用Redis的数据结构实现</li><li>查询收件箱数据时，可以实现分页查询</li></ul><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@PostMapping</span>
<span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>saveBlog</span><span style=color:#666>(</span><span style=color:#a2f>@RequestBody</span> Blog blog<span style=color:#666>)</span> <span style=color:#666>{</span>    
    <span style=color:#408080;font-style:italic>// 获取登录用户    
</span><span style=color:#408080;font-style:italic></span>    UserDTO user <span style=color:#666>=</span> UserHolder<span style=color:#666>.</span><span style=color:#7d9029>getUser</span><span style=color:#666>();</span>
    blog<span style=color:#666>.</span><span style=color:#7d9029>setUserId</span><span style=color:#666>(</span>user<span style=color:#666>.</span><span style=color:#7d9029>getId</span><span style=color:#666>());</span>     
    <span style=color:#408080;font-style:italic>// 保存探店笔记    
</span><span style=color:#408080;font-style:italic></span>    blogService<span style=color:#666>.</span><span style=color:#7d9029>save</span><span style=color:#666>(</span>blog<span style=color:#666>);</span>
    <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>();</span>
<span style=color:#666>}</span>

</code></pre></div><blockquote><p>Feed流的滚动分页</p></blockquote><blockquote><p>Feed 流中的数据会不断更新，所以数据的角标也在变化，因此不能采用传统的分页模式。</p></blockquote><p><img src=https://img-blog.csdnimg.cn/3859666844fe4bee8eb5bfa692a99e24.png#pic_center alt=在这里插入图片描述></p><blockquote><p>满足这种条件的 Redis 中的数据结构就是 SortedSet</p></blockquote><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@Override</span>
<span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>saveBlog</span><span style=color:#666>(</span>Blog blog<span style=color:#666>)</span> <span style=color:#666>{</span>
    <span style=color:#408080;font-style:italic>// 1.获取登录用户
</span><span style=color:#408080;font-style:italic></span>    UserDTO user <span style=color:#666>=</span> UserHolder<span style=color:#666>.</span><span style=color:#7d9029>getUser</span><span style=color:#666>();</span>
    blog<span style=color:#666>.</span><span style=color:#7d9029>setUserId</span><span style=color:#666>(</span>user<span style=color:#666>.</span><span style=color:#7d9029>getId</span><span style=color:#666>());</span>
    <span style=color:#408080;font-style:italic>// 2.保存探店笔记
</span><span style=color:#408080;font-style:italic></span>    <span style=color:#b00040>boolean</span> isSuccess <span style=color:#666>=</span> save<span style=color:#666>(</span>blog<span style=color:#666>);</span>
    <span style=color:green;font-weight:700>if</span><span style=color:#666>(!</span>isSuccess<span style=color:#666>){</span>
        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;新增笔记失败!&#34;</span><span style=color:#666>);</span>
    <span style=color:#666>}</span>
    <span style=color:#408080;font-style:italic>// 3.查询笔记作者的所有粉丝 select * from tb_follow where follow_user_id = ?
</span><span style=color:#408080;font-style:italic></span>    List<span style=color:#666>&lt;</span>Follow<span style=color:#666>&gt;</span> follows <span style=color:#666>=</span> followService<span style=color:#666>.</span><span style=color:#7d9029>query</span><span style=color:#666>().</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;follow_user_id&#34;</span><span style=color:#666>,</span> user<span style=color:#666>.</span><span style=color:#7d9029>getId</span><span style=color:#666>()).</span><span style=color:#7d9029>list</span><span style=color:#666>();</span>
    <span style=color:#408080;font-style:italic>// 4.推送笔记id给所有粉丝
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>for</span> <span style=color:#666>(</span>Follow follow <span style=color:#666>:</span> follows<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 4.1.获取粉丝id
</span><span style=color:#408080;font-style:italic></span>        Long userId <span style=color:#666>=</span> follow<span style=color:#666>.</span><span style=color:#7d9029>getUserId</span><span style=color:#666>();</span>
        <span style=color:#408080;font-style:italic>// 4.2.推送
</span><span style=color:#408080;font-style:italic></span>        String key <span style=color:#666>=</span> FEED_KEY <span style=color:#666>+</span> userId<span style=color:#666>;</span>
        stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForZSet</span><span style=color:#666>().</span><span style=color:#7d9029>add</span><span style=color:#666>(</span>key<span style=color:#666>,</span> blog<span style=color:#666>.</span><span style=color:#7d9029>getId</span><span style=color:#666>().</span><span style=color:#7d9029>toString</span><span style=color:#666>(),</span> System<span style=color:#666>.</span><span style=color:#7d9029>currentTimeMillis</span><span style=color:#666>());</span>
    <span style=color:#666>}</span>
    <span style=color:#408080;font-style:italic>// 5.返回id
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>blog<span style=color:#666>.</span><span style=color:#7d9029>getId</span><span style=color:#666>());</span>
<span style=color:#666>}</span>
</code></pre></div><h3 id=95好友关注-实现分页查询收邮箱>9.5好友关注-实现分页查询收邮箱<a href=#95好友关注-实现分页查询收邮箱 class=header-anchor arialabel=Anchor> #</a></h3><blockquote><p><strong>分页查询收件箱：在个人主页的 “关注” 中，查询并展示推送的 Blog。</strong></p></blockquote><ol><li><blockquote><p>第一次查询的 <code>lastId</code> 为当前时间戳，每次查询后，<code>lastId</code> 为上一次查询的最小时间戳；</p></blockquote></li><li><blockquote><p>偏移量 <code>offset</code> 为 上一次查询的最小值的元素个数，下一次查询时需要跳过这些已经查询过的数据。</p></blockquote><table><thead><tr><th>请求方式</th><th>请求路径</th><th>请求参数</th><th>返回值</th></tr></thead><tbody><tr><td>GET</td><td><code>/blog/of/follow</code></td><td><code>lastId</code>（上一次查询的最小时间戳）；<code>offset</code>（偏移量）</td><td><code>List&lt;Blog></code>（小于指定时间戳的 Blog 集合）；<code>minTime</code>（本次查询的最小时间戳）；<code>offset</code>（偏移量）</td></tr></tbody></table></li></ol><p>一、定义出来具体的返回值实体类</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@Data</span>
<span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>ScrollResult</span> <span style=color:#666>{</span>
    <span style=color:green;font-weight:700>private</span> List<span style=color:#666>&lt;?&gt;</span> list<span style=color:#666>;</span>
    <span style=color:green;font-weight:700>private</span> Long minTime<span style=color:#666>;</span>
    <span style=color:green;font-weight:700>private</span> Integer offset<span style=color:#666>;</span>
<span style=color:#666>}</span>
</code></pre></div><p>BlogController</p><p>注意：RequestParam 表示接受url地址栏传参的注解，当方法上参数的名称和url地址栏不相同时，可以通过RequestParam 来进行指定</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@GetMapping</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;/of/follow&#34;</span><span style=color:#666>)</span>
<span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>queryBlogOfFollow</span><span style=color:#666>(</span>
    <span style=color:#a2f>@RequestParam</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;lastId&#34;</span><span style=color:#666>)</span> Long max<span style=color:#666>,</span> <span style=color:#a2f>@RequestParam</span><span style=color:#666>(</span>value <span style=color:#666>=</span> <span style=color:#ba2121>&#34;offset&#34;</span><span style=color:#666>,</span> defaultValue <span style=color:#666>=</span> <span style=color:#ba2121>&#34;0&#34;</span><span style=color:#666>)</span> Integer offset<span style=color:#666>){</span>
    <span style=color:green;font-weight:700>return</span> blogService<span style=color:#666>.</span><span style=color:#7d9029>queryBlogOfFollow</span><span style=color:#666>(</span>max<span style=color:#666>,</span> offset<span style=color:#666>);</span>
<span style=color:#666>}</span>
</code></pre></div><p>BlogServiceImpl</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@Override</span>
<span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>queryBlogOfFollow</span><span style=color:#666>(</span>Long max<span style=color:#666>,</span> Integer offset<span style=color:#666>)</span> <span style=color:#666>{</span>
    <span style=color:#408080;font-style:italic>// 1.获取当前用户
</span><span style=color:#408080;font-style:italic></span>    Long userId <span style=color:#666>=</span> UserHolder<span style=color:#666>.</span><span style=color:#7d9029>getUser</span><span style=color:#666>().</span><span style=color:#7d9029>getId</span><span style=color:#666>();</span>
    <span style=color:#408080;font-style:italic>// 2.查询收件箱 ZREVRANGEBYSCORE key Max Min LIMIT offset count
</span><span style=color:#408080;font-style:italic></span>    String key <span style=color:#666>=</span> FEED_KEY <span style=color:#666>+</span> userId<span style=color:#666>;</span>
    Set<span style=color:#666>&lt;</span>ZSetOperations<span style=color:#666>.</span><span style=color:#7d9029>TypedTuple</span><span style=color:#666>&lt;</span>String<span style=color:#666>&gt;&gt;</span> typedTuples <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForZSet</span><span style=color:#666>()</span>
        <span style=color:#666>.</span><span style=color:#7d9029>reverseRangeByScoreWithScores</span><span style=color:#666>(</span>key<span style=color:#666>,</span> 0<span style=color:#666>,</span> max<span style=color:#666>,</span> offset<span style=color:#666>,</span> 2<span style=color:#666>);</span>
    <span style=color:#408080;font-style:italic>// 3.非空判断
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>typedTuples <span style=color:#666>==</span> <span style=color:green;font-weight:700>null</span> <span style=color:#666>||</span> typedTuples<span style=color:#666>.</span><span style=color:#7d9029>isEmpty</span><span style=color:#666>())</span> <span style=color:#666>{</span>
        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>();</span>
    <span style=color:#666>}</span>
    <span style=color:#408080;font-style:italic>// 4.解析数据：blogId、minTime（时间戳）、offset
</span><span style=color:#408080;font-style:italic></span>    List<span style=color:#666>&lt;</span>Long<span style=color:#666>&gt;</span> ids <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> ArrayList<span style=color:#666>&lt;&gt;(</span>typedTuples<span style=color:#666>.</span><span style=color:#7d9029>size</span><span style=color:#666>());</span>
    <span style=color:#b00040>long</span> minTime <span style=color:#666>=</span> 0<span style=color:#666>;</span> <span style=color:#408080;font-style:italic>// 2
</span><span style=color:#408080;font-style:italic></span>    <span style=color:#b00040>int</span> os <span style=color:#666>=</span> 1<span style=color:#666>;</span> <span style=color:#408080;font-style:italic>// 2
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>for</span> <span style=color:#666>(</span>ZSetOperations<span style=color:#666>.</span><span style=color:#7d9029>TypedTuple</span><span style=color:#666>&lt;</span>String<span style=color:#666>&gt;</span> tuple <span style=color:#666>:</span> typedTuples<span style=color:#666>)</span> <span style=color:#666>{</span> <span style=color:#408080;font-style:italic>// 5 4 4 2 2
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#408080;font-style:italic>// 4.1.获取id
</span><span style=color:#408080;font-style:italic></span>        ids<span style=color:#666>.</span><span style=color:#7d9029>add</span><span style=color:#666>(</span>Long<span style=color:#666>.</span><span style=color:#7d9029>valueOf</span><span style=color:#666>(</span>tuple<span style=color:#666>.</span><span style=color:#7d9029>getValue</span><span style=color:#666>()));</span>
        <span style=color:#408080;font-style:italic>// 4.2.获取分数(时间戳）
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#b00040>long</span> time <span style=color:#666>=</span> tuple<span style=color:#666>.</span><span style=color:#7d9029>getScore</span><span style=color:#666>().</span><span style=color:#7d9029>longValue</span><span style=color:#666>();</span>
        <span style=color:green;font-weight:700>if</span><span style=color:#666>(</span>time <span style=color:#666>==</span> minTime<span style=color:#666>){</span>
            os<span style=color:#666>++;</span>
        <span style=color:#666>}</span><span style=color:green;font-weight:700>else</span><span style=color:#666>{</span>
            minTime <span style=color:#666>=</span> time<span style=color:#666>;</span>
            os <span style=color:#666>=</span> 1<span style=color:#666>;</span>
        <span style=color:#666>}</span>
    <span style=color:#666>}</span>
	os <span style=color:#666>=</span> minTime <span style=color:#666>==</span> max <span style=color:#666>?</span> os <span style=color:#666>:</span> os <span style=color:#666>+</span> offset<span style=color:#666>;</span>
    <span style=color:#408080;font-style:italic>// 5.根据id查询blog
</span><span style=color:#408080;font-style:italic></span>    String idStr <span style=color:#666>=</span> StrUtil<span style=color:#666>.</span><span style=color:#7d9029>join</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;,&#34;</span><span style=color:#666>,</span> ids<span style=color:#666>);</span>
    List<span style=color:#666>&lt;</span>Blog<span style=color:#666>&gt;</span> blogs <span style=color:#666>=</span> query<span style=color:#666>().</span><span style=color:#7d9029>in</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;id&#34;</span><span style=color:#666>,</span> ids<span style=color:#666>).</span><span style=color:#7d9029>last</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;ORDER BY FIELD(id,&#34;</span> <span style=color:#666>+</span> idStr <span style=color:#666>+</span> <span style=color:#ba2121>&#34;)&#34;</span><span style=color:#666>).</span><span style=color:#7d9029>list</span><span style=color:#666>();</span>

    <span style=color:green;font-weight:700>for</span> <span style=color:#666>(</span>Blog blog <span style=color:#666>:</span> blogs<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 5.1.查询blog有关的用户
</span><span style=color:#408080;font-style:italic></span>        queryBlogUser<span style=color:#666>(</span>blog<span style=color:#666>);</span>
        <span style=color:#408080;font-style:italic>// 5.2.查询blog是否被点赞
</span><span style=color:#408080;font-style:italic></span>        isBlogLiked<span style=color:#666>(</span>blog<span style=color:#666>);</span>
    <span style=color:#666>}</span>

    <span style=color:#408080;font-style:italic>// 6.封装并返回
</span><span style=color:#408080;font-style:italic></span>    ScrollResult r <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> ScrollResult<span style=color:#666>();</span>
    r<span style=color:#666>.</span><span style=color:#7d9029>setList</span><span style=color:#666>(</span>blogs<span style=color:#666>);</span>
    r<span style=color:#666>.</span><span style=color:#7d9029>setOffset</span><span style=color:#666>(</span>os<span style=color:#666>);</span>
    r<span style=color:#666>.</span><span style=color:#7d9029>setMinTime</span><span style=color:#666>(</span>minTime<span style=color:#666>);</span>

    <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>r<span style=color:#666>);</span>
<span style=color:#666>}</span>
</code></pre></div><h2 id=10附近商户>10、附近商户<a href=#10附近商户 class=header-anchor arialabel=Anchor> #</a></h2><h3 id=101附近商户-geo数据结构的基本用法>10.1、附近商户-GEO数据结构的基本用法<a href=#101附近商户-geo数据结构的基本用法 class=header-anchor arialabel=Anchor> #</a></h3><p>GEO就是Geolocation的简写形式，代表地理坐标。Redis在3.2版本中加入了对GEO的支持，允许存储地理坐标信息，帮助我们根据经纬度来检索数据。常见的命令有：</p><blockquote><p><strong>GEO Geolocation</strong>，代表地理位置，允许存储地理坐标。GEO 底层的实现原理是 ZSET，可以使用 ZSET 的命令操作 GEO。</p></blockquote><ul><li>GEOADD：添加一个地理空间信息，包含：经度（longitude）、纬度（latitude）、值（member）</li><li>GEODIST：计算指定的两个点之间的距离并返回</li><li>GEOHASH：将指定member的坐标转为hash字符串形式并返回</li><li>GEOPOS：返回指定member的坐标</li><li>GEORADIUS：指定圆心、半径，找到该圆内包含的所有member，并按照与圆心之间的距离排序后返回。6.以后已废弃</li><li>GEOSEARCH：在指定范围内搜索member，并按照与指定点之间的距离排序后返回。范围可以是圆形或矩形。6.2.新功能</li><li>GEOSEARCHSTORE：与GEOSEARCH功能一致，不过可以把结果存储到一个指定的key。 6.2.新功能</li></ul><h3 id=102-附近商户-导入店铺数据到geo>10.2、 附近商户-导入店铺数据到GEO<a href=#102-附近商户-导入店铺数据到geo class=header-anchor arialabel=Anchor> #</a></h3><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span>#</span>自写在redis做一个测试
  将经纬度变成sorece存入zset
   

</code></pre></div><ul><li><code>GEOADD key longitude latitude member [longitude latitude member ...]</code>：添加一个地理空间信息，包含：经度（longitude）、纬度（latitude）、值（member）；</li></ul><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>GEOADD China<span style=color:#666>:</span>City 116<span style=color:#666>.</span><span style=color:#7d9029>40</span> 39<span style=color:#666>.</span><span style=color:#7d9029>90</span> <span style=color:#00f>Beijing</span>
<span style=color:#666>(</span>integer<span style=color:#666>)</span> 1
GEOADD China<span style=color:#666>:</span>City 121<span style=color:#666>.</span><span style=color:#7d9029>47</span> 31<span style=color:#666>.</span><span style=color:#7d9029>23</span> Shanghai 106<span style=color:#666>.</span><span style=color:#7d9029>50</span> 29<span style=color:#666>.</span><span style=color:#7d9029>53</span> Chongqing 114<span style=color:#666>.</span><span style=color:#7d9029>08</span> 22<span style=color:#666>.</span><span style=color:#7d9029>547</span> Shenzhen 120<span style=color:#666>.</span><span style=color:#7d9029>15</span> 30<span style=color:#666>.</span><span style=color:#7d9029>28</span> Hangzhou 125<span style=color:#666>.</span><span style=color:#7d9029>15</span> 42<span style=color:#666>.</span><span style=color:#7d9029>93</span> Xian 102<span style=color:#666>.</span><span style=color:#7d9029>71</span> 25<span style=color:#666>.</span><span style=color:#7d9029>04</span> Kunming
</code></pre></div><ul><li><code>GEODIST key member1 member2 [unit]</code>：计算指定的两个点之间的距离并返回；</li></ul><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> GEODIST China<span style=color:#666>:</span>City Beijing Shanghai km
<span style=color:#ba2121>&#34;1067.3788&#34;</span>
 GEODIST China<span style=color:#666>:</span>City Shanghai Kunming km
<span style=color:#ba2121>&#34;1961.3500&#34;</span>

</code></pre></div><ul><li><p><code>GEOHASH key member [member ...]</code>：将指定 member 的坐标转为 hash 字符串形式并返回；</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span>#</span> 降低内存存储压力<span>，</span>会损失一些精度<span>，</span>但是仍然指向同一个地区<span>。</span>
127<span style=color:#666>.</span><span style=color:#7d9029>0</span><span style=color:#666>.</span><span style=color:#7d9029>0</span><span style=color:#666>.</span><span style=color:#7d9029>1</span><span style=color:#666>:</span>6379<span style=color:#666>&gt;</span> GEOHASH China<span style=color:#666>:</span>City Beijing Shanghai Kunming
1<span style=color:#666>)</span> <span style=color:#ba2121>&#34;wx4fbxxfke0&#34;</span>
2<span style=color:#666>)</span> <span style=color:#ba2121>&#34;wtw3sj5zbj0&#34;</span>
3<span style=color:#666>)</span> <span style=color:#ba2121>&#34;wk3n3nrhs60&#34;</span>
  
</code></pre></div></li><li><p><code>GEOPOS key member [member ...]</code>：返回指定 member 的坐标；</p></li></ul><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>127<span style=color:#666>.</span><span style=color:#7d9029>0</span><span style=color:#666>.</span><span style=color:#7d9029>0</span><span style=color:#666>.</span><span style=color:#7d9029>1</span><span style=color:#666>:</span>6379<span style=color:#666>&gt;</span> GEOPOS China<span style=color:#666>:</span>City Beijing
1<span style=color:#666>)</span> 1<span style=color:#666>)</span> <span style=color:#ba2121>&#34;116.39999896287918091&#34;</span>
   2<span style=color:#666>)</span> <span style=color:#ba2121>&#34;39.90000009167092543&#34;</span>
127<span style=color:#666>.</span><span style=color:#7d9029>0</span><span style=color:#666>.</span><span style=color:#7d9029>0</span><span style=color:#666>.</span><span style=color:#7d9029>1</span><span style=color:#666>:</span>6379<span style=color:#666>&gt;</span> GEOPOS China<span style=color:#666>:</span>City Shanghai Kunming Hangzhou
1<span style=color:#666>)</span> 1<span style=color:#666>)</span> <span style=color:#ba2121>&#34;121.47000163793563843&#34;</span>
   2<span style=color:#666>)</span> <span style=color:#ba2121>&#34;31.22999903975783553&#34;</span>
2<span style=color:#666>)</span> 1<span style=color:#666>)</span> <span style=color:#ba2121>&#34;102.70999878644943237&#34;</span>
   2<span style=color:#666>)</span> <span style=color:#ba2121>&#34;25.03999958679589355&#34;</span>
3<span style=color:#666>)</span> 1<span style=color:#666>)</span> <span style=color:#ba2121>&#34;120.15000075101852417&#34;</span>
   2<span style=color:#666>)</span> <span style=color:#ba2121>&#34;30.2800007575645509&#34;</span>

</code></pre></div><ul><li>GEORADIUS key longitude latitude radius [unit] [WITHCOORD] [WITHDIST] [WITHHASH] [COUNT count] [ASC|DESC]：指定圆心、半径，找到该圆范围内包含的所有 member，并按照与圆心的距离排序后返回（6.2 后弃用）；</li></ul><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>127<span style=color:#666>.</span><span style=color:#7d9029>0</span><span style=color:#666>.</span><span style=color:#7d9029>0</span><span style=color:#666>.</span><span style=color:#7d9029>1</span><span style=color:#666>:</span>6379<span style=color:#666>&gt;</span> GEOSEARCH China<span style=color:#666>:</span>City FROMLONLAT 116<span style=color:#666>.</span><span style=color:#7d9029>397904</span> 39<span style=color:#666>.</span><span style=color:#7d9029>909005</span> BYRADIUS 1000 km WITHDIST
1<span style=color:#666>)</span> 1<span style=color:#666>)</span> <span style=color:#ba2121>&#34;Beijing&#34;</span>
   2<span style=color:#666>)</span> <span style=color:#ba2121>&#34;1.0174&#34;</span>
2<span style=color:#666>)</span> 1<span style=color:#666>)</span> <span style=color:#ba2121>&#34;Xian&#34;</span>
   2<span style=color:#666>)</span> <span style=color:#ba2121>&#34;803.0689&#34;</span>

127<span style=color:#666>.</span><span style=color:#7d9029>0</span><span style=color:#666>.</span><span style=color:#7d9029>0</span><span style=color:#666>.</span><span style=color:#7d9029>1</span><span style=color:#666>:</span>6379<span style=color:#666>&gt;</span> GEOSEARCH China<span style=color:#666>:</span>City FROMLONLAT 116<span style=color:#666>.</span><span style=color:#7d9029>397904</span> 39<span style=color:#666>.</span><span style=color:#7d9029>909005</span> BYBOX 2000 2000 km WITHDIST
1<span style=color:#666>)</span> 1<span style=color:#666>)</span> <span style=color:#ba2121>&#34;Shanghai&#34;</span>
   2<span style=color:#666>)</span> <span style=color:#ba2121>&#34;1068.3526&#34;</span>
2<span style=color:#666>)</span> 1<span style=color:#666>)</span> <span style=color:#ba2121>&#34;Beijing&#34;</span>
   2<span style=color:#666>)</span> <span style=color:#ba2121>&#34;1.0174&#34;</span>
3<span style=color:#666>)</span> 1<span style=color:#666>)</span> <span style=color:#ba2121>&#34;Xian&#34;</span>
   2<span style=color:#666>)</span> <span style=color:#ba2121>&#34;803.0689
</span><span style=color:#ba2121>
</span><span style=color:#ba2121>127.0.0.1:6379&gt; GEOSEARCH China:City FROMMEMBER Beijing BYBOX 2000 2000 km WITHDIST
</span><span style=color:#ba2121>1) 1) &#34;</span>Shanghai<span style=color:#ba2121>&#34;
</span><span style=color:#ba2121>   2) &#34;</span>1067<span style=color:#666>.</span><span style=color:#7d9029>3788</span><span style=color:#ba2121>&#34;
</span><span style=color:#ba2121>2) 1) &#34;</span>Beijing<span style=color:#ba2121>&#34;
</span><span style=color:#ba2121>   2) &#34;</span>0<span style=color:#666>.</span><span style=color:#7d9029>0000</span><span style=color:#ba2121>&#34;
</span><span style=color:#ba2121>3) 1) &#34;</span>Xian<span style=color:#ba2121>&#34;
</span><span style=color:#ba2121>   2) &#34;</span>803<span style=color:#666>.</span><span style=color:#7d9029>3746</span><span>&#34;</span>

</code></pre></div><ul><li><code>GEOSEARCHSTORE </code>：与 <code>GEOSEARCH</code> 功能一致，不过可以把结果存储到一个指定的 Key（6.2 新功能）。</li></ul><p>HmDianPingApplicationTests</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@Test</span>
<span style=color:#b00040>void</span> <span style=color:#00f>loadShopData</span><span style=color:#666>()</span> <span style=color:#666>{</span>
    <span style=color:#408080;font-style:italic>// 1.查询店铺信息
</span><span style=color:#408080;font-style:italic></span>    List<span style=color:#666>&lt;</span>Shop<span style=color:#666>&gt;</span> list <span style=color:#666>=</span> shopService<span style=color:#666>.</span><span style=color:#7d9029>list</span><span style=color:#666>();</span>
    <span style=color:#408080;font-style:italic>// 2.把店铺分组，按照typeId分组，typeId一致的放到一个集合
</span><span style=color:#408080;font-style:italic></span>    Map<span style=color:#666>&lt;</span>Long<span style=color:#666>,</span> List<span style=color:#666>&lt;</span>Shop<span style=color:#666>&gt;&gt;</span> map <span style=color:#666>=</span> list<span style=color:#666>.</span><span style=color:#7d9029>stream</span><span style=color:#666>().</span><span style=color:#7d9029>collect</span><span style=color:#666>(</span>Collectors<span style=color:#666>.</span><span style=color:#7d9029>groupingBy</span><span style=color:#666>(</span>Shop<span style=color:#666>::</span>getTypeId<span style=color:#666>));</span>
    <span style=color:#408080;font-style:italic>// 3.分批完成写入Redis
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>for</span> <span style=color:#666>(</span>Map<span style=color:#666>.</span><span style=color:#7d9029>Entry</span><span style=color:#666>&lt;</span>Long<span style=color:#666>,</span> List<span style=color:#666>&lt;</span>Shop<span style=color:#666>&gt;&gt;</span> entry <span style=color:#666>:</span> map<span style=color:#666>.</span><span style=color:#7d9029>entrySet</span><span style=color:#666>())</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 3.1.获取类型id
</span><span style=color:#408080;font-style:italic></span>        Long typeId <span style=color:#666>=</span> entry<span style=color:#666>.</span><span style=color:#7d9029>getKey</span><span style=color:#666>();</span>
        String key <span style=color:#666>=</span> SHOP_GEO_KEY <span style=color:#666>+</span> typeId<span style=color:#666>;</span>
        <span style=color:#408080;font-style:italic>// 3.2.获取同类型的店铺的集合
</span><span style=color:#408080;font-style:italic></span>        List<span style=color:#666>&lt;</span>Shop<span style=color:#666>&gt;</span> value <span style=color:#666>=</span> entry<span style=color:#666>.</span><span style=color:#7d9029>getValue</span><span style=color:#666>();</span>
        List<span style=color:#666>&lt;</span>RedisGeoCommands<span style=color:#666>.</span><span style=color:#7d9029>GeoLocation</span><span style=color:#666>&lt;</span>String<span style=color:#666>&gt;&gt;</span> locations <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> ArrayList<span style=color:#666>&lt;&gt;(</span>value<span style=color:#666>.</span><span style=color:#7d9029>size</span><span style=color:#666>());</span>
        <span style=color:#408080;font-style:italic>// 3.3.写入redis GEOADD key 经度 纬度 member
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>for</span> <span style=color:#666>(</span>Shop shop <span style=color:#666>:</span> value<span style=color:#666>)</span> <span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>// stringRedisTemplate.opsForGeo().add(key, new Point(shop.getX(), shop.getY()), shop.getId().toString());
</span><span style=color:#408080;font-style:italic></span>            locations<span style=color:#666>.</span><span style=color:#7d9029>add</span><span style=color:#666>(</span><span style=color:green;font-weight:700>new</span> RedisGeoCommands<span style=color:#666>.</span><span style=color:#7d9029>GeoLocation</span><span style=color:#666>&lt;&gt;(</span>
                    shop<span style=color:#666>.</span><span style=color:#7d9029>getId</span><span style=color:#666>().</span><span style=color:#7d9029>toString</span><span style=color:#666>(),</span>
                    <span style=color:green;font-weight:700>new</span> Point<span style=color:#666>(</span>shop<span style=color:#666>.</span><span style=color:#7d9029>getX</span><span style=color:#666>(),</span> shop<span style=color:#666>.</span><span style=color:#7d9029>getY</span><span style=color:#666>())</span>
            <span style=color:#666>));</span>
        <span style=color:#666>}</span>
        stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForGeo</span><span style=color:#666>().</span><span style=color:#7d9029>add</span><span style=color:#666>(</span>key<span style=color:#666>,</span> locations<span style=color:#666>);</span>
    <span style=color:#666>}</span>
<span style=color:#666>}</span>
</code></pre></div><h3 id=103-附近商户-实现附近商户功能>10.3 附近商户-实现附近商户功能<a href=#103-附近商户-实现附近商户功能 class=header-anchor arialabel=Anchor> #</a></h3><p>SpringDataRedis的2.3.9版本并不支持Redis 6.2提供的GEOSEARCH命令，因此我们需要提示其版本，修改自己的POM</p><p><strong>将数据库中的数据导入到 Redis 中</strong>：按照商家类型分组，类型相同的商家作为一组，以 <code>typeId</code> 为 Key，商家地址为 Value。</p><h3 id=可以安装一个dependency-analyzer>可以安装一个dependency analyzer<a href=#可以安装一个dependency-analyzer class=header-anchor arialabel=Anchor> #</a></h3><p>第一步：导入pom</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#666>&lt;</span>dependency<span style=color:#666>&gt;</span>
    <span style=color:#666>&lt;</span>groupId<span style=color:#666>&gt;</span>org<span style=color:#666>.</span><span style=color:#7d9029>springframework</span><span style=color:#666>.</span><span style=color:#7d9029>boot</span><span style=color:#666>&lt;/</span>groupId<span style=color:#666>&gt;</span>
    <span style=color:#666>&lt;</span>artifactId<span style=color:#666>&gt;</span>spring<span style=color:#666>-</span>boot<span style=color:#666>-</span>starter<span style=color:#666>-</span>data<span style=color:#666>-</span>redis<span style=color:#666>&lt;/</span>artifactId<span style=color:#666>&gt;</span>
    <span style=color:#666>&lt;</span>exclusions<span style=color:#666>&gt;</span>
        <span style=color:#666>&lt;</span>exclusion<span style=color:#666>&gt;</span>
            <span style=color:#666>&lt;</span>artifactId<span style=color:#666>&gt;</span>spring<span style=color:#666>-</span>data<span style=color:#666>-</span>redis<span style=color:#666>&lt;/</span>artifactId<span style=color:#666>&gt;</span>
            <span style=color:#666>&lt;</span>groupId<span style=color:#666>&gt;</span>org<span style=color:#666>.</span><span style=color:#7d9029>springframework</span><span style=color:#666>.</span><span style=color:#7d9029>data</span><span style=color:#666>&lt;/</span>groupId<span style=color:#666>&gt;</span>
        <span style=color:#666>&lt;/</span>exclusion<span style=color:#666>&gt;</span>
        <span style=color:#666>&lt;</span>exclusion<span style=color:#666>&gt;</span>
            <span style=color:#666>&lt;</span>artifactId<span style=color:#666>&gt;</span>lettuce<span style=color:#666>-</span>core<span style=color:#666>&lt;/</span>artifactId<span style=color:#666>&gt;</span>
            <span style=color:#666>&lt;</span>groupId<span style=color:#666>&gt;</span>io<span style=color:#666>.</span><span style=color:#7d9029>lettuce</span><span style=color:#666>&lt;/</span>groupId<span style=color:#666>&gt;</span>
        <span style=color:#666>&lt;/</span>exclusion<span style=color:#666>&gt;</span>
    <span style=color:#666>&lt;/</span>exclusions<span style=color:#666>&gt;</span>
<span style=color:#666>&lt;/</span>dependency<span style=color:#666>&gt;</span>
<span style=color:#666>&lt;</span>dependency<span style=color:#666>&gt;</span>
    <span style=color:#666>&lt;</span>groupId<span style=color:#666>&gt;</span>org<span style=color:#666>.</span><span style=color:#7d9029>springframework</span><span style=color:#666>.</span><span style=color:#7d9029>data</span><span style=color:#666>&lt;/</span>groupId<span style=color:#666>&gt;</span>
    <span style=color:#666>&lt;</span>artifactId<span style=color:#666>&gt;</span>spring<span style=color:#666>-</span>data<span style=color:#666>-</span>redis<span style=color:#666>&lt;/</span>artifactId<span style=color:#666>&gt;</span>
    <span style=color:#666>&lt;</span>version<span style=color:#666>&gt;</span>2<span style=color:#666>.</span><span style=color:#7d9029>6</span><span style=color:#666>.</span><span style=color:#7d9029>2</span><span style=color:#666>&lt;/</span>version<span style=color:#666>&gt;</span>
<span style=color:#666>&lt;/</span>dependency<span style=color:#666>&gt;</span>
<span style=color:#666>&lt;</span>dependency<span style=color:#666>&gt;</span>
    <span style=color:#666>&lt;</span>groupId<span style=color:#666>&gt;</span>io<span style=color:#666>.</span><span style=color:#7d9029>lettuce</span><span style=color:#666>&lt;/</span>groupId<span style=color:#666>&gt;</span>
    <span style=color:#666>&lt;</span>artifactId<span style=color:#666>&gt;</span>lettuce<span style=color:#666>-</span>core<span style=color:#666>&lt;/</span>artifactId<span style=color:#666>&gt;</span>
    <span style=color:#666>&lt;</span>version<span style=color:#666>&gt;</span>6<span style=color:#666>.</span><span style=color:#7d9029>1</span><span style=color:#666>.</span><span style=color:#7d9029>6</span><span style=color:#666>.</span><span style=color:#7d9029>RELEASE</span><span style=color:#666>&lt;/</span>version<span style=color:#666>&gt;</span>
<span style=color:#666>&lt;/</span>dependency<span style=color:#666>&gt;</span>
</code></pre></div><p>第二步：</p><p>ShopController</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@GetMapping</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;/of/type&#34;</span><span style=color:#666>)</span>
<span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>queryShopByType</span><span style=color:#666>(</span>
        <span style=color:#a2f>@RequestParam</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;typeId&#34;</span><span style=color:#666>)</span> Integer typeId<span style=color:#666>,</span>
        <span style=color:#a2f>@RequestParam</span><span style=color:#666>(</span>value <span style=color:#666>=</span> <span style=color:#ba2121>&#34;current&#34;</span><span style=color:#666>,</span> defaultValue <span style=color:#666>=</span> <span style=color:#ba2121>&#34;1&#34;</span><span style=color:#666>)</span> Integer current<span style=color:#666>,</span>
        <span style=color:#a2f>@RequestParam</span><span style=color:#666>(</span>value <span style=color:#666>=</span> <span style=color:#ba2121>&#34;x&#34;</span><span style=color:#666>,</span> required <span style=color:#666>=</span> <span style=color:green;font-weight:700>false</span><span style=color:#666>)</span> Double x<span style=color:#666>,</span>
        <span style=color:#a2f>@RequestParam</span><span style=color:#666>(</span>value <span style=color:#666>=</span> <span style=color:#ba2121>&#34;y&#34;</span><span style=color:#666>,</span> required <span style=color:#666>=</span> <span style=color:green;font-weight:700>false</span><span style=color:#666>)</span> Double y
<span style=color:#666>)</span> <span style=color:#666>{</span>
   <span style=color:green;font-weight:700>return</span> shopService<span style=color:#666>.</span><span style=color:#7d9029>queryShopByType</span><span style=color:#666>(</span>typeId<span style=color:#666>,</span> current<span style=color:#666>,</span> x<span style=color:#666>,</span> y<span style=color:#666>);</span>
<span style=color:#666>}</span>
</code></pre></div><p>ShopServiceImpl</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@Override</span>
    <span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>queryShopByType</span><span style=color:#666>(</span>Integer typeId<span style=color:#666>,</span> Integer current<span style=color:#666>,</span> Double x<span style=color:#666>,</span> Double y<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 1.判断是否需要根据坐标查询
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>x <span style=color:#666>==</span> <span style=color:green;font-weight:700>null</span> <span style=color:#666>||</span> y <span style=color:#666>==</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>// 不需要坐标查询，按数据库查询
</span><span style=color:#408080;font-style:italic></span>            Page<span style=color:#666>&lt;</span>Shop<span style=color:#666>&gt;</span> page <span style=color:#666>=</span> query<span style=color:#666>()</span>
                    <span style=color:#666>.</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;type_id&#34;</span><span style=color:#666>,</span> typeId<span style=color:#666>)</span>
                    <span style=color:#666>.</span><span style=color:#7d9029>page</span><span style=color:#666>(</span><span style=color:green;font-weight:700>new</span> Page<span style=color:#666>&lt;&gt;(</span>current<span style=color:#666>,</span> SystemConstants<span style=color:#666>.</span><span style=color:#7d9029>DEFAULT_PAGE_SIZE</span><span style=color:#666>));</span>
            <span style=color:#408080;font-style:italic>// 返回数据
</span><span style=color:#408080;font-style:italic></span>            <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>page<span style=color:#666>.</span><span style=color:#7d9029>getRecords</span><span style=color:#666>());</span>
        <span style=color:#666>}</span>

        <span style=color:#408080;font-style:italic>// 2.计算分页参数
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#b00040>int</span> from <span style=color:#666>=</span> <span style=color:#666>(</span>current <span style=color:#666>-</span> 1<span style=color:#666>)</span> <span style=color:#666>*</span> SystemConstants<span style=color:#666>.</span><span style=color:#7d9029>DEFAULT_PAGE_SIZE</span><span style=color:#666>;</span>
        <span style=color:#b00040>int</span> end <span style=color:#666>=</span> current <span style=color:#666>*</span> SystemConstants<span style=color:#666>.</span><span style=color:#7d9029>DEFAULT_PAGE_SIZE</span><span style=color:#666>;</span>

        <span style=color:#408080;font-style:italic>// 3.查询redis、按照距离排序、分页。结果：shopId、distance
</span><span style=color:#408080;font-style:italic></span>        String key <span style=color:#666>=</span> SHOP_GEO_KEY <span style=color:#666>+</span> typeId<span style=color:#666>;</span>
        GeoResults<span style=color:#666>&lt;</span>RedisGeoCommands<span style=color:#666>.</span><span style=color:#7d9029>GeoLocation</span><span style=color:#666>&lt;</span>String<span style=color:#666>&gt;&gt;</span> results <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForGeo</span><span style=color:#666>()</span> <span style=color:#408080;font-style:italic>// GEOSEARCH key BYLONLAT x y BYRADIUS 10 WITHDISTANCE
</span><span style=color:#408080;font-style:italic></span>                <span style=color:#666>.</span><span style=color:#7d9029>search</span><span style=color:#666>(</span>
                        key<span style=color:#666>,</span>
                        GeoReference<span style=color:#666>.</span><span style=color:#7d9029>fromCoordinate</span><span style=color:#666>(</span>x<span style=color:#666>,</span> y<span style=color:#666>),</span>
                        <span style=color:green;font-weight:700>new</span> Distance<span style=color:#666>(</span>5000<span style=color:#666>),</span>
                        RedisGeoCommands<span style=color:#666>.</span><span style=color:#7d9029>GeoSearchCommandArgs</span><span style=color:#666>.</span><span style=color:#7d9029>newGeoSearchArgs</span><span style=color:#666>().</span><span style=color:#7d9029>includeDistance</span><span style=color:#666>().</span><span style=color:#7d9029>limit</span><span style=color:#666>(</span>end<span style=color:#666>)</span>
                <span style=color:#666>);</span>
        <span style=color:#408080;font-style:italic>// 4.解析出id
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>results <span style=color:#666>==</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
            <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>Collections<span style=color:#666>.</span><span style=color:#7d9029>emptyList</span><span style=color:#666>());</span>
        <span style=color:#666>}</span>
        List<span style=color:#666>&lt;</span>GeoResult<span style=color:#666>&lt;</span>RedisGeoCommands<span style=color:#666>.</span><span style=color:#7d9029>GeoLocation</span><span style=color:#666>&lt;</span>String<span style=color:#666>&gt;&gt;&gt;</span> list <span style=color:#666>=</span> results<span style=color:#666>.</span><span style=color:#7d9029>getContent</span><span style=color:#666>();</span>
        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>list<span style=color:#666>.</span><span style=color:#7d9029>size</span><span style=color:#666>()</span> <span style=color:#666>&lt;=</span> from<span style=color:#666>)</span> <span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>// 没有下一页了，结束
</span><span style=color:#408080;font-style:italic></span>            <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>Collections<span style=color:#666>.</span><span style=color:#7d9029>emptyList</span><span style=color:#666>());</span>
        <span style=color:#666>}</span>
        <span style=color:#408080;font-style:italic>// 4.1.截取 from ~ end的部分
</span><span style=color:#408080;font-style:italic></span>        List<span style=color:#666>&lt;</span>Long<span style=color:#666>&gt;</span> ids <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> ArrayList<span style=color:#666>&lt;&gt;(</span>list<span style=color:#666>.</span><span style=color:#7d9029>size</span><span style=color:#666>());</span>
        Map<span style=color:#666>&lt;</span>String<span style=color:#666>,</span> Distance<span style=color:#666>&gt;</span> distanceMap <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> HashMap<span style=color:#666>&lt;&gt;(</span>list<span style=color:#666>.</span><span style=color:#7d9029>size</span><span style=color:#666>());</span>
        list<span style=color:#666>.</span><span style=color:#7d9029>stream</span><span style=color:#666>().</span><span style=color:#7d9029>skip</span><span style=color:#666>(</span>from<span style=color:#666>).</span><span style=color:#7d9029>forEach</span><span style=color:#666>(</span>result <span style=color:#666>-&gt;</span> <span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>// 4.2.获取店铺id
</span><span style=color:#408080;font-style:italic></span>            String shopIdStr <span style=color:#666>=</span> result<span style=color:#666>.</span><span style=color:#7d9029>getContent</span><span style=color:#666>().</span><span style=color:#7d9029>getName</span><span style=color:#666>();</span>
            ids<span style=color:#666>.</span><span style=color:#7d9029>add</span><span style=color:#666>(</span>Long<span style=color:#666>.</span><span style=color:#7d9029>valueOf</span><span style=color:#666>(</span>shopIdStr<span style=color:#666>));</span>
            <span style=color:#408080;font-style:italic>// 4.3.获取距离
</span><span style=color:#408080;font-style:italic></span>            Distance distance <span style=color:#666>=</span> result<span style=color:#666>.</span><span style=color:#7d9029>getDistance</span><span style=color:#666>();</span>
            distanceMap<span style=color:#666>.</span><span style=color:#7d9029>put</span><span style=color:#666>(</span>shopIdStr<span style=color:#666>,</span> distance<span style=color:#666>);</span>
        <span style=color:#666>});</span>
        <span style=color:#408080;font-style:italic>// 5.根据id查询Shop
</span><span style=color:#408080;font-style:italic></span>        String idStr <span style=color:#666>=</span> StrUtil<span style=color:#666>.</span><span style=color:#7d9029>join</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;,&#34;</span><span style=color:#666>,</span> ids<span style=color:#666>);</span>
        List<span style=color:#666>&lt;</span>Shop<span style=color:#666>&gt;</span> shops <span style=color:#666>=</span> query<span style=color:#666>().</span><span style=color:#7d9029>in</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;id&#34;</span><span style=color:#666>,</span> ids<span style=color:#666>).</span><span style=color:#7d9029>last</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;ORDER BY FIELD(id,&#34;</span> <span style=color:#666>+</span> idStr <span style=color:#666>+</span> <span style=color:#ba2121>&#34;)&#34;</span><span style=color:#666>).</span><span style=color:#7d9029>list</span><span style=color:#666>();</span>
        <span style=color:green;font-weight:700>for</span> <span style=color:#666>(</span>Shop shop <span style=color:#666>:</span> shops<span style=color:#666>)</span> <span style=color:#666>{</span>
            shop<span style=color:#666>.</span><span style=color:#7d9029>setDistance</span><span style=color:#666>(</span>distanceMap<span style=color:#666>.</span><span style=color:#7d9029>get</span><span style=color:#666>(</span>shop<span style=color:#666>.</span><span style=color:#7d9029>getId</span><span style=color:#666>().</span><span style=color:#7d9029>toString</span><span style=color:#666>()).</span><span style=color:#7d9029>getValue</span><span style=color:#666>());</span>
        <span style=color:#666>}</span>
        <span style=color:#408080;font-style:italic>// 6.返回
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>shops<span style=color:#666>);</span>
    <span style=color:#666>}</span>
</code></pre></div><h2 id=11用户签到>11、用户签到<a href=#11用户签到 class=header-anchor arialabel=Anchor> #</a></h2><h3 id=111用户签到-bitmap功能演示-bitmap-数据结构>11.1、用户签到-BitMap功能演示 BitMap 数据结构<a href=#111用户签到-bitmap功能演示-bitmap-数据结构 class=header-anchor arialabel=Anchor> #</a></h3><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:green;font-weight:700>CREATE</span> <span style=color:green;font-weight:700>TABLE</span> <span style=color:#666>`</span>tb_sign<span style=color:#666>`</span> (
  <span style=color:#666>`</span>id<span style=color:#666>`</span> <span style=color:green>bigint</span> unsigned <span style=color:green;font-weight:700>NOT</span> <span style=color:green;font-weight:700>NULL</span> AUTO_INCREMENT <span style=color:green;font-weight:700>COMMENT</span> <span style=color:#ba2121>&#39;主键&#39;</span>,
  <span style=color:#666>`</span>user_id<span style=color:#666>`</span> <span style=color:green>bigint</span> unsigned <span style=color:green;font-weight:700>NOT</span> <span style=color:green;font-weight:700>NULL</span> <span style=color:green;font-weight:700>COMMENT</span> <span style=color:#ba2121>&#39;用户id&#39;</span>,
  <span style=color:#666>`</span><span style=color:green;font-weight:700>year</span><span style=color:#666>`</span> <span style=color:green;font-weight:700>year</span> <span style=color:green;font-weight:700>NOT</span> <span style=color:green;font-weight:700>NULL</span> <span style=color:green;font-weight:700>COMMENT</span> <span style=color:#ba2121>&#39;签到的年&#39;</span>,
  <span style=color:#666>`</span><span style=color:green;font-weight:700>month</span><span style=color:#666>`</span> tinyint <span style=color:green;font-weight:700>NOT</span> <span style=color:green;font-weight:700>NULL</span> <span style=color:green;font-weight:700>COMMENT</span> <span style=color:#ba2121>&#39;签到的月&#39;</span>,
  <span style=color:#666>`</span><span style=color:green>date</span><span style=color:#666>`</span> <span style=color:green>date</span> <span style=color:green;font-weight:700>NOT</span> <span style=color:green;font-weight:700>NULL</span> <span style=color:green;font-weight:700>COMMENT</span> <span style=color:#ba2121>&#39;签到的日期&#39;</span>,
  <span style=color:#666>`</span>is_backup<span style=color:#666>`</span> tinyint unsigned <span style=color:green;font-weight:700>DEFAULT</span> <span style=color:green;font-weight:700>NULL</span> <span style=color:green;font-weight:700>COMMENT</span> <span style=color:#ba2121>&#39;是否补签&#39;</span>,
  <span style=color:green;font-weight:700>PRIMARY</span> <span style=color:green;font-weight:700>KEY</span> (<span style=color:#666>`</span>id<span style=color:#666>`</span>) <span style=color:green;font-weight:700>USING</span> BTREE
) ENGINE<span style=color:#666>=</span>InnoDB <span style=color:green;font-weight:700>DEFAULT</span> CHARSET<span style=color:#666>=</span>utf8mb4 <span style=color:green;font-weight:700>COLLATE</span><span style=color:#666>=</span>utf8mb4_general_ci ROW_FORMAT<span style=color:#666>=</span>COMPACT;

</code></pre></div><blockquote><p>我们按月来统计用户签到信息，签到记录为1，未签到则记录为0.</p></blockquote><blockquote><p>把每一个bit位对应当月的每一天，形成了映射关系。用0和1标示业务状态，这种思路就称为位图（BitMap）。这样我们就用极小的空间，来实现了大量数据的表示</p></blockquote><blockquote><p>Redis中是利用string类型数据结构实现BitMap，因此最大上限是512M，转换为bit则是 2^32个bit位。</p></blockquote><p><img src=https://itsawaysu.oss-cn-shanghai.aliyuncs.com/note/%E7%AD%BE%E5%88%B0%E8%A1%A8%20BitMap.jpg alt="签到表 BitMap"></p><p>BitMap的操作命令有：</p><ul><li><code>SETBIT key offset value</code> 向指定位置 <code>offset</code> 存入一个 0 或 1;</li><li><code>GETBIT key offset</code> ：获取指定位置 <code>offset</code> 的 Bit 值；</li><li><code>BITCOUNT key [start end]</code> ：统计 BitMap 中值为 1 的 Bit 位的数量；</li><li><code>BITFIELD key [GET type offset] </code>：操作（查询、修改、自增） BitMap 中 Bit 数组中指定位置 <code>offset</code> 的值；<ul><li><code>type</code> ：<code>u</code> 为无符号，<code>i</code> 为有符号；符号后的数字为</li></ul></li><li>BITFIELD_RO ：获取BitMap中bit数组，并以十进制形式返回</li><li>BITOP ：将多个BitMap的结果做位运算（与 、或、异或）</li><li><code>BITPOS key bit [start] [end]</code> ：查找 Bit 数组中指定范围内的第一个 0 或 1 出现的位置。</li></ul><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span>#</span>自写
192<span style=color:#666>.</span><span style=color:#7d9029>168</span><span style=color:#666>.</span><span style=color:#7d9029>8</span><span style=color:#666>.</span><span style=color:#7d9029>130</span><span style=color:#666>:</span>6379<span style=color:#666>&gt;</span> setbit bm1 0 <span style=color:#00f>1</span>
<span style=color:#666>(</span>integer<span style=color:#666>)</span> 0
192<span style=color:#666>.</span><span style=color:#7d9029>168</span><span style=color:#666>.</span><span style=color:#7d9029>8</span><span style=color:#666>.</span><span style=color:#7d9029>130</span><span style=color:#666>:</span>6379<span style=color:#666>&gt;</span> setbit bm1  1 <span style=color:#00f>1</span>
<span style=color:#666>(</span>integer<span style=color:#666>)</span> 0
192<span style=color:#666>.</span><span style=color:#7d9029>168</span><span style=color:#666>.</span><span style=color:#7d9029>8</span><span style=color:#666>.</span><span style=color:#7d9029>130</span><span style=color:#666>:</span>6379<span style=color:#666>&gt;</span> setbit bm1 2 <span style=color:#00f>1</span>
<span style=color:#666>(</span>integer<span style=color:#666>)</span> 0
192<span style=color:#666>.</span><span style=color:#7d9029>168</span><span style=color:#666>.</span><span style=color:#7d9029>8</span><span style=color:#666>.</span><span style=color:#7d9029>130</span><span style=color:#666>:</span>6379<span style=color:#666>&gt;</span> setbit bm1 5 <span style=color:#00f>1</span>
<span style=color:#666>(</span>integer<span style=color:#666>)</span> 0
192<span style=color:#666>.</span><span style=color:#7d9029>168</span><span style=color:#666>.</span><span style=color:#7d9029>8</span><span style=color:#666>.</span><span style=color:#7d9029>130</span><span style=color:#666>:</span>6379<span style=color:#666>&gt;</span> setbit bm1 6 <span style=color:#00f>1</span>
<span style=color:#666>(</span>integer<span style=color:#666>)</span> 0
192<span style=color:#666>.</span><span style=color:#7d9029>168</span><span style=color:#666>.</span><span style=color:#7d9029>8</span><span style=color:#666>.</span><span style=color:#7d9029>130</span><span style=color:#666>:</span>6379<span style=color:#666>&gt;</span> setbit  bm1 7 <span style=color:#00f>1</span>
<span style=color:#666>(</span>integer<span style=color:#666>)</span> 0
192<span style=color:#666>.</span><span style=color:#7d9029>168</span><span style=color:#666>.</span><span style=color:#7d9029>8</span><span style=color:#666>.</span><span style=color:#7d9029>130</span><span style=color:#666>:</span>6379<span style=color:#666>&gt;</span> getbit bm1 <span style=color:#00f>2</span>
<span style=color:#666>(</span>integer<span style=color:#666>)</span> 1
192<span style=color:#666>.</span><span style=color:#7d9029>168</span><span style=color:#666>.</span><span style=color:#7d9029>8</span><span style=color:#666>.</span><span style=color:#7d9029>130</span><span style=color:#666>:</span>6379<span style=color:#666>&gt;</span> bitcount <span style=color:#00f>bm1</span>
<span style=color:#666>(</span>integer<span style=color:#666>)</span> 6
192<span style=color:#666>.</span><span style=color:#7d9029>168</span><span style=color:#666>.</span><span style=color:#7d9029>8</span><span style=color:#666>.</span><span style=color:#7d9029>130</span><span style=color:#666>:</span>6379<span style=color:#666>&gt;</span> bitfield bm1 get u2 0
1<span style=color:#666>)</span> <span style=color:#666>(</span>integer<span style=color:#666>)</span> 3
192<span style=color:#666>.</span><span style=color:#7d9029>168</span><span style=color:#666>.</span><span style=color:#7d9029>8</span><span style=color:#666>.</span><span style=color:#7d9029>130</span><span style=color:#666>:</span>6379<span style=color:#666>&gt;</span> bitfield bm1 get u2 0
1<span style=color:#666>)</span> <span style=color:#666>(</span>integer<span style=color:#666>)</span> 3
192<span style=color:#666>.</span><span style=color:#7d9029>168</span><span style=color:#666>.</span><span style=color:#7d9029>8</span><span style=color:#666>.</span><span style=color:#7d9029>130</span><span style=color:#666>:</span>6379<span style=color:#666>&gt;</span> bitfield bm1 get u3 0
1<span style=color:#666>)</span> <span style=color:#666>(</span>integer<span style=color:#666>)</span> 7
192<span style=color:#666>.</span><span style=color:#7d9029>168</span><span style=color:#666>.</span><span style=color:#7d9029>8</span><span style=color:#666>.</span><span style=color:#7d9029>130</span><span style=color:#666>:</span>6379<span style=color:#666>&gt;</span> bitfield bm1 get u4 0
1<span style=color:#666>)</span> <span style=color:#666>(</span>integer<span style=color:#666>)</span> 14
192<span style=color:#666>.</span><span style=color:#7d9029>168</span><span style=color:#666>.</span><span style=color:#7d9029>8</span><span style=color:#666>.</span><span style=color:#7d9029>130</span><span style=color:#666>:</span>6379<span style=color:#666>&gt;</span> 
ut2 0 从0开始读两个 1<span style=color:#666>+</span>2<span style=color:#666>=</span>3
</code></pre></div><h3 id=112-用户签到-实现签到功能>11.2 、用户签到-实现签到功能<a href=#112-用户签到-实现签到功能 class=header-anchor arialabel=Anchor> #</a></h3><p>需求：实现签到接口，将当前用户当天签到信息保存到Redis中</p><p>思路：我们可以把年和月作为bitMap的key，然后保存到一个bitMap中，每次签到就到对应的位上把数字从0变成1，只要对应是1，就表明说明这一天已经签到了，反之则没有签到。</p><blockquote><p>BitMap 底层基于 String 数据结构，因此其操作也都封装到在字符串的相关操作中。</p></blockquote><p><strong>代码</strong></p><p>UserController</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#a2f>@PostMapping</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;/sign&#34;</span><span style=color:#666>)</span>
 <span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>sign</span><span style=color:#666>(){</span>
    <span style=color:green;font-weight:700>return</span> userService<span style=color:#666>.</span><span style=color:#7d9029>sign</span><span style=color:#666>();</span>
 <span style=color:#666>}</span>
</code></pre></div><p>UserServiceImpl</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@Override</span>
<span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>sign</span><span style=color:#666>()</span> <span style=color:#666>{</span>
    <span style=color:#408080;font-style:italic>// 1.获取当前登录用户
</span><span style=color:#408080;font-style:italic></span>    Long userId <span style=color:#666>=</span> UserHolder<span style=color:#666>.</span><span style=color:#7d9029>getUser</span><span style=color:#666>().</span><span style=color:#7d9029>getId</span><span style=color:#666>();</span>
    <span style=color:#408080;font-style:italic>// 2.获取日期
</span><span style=color:#408080;font-style:italic></span>    LocalDateTime now <span style=color:#666>=</span> LocalDateTime<span style=color:#666>.</span><span style=color:#7d9029>now</span><span style=color:#666>();</span>
    <span style=color:#408080;font-style:italic>// 3.拼接key
</span><span style=color:#408080;font-style:italic></span>    String keySuffix <span style=color:#666>=</span> now<span style=color:#666>.</span><span style=color:#7d9029>format</span><span style=color:#666>(</span>DateTimeFormatter<span style=color:#666>.</span><span style=color:#7d9029>ofPattern</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;:yyyyMM&#34;</span><span style=color:#666>));</span>
    String key <span style=color:#666>=</span> USER_SIGN_KEY <span style=color:#666>+</span> userId <span style=color:#666>+</span> keySuffix<span style=color:#666>;</span>
    <span style=color:#408080;font-style:italic>// 4.获取今天是本月的第几天
</span><span style=color:#408080;font-style:italic></span>    <span style=color:#b00040>int</span> dayOfMonth <span style=color:#666>=</span> now<span style=color:#666>.</span><span style=color:#7d9029>getDayOfMonth</span><span style=color:#666>();</span>
    <span style=color:#408080;font-style:italic>// 5.写入Redis SETBIT key offset 1
</span><span style=color:#408080;font-style:italic></span>    stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>().</span><span style=color:#7d9029>setBit</span><span style=color:#666>(</span>key<span style=color:#666>,</span> dayOfMonth <span style=color:#666>-</span> 1<span style=color:#666>,</span> <span style=color:green;font-weight:700>true</span><span style=color:#666>);</span>
    <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>();</span>
<span style=color:#666>}</span>
</code></pre></div><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span>#</span>自写
    签到之后查看数据
    binary 今天五号
<span style=color:#a0a000>sign:</span>1013<span style=color:#666>:</span>202212
    00001000 8个bit一字节<span>，</span>要将位置补全
</code></pre></div><h3 id=113-用户签到-签到统计>11.3 用户签到-签到统计<a href=#113-用户签到-签到统计 class=header-anchor arialabel=Anchor> #</a></h3><p>**问题1：**什么叫做连续签到天数？
从最后一次签到开始向前统计，直到遇到第一次未签到为止，计算总的签到次数，就是连续签到天数。</p><p>Java逻辑代码：获得当前这个月的最后一次签到数据，定义一个计数器，然后不停的向前统计，直到获得第一个非0的数字即可，每得到一个非0的数字计数器+1，直到遍历完所有的数据，就可以获得当前月的签到总天数了</p><p>**问题2：**如何得到本月到今天为止的所有签到数据？</p><blockquote><p>BITFIELD key GET u[dayOfMonth] 0</p></blockquote><p>假设今天是10号，那么我们就可以从当前月的第一天开始，获得到当前这一天的位数，是10号，那么就是10位，去拿这段时间的数据，就能拿到所有的数据了，那么这10天里边签到了多少次呢？统计有多少个1即可。</p><p><strong>问题3：如何从后向前遍历每个bit位？</strong></p><p>注意：bitMap返回的数据是10进制，哪假如说返回一个数字8，那么我哪儿知道到底哪些是0，哪些是1呢？我们只需要让得到的10进制数字和1做与运算就可以了，因为1只有遇见1 才是1，其他数字都是0 ，我们把签到结果和1进行与操作，每与一次，就把签到结果向右移动一位，依次内推，我们就能完成逐个遍历的效果了。</p><p>需求：实现下面接口，统计当前用户截止当前时间在本月的连续签到天数</p><p>有用户有时间我们就可以组织出对应的key，此时就能找到这个用户截止这天的所有签到记录，再根据这套算法，就能统计出来他连续签到的次数了</p><blockquote><p>BitMap 返回的数据是 10 进制的，只需要让得到的 10 进制数字 和 1 进行与运算，每与一次就将签到结果右移一位，实现遍历。</p></blockquote><p>代码</p><p><strong>UserController</strong></p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@GetMapping</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;/sign/count&#34;</span><span style=color:#666>)</span>
<span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>signCount</span><span style=color:#666>(){</span>
    <span style=color:green;font-weight:700>return</span> userService<span style=color:#666>.</span><span style=color:#7d9029>signCount</span><span style=color:#666>();</span>
<span style=color:#666>}</span>
</code></pre></div><p><strong>UserServiceImpl</strong></p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@Override</span>
<span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>signCount</span><span style=color:#666>()</span> <span style=color:#666>{</span>
    <span style=color:#408080;font-style:italic>// 1.获取当前登录用户
</span><span style=color:#408080;font-style:italic></span>    Long userId <span style=color:#666>=</span> UserHolder<span style=color:#666>.</span><span style=color:#7d9029>getUser</span><span style=color:#666>().</span><span style=color:#7d9029>getId</span><span style=color:#666>();</span>
    <span style=color:#408080;font-style:italic>// 2.获取日期
</span><span style=color:#408080;font-style:italic></span>    LocalDateTime now <span style=color:#666>=</span> LocalDateTime<span style=color:#666>.</span><span style=color:#7d9029>now</span><span style=color:#666>();</span>
    <span style=color:#408080;font-style:italic>// 3.拼接key
</span><span style=color:#408080;font-style:italic></span>    String keySuffix <span style=color:#666>=</span> now<span style=color:#666>.</span><span style=color:#7d9029>format</span><span style=color:#666>(</span>DateTimeFormatter<span style=color:#666>.</span><span style=color:#7d9029>ofPattern</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;:yyyyMM&#34;</span><span style=color:#666>));</span>
    String key <span style=color:#666>=</span> USER_SIGN_KEY <span style=color:#666>+</span> userId <span style=color:#666>+</span> keySuffix<span style=color:#666>;</span>
    <span style=color:#408080;font-style:italic>// 4.获取今天是本月的第几天
</span><span style=color:#408080;font-style:italic></span>    <span style=color:#b00040>int</span> dayOfMonth <span style=color:#666>=</span> now<span style=color:#666>.</span><span style=color:#7d9029>getDayOfMonth</span><span style=color:#666>();</span>
    <span style=color:#408080;font-style:italic>// 5.获取本月截止今天为止的所有的签到记录，返回的是一个十进制的数字 BITFIELD sign:5:202203 GET u14 0
</span><span style=color:#408080;font-style:italic></span>    List<span style=color:#666>&lt;</span>Long<span style=color:#666>&gt;</span> result <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>().</span><span style=color:#7d9029>bitField</span><span style=color:#666>(</span>
            key<span style=color:#666>,</span>
            BitFieldSubCommands<span style=color:#666>.</span><span style=color:#7d9029>create</span><span style=color:#666>()</span>
                    <span style=color:#666>.</span><span style=color:#7d9029>get</span><span style=color:#666>(</span>BitFieldSubCommands<span style=color:#666>.</span><span style=color:#7d9029>BitFieldType</span><span style=color:#666>.</span><span style=color:#7d9029>unsigned</span><span style=color:#666>(</span>dayOfMonth<span style=color:#666>)).</span><span style=color:#7d9029>valueAt</span><span style=color:#666>(</span>0<span style=color:#666>)</span>
    <span style=color:#666>);</span>
    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>result <span style=color:#666>==</span> <span style=color:green;font-weight:700>null</span> <span style=color:#666>||</span> result<span style=color:#666>.</span><span style=color:#7d9029>isEmpty</span><span style=color:#666>())</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 没有任何签到结果
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>0<span style=color:#666>);</span>
    <span style=color:#666>}</span>
    Long num <span style=color:#666>=</span> result<span style=color:#666>.</span><span style=color:#7d9029>get</span><span style=color:#666>(</span>0<span style=color:#666>);</span>
    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>num <span style=color:#666>==</span> <span style=color:green;font-weight:700>null</span> <span style=color:#666>||</span> num <span style=color:#666>==</span> 0<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>0<span style=color:#666>);</span>
    <span style=color:#666>}</span>
    <span style=color:#408080;font-style:italic>// 6.循环遍历
</span><span style=color:#408080;font-style:italic></span>    <span style=color:#b00040>int</span> count <span style=color:#666>=</span> 0<span style=color:#666>;</span>
    <span style=color:green;font-weight:700>while</span> <span style=color:#666>(</span><span style=color:green;font-weight:700>true</span><span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 6.1.让这个数字与1做与运算，得到数字的最后一个bit位  // 判断这个bit位是否为0
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>((</span>num <span style=color:#666>&amp;</span> 1<span style=color:#666>)</span> <span style=color:#666>==</span> 0<span style=color:#666>)</span> <span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>// 如果为0，说明未签到，结束
</span><span style=color:#408080;font-style:italic></span>            <span style=color:green;font-weight:700>break</span><span style=color:#666>;</span>
        <span style=color:#666>}</span><span style=color:green;font-weight:700>else</span> <span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>// 如果不为0，说明已签到，计数器+1
</span><span style=color:#408080;font-style:italic></span>            count<span style=color:#666>++;</span>
        <span style=color:#666>}</span>
        <span style=color:#408080;font-style:italic>// 把数字右移一位，抛弃最后一个bit位，继续下一个bit位
</span><span style=color:#408080;font-style:italic></span>        num <span style=color:#666>&gt;&gt;&gt;=</span> 1<span style=color:#666>;</span>
        
    <span style=color:#666>}</span>
    <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>count<span style=color:#666>);</span>
<span style=color:#666>}</span>
</code></pre></div><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>num <span style=color:#666>&lt;&lt;</span> 1<span style=color:#666>;</span> <span style=color:#408080;font-style:italic>// 左移运算符，num &lt;&lt; 1,相当于num乘以2
</span><span style=color:#408080;font-style:italic></span>num <span style=color:#666>&gt;&gt;</span> 1<span style=color:#666>;</span> <span style=color:#408080;font-style:italic>//右移运算符，num &gt;&gt; 1,相当于num除以2
</span><span style=color:#408080;font-style:italic></span>num <span style=color:#666>&gt;&gt;&gt;</span> 1<span style=color:#666>;</span> <span style=color:#408080;font-style:italic>//无符号右移，忽略符号位，空位都以0补齐
</span><span style=color:#408080;font-style:italic></span><span style=color:#666>&gt;&gt;&gt;</span>num
其中<span>，</span><span style=color:#666>&gt;&gt;&gt;</span>num<span>，</span>是无符号右移操作符<span>，</span><span style=color:#666>&gt;&gt;&gt;</span>3表示无符号右移三位<span>，</span>无符号则在二进制码前面的空缺位补0<span>。</span>
<span style=color:#666>&gt;&gt;</span>num
对于<span style=color:#666>&gt;&gt;</span>num<span>，</span>是有符号右移操作符<span>。</span>对于正数<span>，</span>右移num位后在前面的空缺位补0<span>，</span>对于负数<span>，</span>右移num位后在前面补1
</code></pre></div><h3 id=114-额外加餐-关于使用bitmap来解决缓存穿透的方案>11.4 额外加餐-关于使用bitmap来解决缓存穿透的方案<a href=#114-额外加餐-关于使用bitmap来解决缓存穿透的方案 class=header-anchor arialabel=Anchor> #</a></h3><p>回顾<strong>缓存穿透</strong>：</p><p>发起了一个数据库不存在的，redis里边也不存在的数据，通常你可以把他看成一个攻击</p><p>解决方案：</p><ul><li><p>判断id&lt;0</p></li><li><p>如果数据库是空，那么就可以直接往redis里边把这个空数据缓存起来</p></li></ul><p>第一种解决方案：遇到的问题是如果用户访问的是id不存在的数据，则此时就无法生效</p><p>第二种解决方案：遇到的问题是：如果是不同的id那就可以防止下次过来直击数据</p><p>所以我们如何解决呢？</p><p>我们可以将数据库的数据，所对应的id写入到一个list集合中，当用户过来访问的时候，我们直接去判断list中是否包含当前的要查询的数据，如果说用户要查询的id数据并不在list集合中，则直接返回，如果list中包含对应查询的id数据，则说明不是一次缓存穿透数据，则直接放行。</p><p>现在的问题是这个主键其实并没有那么短，而是很长的一个 主键</p><p>哪怕你单独去提取这个主键，但是在11年左右，淘宝的商品总量就已经超过10亿个</p><p>所以如果采用以上方案，这个list也会很大，所以我们可以使用bitmap来减少list的存储空间</p><p>我们可以把list数据抽象成一个非常大的bitmap，我们不再使用list，而是将db中的id数据利用哈希思想，比如：</p><p>id % bitmap.size = 算出当前这个id对应应该落在bitmap的哪个索引上，然后将这个值从0变成1，然后当用户来查询数据时，此时已经没有了list，让用户用他查询的id去用相同的哈希算法， 算出来当前这个id应当落在bitmap的哪一位，然后判断这一位是0，还是1，如果是0则表明这一位上的数据一定不存在， 采用这种方式来处理，需要重点考虑一个事情，就是误差率，所谓的误差率就是指当发生哈希冲突的时候，产生的误差。</p><h2 id=12uv统计>12、UV统计<a href=#12uv统计 class=header-anchor arialabel=Anchor> #</a></h2><h3 id=121-uv统计-hyperloglog>12.1 、UV统计-HyperLogLog<a href=#121-uv统计-hyperloglog class=header-anchor arialabel=Anchor> #</a></h3><p>首先我们搞懂两个概念：</p><ul><li>UV：全称Unique Visitor，也叫独立访客量，是指通过互联网访问、浏览这个网页的自然人。1天内同一个用户多次访问该网站，只记录1次。</li><li>PV：全称Page View，也叫页面访问量或点击量，用户每访问网站的一个页面，记录1次PV，用户多次打开页面，则记录多次PV。往往用来衡量网站的流量。</li></ul><p>通常来说UV会比PV大很多，所以衡量同一个网站的访问量，我们需要综合考虑很多因素，所以我们只是单纯的把这两个值作为一个参考值</p><p>UV统计在服务端做会比较麻烦，因为要判断该用户是否已经统计过了，需要将统计过的用户信息保存。但是如果每个访问的用户都保存到Redis中，数据量会非常恐怖，那怎么处理呢？</p><p>Hyperloglog(HLL)是从Loglog算法派生的概率算法，用于确定非常大的集合的基数，而不需要存储其所有值。相关算法原理大家可以参考：https://juejin.cn/post/6844903785744056333#heading-0
Redis中的HLL是基于string结构实现的，单个HLL的内存<strong>永远小于16kb</strong>，<strong>内存占用低</strong>的令人发指！作为代价，其测量结果是概率性的，<strong>有小于0.81％的误差</strong>。不过对于UV统计来说，这完全可以忽略。</p><p>UV 统计在服务器端比较麻烦，因为要判断该用户是否已经统计过了，需要将统计过的用户信息保存；但是如果所有访问过该网站的用户都保存到 Redis 中，数据量会十分大。</p><blockquote><p>HyperLogLog（HLL） 用于确定非常大的集合的基数，而不需要存储其所有值。</p></blockquote><blockquote><p>基数：假设数据集 {1,3,5,7,5,7,8}，那么这个数据集的基数集为 {1,3,5,7,8}，基数（不重复的元素）为 5。
Redis 中的 HyperLogLog 是基于 String 数据结构实现的，单个 HLL 的内存永远小于 16 KB，内存占用非常非常低。
但是它的测量存在小于 0.81% 的误差，不过对于 UV 统计而言，几乎可以忽略。</p></blockquote><pre><code>192.168.8.130:6379&gt; PFADD hl1 e1 e2 e3 e4 e5
(integer) 1
192.168.8.130:6379&gt; PFCOUNT hl1
(integer) 5
192.168.8.130:6379&gt; PFADD hl1 e1 e2 e3 e4 e5
(integer) 0
192.168.8.130:6379&gt; PFCOUNT hl1
(integer) 5
192.168.8.130:6379&gt; 
意思是过滤复制

127.0.0.1:6379&gt; pfadd set1 e1 e2 e3 e4 e5
(integer) 1
127.0.0.1:6379&gt; pfadd set2 e4 e5 e6 e7 e8
(integer) 1
# 合并 set1 set2 得到并集 set3
127.0.0.1:6379&gt; pfmerge set3 set1 set2
OK
127.0.0.1:6379&gt; pfcount set3
(integer) 8

</code></pre><h3 id=122-uv统计-测试百万数据的统计>12.2 UV统计-测试百万数据的统计<a href=#122-uv统计-测试百万数据的统计 class=header-anchor arialabel=Anchor> #</a></h3><p>测试思路：我们直接利用单元测试，向HyperLogLog中添加100万条数据，看看内存占用和统计效果如何</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@Test</span>
<span style=color:#b00040>void</span> <span style=color:#00f>millionDataHyperLogLogTest</span><span style=color:#666>()</span> <span style=color:#666>{</span>
    String<span style=color:#666>[]</span> users <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> String<span style=color:#666>[</span>1000<span style=color:#666>];</span>
    <span style=color:#b00040>int</span> j <span style=color:#666>=</span> 0<span style=color:#666>;</span>
    <span style=color:green;font-weight:700>for</span> <span style=color:#666>(</span><span style=color:#b00040>int</span> i <span style=color:#666>=</span> 0<span style=color:#666>;</span> i <span style=color:#666>&lt;</span> 1000000<span style=color:#666>;</span> i<span style=color:#666>++)</span> <span style=color:#666>{</span>
        j <span style=color:#666>=</span> i <span style=color:#666>%</span> 1000<span style=color:#666>;</span>
        users<span style=color:#666>[</span>j<span style=color:#666>]</span> <span style=color:#666>=</span> <span style=color:#ba2121>&#34;user_&#34;</span> <span style=color:#666>+</span> i<span style=color:#666>;</span>
        <span style=color:#408080;font-style:italic>// 分批导入，每 1000 条数据写入一次
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>j <span style=color:#666>==</span> 999<span style=color:#666>)</span> <span style=color:#666>{</span>
            stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForHyperLogLog</span><span style=color:#666>().</span><span style=color:#7d9029>add</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;hll&#34;</span><span style=color:#666>,</span> users<span style=color:#666>);</span>
        <span style=color:#666>}</span>
    <span style=color:#666>}</span>
    Long hllSize <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForHyperLogLog</span><span style=color:#666>().</span><span style=color:#7d9029>size</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;hll&#34;</span><span style=color:#666>);</span>
    System<span style=color:#666>.</span><span style=color:#7d9029>out</span><span style=color:#666>.</span><span style=color:#7d9029>println</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;size = &#34;</span> <span style=color:#666>+</span> hllSize<span style=color:#666>);</span>    <span style=color:#408080;font-style:italic>// size = 997593
</span><span style=color:#408080;font-style:italic></span><span style=color:#666>}</span>

</code></pre></div><blockquote><ul><li>测试之前 和 测试之后的内存占用：1106056 、1118960；</li><li>HyperLogLog 占用内存：<code>(1118960 - 1106056) / 1024 = 12.6KB</code></li></ul></blockquote><p>经过测试：我们会发生他的误差是在允许范围内，并且内存占用极小</p><h3 id=项目的总结>项目的总结<a href=#项目的总结 class=header-anchor arialabel=Anchor> #</a></h3><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>src
<span>├──</span> main
<span>│</span>   <span>├──</span> java
<span>│</span>   <span>│</span>   <span>└──</span> com
Comment
<span>├──</span> config <span>：</span>存放项目依赖相关配置<span>；</span>
<span>│</span>   <span>├──</span> LocalDateTimeSerializerConfig<span style=color:#666>.</span><span style=color:#7d9029>java</span> <span>：</span>解决 Json timestamp 转 LocalDateTime 的报错问题<span>；</span>
<span>│</span>   <span>├──</span> MybatisPlusConfiguration<span style=color:#666>.</span><span style=color:#7d9029>java</span> <span>：</span>配置 MyBatis Plus 分页插件<span>；</span>
<span>│</span>   <span>├──</span> RedisConfiguration<span style=color:#666>.</span><span style=color:#7d9029>java</span> <span>：</span>创建单例 Redisson 客户端<span>；</span>
<span>│</span>   <span>├──</span> WebExceptionAdvice<span style=color:#666>.</span><span style=color:#7d9029>java</span> <span>：</span>全局响应拦截器<span>；</span>
<span>│</span>   <span>└──</span> WebMvcConfiguration<span style=color:#666>.</span><span style=color:#7d9029>java</span> <span>：</span>配置了登录<span>、</span>自动刷新登录 Token 的拦截器<span>。</span>
<span>│</span>
<span>├──</span> controller <span>：</span>存放 Restful 风格的 API 接口<span>；</span>
<span>│</span>
<span>├──</span> dto <span>：</span>存放业务封装类<span>，</span>如 Result 通用响应封装<span>（</span>不推荐学习它的写法<span>）；</span>
<span>│</span>
<span>├──</span> entity <span>：</span>存放和数据库对应的 Java POJO<span>；</span>
<span>│</span>
<span>├──</span> interceptor <span>：</span>登录拦截器 <span style=color:#666>&amp;</span> 自动刷新 Redis 登录 Token 有效期<span>；</span>
<span>│</span>
<span>├──</span> mapper <span>：</span>存放操作数据库的代码<span>；</span>
<span>│</span>
<span>├──</span> service <span>：</span>存放业务逻辑处理代码<span>；</span>
<span>│</span>   <span>├──</span> BlogCommentsService<span style=color:#666>.</span><span style=color:#7d9029>java</span>
<span>│</span>   <span>├──</span> BlogService<span style=color:#666>.</span><span style=color:#7d9029>java</span> <span>：</span> 基于 Redis 实现点赞<span>、</span>按时间排序的点赞排行榜<span>；</span>基于 Redis 实现拉模式的 Feed 流<span>；</span>
<span>│</span>   <span>├──</span> FollowService<span style=color:#666>.</span><span style=color:#7d9029>java</span> <span>：</span>基于 Redis 集合实现关注<span>、</span>共同关注<span>；</span>
<span>│</span>   <span>├──</span> ShopService<span style=color:#666>.</span><span style=color:#7d9029>java</span> <span>：</span> 基于 Redis 缓存优化店铺查询性能<span>；</span>基于 Redis GEO 实现附近店铺按距离排序<span>；</span>
<span>│</span>   <span>├──</span> UserService<span style=color:#666>.</span><span style=color:#7d9029>java</span> <span>：</span> 基于 Redis 实现短信登录<span>（</span>分布式 Session<span>）；</span>
<span>│</span>   <span>├──</span> VoucherOrderService<span style=color:#666>.</span><span style=color:#7d9029>java</span> <span>：</span>基于 Redis 分布式锁<span>、</span>Redis <span style=color:#666>+</span> Lua 两种方式<span>，</span>结合消息队列<span>，</span>共同实现了秒杀和一人一单功能<span>；</span>
<span>│</span>   <span>├──</span> VoucherService<span style=color:#666>.</span><span style=color:#7d9029>java</span> <span>：</span>添加优惠券<span>，</span>并将库存保存在 Redis 中<span>，</span>为秒杀做准备<span>。</span>
<span>│</span>
<span>└──</span> utils <span>：</span>存放项目内通用的工具类<span>；</span>
    <span>├──</span> CacheClient<span style=color:#666>.</span><span style=color:#7d9029>java</span> <span>：</span>封装了通用的缓存工具类<span>，</span>涉及泛型<span>、</span>函数式编程等知识点<span>；</span>
    <span>├──</span> DistributedLock<span style=color:#666>.</span><span style=color:#7d9029>java</span>
    <span>├──</span> RedisConstants<span style=color:#666>.</span><span style=color:#7d9029>java</span> <span>：</span>保存项目中用到的 Redis 键<span>、</span>过期时间等常量<span>；</span>
    <span>├──</span> RedisData<span style=color:#666>.</span><span style=color:#7d9029>java</span>
    <span>├──</span> RedisIdWorker<span style=color:#666>.</span><span style=color:#7d9029>java</span> <span>：</span>基于 Redis 的全局唯一自增 ID 生成器<span>；</span>
    <span>├──</span> SimpleDistributedLockBasedOnRedis<span style=color:#666>.</span><span style=color:#7d9029>java</span> <span>：</span>简单的 Redis 锁实现<span>，</span>了解即可<span>，</span>一般用 Redisson<span>；</span>
    <span>└──</span> UserHolder<span style=color:#666>.</span><span style=color:#7d9029>java</span> <span>：</span>线程内缓存用户信息<span>。</span>

</code></pre></div><h2 id=完整代码>完整代码<a href=#完整代码 class=header-anchor arialabel=Anchor> #</a></h2><h3 id=userdto>UserDto<a href=#userdto class=header-anchor arialabel=Anchor> #</a></h3><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JAVA data-lang=JAVA><span style=color:green;font-weight:700>package</span> <span style=color:#00f;font-weight:700>com.hmdp.dto</span><span style=color:#666>;</span>
<span style=color:green;font-weight:700>import</span> <span style=color:#00f;font-weight:700>lombok.Data</span><span style=color:#666>;</span>
<span style=color:#a2f>@Data</span>
<span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>UserDTO</span> <span style=color:#666>{</span>
    <span style=color:green;font-weight:700>private</span> Long id<span style=color:#666>;</span>
    <span style=color:green;font-weight:700>private</span> String nickName<span style=color:#666>;</span>
    <span style=color:green;font-weight:700>private</span> String icon<span style=color:#666>;</span>
<span style=color:#666>}</span>
</code></pre></div><h3 id=user>User<a href=#user class=header-anchor arialabel=Anchor> #</a></h3><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@Data</span>
<span style=color:#a2f>@EqualsAndHashCode</span><span style=color:#666>(</span>callSuper <span style=color:#666>=</span> <span style=color:green;font-weight:700>false</span><span style=color:#666>)</span>
<span style=color:#a2f>@Accessors</span><span style=color:#666>(</span>chain <span style=color:#666>=</span> <span style=color:green;font-weight:700>true</span><span style=color:#666>)</span>
<span style=color:#a2f>@TableName</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;tb_user&#34;</span><span style=color:#666>)</span>
<span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>User</span> <span style=color:green;font-weight:700>implements</span> Serializable <span style=color:#666>{</span>

    <span style=color:green;font-weight:700>private</span> <span style=color:green;font-weight:700>static</span> <span style=color:green;font-weight:700>final</span> <span style=color:#b00040>long</span> serialVersionUID <span style=color:#666>=</span> 1L<span style=color:#666>;</span>
    <span style=color:#408080;font-style:italic>/**
</span><span style=color:#408080;font-style:italic>     * 主键
</span><span style=color:#408080;font-style:italic>     */</span>
    <span style=color:#a2f>@TableId</span><span style=color:#666>(</span>value <span style=color:#666>=</span> <span style=color:#ba2121>&#34;id&#34;</span><span style=color:#666>,</span> type <span style=color:#666>=</span> IdType<span style=color:#666>.</span><span style=color:#7d9029>AUTO</span><span style=color:#666>)</span>
    <span style=color:green;font-weight:700>private</span> Long id<span style=color:#666>;</span>
    <span style=color:#408080;font-style:italic>/**
</span><span style=color:#408080;font-style:italic>     * 手机号码
</span><span style=color:#408080;font-style:italic>     */</span>
    <span style=color:green;font-weight:700>private</span> String phone<span style=color:#666>;</span>
    <span style=color:#408080;font-style:italic>/**
</span><span style=color:#408080;font-style:italic>     * 密码，加密存储
</span><span style=color:#408080;font-style:italic>     */</span>
    <span style=color:green;font-weight:700>private</span> String password<span style=color:#666>;</span>
    <span style=color:#408080;font-style:italic>/**
</span><span style=color:#408080;font-style:italic>     * 昵称，默认是随机字符
</span><span style=color:#408080;font-style:italic>     */</span>
    <span style=color:green;font-weight:700>private</span> String nickName<span style=color:#666>;</span>
    <span style=color:#408080;font-style:italic>/**
</span><span style=color:#408080;font-style:italic>     * 用户头像
</span><span style=color:#408080;font-style:italic>     */</span>
    <span style=color:green;font-weight:700>private</span> String icon <span style=color:#666>=</span> <span style=color:#ba2121>&#34;&#34;</span><span style=color:#666>;</span>
    <span style=color:#408080;font-style:italic>/**
</span><span style=color:#408080;font-style:italic>     * 创建时间
</span><span style=color:#408080;font-style:italic>     */</span>
    <span style=color:green;font-weight:700>private</span> LocalDateTime createTime<span style=color:#666>;</span>
    <span style=color:#408080;font-style:italic>/**
</span><span style=color:#408080;font-style:italic>     * 更新时间
</span><span style=color:#408080;font-style:italic>     */</span>
    <span style=color:green;font-weight:700>private</span> LocalDateTime updateTime<span style=color:#666>;</span>
<span style=color:#666>}</span>
</code></pre></div><h3 id=userholder>UserHolder<a href=#userholder class=header-anchor arialabel=Anchor> #</a></h3><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>UserHolder</span> <span style=color:#666>{</span>
    <span style=color:green;font-weight:700>private</span> <span style=color:green;font-weight:700>static</span> <span style=color:green;font-weight:700>final</span> ThreadLocal<span style=color:#666>&lt;</span>UserDTO<span style=color:#666>&gt;</span> tl <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> ThreadLocal<span style=color:#666>&lt;&gt;();</span>

    <span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>static</span> <span style=color:#b00040>void</span> <span style=color:#00f>saveUser</span><span style=color:#666>(</span>UserDTO user<span style=color:#666>){</span>
        tl<span style=color:#666>.</span><span style=color:#7d9029>set</span><span style=color:#666>(</span>user<span style=color:#666>);</span>
    <span style=color:#666>}</span>

    <span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>static</span> UserDTO <span style=color:#00f>getUser</span><span style=color:#666>(){</span>
        <span style=color:green;font-weight:700>return</span> tl<span style=color:#666>.</span><span style=color:#7d9029>get</span><span style=color:#666>();</span>
    <span style=color:#666>}</span>

    <span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>static</span> <span style=color:#b00040>void</span> <span style=color:#00f>removeUser</span><span style=color:#666>(){</span>
        tl<span style=color:#666>.</span><span style=color:#7d9029>remove</span><span style=color:#666>();</span>
    <span style=color:#666>}</span>
<span style=color:#666>}</span>
</code></pre></div><h3 id=regexutils>RegexUtils<a href=#regexutils class=header-anchor arialabel=Anchor> #</a></h3><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>mport cn<span style=color:#666>.</span><span style=color:#7d9029>hutool</span><span style=color:#666>.</span><span style=color:#7d9029>core</span><span style=color:#666>.</span><span style=color:#7d9029>util</span><span style=color:#666>.</span><span style=color:#7d9029>StrUtil</span><span style=color:#666>;</span>
<span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>RegexUtils</span> <span style=color:#666>{</span>
    <span style=color:#408080;font-style:italic>/**
</span><span style=color:#408080;font-style:italic>     * 是否是无效手机格式
</span><span style=color:#408080;font-style:italic>     * @param phone 要校验的手机号
</span><span style=color:#408080;font-style:italic>     * @return true:符合，false：不符合
</span><span style=color:#408080;font-style:italic>     */</span>
    <span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>static</span> <span style=color:#b00040>boolean</span> <span style=color:#00f>isPhoneInvalid</span><span style=color:#666>(</span>String phone<span style=color:#666>){</span>
        <span style=color:green;font-weight:700>return</span> mismatch<span style=color:#666>(</span>phone<span style=color:#666>,</span> RegexPatterns<span style=color:#666>.</span><span style=color:#7d9029>PHONE_REGEX</span><span style=color:#666>);</span>
    <span style=color:#666>}</span>
    <span style=color:#408080;font-style:italic>/**
</span><span style=color:#408080;font-style:italic>     * 是否是无效邮箱格式
</span><span style=color:#408080;font-style:italic>     * @param email 要校验的邮箱
</span><span style=color:#408080;font-style:italic>     * @return true:符合，false：不符合
</span><span style=color:#408080;font-style:italic>     */</span>
    <span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>static</span> <span style=color:#b00040>boolean</span> <span style=color:#00f>isEmailInvalid</span><span style=color:#666>(</span>String email<span style=color:#666>){</span>
        <span style=color:green;font-weight:700>return</span> mismatch<span style=color:#666>(</span>email<span style=color:#666>,</span> RegexPatterns<span style=color:#666>.</span><span style=color:#7d9029>EMAIL_REGEX</span><span style=color:#666>);</span>
    <span style=color:#666>}</span>

    <span style=color:#408080;font-style:italic>/**
</span><span style=color:#408080;font-style:italic>     * 是否是无效验证码格式
</span><span style=color:#408080;font-style:italic>     * @param code 要校验的验证码
</span><span style=color:#408080;font-style:italic>     * @return true:符合，false：不符合
</span><span style=color:#408080;font-style:italic>     */</span>
    <span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>static</span> <span style=color:#b00040>boolean</span> <span style=color:#00f>isCodeInvalid</span><span style=color:#666>(</span>String code<span style=color:#666>){</span>
        <span style=color:green;font-weight:700>return</span> mismatch<span style=color:#666>(</span>code<span style=color:#666>,</span> RegexPatterns<span style=color:#666>.</span><span style=color:#7d9029>VERIFY_CODE_REGEX</span><span style=color:#666>);</span>
    <span style=color:#666>}</span>

    <span style=color:#408080;font-style:italic>// 校验是否不符合正则格式
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>private</span> <span style=color:green;font-weight:700>static</span> <span style=color:#b00040>boolean</span> <span style=color:#00f>mismatch</span><span style=color:#666>(</span>String str<span style=color:#666>,</span> String regex<span style=color:#666>){</span>
        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>StrUtil<span style=color:#666>.</span><span style=color:#7d9029>isBlank</span><span style=color:#666>(</span>str<span style=color:#666>))</span> <span style=color:#666>{</span>
            <span style=color:green;font-weight:700>return</span> <span style=color:green;font-weight:700>true</span><span style=color:#666>;</span>
        <span style=color:#666>}</span>
        <span style=color:green;font-weight:700>return</span> <span style=color:#666>!</span>str<span style=color:#666>.</span><span style=color:#7d9029>matches</span><span style=color:#666>(</span>regex<span style=color:#666>);</span>
    <span style=color:#666>}</span>
<span style=color:#666>}</span>
</code></pre></div><h3 id=result>Result<a href=#result class=header-anchor arialabel=Anchor> #</a></h3><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@Data</span>
<span style=color:#a2f>@NoArgsConstructor</span>
<span style=color:#a2f>@AllArgsConstructor</span>
<span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>Result</span> <span style=color:#666>{</span>
    <span style=color:green;font-weight:700>private</span> Boolean success<span style=color:#666>;</span>
    <span style=color:green;font-weight:700>private</span> String errorMsg<span style=color:#666>;</span>
    <span style=color:green;font-weight:700>private</span> Object data<span style=color:#666>;</span>
    <span style=color:green;font-weight:700>private</span> Long total<span style=color:#666>;</span>

    <span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>static</span> Result <span style=color:#00f>ok</span><span style=color:#666>(){</span>
        <span style=color:green;font-weight:700>return</span> <span style=color:green;font-weight:700>new</span> Result<span style=color:#666>(</span><span style=color:green;font-weight:700>true</span><span style=color:#666>,</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>,</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>,</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>);</span>
    <span style=color:#666>}</span>
    <span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>static</span> Result <span style=color:#00f>ok</span><span style=color:#666>(</span>Object data<span style=color:#666>){</span>
        <span style=color:green;font-weight:700>return</span> <span style=color:green;font-weight:700>new</span> Result<span style=color:#666>(</span><span style=color:green;font-weight:700>true</span><span style=color:#666>,</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>,</span> data<span style=color:#666>,</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>);</span>
    <span style=color:#666>}</span>
    <span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>static</span> Result <span style=color:#00f>ok</span><span style=color:#666>(</span>List<span style=color:#666>&lt;?&gt;</span> data<span style=color:#666>,</span> Long total<span style=color:#666>){</span>
        <span style=color:green;font-weight:700>return</span> <span style=color:green;font-weight:700>new</span> Result<span style=color:#666>(</span><span style=color:green;font-weight:700>true</span><span style=color:#666>,</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>,</span> data<span style=color:#666>,</span> total<span style=color:#666>);</span>
    <span style=color:#666>}</span>
    <span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>static</span> Result <span style=color:#00f>fail</span><span style=color:#666>(</span>String errorMsg<span style=color:#666>){</span>
        <span style=color:green;font-weight:700>return</span> <span style=color:green;font-weight:700>new</span> Result<span style=color:#666>(</span><span style=color:green;font-weight:700>false</span><span style=color:#666>,</span> errorMsg<span style=color:#666>,</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>,</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>);</span>
    <span style=color:#666>}</span>
<span style=color:#666>}</span>

</code></pre></div><h3 id=loginformdto>LoginFormDTO<a href=#loginformdto class=header-anchor arialabel=Anchor> #</a></h3><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@Data</span>
<span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>LoginFormDTO</span> <span style=color:#666>{</span>
    <span style=color:green;font-weight:700>private</span> String phone<span style=color:#666>;</span>
    <span style=color:green;font-weight:700>private</span> String code<span style=color:#666>;</span>
    <span style=color:green;font-weight:700>private</span> String password<span style=color:#666>;</span>
<span style=color:#666>}</span>

</code></pre></div><h2 id=代码总思路>代码总思路<a href=#代码总思路 class=header-anchor arialabel=Anchor> #</a></h2><h2 id=1redis实现验证码缓存token更新>1.redis实现验证码缓存，token更新<a href=#1redis实现验证码缓存token更新 class=header-anchor arialabel=Anchor> #</a></h2><blockquote><ol><li>验证码存入redis中（phone,code）</li><li>验证码成功，进行token(token,map(user))</li><li>第一个拦截器拦截所有路径，从请求头获取toekn,更新toekn(携带的用户保存)，都放行</li><li>第二个拦截器特定路径，判断有用户就放行</li></ol></blockquote><h2 id=2商铺缓存>2.商铺缓存<a href=#2商铺缓存 class=header-anchor arialabel=Anchor> #</a></h2><blockquote><p>1.缓存的更新：<strong>内存淘汰</strong>，<strong>超时剔除</strong> ，<strong>主动更新</strong></p><p>2.主动更新：</p><table><thead><tr><th>Cache Aside Pattern</th><th>Read/Write Through Pattern</th><th>Write Behind Catching Pattern</th></tr></thead><tbody><tr><td>由缓存的调用者，在更新数据库的同时更新缓存</td><td>缓存与数据库整合为一个服务，由服务来维护一致性。调用者使用该服务，无需关心缓存一致性问题。</td><td>调用者只凑走缓存，由其他线程异步的将缓存数据持久到数据库中，保证最终一致性。</td></tr></tbody></table></blockquote><blockquote><p>3.选择删除缓存，先更新数据库，再删除缓存</p><ul><li>更新缓存：每次更新数据库时都更新缓存，无效写操作较多</li><li>删除缓存：每次更新数据库时都让缓存失效，查询时再更新缓存。
如何保证缓存和数据库的操作同时成功或失败？</li><li>单体系统：将缓存与数据库操作放在一个事务；</li><li>分布式系统：利用 TCC 等分布式事务方案。</li><li>先删除缓存，再操作数据库；</li></ul></blockquote><blockquote><p>4.缓存更新策略的最佳实践方案</p><ul><li>低一致性需求：使用 Redis 自带的内存淘汰机制；</li><li>高一致性需求：使用主动更新策略，并以超时剔除作为兜底方案。
读操作：</li><li>缓存命中则直接返回；</li><li>缓存未命中则查询数据库，并写入缓存，设定超时时间。
写操作：</li><li>先写数据库，然后再删缓存；</li><li>确保数据库与缓存操作的原子性。</li></ul><p>5.再shop的更新时候删除缓存</p></blockquote><h2 id=3缓存穿透缓存雪崩缓存击穿>3.缓存穿透，缓存雪崩，缓存击穿<a href=#3缓存穿透缓存雪崩缓存击穿 class=header-anchor arialabel=Anchor> #</a></h2><blockquote><p>1.缓存穿透</p><blockquote><p>缓存穿透：查询某个 Key 对应的数据，Redis 缓存中没有相应的数据，则直接到数据库中查询；数据库中也不存在要查询的数据，数据库会返回空，Redis 也不会缓存这个空结果；导致每次通过这个 Key 查询数据都会直接到数据库中查询。给数据库带来巨大的压力，可能最终会导致数据库崩溃。</p></blockquote><blockquote><p>Redis 缓存穿透的两种方法</p></blockquote><ul><li>缓存空对象：发送请求，未命中缓存，未命中数据库，为了防止不断的请求，将 null 缓存到 Redis 中；之后的请求将会直接命中 Redis 缓存中的 null 值。<ul><li>实现简单，维护方便；</li><li>缓存中包含过多的 null 值，会造成额外的内存消耗（可以设置 TTL 解决）；</li><li>可能造成短期的不一致（可以通过 先操作数据库，后删除缓存 解决）。</li></ul></li><li>布隆过滤：<ul><li>内存占用较少，没有多余的 key；</li><li>实现复杂；</li><li>存在误判的可能。</li></ul></li></ul><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@Override</span>
<span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>queryById</span><span style=color:#666>(</span>Long id<span style=color:#666>)</span> <span style=color:#666>{</span>
    <span style=color:#408080;font-style:italic>// 缓存穿透
</span><span style=color:#408080;font-style:italic></span>    Shop shop <span style=color:#666>=</span> dealWithCachePenetrationByNullValue<span style=color:#666>(</span>id<span style=color:#666>);</span>
    <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>shop<span style=color:#666>);</span>
<span style=color:#666>}</span>

<span style=color:#408080;font-style:italic>/**
</span><span style=color:#408080;font-style:italic> * 通过缓存空对象解决 Redis 的缓存穿透问题
</span><span style=color:#408080;font-style:italic> */</span>
<span style=color:green;font-weight:700>public</span> Shop <span style=color:#00f>dealWithCachePenetrationByNullValue</span><span style=color:#666>(</span>Long id<span style=color:#666>)</span> <span style=color:#666>{</span>
    String key <span style=color:#666>=</span> CACHE_SHOP_KEY <span style=color:#666>+</span> id<span style=color:#666>;</span>
    
  	<span style=color:#408080;font-style:italic>// 1. 从 Redis 中查询店铺缓存；
</span><span style=color:#408080;font-style:italic></span>    String shopJson <span style=color:#666>=</span> redisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>().</span><span style=color:#7d9029>get</span><span style=color:#666>(</span>key<span style=color:#666>);</span>
    
  	<span style=color:#408080;font-style:italic>// 2. 若 Redis 中存在（命中），则将其转换为 Java 对象后返回；
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>StrUtil<span style=color:#666>.</span><span style=color:#7d9029>isNotBlank</span><span style=color:#666>(</span>shopJson<span style=color:#666>))</span> <span style=color:#666>{</span>
        Shop shop <span style=color:#666>=</span> JSONUtil<span style=color:#666>.</span><span style=color:#7d9029>toBean</span><span style=color:#666>(</span>shopJson<span style=color:#666>,</span> Shop<span style=color:#666>.</span><span style=color:#7d9029>class</span><span style=color:#666>);</span>
        <span style=color:green;font-weight:700>return</span> shop<span style=color:#666>;</span>
    <span style=color:#666>}</span>
    
  	<span style=color:#408080;font-style:italic>// 3. 命中缓存后判断是否为空值
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>ObjectUtil<span style=color:#666>.</span><span style=color:#7d9029>equals</span><span style=color:#666>(</span>shopJson<span style=color:#666>,</span> <span style=color:#ba2121>&#34;&#34;</span><span style=color:#666>))</span> <span style=color:#666>{</span>
        <span style=color:green;font-weight:700>return</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>;</span>
    <span style=color:#666>}</span>
    
  	<span style=color:#408080;font-style:italic>// 4. 若 Redis 中不存在（未命中），则根据 id 从数据库中查询；
</span><span style=color:#408080;font-style:italic></span>    Shop shop <span style=color:#666>=</span> getById<span style=color:#666>(</span>id<span style=color:#666>);</span>
    
  	<span style=color:#408080;font-style:italic>// 5. 若 数据库 中不存在，将空值写入 Redis（缓存空对象）
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>shop <span style=color:#666>==</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
        redisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>().</span><span style=color:#7d9029>set</span><span style=color:#666>(</span>key<span style=color:#666>,</span> <span style=color:#ba2121>&#34;&#34;</span><span style=color:#666>,</span> TTL_TWO<span style=color:#666>,</span> TimeUnit<span style=color:#666>.</span><span style=color:#7d9029>MINUTES</span><span style=color:#666>);</span>
        <span style=color:green;font-weight:700>return</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>;</span>
    <span style=color:#666>}</span>
  	
    <span style=color:#408080;font-style:italic>// 6. 若 数据库 中存在，则将其返回并存入 Redis 缓存中。
</span><span style=color:#408080;font-style:italic></span>    redisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>().</span><span style=color:#7d9029>set</span><span style=color:#666>(</span>key<span style=color:#666>,</span> JSONUtil<span style=color:#666>.</span><span style=color:#7d9029>toJsonStr</span><span style=color:#666>(</span>shop<span style=color:#666>),</span> TTL_THIRTY<span style=color:#666>,</span> TimeUnit<span style=color:#666>.</span><span style=color:#7d9029>MINUTES</span><span style=color:#666>);</span>
    <span style=color:green;font-weight:700>return</span> shop<span style=color:#666>;</span>
<span style=color:#666>}</span>
</code></pre></div></blockquote><blockquote><p>2.缓存雪崩：</p><blockquote><p>缓存雪崩：大量的 Key 在同一时间内大面积的失效 或者 Redis 服务宕机，导致后面的请求直接打到数据库，造成数据库短时间内承受大量的请求。</p></blockquote><p>解决方案：</p><ul><li>给不同的 Key 的 TTL 添加随机值，避免同时失效；</li><li>利用 Redis 集群提高服务的可用性；</li><li>给缓存业务添加降级限流策略；</li><li>给业务添加多级缓存。</li></ul><p>3.缓存击穿</p><blockquote><p>缓存击穿问题，也叫 热点 Key 问题；就是一个被 <strong>高并发访问</strong> 并且 <strong>缓存中业务较复杂的</strong> Key 突然失效，大量的请求在极短的时间内一起请求这个 Key 并且都未命中，无数的请求访问在瞬间打到数据库上，给数据库带来巨大的冲击。</p></blockquote><ul><li><p>缓存击穿的解决方案</p></li><li><p>互斥锁：查询缓存未命中，获取互斥锁，获取到互斥锁的才能查询数据库重建缓存，将数据写入缓存中后，释放锁。</p></li><li><p>逻辑过期：查询缓存，发现逻辑时间已经过期，获取互斥锁，开启新线程；在新线程中查询数据库重建缓存，将数据写入缓存中后，释放锁；在释放锁之前，查询该数据时，都会将过期的数据返回。</p></li></ul></blockquote><h2 id=4-基于互斥锁解决缓存击穿问题>4. 基于互斥锁解决缓存击穿问题<a href=#4-基于互斥锁解决缓存击穿问题 class=header-anchor arialabel=Anchor> #</a></h2><blockquote><p>核心：利用 Redis 的 setnx 方法来表示获取锁。该方法的含义是：如果 Redis 中没有这个 Key，则插入成功；如果有这个 Key，则插入失败。通过插入成功或失败来表示是否有线程插入 Key，插入成功的 Key 则认为是获取到锁的线程；释放锁就是将这个 Key 删除，因为删除 Key 以后其他线程才能再执行 setnx 方法。</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#408080;font-style:italic>/**
</span><span style=color:#408080;font-style:italic> * 获取互斥锁
</span><span style=color:#408080;font-style:italic> */</span>
<span style=color:green;font-weight:700>private</span> <span style=color:#b00040>boolean</span> <span style=color:#00f>tryLock</span><span style=color:#666>(</span>String key<span style=color:#666>)</span> <span style=color:#666>{</span>
    Boolean flag <span style=color:#666>=</span> redisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>().</span><span style=color:#7d9029>setIfAbsent</span><span style=color:#666>(</span>key<span style=color:#666>,</span> <span style=color:#ba2121>&#34;1&#34;</span><span style=color:#666>,</span> TTL_TEN<span style=color:#666>,</span> TimeUnit<span style=color:#666>.</span><span style=color:#7d9029>SECONDS</span><span style=color:#666>);</span>
    <span style=color:green;font-weight:700>return</span> BooleanUtil<span style=color:#666>.</span><span style=color:#7d9029>isTrue</span><span style=color:#666>(</span>flag<span style=color:#666>);</span>
<span style=color:#666>}</span>

<span style=color:#408080;font-style:italic>/**
</span><span style=color:#408080;font-style:italic> * 释放互斥锁
</span><span style=color:#408080;font-style:italic> */</span>
<span style=color:green;font-weight:700>private</span> <span style=color:#b00040>void</span> <span style=color:#00f>unLock</span><span style=color:#666>(</span>String key<span style=color:#666>)</span> <span style=color:#666>{</span>
    redisTemplate<span style=color:#666>.</span><span style=color:#7d9029>delete</span><span style=color:#666>(</span>key<span style=color:#666>);</span>
<span style=color:#666>}</span>

</code></pre></div><blockquote><p>1.请求打进来，先去 Redis 中查，未命中；
2.获取互斥锁：将一个 Key 为 LOCK_SHOP_KEY + id 的数据写入 Redis 中，此时其他线程就无法拿到这个 Key，也就无法继续后续操作；
3.获取失败就进行休眠，休眠结束后通过递归再次请求；
4.获取成功，查询数据库、将需要查询的那个数据写入 Redis；
5.最后，删除通过 setnx 创建的那个 Key。</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@Override</span>
<span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>queryById</span><span style=color:#666>(</span>Long id<span style=color:#666>)</span> <span style=color:#666>{</span>
    <span style=color:#408080;font-style:italic>// 缓存击穿(Mutex)
</span><span style=color:#408080;font-style:italic></span>    Shop shop <span style=color:#666>=</span> dealWithCacheHotspotInvalidByMutex<span style=color:#666>(</span>id<span style=color:#666>);</span>
    <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>shop<span style=color:#666>);</span>
<span style=color:#666>}</span>

<span style=color:#408080;font-style:italic>/**
</span><span style=color:#408080;font-style:italic> * 通过互斥锁解决 Redis 的缓存击穿问题
</span><span style=color:#408080;font-style:italic> */</span>
<span style=color:green;font-weight:700>public</span> Shop <span style=color:#00f>dealWithCacheHotspotInvalidByMutex</span><span style=color:#666>(</span>Long id<span style=color:#666>)</span> <span style=color:#666>{</span>
    String key <span style=color:#666>=</span> CACHE_SHOP_KEY <span style=color:#666>+</span> id<span style=color:#666>;</span>
    
  	<span style=color:#408080;font-style:italic>// 1. 从 Redis 中查询店铺缓存；
</span><span style=color:#408080;font-style:italic></span>    String shopJson <span style=color:#666>=</span> redisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>().</span><span style=color:#7d9029>get</span><span style=color:#666>(</span>key<span style=color:#666>);</span>
    
  	<span style=color:#408080;font-style:italic>// 2. 若 Redis 中存在（命中），则将其转换为 Java 对象后返回；
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>StrUtil<span style=color:#666>.</span><span style=color:#7d9029>isNotBlank</span><span style=color:#666>(</span>shopJson<span style=color:#666>))</span> <span style=color:#666>{</span>
        <span style=color:green;font-weight:700>return</span> JSONUtil<span style=color:#666>.</span><span style=color:#7d9029>toBean</span><span style=color:#666>(</span>shopJson<span style=color:#666>,</span> Shop<span style=color:#666>.</span><span style=color:#7d9029>class</span><span style=color:#666>);</span>
    <span style=color:#666>}</span>
    
  	<span style=color:#408080;font-style:italic>// 3. 命中缓存后判断是否为空值
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>ObjectUtil<span style=color:#666>.</span><span style=color:#7d9029>equals</span><span style=color:#666>(</span>shopJson<span style=color:#666>,</span> <span style=color:#ba2121>&#34;&#34;</span><span style=color:#666>))</span> <span style=color:#666>{</span>
        <span style=color:green;font-weight:700>return</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>;</span>
    <span style=color:#666>}</span>
  	
    <span style=color:#408080;font-style:italic>// 4. 若 Redis 中不存在（缓存未命中），实现缓存重建
</span><span style=color:#408080;font-style:italic></span>    <span style=color:#408080;font-style:italic>// 4.1 获取互斥锁
</span><span style=color:#408080;font-style:italic></span>    String lockKey <span style=color:#666>=</span> LOCK_SHOP_KEY <span style=color:#666>+</span> id<span style=color:#666>;</span>
    Shop shop <span style=color:#666>=</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>;</span>
    <span style=color:green;font-weight:700>try</span> <span style=color:#666>{</span>
        <span style=color:#b00040>boolean</span> isLocked <span style=color:#666>=</span> tryLock<span style=color:#666>(</span>lockKey<span style=color:#666>);</span>
        <span style=color:#408080;font-style:italic>// 4.2 获取失败，休眠重试
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(!</span>isLocked<span style=color:#666>)</span> <span style=color:#666>{</span>
            Thread<span style=color:#666>.</span><span style=color:#7d9029>sleep</span><span style=color:#666>(</span>50<span style=color:#666>);</span>
            <span style=color:green;font-weight:700>return</span> dealWithCacheHotspotInvalidByMutex<span style=color:#666>(</span>id<span style=color:#666>);</span>
        <span style=color:#666>}</span>
        <span style=color:#408080;font-style:italic>// 4.3 获取成功，从数据库中根据 id 查询数据
</span><span style=color:#408080;font-style:italic></span>        shop <span style=color:#666>=</span> getById<span style=color:#666>(</span>id<span style=color:#666>);</span>
        <span style=color:#408080;font-style:italic>// 4.4 若 数据库 中不存在，将空值写入 Redis（缓存空对象）
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>shop <span style=color:#666>==</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
            redisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>().</span><span style=color:#7d9029>set</span><span style=color:#666>(</span>key<span style=color:#666>,</span> <span style=color:#ba2121>&#34;&#34;</span><span style=color:#666>,</span> TTL_TWO<span style=color:#666>,</span> TimeUnit<span style=color:#666>.</span><span style=color:#7d9029>MINUTES</span><span style=color:#666>);</span>
            <span style=color:green;font-weight:700>return</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>;</span>
        <span style=color:#666>}</span>
        <span style=color:#408080;font-style:italic>// 4.5 若 数据库 中存在，则将其返回并存入 Redis 缓存中。
</span><span style=color:#408080;font-style:italic></span>        redisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>().</span><span style=color:#7d9029>set</span><span style=color:#666>(</span>key<span style=color:#666>,</span> JSONUtil<span style=color:#666>.</span><span style=color:#7d9029>toJsonStr</span><span style=color:#666>(</span>shop<span style=color:#666>),</span> TTL_THIRTY<span style=color:#666>,</span> TimeUnit<span style=color:#666>.</span><span style=color:#7d9029>MINUTES</span><span style=color:#666>);</span>
    <span style=color:#666>}</span> <span style=color:green;font-weight:700>catch</span> <span style=color:#666>(</span>Exception e<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:green;font-weight:700>throw</span> <span style=color:green;font-weight:700>new</span> RuntimeException<span style=color:#666>(</span>e<span style=color:#666>);</span>
    <span style=color:#666>}</span> <span style=color:green;font-weight:700>finally</span> <span style=color:#666>{</span>
      	<span style=color:#408080;font-style:italic>// 5. 释放互斥锁
</span><span style=color:#408080;font-style:italic></span>        unLock<span style=color:#666>(</span>lockKey<span style=color:#666>);</span>
    <span style=color:#666>}</span>
    <span style=color:green;font-weight:700>return</span> shop<span style=color:#666>;</span>
<span style=color:#666>}</span>

</code></pre></div></blockquote></blockquote><h2 id=5逻辑过期解决缓存击穿>5.逻辑过期解决缓存击穿<a href=#5逻辑过期解决缓存击穿 class=header-anchor arialabel=Anchor> #</a></h2><blockquote><ul><li>可以认为存储到 Redis 中的 Key 永久有效的，其过期时间是可以代码控制的，而非通过 TTL 控制。</li><li>因此 Redis 存储的数据需要带上一个逻辑过期时间，即 Shop 实体类中需要一个逻辑过期时间属性。</li><li>可以新建一个 RedisData，该类包含两个属性 —— expireTime 和 Data，对原来的代码没有入侵性。</li></ul><p><img src=https://itsawaysu.oss-cn-shanghai.aliyuncs.com/note/%E5%9F%BA%E4%BA%8E%E9%80%BB%E8%BE%91%E8%BF%87%E6%9C%9F%E8%A7%A3%E5%86%B3%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF%E9%97%AE%E9%A2%98.jpg alt=基于逻辑过期解决缓存击穿问题></p></blockquote><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:green;font-weight:700>private</span> <span style=color:green;font-weight:700>static</span> <span style=color:green;font-weight:700>final</span> ExecutorService CACHE_REBUILD_EXECUTOR <span style=color:#666>=</span> Executors<span style=color:#666>.</span><span style=color:#7d9029>newFixedThreadPool</span><span style=color:#666>(</span>10<span style=color:#666>);</span>
<span style=color:green;font-weight:700>public</span> <span style=color:#666>&lt;</span>R<span style=color:#666>,</span> ID<span style=color:#666>&gt;</span> R <span style=color:#00f>queryWithLogicalExpire</span><span style=color:#666>(</span>
            String keyPrefix<span style=color:#666>,</span> ID id<span style=color:#666>,</span> Class<span style=color:#666>&lt;</span>R<span style=color:#666>&gt;</span> type<span style=color:#666>,</span> Function<span style=color:#666>&lt;</span>ID<span style=color:#666>,</span> R<span style=color:#666>&gt;</span> dbFallback<span style=color:#666>,</span> Long time<span style=color:#666>,</span> TimeUnit unit<span style=color:#666>)</span> <span style=color:#666>{</span>
        String key <span style=color:#666>=</span> keyPrefix <span style=color:#666>+</span> id<span style=color:#666>;</span>
        <span style=color:#408080;font-style:italic>// 1.从redis查询商铺缓存
</span><span style=color:#408080;font-style:italic></span>        String json <span style=color:#666>=</span> stringRedisTemplate<span style=color:#666>.</span><span style=color:#7d9029>opsForValue</span><span style=color:#666>().</span><span style=color:#7d9029>get</span><span style=color:#666>(</span>key<span style=color:#666>);</span>
        <span style=color:#408080;font-style:italic>// 2.判断是否存在
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>StrUtil<span style=color:#666>.</span><span style=color:#7d9029>isBlank</span><span style=color:#666>(</span>json<span style=color:#666>))</span> <span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>// 3.不存在，直接返回
</span><span style=color:#408080;font-style:italic></span>            <span style=color:green;font-weight:700>return</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>;</span>
        <span style=color:#666>}</span>
        <span style=color:#408080;font-style:italic>// 4.命中，需要先把json反序列化为对象
</span><span style=color:#408080;font-style:italic></span>        RedisData redisData <span style=color:#666>=</span> JSONUtil<span style=color:#666>.</span><span style=color:#7d9029>toBean</span><span style=color:#666>(</span>json<span style=color:#666>,</span> RedisData<span style=color:#666>.</span><span style=color:#7d9029>class</span><span style=color:#666>);</span>
        R r <span style=color:#666>=</span> JSONUtil<span style=color:#666>.</span><span style=color:#7d9029>toBean</span><span style=color:#666>((</span>JSONObject<span style=color:#666>)</span> redisData<span style=color:#666>.</span><span style=color:#7d9029>getData</span><span style=color:#666>(),</span> type<span style=color:#666>);</span>
        LocalDateTime expireTime <span style=color:#666>=</span> redisData<span style=color:#666>.</span><span style=color:#7d9029>getExpireTime</span><span style=color:#666>();</span>
        <span style=color:#408080;font-style:italic>// 5.判断是否过期
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span><span style=color:#666>(</span>expireTime<span style=color:#666>.</span><span style=color:#7d9029>isAfter</span><span style=color:#666>(</span>LocalDateTime<span style=color:#666>.</span><span style=color:#7d9029>now</span><span style=color:#666>()))</span> <span style=color:#666>{</span>
            <span style=color:#408080;font-style:italic>// 5.1.未过期，直接返回店铺信息
</span><span style=color:#408080;font-style:italic></span>            <span style=color:green;font-weight:700>return</span> r<span style=color:#666>;</span>
        <span style=color:#666>}</span>
        <span style=color:#408080;font-style:italic>// 5.2.已过期，需要缓存重建
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#408080;font-style:italic>// 6.缓存重建
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#408080;font-style:italic>// 6.1.获取互斥锁
</span><span style=color:#408080;font-style:italic></span>        String lockKey <span style=color:#666>=</span> LOCK_SHOP_KEY <span style=color:#666>+</span> id<span style=color:#666>;</span>
        <span style=color:#b00040>boolean</span> isLock <span style=color:#666>=</span> tryLock<span style=color:#666>(</span>lockKey<span style=color:#666>);</span>
        <span style=color:#408080;font-style:italic>// 6.2.判断是否获取锁成功
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>isLock<span style=color:#666>){</span>
            <span style=color:#408080;font-style:italic>// 6.3.成功，开启独立线程，实现缓存重建
</span><span style=color:#408080;font-style:italic></span>            CACHE_REBUILD_EXECUTOR<span style=color:#666>.</span><span style=color:#7d9029>submit</span><span style=color:#666>(()</span> <span style=color:#666>-&gt;</span> <span style=color:#666>{</span>
                <span style=color:green;font-weight:700>try</span> <span style=color:#666>{</span>
                    <span style=color:#408080;font-style:italic>// 查询数据库
</span><span style=color:#408080;font-style:italic></span>                    R newR <span style=color:#666>=</span> dbFallback<span style=color:#666>.</span><span style=color:#7d9029>apply</span><span style=color:#666>(</span>id<span style=color:#666>);</span>
                    <span style=color:#408080;font-style:italic>// 重建缓存
</span><span style=color:#408080;font-style:italic></span>                    <span style=color:green;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#7d9029>setWithLogicalExpire</span><span style=color:#666>(</span>key<span style=color:#666>,</span> newR<span style=color:#666>,</span> time<span style=color:#666>,</span> unit<span style=color:#666>);</span>
                <span style=color:#666>}</span> <span style=color:green;font-weight:700>catch</span> <span style=color:#666>(</span>Exception e<span style=color:#666>)</span> <span style=color:#666>{</span>
                    <span style=color:green;font-weight:700>throw</span> <span style=color:green;font-weight:700>new</span> RuntimeException<span style=color:#666>(</span>e<span style=color:#666>);</span>
                <span style=color:#666>}</span><span style=color:green;font-weight:700>finally</span> <span style=color:#666>{</span>
                    <span style=color:#408080;font-style:italic>// 释放锁
</span><span style=color:#408080;font-style:italic></span>                    unlock<span style=color:#666>(</span>lockKey<span style=color:#666>);</span>
                <span style=color:#666>}</span>
            <span style=color:#666>});</span>
        <span style=color:#666>}</span>
        <span style=color:#408080;font-style:italic>// 6.4.返回过期的商铺信息
</span><span style=color:#408080;font-style:italic></span>        <span style=color:green;font-weight:700>return</span> r<span style=color:#666>;</span>
    <span style=color:#666>}</span>

 <span style=color:#408080;font-style:italic>// 逻辑过期解决缓存击穿
</span><span style=color:#408080;font-style:italic>//         Shop shop = cacheClient
</span><span style=color:#408080;font-style:italic>//                 .queryWithLogicalExpire(CACHE_SHOP_KEY, id, Shop.class,this::getById,CACHE_SHOP_TTL,TimeUnit.MINUTES );
</span></code></pre></div><h2 id=6超卖问题>6.超卖问题<a href=#6超卖问题 class=header-anchor arialabel=Anchor> #</a></h2><blockquote><p><strong>使用 Jmeter 进行测试能够发现：秒杀优惠券的库存为 负数，生成的订单数量超过 100 份。</strong></p><p>多线程下单出现超卖问题</p><blockquote><ul><li><p>悲观锁：每次拿数据的时候都会上锁，共享资源每次只给一个线程使用，其它线程阻塞，用完后再把资源转让给其它线程；</p></li><li><p>乐观锁：每次拿数据的时候都不会上锁，但在更新时会判断在此期间有没有其他线程更新这个数据；如果存在冲突，则采取一个补偿措施（比如告知用户失败）。</p></li><li><p>乐观锁的关键是判断之前查询得到的数据是否被修改过；
一般有 2 种实现方式：版本号法 和 CAS 法。</p></li></ul></blockquote><ul><li>通过版本号法实现乐观锁</li></ul><blockquote><p>查询数据，获取当前需要操作数据的 版本号；
更新数据时同时需要更新版本号；
若执行更新时的版本号 与 最初查询获取到的版本号不同，则更新失败。</p></blockquote><blockquote><p>假设库存为 1，有线程1、2、3，时刻 t1、t2、t3、t4。</p><p>线程1 在 t1 查询库存，库存为 1，版本号为 1；线程2 在 t2 查询库存，库存为 1，版本号为 1；线程3 在 t2 查询库存，库存为 1，版本号为 1。
线程1 在 t3 下单，库存扣减为0，版本号为 2；
线程2 和 线程3 在 t4 下单，版本号为 2，与最初查询到的版本号不同，执行失败。</p></blockquote><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span>#</span> id <span style=color:#666>=</span> 10<span style=color:#666>,</span> stock <span style=color:#666>=</span> 1<span style=color:#666>,</span> version <span style=color:#666>=</span> 1
SELECT id<span style=color:#666>,</span> stock<span style=color:#666>,</span> version FROM tb_scekill_voucher<span style=color:#666>;</span>

<span>#</span> id <span style=color:#666>=</span> 10<span style=color:#666>,</span> stock <span style=color:#666>=</span> 0<span style=color:#666>,</span> version <span style=color:#666>=</span> 2
UDATE SET tb_seckill_voucher stock <span style=color:#666>=</span> stock <span style=color:#666>-</span> 1<span style=color:#666>,</span> version <span style=color:#666>=</span> version <span style=color:#666>+</span> 1 WHERE id <span style=color:#666>=</span> 10 AND version <span style=color:#666>=</span> 1<span style=color:#666>;</span>

</code></pre></div><blockquote><p>CAS Compare And Set</p></blockquote><blockquote><p>通过以上描述发现，stock 能够替代 version 字段 —— 查询、然后更新、更新时检查其是否与最初查询的值一致。</p></blockquote><blockquote><p>查询获取 stock；
更新 stock；
若执行更新时的 stock 与最初查询到的 stock 的值不同，则更新失败。
假设库存为 1，有线程1、2、3，时刻 t1、t2、t3、t4。</p></blockquote><blockquote><p>线程1 在 t1 查询库存，库存为 1；线程2 在 t2 查询库存，库存为 1；线程3 在 t2 查询库存，库存为 1。
线程1 在 t3 下单，库存扣减为0；
线程2 和 线程3 在 t4 下单，库存为 0，与最初查询到的库存不同，执行失败。</p></blockquote><blockquote><p>乐观锁解决超卖问题</p></blockquote><blockquote><p>使用乐观锁：进行测试会发现，库存尚未不足时就会导致很多线程更新失败 —— 若有十个线程查询到的 <code>stock</code> 为100，只要有一个更新成功，其他全部失败。</p></blockquote><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#408080;font-style:italic>// 4. 减扣库存
</span><span style=color:#408080;font-style:italic></span><span style=color:#b00040>boolean</span> isAccomplished <span style=color:#666>=</span> seckillVoucherService<span style=color:#666>.</span><span style=color:#7d9029>update</span><span style=color:#666>()</span>
        <span style=color:#408080;font-style:italic>// SET stock= stock - 1
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#666>.</span><span style=color:#7d9029>setSql</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;stock = stock - 1&#34;</span><span style=color:#666>)</span>
        <span style=color:#408080;font-style:italic>// WHERE  voucher_id = ? AND stock = ?
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#666>.</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;voucher_id&#34;</span><span style=color:#666>,</span> voucherId<span style=color:#666>).</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;stock&#34;</span><span style=color:#666>,</span>seckillVoucher<span style=color:#666>.</span><span style=color:#7d9029>getStock</span><span style=color:#666>())</span>
        <span style=color:#666>.</span><span style=color:#7d9029>update</span><span style=color:#666>();</span>
<span style=color:green;font-weight:700>if</span> <span style=color:#666>(!</span>isAccomplished<span style=color:#666>)</span> <span style=color:#666>{</span>
    <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;库存不足..&#34;</span><span style=color:#666>);</span>
<span style=color:#666>}</span>

</code></pre></div><p><strong>此处不会超卖</strong>：基于数据库的 <code>update</code> 语句自带行锁，一旦某个用户对某行进行 <code>update</code> 操作，其他用户只能查询但不能 <code>update</code> 被加锁的数据行。
<strong>只需要让 <code>stock > 0</code> 即可～</strong></p><p>CAS的缺点：</p><blockquote><p>1.CPU开销较大
在并发量比较高的情况下，如果许多线程反复尝试更新某一个变量，却又一直更新不成功，循环往复，会给CPU带来很大的压力。</p></blockquote><blockquote><p>2.不能保证代码块的原子性
CAS机制所保证的只是一个变量的原子性操作，而不能保证整个代码块的原子性。比如需要保证3个变量共同进行原子性的更新，就不得不使用Synchronized了。// 4. 减扣库存</p></blockquote><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#b00040>boolean</span> isAccomplished <span style=color:#666>=</span> seckillVoucherService<span style=color:#666>.</span><span style=color:#7d9029>update</span><span style=color:#666>()</span>
        <span style=color:#408080;font-style:italic>// SET stock= stock - 1
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#666>.</span><span style=color:#7d9029>setSql</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;stock = stock - 1&#34;</span><span style=color:#666>)</span>
        <span style=color:#408080;font-style:italic>// WHERE  voucher_id = ? AND stock &gt; 0
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#666>.</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;voucher_id&#34;</span><span style=color:#666>,</span> voucherId<span style=color:#666>).</span><span style=color:#7d9029>gt</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;stock&#34;</span><span style=color:#666>,</span> 0<span style=color:#666>)</span>
        <span style=color:#666>.</span><span style=color:#7d9029>update</span><span style=color:#666>();</span>
<span style=color:green;font-weight:700>if</span> <span style=color:#666>(!</span>isAccomplished<span style=color:#666>)</span> <span style=color:#666>{</span>
    <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;库存不足..&#34;</span><span style=color:#666>);</span>
<span style=color:#666>}</span>
</code></pre></div></blockquote><h2 id=7一人一单>7.一人一单<a href=#7一人一单 class=header-anchor arialabel=Anchor> #</a></h2><p>**存在问题：**高并发的情况下，查询数据库时，都不存在订单，仍然会出现一人多单的情况，仍需加锁。乐观锁比较适合更新操作，此处的插入操作选择悲观锁。</p><p>**注意：**在这里提到了非常多的问题，我们需要慢慢的来思考，首先我们的初始方案是封装了一个createVoucherOrder方法，同时为了确保他线程安全。首先，初始方案是在 createVoucherOrder 方法上添加 synchronized，这样导致锁的粒度过大。</p><p>在seckillVoucher 方法中，添加以下逻辑，这样就能保证事务的特性，同时也控制了锁的粒度</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>synchronized</span> Result <span style=color:#00f>createVoucherOrder</span><span style=color:#666>(</span>Long voucherId<span style=color:#666>)</span> <span style=color:#666>{</span> 
<span style=color:#666>}</span>
</code></pre></div><p>于是选择 “一个用户一把锁” 这样的方案。但是必须先保证 锁是同一把：userId.toString() 方法锁获取到的字符串是不同的对象，底层是 new 出来的，intern() 方法是从常量池里获取数据，保证了同一个用户的 userId.toString() 值相同。</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@Transactional</span>
<span style=color:#a2f>@Override</span>
<span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>createVoucherOrder</span><span style=color:#666>(</span>Long voucherId<span style=color:#666>)</span> <span style=color:#666>{</span>
    Long userId <span style=color:#666>=</span> UserHolder<span style=color:#666>.</span><span style=color:#7d9029>getUser</span><span style=color:#666>().</span><span style=color:#7d9029>getId</span><span style=color:#666>();</span>
  	<span style=color:green;font-weight:700>synchronized</span><span style=color:#666>(</span>userId<span style=color:#666>.</span><span style=color:#7d9029>toString</span><span style=color:#666>().</span><span style=color:#7d9029>intern</span><span style=color:#666>())</span> <span style=color:#666>{</span>
      	<span style=color:#666>...</span>
    <span style=color:#666>}</span>
<span style=color:#666>}</span>
</code></pre></div><p>此外，还需要注意一个点，我们需要将 createVoucherOrder 方法整体包裹起来，确保事务不会出问题；否则会出现 “synchronized 包裹的代码片段执行完毕，事务还未提交，但是锁已经释放了” 的情况。</p><p>但是以上代码还是存在问题，问题的原因在于当前方法被spring的事务控制，如果你在方法内部加锁，可能会导致当前方法事务还没有提交，但是锁已经释放也会导致问题，所以我们选择将当前方法整体包裹起来，确保事务不会出现问题：如下：</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:green;font-weight:700>synchronized</span> <span style=color:#666>(</span>userId<span style=color:#666>.</span><span style=color:#7d9029>toString</span><span style=color:#666>().</span><span style=color:#7d9029>intern</span><span style=color:#666>())</span> <span style=color:#666>{</span>
		<span style=color:green;font-weight:700>return</span> createVoucherOrder<span style=color:#666>(</span>voucherId<span style=color:#666>);</span>
<span style=color:#666>}</span>
</code></pre></div><p>最后，createVoucherOrder 方法实际上是通过 this.createVoucherOrder() 的方式调用的，this 拿到的是原始对象，没有经过动态代理，事务要生效，需要使用代理对象来执行。</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:green;font-weight:700>synchronized</span> <span style=color:#666>(</span>userId<span style=color:#666>.</span><span style=color:#7d9029>toString</span><span style=color:#666>().</span><span style=color:#7d9029>intern</span><span style=color:#666>())</span> <span style=color:#666>{</span>
    <span style=color:#408080;font-style:italic>// 获取代理对象
</span><span style=color:#408080;font-style:italic></span>    VoucherOrderService currentProxy <span style=color:#666>=</span> <span style=color:#666>(</span>VoucherOrderService<span style=color:#666>)</span> AopContext<span style=color:#666>.</span><span style=color:#7d9029>currentProxy</span><span style=color:#666>();</span>
    <span style=color:green;font-weight:700>return</span> currentProxy<span style=color:#666>.</span><span style=color:#7d9029>createVoucherOrder</span><span style=color:#666>(</span>voucherId<span style=color:#666>);</span>
<span style=color:#666>}</span>
</code></pre></div><blockquote><p>终极版本</p></blockquote><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a2f>@Override</span>
<span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>seckillVoucher</span><span style=color:#666>(</span>Long voucherId<span style=color:#666>)</span> <span style=color:#666>{</span>
    <span style=color:#408080;font-style:italic>// 1. 根据 优惠券 id 查询数据库
</span><span style=color:#408080;font-style:italic></span>    SeckillVoucher seckillVoucher <span style=color:#666>=</span> seckillVoucherService<span style=color:#666>.</span><span style=color:#7d9029>getById</span><span style=color:#666>(</span>voucherId<span style=color:#666>);</span>
    
  	<span style=color:#408080;font-style:italic>// 2. 判断秒杀是否开始或结束（未开始或已结束，返回异常结果）
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>LocalDateTime<span style=color:#666>.</span><span style=color:#7d9029>now</span><span style=color:#666>().</span><span style=color:#7d9029>isBefore</span><span style=color:#666>(</span>seckillVoucher<span style=color:#666>.</span><span style=color:#7d9029>getBeginTime</span><span style=color:#666>()))</span> <span style=color:#666>{</span>
        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;秒杀尚未开始..&#34;</span><span style=color:#666>);</span>
    <span style=color:#666>}</span>
    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>LocalDateTime<span style=color:#666>.</span><span style=color:#7d9029>now</span><span style=color:#666>().</span><span style=color:#7d9029>isAfter</span><span style=color:#666>(</span>seckillVoucher<span style=color:#666>.</span><span style=color:#7d9029>getEndTime</span><span style=color:#666>()))</span> <span style=color:#666>{</span>
        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;秒杀已经结束..&#34;</span><span style=color:#666>);</span>
    <span style=color:#666>}</span>
  	
    <span style=color:#408080;font-style:italic>// 3. 判断库存是否充足（不充足返回异常结果）
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>seckillVoucher<span style=color:#666>.</span><span style=color:#7d9029>getStock</span><span style=color:#666>()</span> <span style=color:#666>&lt;</span> 1<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;库存不足..&#34;</span><span style=color:#666>);</span>
    <span style=color:#666>}</span>
  	
    Long userId <span style=color:#666>=</span> UserHolder<span style=color:#666>.</span><span style=color:#7d9029>getUser</span><span style=color:#666>().</span><span style=color:#7d9029>getId</span><span style=color:#666>();</span>
    <span style=color:green;font-weight:700>synchronized</span> <span style=color:#666>(</span>userId<span style=color:#666>.</span><span style=color:#7d9029>toString</span><span style=color:#666>().</span><span style=color:#7d9029>intern</span><span style=color:#666>())</span> <span style=color:#666>{</span>
        <span style=color:#408080;font-style:italic>// 获取代理对象
</span><span style=color:#408080;font-style:italic></span>        VoucherOrderService currentProxy <span style=color:#666>=</span> <span style=color:#666>(</span>VoucherOrderService<span style=color:#666>)</span> AopContext<span style=color:#666>.</span><span style=color:#7d9029>currentProxy</span><span style=color:#666>();</span>
        <span style=color:green;font-weight:700>return</span> currentProxy<span style=color:#666>.</span><span style=color:#7d9029>createVoucherOrder</span><span style=color:#666>(</span>voucherId<span style=color:#666>);</span>
    <span style=color:#666>}</span>
<span style=color:#666>}</span>

<span style=color:#a2f>@Transactional</span>
<span style=color:#a2f>@Override</span>
<span style=color:green;font-weight:700>public</span> Result <span style=color:#00f>createVoucherOrder</span><span style=color:#666>(</span>Long voucherId<span style=color:#666>)</span> <span style=color:#666>{</span>
    Long userId <span style=color:#666>=</span> UserHolder<span style=color:#666>.</span><span style=color:#7d9029>getUser</span><span style=color:#666>().</span><span style=color:#7d9029>getId</span><span style=color:#666>();</span>
    <span style=color:#408080;font-style:italic>// 4. 一人一单（根据 优惠券id 和 用户id 查询订单；存在，则直接返回）
</span><span style=color:#408080;font-style:italic></span>    Integer count <span style=color:#666>=</span> query<span style=color:#666>().</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;voucher_id&#34;</span><span style=color:#666>,</span> voucherId<span style=color:#666>).</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;user_id&#34;</span><span style=color:#666>,</span> userId<span style=color:#666>).</span><span style=color:#7d9029>count</span><span style=color:#666>();</span>
    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>count <span style=color:#666>&gt;</span> 0<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;不可重复下单！&#34;</span><span style=color:#666>);</span>
    <span style=color:#666>}</span>
  	
    <span style=color:#408080;font-style:italic>// 5. 减扣库存
</span><span style=color:#408080;font-style:italic></span>    <span style=color:#b00040>boolean</span> isAccomplished <span style=color:#666>=</span> seckillVoucherService<span style=color:#666>.</span><span style=color:#7d9029>update</span><span style=color:#666>()</span>
            <span style=color:#408080;font-style:italic>// SET stock= stock - 1
</span><span style=color:#408080;font-style:italic></span>            <span style=color:#666>.</span><span style=color:#7d9029>setSql</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;stock = stock - 1&#34;</span><span style=color:#666>)</span>
            <span style=color:#408080;font-style:italic>// WHERE  voucher_id = ? AND stock &gt; 0
</span><span style=color:#408080;font-style:italic></span>            <span style=color:#666>.</span><span style=color:#7d9029>eq</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;voucher_id&#34;</span><span style=color:#666>,</span> voucherId<span style=color:#666>).</span><span style=color:#7d9029>gt</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;stock&#34;</span><span style=color:#666>,</span> 0<span style=color:#666>)</span>
            <span style=color:#666>.</span><span style=color:#7d9029>update</span><span style=color:#666>();</span>
    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(!</span>isAccomplished<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;库存不足..&#34;</span><span style=color:#666>);</span>
    <span style=color:#666>}</span>
  	
    <span style=color:#408080;font-style:italic>// 6. 创建订单
</span><span style=color:#408080;font-style:italic></span>    VoucherOrder voucherOrder <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> VoucherOrder<span style=color:#666>();</span>
    <span style=color:#b00040>long</span> orderId <span style=color:#666>=</span> redisIdWorker<span style=color:#666>.</span><span style=color:#7d9029>nextId</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;order&#34;</span><span style=color:#666>);</span>
    voucherOrder<span style=color:#666>.</span><span style=color:#7d9029>setId</span><span style=color:#666>(</span>orderId<span style=color:#666>);</span>
    voucherOrder<span style=color:#666>.</span><span style=color:#7d9029>setUserId</span><span style=color:#666>(</span>userId<span style=color:#666>);</span>
    voucherOrder<span style=color:#666>.</span><span style=color:#7d9029>setVoucherId</span><span style=color:#666>(</span>voucherId<span style=color:#666>);</span>
    <span style=color:#b00040>boolean</span> isSaved <span style=color:#666>=</span> save<span style=color:#666>(</span>voucherOrder<span style=color:#666>);</span>
    <span style=color:green;font-weight:700>if</span> <span style=color:#666>(!</span>isSaved<span style=color:#666>)</span> <span style=color:#666>{</span>
        <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>fail</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;下单失败..&#34;</span><span style=color:#666>);</span>
    <span style=color:#666>}</span>
  	
    <span style=color:#408080;font-style:italic>// 7. 返回 订单 id
</span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>return</span> Result<span style=color:#666>.</span><span style=color:#7d9029>ok</span><span style=color:#666>(</span>orderId<span style=color:#666>);</span>
<span style=color:#666>}</span>
</code></pre></div><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span>#</span>自写
            Long usrId <span style=color:#666>=</span> UserHolder<span style=color:#666>.</span><span style=color:#7d9029>getUser</span><span style=color:#666>().</span><span style=color:#7d9029>getId</span><span style=color:#666>();</span>
        <span style=color:green;font-weight:700>synchronized</span><span style=color:#666>(</span>usrId<span style=color:#666>.</span><span style=color:#7d9029>toString</span><span style=color:#666>().</span><span style=color:#7d9029>intern</span><span style=color:#666>())</span> <span style=color:#666>{</span>
            IVoucherOrderService proxy <span style=color:#666>=</span> <span style=color:#666>(</span>IVoucherOrderService<span style=color:#666>)</span>AopContext<span style=color:#666>.</span><span style=color:#7d9029>currentProxy</span><span style=color:#666>();</span>
            <span style=color:green;font-weight:700>return</span> proxy<span style=color:#666>.</span><span style=color:#7d9029>createVoucherOrder</span><span style=color:#666>(</span>voucherId<span style=color:#666>);</span>
        <span style=color:#666>}</span>
        <span style=color:#408080;font-style:italic>//但是这个时候的事务优点问题调用的是this剩下，拿到当前的oder对象不是代理对象，
</span><span style=color:#408080;font-style:italic></span>        <span style=color:#408080;font-style:italic>// 所以没有事务功能，所以拿到事务的代理对象
</span><span style=color:#408080;font-style:italic></span>同时在pom<span style=color:#666>.</span><span style=color:#7d9029>xml引入依赖</span>
    <span style=color:#666>&lt;!--</span> https<span style=color:#666>:</span><span style=color:#408080;font-style:italic>//mvnrepository.com/artifact/org.aspectj/aspectjweaver --&gt;
</span><span style=color:#408080;font-style:italic></span><span style=color:#666>&lt;</span>dependency<span style=color:#666>&gt;</span>
    <span style=color:#666>&lt;</span>groupId<span style=color:#666>&gt;</span>org<span style=color:#666>.</span><span style=color:#7d9029>aspectj</span><span style=color:#666>&lt;/</span>groupId<span style=color:#666>&gt;</span>
    <span style=color:#666>&lt;</span>artifactId<span style=color:#666>&gt;</span>aspectjweaver<span style=color:#666>&lt;/</span>artifactId<span style=color:#666>&gt;</span>
    <span style=color:#666>&lt;</span>version<span style=color:#666>&gt;</span>1<span style=color:#666>.</span><span style=color:#7d9029>9</span><span style=color:#666>.</span><span style=color:#7d9029>9</span><span style=color:#666>.</span><span style=color:#7d9029>1</span><span style=color:#666>&lt;/</span>version<span style=color:#666>&gt;</span>
    <span style=color:#666>&lt;</span>scope<span style=color:#666>&gt;</span>runtime<span style=color:#666>&lt;/</span>scope<span style=color:#666>&gt;</span>
<span style=color:#666>&lt;/</span>dependency<span style=color:#666>&gt;</span>
<span>#</span> 同时在springboot开注解
</code></pre></div><h2 id=8分布式锁集群项目>8.分布式锁集群项目<a href=#8分布式锁集群项目 class=header-anchor arialabel=Anchor> #</a></h2><blockquote><ul><li>单体项目的时候可以用</li><li>线程1/2 和 线程3/4 使用的不是同一份代码，锁对象不是同一个，于是线程1/2 与 线程3/4 之间无法实现互斥；导致 <code>synchronized</code> 锁失效，这种情况下就需要 <strong>分布式锁</strong> 来解决。</li></ul><blockquote><p>SimpleRedisLock**</p><blockquote><p>利用setnx方法进行加锁，同时增加过期时间，防止死锁，此方法可以保证加锁和增加过期时间具有原子性</p></blockquote></blockquote><ol><li><p>redis锁代替悲观锁，解决分布式锁的问题（创建新的simpleredislock对象+代理对象调用方法）</p><p>此时出现问题删除锁的时候多线程可能出现锁的误删</p></li><li><p>在获取锁的时候存入线程标识（用 UUID 表示）；</p><blockquote><p>在释放锁时先获取锁中的线程标识，判断是否与当前的线程标识一致；</p><p>出现问题“判断线程标识的一致性 与 释放锁” 操作的需要原子性。</p></blockquote></li><li><p>用lua脚本执行多条命令的原子性</p><blockquote><p>在判断线程标识和释放锁的操作是lua脚本保证原子性</p></blockquote></li></ol></blockquote><h2 id=9redission分布式锁>9.redission分布式锁<a href=#9redission分布式锁 class=header-anchor arialabel=Anchor> #</a></h2><blockquote><ul><li>1）不可重入Redis分布式锁：
原理：利用setnx的互斥性；利用ex避免死锁；释放锁时判断线程标示
缺陷：不可重入、无法重试、锁超时失效</li><li>2）可重入的Redis分布式锁：
原理：利用hash结构，记录线程标示和重入次数；利用watchDog延续锁时间；利用信号量控制锁重试等待
缺陷：redis宕机引起锁失效问题</li><li>3）Redisson的multiLock：
原理：多个独立的Redis节点，必须在所有节点都获取重入锁，才算获取锁成功
缺陷：运维成本高、实现复杂</li></ul></blockquote><h2 id=10秒杀优化基于阻塞队列>10.秒杀优化基于阻塞队列<a href=#10秒杀优化基于阻塞队列 class=header-anchor arialabel=Anchor> #</a></h2><blockquote><ol><li>新增秒杀优惠券的同时，将优惠券信息保存到 Redis 中</li><li>基于 Lua 脚本，判断秒杀库存、一人一单，决定用户是否抢购成功</li><li>如果抢购成功，将优惠券 id 和用户 id 封装后存入阻塞队列</li><li>开启线程任务，不断从阻塞队列中获取信息，实现异步下单功能</li><li>完成init之后，执行seckillVoucher(voucherId)</li><li>执行脚本返回资格，如果有资格进行创建订单，将订单加入到阻塞队列中，返回订单号。</li></ol><p><strong>小总结：</strong></p><ul><li>先利用Redis完成库存余量、一人一单判断，完成抢单业务</li><li>再将下单业务放入阻塞队列，利用独立线程异步下单</li><li>基于阻塞队列的异步秒杀存在哪些问题？<ul><li>内存限制问题</li><li>数据安全问题</li></ul></li></ul></blockquote><h2 id=11秒杀优化基于消息队列>11.秒杀优化基于消息队列<a href=#11秒杀优化基于消息队列 class=header-anchor arialabel=Anchor> #</a></h2><blockquote><p>用消息队列代替阻塞队列</p></blockquote><h2 id=12点赞用sortedset>12.点赞用sortedSet<a href=#12点赞用sortedset class=header-anchor arialabel=Anchor> #</a></h2><blockquote><p>之前的点赞放在 Set 集合中，但是 Set 集合是无序不可重复的，此处需要使用可排序的 Set 集合，即 SortedSet。</p></blockquote><h2 id=13关注互关用set>13.关注互关用set<a href=#13关注互关用set class=header-anchor arialabel=Anchor> #</a></h2><blockquote><h3 id=总结用关注setkey用户value关注用户名-1>总结用关注set(key用户，value关注用户名)<a href=#总结用关注setkey用户value关注用户名-1 class=header-anchor arialabel=Anchor> #</a></h3><blockquote><p>互相关注的时候用stringRedisTemplate.opsForSet().intersect(selfKey, aimKey);</p><p>注意：为了实现共同关注功能，使用 Set，因为 Set 中有 <code>SINTER - 交集</code>、<code>SDIFFER - 差集</code>、<code>SUNION - 并集</code> 命令。</p></blockquote></blockquote><h2 id=14feed流推送>14.Feed流推送<a href=#14feed流推送 class=header-anchor arialabel=Anchor> #</a></h2><blockquote><p>本例中的个人页面，是基于关注的好友来做 Feed 流，因此采用 Timeline 的模式。</p><ul><li>该模式的实现方案有三种：拉模式、推模式、推拉结合</li></ul><p>feed流滚动分页用满足这种条件的 Redis 中的数据结构就是 SortedSet</p></blockquote><h2 id=15geo实现附近商务功能>15GEO实现附近商务功能<a href=#15geo实现附近商务功能 class=header-anchor arialabel=Anchor> #</a></h2><blockquote><p>Geolocation**，代表地理位置，允许存储地理坐标。GEO 底层的实现原理是 ZSET，可以使用 ZSET 的命令操作 GEO。</p><p><strong>将数据库中的数据导入到 Redis 中</strong>：按照商家类型分组，类型相同的商家作为一组，以 <code>typeId</code> 为 Key，商家地址为 Value。</p></blockquote><h2 id=16bitmap实现用户签到>16.BitMap实现用户签到<a href=#16bitmap实现用户签到 class=header-anchor arialabel=Anchor> #</a></h2><blockquote><p>BitMap 返回的数据是 10 进制的，只需要让得到的 10 进制数字 和 1 进行与运算，每与一次就将签到结果右移一位，实现遍历。</p></blockquote><h2 id=17uv统计-hyperloglog>17.UV统计-HyperLogLog<a href=#17uv统计-hyperloglog class=header-anchor arialabel=Anchor> #</a></h2><blockquote><ul><li>UV：全称Unique Visitor，也叫独立访客量，是指通过互联网访问、浏览这个网页的自然人。1天内同一个用户多次访问该网站，只记录1次。</li><li>PV：全称Page View，也叫页面访问量或点击量，用户每访问网站的一个页面，记录1次PV，用户多次打开页面，则记录多次PV。往往用来衡量网站的流量。</li></ul></blockquote><p>参考博主：(文章)[https://blog.csdn.net/weixin_45033015?type=blog]</p><p style=color:#777>最后一次修改于 2022-12-11</p></div><a href=#top><i class="fa fa-chevron-up" style=font-size:30px;color:#000></i></a></main><footer class=footer><script type=text/javascript src=/js/math-code.js></script><script async src="//mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script><script type=text/javascript src=/js/center-img.js></script><ul class=footer-links><li><a href=/cn/posts/index.xml type=application/rss+xml title="RSS feed">订阅</a></li><li><a href=http://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh target=_blank>版权
<i class="fa fa-cc" aria-hidden=true title="Attribution-NonCommercial-ShareAlike 4.0 International"></i></a></li></ul><div class=copyright-text>©
杨星月
2020-2021</div></footer>